<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>ALEX 3.0 - Configuraci√≥n</title>
  <link rel="stylesheet" href="styles.css">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>

<body class="dashboard-body">
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <span class="logo-badge">A</span>
      <div class="sidebar-logo-text">
        <span class="sidebar-logo-main">ALEX 3.0</span>
        <span class="sidebar-logo-sub">Panel del negocio</span>
      </div>
    </div>

    <nav class="sidebar-nav">
      <a href="dashboard.html" class="sidebar-link">üìä Dashboard</a>
      <a href="ventas.html" class="sidebar-link">üíµ Ventas</a>
      <a href="inventario.html" class="sidebar-link">üì¶ Inventario</a>
      <a href="caja.html" class="sidebar-link">üí∞ Caja</a>
      <a href="compras.html" class="sidebar-link">üßæ Compras</a>
      <a href="gastos.html" class="sidebar-link">üìâ Gastos</a>
      <a href="clientes.html" class="sidebar-link">üë• Clientes</a>
      <a href="proveedores.html" class="sidebar-link">üöö Proveedores</a>
      <a href="reportes.html" class="sidebar-link">üìö Reportes</a>
      <a href="ia.html" class="sidebar-link">ü§ñ IA empresarial</a>
      <a href="configuracion.html" class="sidebar-link active">‚öôÔ∏è Configuraci√≥n</a>
    </nav>

    <div class="sidebar-footer">
      <span class="sidebar-footer-title">Mi negocio</span>
      <span class="sidebar-footer-sub">Centro de control</span>
    </div>
  </aside>

  <!-- Layout principal -->
  <div class="main-layout">
    <!-- Topbar -->
    <header class="topbar">
      <button class="btn-menu-mobile" id="btnMenuMobile">‚ò∞</button>

      <div class="topbar-left">
        <h1 class="topbar-title">Configuraci√≥n del negocio</h1>
        <p class="topbar-subtitle">
          Define el tipo de negocio y c√≥mo funcionar√° ALEX 3.0 para este perfil.
        </p>
      </div>

      <div class="topbar-right">
        <span class="topbar-company" id="topbar-company-label">Mi negocio</span>
        <span class="topbar-divider">‚Ä¢</span>
        <span class="topbar-user" id="topbar-user-label">Usuario (Rol)</span>
      </div>
    </header>

    <!-- Contenido principal -->
    <main class="main-content">
      <!-- Perfil del negocio -->
      <section class="card">
        <h2 class="card-title">1. Perfil del negocio</h2>
        <p class="card-description">
          Esta configuraci√≥n se usa en todos los m√≥dulos (Inventario, Ventas, Caja, etc.)
          para que ALEX se adapte al tipo de negocio y no muestre cosas innecesarias.
        </p>

        <div class="form-grid">
          <div class="form-field" style="grid-column: 1 / -1;">
            <label for="negocioNombre">Nombre del negocio</label>
            <input id="negocioNombre" class="input" type="text"
                   placeholder="Ej: Tienda Brayan, Barber√≠a ALEX, Carnicer√≠a El Centro">
          </div>

          <div class="form-field" style="grid-column: 1 / -1;">
            <label for="negocioTipo">Tipo principal de negocio</label>
            <select id="negocioTipo" class="input">
              <option value="tienda">üõí Tienda / Abarroter√≠a</option>
              <option value="carniceria">ü•© Carnicer√≠a / Granel</option>
              <option value="servicios">üíá Sal√≥n / Barber√≠a / Servicios</option>
              <option value="restaurante">üçΩÔ∏è Restaurante / Cafeter√≠a</option>
              <option value="mixto">üß∞ Negocio mixto (varios tipos)</option>
            </select>
          </div>
        </div>
      </section>

      <!-- Comportamiento de inventario y ventas -->
      <section class="card">
        <h2 class="card-title">2. ¬øQu√© manejar√° ALEX en este negocio?</h2>
        <p class="card-description">
          Marca solo lo que este negocio realmente usa. ALEX ocultar√° campos innecesarios en
          Inventario y Ventas para que la pantalla no se vea cargada.
        </p>

        <div class="form-grid">
          <div class="form-field" style="grid-column: 1 / -1;">
            <label class="checkbox-label">
              <input type="checkbox" id="usaProductosUnidad">
              <span>Productos por unidad (ej: galletas, shampoos, celulares, gorras)</span>
            </label>
          </div>

          <div class="form-field" style="grid-column: 1 / -1;">
            <label class="checkbox-label">
              <input type="checkbox" id="usaPorPeso">
              <span>Productos por peso / granel (ej: carne por libra/kilo, frutas, verduras)</span>
            </label>
          </div>

          <div class="form-field" style="grid-column: 1 / -1;">
            <label class="checkbox-label">
              <input type="checkbox" id="usaServicios">
              <span>Servicios (ej: cortes de cabello, u√±as, dise√±o, mantenimiento, consultas)</span>
            </label>
          </div>
        </div>

        <div class="info-box" id="resumenPerfil" style="margin-top:0.75rem; font-size:0.9rem;">
          <!-- Aqu√≠ pinto un resumen amigable -->
        </div>

        <button class="btn" id="btnGuardarPerfil" style="margin-top:0.75rem;">
          Guardar configuraci√≥n del negocio
        </button>
      </section>

      <!-- Informaci√≥n -->
      <section class="card">
        <h2 class="card-title">3. ¬øC√≥mo usa esto ALEX 3.0?</h2>
        <p class="card-description">
          ALEX leer√° estos datos en cada m√≥dulo y se adaptar√°:
        </p>

        <ul class="bullet-list">
          <li><strong>Inventario</strong> solo mostrar√° los campos que correspondan (productos, servicios, por peso).</li>
          <li><strong>Ventas</strong> ajustar√° c√≥mo funciona el carrito (unidades, peso, servicios sin stock).</li>
          <li><strong>Dashboard y Caja</strong> podr√°n mostrar m√©tricas por tipo de negocio.</li>
        </ul>

        <p class="card-description">
          M√°s adelante, cuando te agregue m√≥dulos especiales (salones, carnicer√≠as, restaurantes),
          esta configuraci√≥n evitar√° que todo se vea junto y amontonado.
        </p>
      </section>
    </main>
  </div>

  <!-- Scripts base -->
  <script src="alex-storage.js"></script>
  <script src="alex-roles.js"></script>

  <script>
    // ===== Men√∫ m√≥vil =====
    const btnMenuMobile = document.getElementById('btnMenuMobile');
    const sidebar = document.querySelector('.sidebar');
    if (btnMenuMobile) {
      btnMenuMobile.addEventListener('click', () => {
        sidebar.classList.toggle('sidebar-open');
      });
    }

    // ===== Usuario y permisos =====
    const usuarioActual = typeof getUsuarioActualObligatorio === "function"
      ? getUsuarioActualObligatorio()
      : null;

    if (typeof aplicarPermisosYProteger === "function") {
      aplicarPermisosYProteger("configuracion");
    }

    const labelUser = document.getElementById("topbar-user-label");
    const labelCompany = document.getElementById("topbar-company-label");

    // ===== Cargar configuraci√≥n del negocio =====
    let negocioConfig = {
      nombre: "Mi negocio",
      tipo: "tienda",
      usaProductosUnidad: true,
      usaPorPeso: false,
      usaServicios: false
    };

    if (typeof load === "function") {
      const data = load("negocio_config", null);
      if (data && typeof data === "object") {
        negocioConfig = Object.assign(negocioConfig, data);
      }
    }

    const inpNombre = document.getElementById("negocioNombre");
    const selTipo = document.getElementById("negocioTipo");
    const chkUnidad = document.getElementById("usaProductosUnidad");
    const chkPeso = document.getElementById("usaPorPeso");
    const chkServicios = document.getElementById("usaServicios");
    const resumenPerfil = document.getElementById("resumenPerfil");
    const btnGuardarPerfil = document.getElementById("btnGuardarPerfil");

    function aplicarConfigEnUI() {
      if (inpNombre) inpNombre.value = negocioConfig.nombre || "";
      if (selTipo) selTipo.value = negocioConfig.tipo || "tienda";
      if (chkUnidad) chkUnidad.checked = !!negocioConfig.usaProductosUnidad;
      if (chkPeso) chkPeso.checked = !!negocioConfig.usaPorPeso;
      if (chkServicios) chkServicios.checked = !!negocioConfig.usaServicios;

      if (labelCompany) {
        labelCompany.textContent = negocioConfig.nombre || "Mi negocio";
      }

      if (usuarioActual && labelUser) {
        const rolTexto = usuarioActual.rol === "dueno" ? "Due√±o" : "Empleado";
        labelUser.textContent = `${usuarioActual.nombre} (${rolTexto})`;
      }

      pintarResumenPerfil();
    }

    function pintarResumenPerfil() {
      if (!resumenPerfil) return;

      const partes = [];
      partes.push(`Tipo de negocio: <strong>${textoTipoNegocio(negocioConfig.tipo)}</strong>`);

      const cosas = [];
      if (negocioConfig.usaProductosUnidad) cosas.push("productos por unidad");
      if (negocioConfig.usaPorPeso) cosas.push("productos por peso/granel");
      if (negocioConfig.usaServicios) cosas.push("servicios");

      let detalle = "";
      if (cosas.length === 0) {
        detalle = "No has marcado qu√© maneja este negocio. Te recomiendo seleccionar al menos una opci√≥n.";
      } else {
        detalle = "ALEX manejar√°: <strong>" + cosas.join(", ") + "</strong>.";
      }

      resumenPerfil.innerHTML = `
        <p>${partes.join(" ‚Ä¢ ")}</p>
        <p>${detalle}</p>
      `;
    }

    function textoTipoNegocio(tipo) {
      switch (tipo) {
        case "tienda": return "Tienda / Abarroter√≠a";
        case "carniceria": return "Carnicer√≠a / Granel";
        case "servicios": return "Sal√≥n / Barber√≠a / Servicios";
        case "restaurante": return "Restaurante / Cafeter√≠a";
        case "mixto": return "Negocio mixto";
        default: return "No definido";
      }
    }

    function guardarPerfilNegocio() {
      const nombre = inpNombre ? inpNombre.value.trim() : "";
      const tipo = selTipo ? selTipo.value : "tienda";
      const usaUnidad = chkUnidad ? chkUnidad.checked : false;
      const usaPeso = chkPeso ? chkPeso.checked : false;
      const usaServ = chkServicios ? chkServicios.checked : false;

      if (!nombre) {
        alert("Escribe un nombre para el negocio.");
        if (inpNombre) inpNombre.focus();
        return;
      }

      if (!usaUnidad && !usaPeso && !usaServ) {
        const continuar = confirm(
          "No marcaste ninguna opci√≥n (productos, peso, servicios). " +
          "¬øSeguro que quieres guardar as√≠? ALEX usar√° el perfil, pero algunos m√≥dulos podr√≠an no tener sentido."
        );
        if (!continuar) return;
      }

      negocioConfig = {
        nombre,
        tipo,
        usaProductosUnidad: usaUnidad,
        usaPorPeso: usaPeso,
        usaServicios: usaServ
      };

      if (typeof save === "function") {
        save("negocio_config", negocioConfig);
      }

      aplicarConfigEnUI();
      alert("Configuraci√≥n del negocio guardada correctamente.");
    }

    if (btnGuardarPerfil) {
      btnGuardarPerfil.addEventListener("click", guardarPerfilNegocio);
    }

    // Si el usuario cambia el tipo de negocio, podemos sugerir toggles
    if (selTipo) {
      selTipo.addEventListener("change", () => {
        const tipo = selTipo.value;
        // Sugerencias por defecto (el usuario puede cambiar luego)
        if (tipo === "tienda") {
          chkUnidad.checked = true;
          chkPeso.checked = false;
          chkServicios.checked = false;
        } else if (tipo === "carniceria") {
          chkUnidad.checked = false;
          chkPeso.checked = true;
          chkServicios.checked = false;
        } else if (tipo === "servicios") {
          chkUnidad.checked = false;
          chkPeso.checked = false;
          chkServicios.checked = true;
        } else if (tipo === "restaurante") {
          chkUnidad.checked = true;
          chkPeso.checked = true;
          chkServicios.checked = false;
        } else if (tipo === "mixto") {
          chkUnidad.checked = true;
          chkPeso.checked = true;
          chkServicios.checked = true;
        }
        negocioConfig.tipo = tipo;
        negocioConfig.usaProductosUnidad = chkUnidad.checked;
        negocioConfig.usaPorPeso = chkPeso.checked;
        negocioConfig.usaServicios = chkServicios.checked;
        pintarResumenPerfil();
      });
    }

    if (chkUnidad || chkPeso || chkServicios) {
      [chkUnidad, chkPeso, chkServicios].forEach(chk => {
        if (!chk) return;
        chk.addEventListener("change", () => {
          negocioConfig.usaProductosUnidad = chkUnidad ? chkUnidad.checked : false;
          negocioConfig.usaPorPeso = chkPeso ? chkPeso.checked : false;
          negocioConfig.usaServicios = chkServicios ? chkServicios.checked : false;
          pintarResumenPerfil();
        });
      });
    }

    // ===== Primera carga =====
    aplicarConfigEnUI();
  </script>
</body>
</html>
