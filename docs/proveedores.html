<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>ALEX 3.0 - Proveedores</title>
  <link rel="stylesheet" href="styles.css">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>

<body class="dashboard-body">
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <span class="logo-badge">A</span>
      <div class="sidebar-logo-text">
        <span class="sidebar-logo-main">ALEX 3.0</span>
        <span class="sidebar-logo-sub">Panel del negocio</span>
      </div>
    </div>

    <nav class="sidebar-nav">
      <a href="dashboard.html" class="sidebar-link">üìä Dashboard</a>
      <a href="ventas.html" class="sidebar-link">üíµ Ventas</a>
      <a href="inventario.html" class="sidebar-link">üì¶ Inventario</a>
      <a href="caja.html" class="sidebar-link">üí∞ Caja</a>
      <a href="compras.html" class="sidebar-link">üßæ Compras</a>
      <a href="gastos.html" class="sidebar-link">üìâ Gastos</a>
      <a href="clientes.html" class="sidebar-link">üë• Clientes</a>
      <a href="proveedores.html" class="sidebar-link active">üöö Proveedores</a>
      <a href="reportes.html" class="sidebar-link">üìö Reportes</a>
      <a href="ia.html" class="sidebar-link">ü§ñ IA empresarial</a>
      <a href="configuracion.html" class="sidebar-link">‚öôÔ∏è Configuraci√≥n</a>
    </nav>

    <div class="sidebar-footer">
      <span class="sidebar-footer-title" id="sidebar-footer-title">Mi negocio</span>
      <span class="sidebar-footer-sub">M√≥dulo de proveedores</span>
    </div>
  </aside>

  <!-- Layout principal -->
  <div class="main-layout">
    <!-- Topbar -->
    <header class="topbar">
      <button class="btn-menu-mobile" id="btnMenuMobile">‚ò∞</button>

      <div class="topbar-left">
        <h1 class="topbar-title">Proveedores</h1>
        <p class="topbar-subtitle">
          Registra y administra los proveedores a los que compras mercader√≠a o servicios.
          Luego se usar√°n en el m√≥dulo de Compras.
        </p>
      </div>

      <div class="topbar-right">
        <span class="topbar-company" id="topbar-company-label">Mi negocio</span>
        <span class="topbar-divider">‚Ä¢</span>
        <span class="topbar-user" id="topbar-user-label">Usuario (Rol)</span>
      </div>
    </header>

    <!-- Contenido principal -->
    <main class="main-content">
      <!-- Formulario -->
      <section class="card">
        <h2 class="card-title">Agregar proveedor</h2>
        <p class="card-description">
          Guarda los datos del proveedor para usarlo al registrar compras y llevar control
          de a qui√©n le compras.
        </p>

        <div class="form-grid">
          <div class="form-field">
            <label for="prNombre">Nombre / contacto principal</label>
            <input id="prNombre" class="input" type="text"
                   placeholder="Ej: Carlos L√≥pez, Distribuidora El Centro, etc.">
          </div>

          <div class="form-field">
            <label for="prEmpresa">Nombre de la empresa (opcional)</label>
            <input id="prEmpresa" class="input" type="text"
                   placeholder="Ej: Importadora XYZ, Mayorista ABC">
          </div>

          <div class="form-field">
            <label for="prTelefono">Tel√©fono / WhatsApp</label>
            <input id="prTelefono" class="input" type="tel"
                   placeholder="Ej: 5555-5555">
          </div>

          <div class="form-field">
            <label for="prCorreo">Correo (opcional)</label>
            <input id="prCorreo" class="input" type="email"
                   placeholder="Ej: proveedor@empresa.com">
          </div>

          <div class="form-field">
            <label for="prTipo">Tipo de proveedor</label>
            <select id="prTipo" class="input">
              <option value="local">Local / nacional</option>
              <option value="importador">Importador</option>
              <option value="servicios">Servicios</option>
              <option value="otro">Otro</option>
            </select>
          </div>

          <div class="form-field">
            <label for="prDireccion">Direcci√≥n (opcional)</label>
            <input id="prDireccion" class="input" type="text"
                   placeholder="Ej: zona, ciudad, referencia, etc.">
          </div>

          <div class="form-field" style="grid-column:1 / -1;">
            <label for="prNotas">Notas (opcional)</label>
            <input id="prNotas" class="input" type="text"
                   placeholder="Ej: d√≠a de cr√©dito, condiciones de pago, productos que le compras, etc.">
          </div>
        </div>

        <button class="btn" id="btnGuardarProveedor" style="margin-top:0.75rem;">
          Guardar proveedor
        </button>
      </section>

      <!-- Listado -->
      <section class="card">
        <h2 class="card-title">Lista de proveedores</h2>
        <p class="card-description">
          Estos proveedores podr√°n seleccionarse desde el m√≥dulo de Compras para registrar entradas de inventario.
        </p>

        <div class="form-grid" style="margin-bottom:0.75rem;">
          <div class="form-field" style="grid-column:1 / -1;">
            <label for="buscarProveedor">Buscar proveedor</label>
            <input id="buscarProveedor" class="input" type="text"
                   placeholder="Filtra por nombre, empresa, tel√©fono, tipo o notas">
          </div>
        </div>

        <table class="table">
          <thead>
            <tr>
              <th>Nombre / contacto</th>
              <th>Empresa</th>
              <th>Tel√©fono</th>
              <th>Tipo</th>
              <th>Notas</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="tabla-proveedores-body">
            <tr>
              <td colspan="6" class="table-empty">
                A√∫n no hay proveedores registrados.
              </td>
            </tr>
          </tbody>
        </table>
      </section>
    </main>
  </div>

  <!-- Scripts base -->
  <script src="alex-storage.js"></script>
  <script src="alex-roles.js"></script>

  <script>
    // ===== Men√∫ m√≥vil =====
    const btnMenuMobile = document.getElementById('btnMenuMobile');
    const sidebar = document.querySelector('.sidebar');
    if (btnMenuMobile) {
      btnMenuMobile.addEventListener('click', () => {
        sidebar.classList.toggle('sidebar-open');
      });
    }

    // ===== Usuario, permisos y negocio =====
    const usuarioActual = typeof getUsuarioActualObligatorio === "function"
      ? getUsuarioActualObligatorio()
      : null;

    if (typeof aplicarPermisosYProteger === "function") {
      aplicarPermisosYProteger("proveedores");
    }

    const labelUser = document.getElementById("topbar-user-label");
    const labelCompany = document.getElementById("topbar-company-label");
    const sidebarFooterTitle = document.getElementById("sidebar-footer-title");

    let negocioConfig = {
      nombre: "Mi negocio"
    };

    if (typeof load === "function") {
      const cfg = load("negocio_config", null);
      if (cfg && typeof cfg === "object") {
        negocioConfig = Object.assign(negocioConfig, cfg);
      }
    }

    if (labelCompany) labelCompany.textContent = negocioConfig.nombre || "Mi negocio";
    if (sidebarFooterTitle) sidebarFooterTitle.textContent = negocioConfig.nombre || "Mi negocio";

    if (usuarioActual && labelUser) {
      const rolTexto = usuarioActual.rol === "dueno" ? "Due√±o" : "Empleado";
      labelUser.textContent = `${usuarioActual.nombre} (${rolTexto})`;
    }

    // ===== Storage proveedores =====
    let proveedores = [];
    if (typeof load === "function") {
      const data = load("proveedores", []);
      proveedores = Array.isArray(data) ? data : [];
    }

    function guardarProveedores() {
      if (typeof save === "function") {
        save("proveedores", proveedores);
      }
    }

    // ===== DOM =====
    const inpNombre = document.getElementById("prNombre");
    const inpEmpresa = document.getElementById("prEmpresa");
    const inpTelefono = document.getElementById("prTelefono");
    const inpCorreo = document.getElementById("prCorreo");
    const selTipo = document.getElementById("prTipo");
    const inpDireccion = document.getElementById("prDireccion");
    const inpNotas = document.getElementById("prNotas");
    const btnGuardarProveedor = document.getElementById("btnGuardarProveedor");
    const inpBuscar = document.getElementById("buscarProveedor");
    const tbodyProveedores = document.getElementById("tabla-proveedores-body");

    // ===== Render tabla =====
    function renderProveedores() {
      if (!tbodyProveedores) return;

      const filtro = inpBuscar ? inpBuscar.value.trim().toLowerCase() : "";
      tbodyProveedores.innerHTML = "";

      if (!proveedores.length) {
        tbodyProveedores.innerHTML = `
          <tr>
            <td colspan="6" class="table-empty">
              A√∫n no hay proveedores registrados.
            </td>
          </tr>
        `;
        return;
      }

      const filtrados = filtro
        ? proveedores.filter(p => {
            const txt = [
              p.nombre || "",
              p.empresa || "",
              p.telefono || "",
              p.correo || "",
              p.tipo || "",
              p.direccion || "",
              p.notas || ""
            ].join(" ").toLowerCase();
            return txt.includes(filtro);
          })
        : proveedores;

      if (!filtrados.length) {
        tbodyProveedores.innerHTML = `
          <tr>
            <td colspan="6" class="table-empty">
              No se encontraron proveedores con ese texto.
            </td>
          </tr>
        `;
        return;
      }

      filtrados.forEach((p, index) => {
        let tipoTxt = "Otro";
        if (p.tipo === "local") tipoTxt = "Local / nacional";
        else if (p.tipo === "importador") tipoTxt = "Importador";
        else if (p.tipo === "servicios") tipoTxt = "Servicios";

        tbodyProveedores.innerHTML += `
          <tr>
            <td>${p.nombre || "-"}</td>
            <td>${p.empresa || "-"}</td>
            <td>${p.telefono || "-"}</td>
            <td>${tipoTxt}</td>
            <td>${p.notas || "-"}</td>
            <td>
              <button class="btn btn-small" data-index="${index}" data-action="eliminar">üóëÔ∏è</button>
            </td>
          </tr>
        `;
      });
    }

    // ===== Guardar proveedor =====
    function guardarProveedor() {
      const nombre = inpNombre ? inpNombre.value.trim() : "";
      const empresa = inpEmpresa ? inpEmpresa.value.trim() : "";
      const telefono = inpTelefono ? inpTelefono.value.trim() : "";
      const correo = inpCorreo ? inpCorreo.value.trim() : "";
      const tipo = selTipo ? selTipo.value : "local";
      const direccion = inpDireccion ? inpDireccion.value.trim() : "";
      const notas = inpNotas ? inpNotas.value.trim() : "";

      if (!nombre && !empresa) {
        alert("Escribe al menos el nombre del contacto o el nombre de la empresa.");
        return;
      }

      const mostrarNombre = nombre || empresa;

      const nuevo = {
        id: "proveedor_" + Date.now(),
        nombre: mostrarNombre,
        empresa,
        telefono,
        correo,
        tipo,
        direccion,
        notas
      };

      proveedores.push(nuevo);
      guardarProveedores();

      if (inpNombre) inpNombre.value = "";
      if (inpEmpresa) inpEmpresa.value = "";
      if (inpTelefono) inpTelefono.value = "";
      if (inpCorreo) inpCorreo.value = "";
      if (inpDireccion) inpDireccion.value = "";
      if (inpNotas) inpNotas.value = "";
      if (selTipo) selTipo.value = "local";

      renderProveedores();
      alert("Proveedor guardado correctamente.");
    }

    if (btnGuardarProveedor) {
      btnGuardarProveedor.addEventListener("click", guardarProveedor);
    }

    // Enter en algunos campos -> guardar
    [inpNombre, inpEmpresa, inpTelefono].forEach(inp => {
      if (inp) {
        inp.addEventListener("keydown", (e) => {
          if (e.key === "Enter") {
            e.preventDefault();
            guardarProveedor();
          }
        });
      }
    });

    // Buscar
    if (inpBuscar) {
      inpBuscar.addEventListener("input", renderProveedores);
    }

    // Eliminar
    if (tbodyProveedores) {
      tbodyProveedores.addEventListener("click", (e) => {
        const btn = e.target.closest("button[data-index][data-action]");
        if (!btn) return;
        const idx = parseInt(btn.getAttribute("data-index"));
        const action = btn.getAttribute("data-action");
        if (isNaN(idx) || !proveedores[idx]) return;

        if (action === "eliminar") {
          const p = proveedores[idx];
          const confirmar = confirm(`¬øEliminar al proveedor "${p.nombre}"? (No lo quitar√° de compras pasadas).`);
          if (!confirmar) return;
          proveedores.splice(idx, 1);
          guardarProveedores();
          renderProveedores();
        }
      });
    }

    // ===== Primera carga =====
    renderProveedores();
  </script>
</body>
</html>
