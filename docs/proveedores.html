<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>ALEX 3.0 - Proveedores</title>
  <link rel="stylesheet" href="styles.css">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>

<body class="dashboard-body">
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <span class="logo-badge">A</span>
      <div class="sidebar-logo-text">
        <span class="sidebar-logo-main">ALEX 3.0</span>
        <span class="sidebar-logo-sub">Panel del negocio</span>
      </div>
    </div>

    <nav class="sidebar-nav">
      <a href="dashboard.html" class="sidebar-link">üìä Dashboard</a>
      <a href="ventas.html" class="sidebar-link">üíµ Ventas</a>
      <a href="inventario.html" class="sidebar-link">üì¶ Inventario</a>
      <a href="caja.html" class="sidebar-link">üí∞ Caja</a>
      <a href="compras.html" class="sidebar-link">üßæ Compras</a>
      <a href="gastos.html" class="sidebar-link">üìâ Gastos</a>
      <a href="clientes.html" class="sidebar-link">üë• Clientes</a>
      <a href="proveedores.html" class="sidebar-link active">üöö Proveedores</a>
      <a href="contabilidad.html" class="sidebar-link">üìö Contabilidad</a>
      <a href="sat.html" class="sidebar-link">üá¨üáπ SAT Guatemala</a>
      <a href="ia.html" class="sidebar-link">ü§ñ IA empresarial</a>
      <a href="configuracion.html" class="sidebar-link">‚öôÔ∏è Configuraci√≥n</a>
    </nav>

    <div class="sidebar-footer">
      <span class="sidebar-footer-title">Mi negocio</span>
      <span class="sidebar-footer-sub">Gesti√≥n de proveedores</span>
    </div>
  </aside>

  <!-- Layout principal -->
  <div class="main-layout">
    <!-- Topbar -->
    <header class="topbar">
      <button class="btn-menu-mobile" id="btnMenuMobile">‚ò∞</button>

      <div class="topbar-left">
        <h1 class="topbar-title">Proveedores</h1>
        <p class="topbar-subtitle">
          Registra y administra tus proveedores para compras e inventario.
        </p>
      </div>

      <div class="topbar-right">
        <span class="topbar-company">Mi negocio</span>
        <span class="topbar-divider">‚Ä¢</span>
        <span class="topbar-user" id="topbar-user-label">Usuario (Rol)</span>
      </div>
    </header>

    <!-- Contenido principal -->
    <main class="main-content">
      <!-- KPIs de proveedores -->
      <section class="cards-grid">
        <article class="card kpi-card">
          <h2 class="card-title">Proveedores totales</h2>
          <p class="card-kpi" id="kpi-prov-total">0</p>
          <p class="card-kpi-sub">Cantidad de proveedores registrados.</p>
        </article>

        <article class="card kpi-card">
          <h2 class="card-title">Mayoristas / importadores</h2>
          <p class="card-kpi" id="kpi-prov-mayoristas">0</p>
          <p class="card-kpi-sub">Mayorista, fabricante o importador.</p>
        </article>

        <article class="card kpi-card">
          <h2 class="card-title">Locales / minoristas</h2>
          <p class="card-kpi" id="kpi-prov-locales">0</p>
          <p class="card-kpi-sub">Proveedores locales o peque√±os.</p>
        </article>

        <article class="card kpi-card">
          <h2 class="card-title">√öltimo proveedor agregado</h2>
          <p class="card-kpi" id="kpi-prov-ultimo">-</p>
          <p class="card-kpi-sub">Nombre del √∫ltimo registro.</p>
        </article>
      </section>

      <!-- Formulario de nuevo proveedor -->
      <section class="card">
        <h2 class="card-title">1. Registrar nuevo proveedor</h2>
        <p class="card-description">
          Guarda los datos b√°sicos para usarlos luego en el m√≥dulo de compras y control de pagos.
        </p>

        <div class="form-grid">
          <div class="form-field">
            <label for="pNombre">Nombre comercial / empresa</label>
            <input id="pNombre" class="input" type="text"
                   placeholder="Ej: Mayorista Centro, Perfumes GT, Proveedor China">
          </div>

          <div class="form-field">
            <label for="pContacto">Persona de contacto</label>
            <input id="pContacto" class="input" type="text"
                   placeholder="Ej: Carlos L√≥pez">
          </div>

          <div class="form-field">
            <label for="pTelefono">Tel√©fono / WhatsApp</label>
            <input id="pTelefono" class="input" type="tel"
                   placeholder="Ej: 5555-5555">
          </div>

          <div class="form-field">
            <label for="pEmail">Correo electr√≥nico</label>
            <input id="pEmail" class="input" type="email"
                   placeholder="Ej: proveedor@ejemplo.com">
          </div>

          <div class="form-field">
            <label for="pNit">NIT / ID</label>
            <input id="pNit" class="input" type="text"
                   placeholder="Ej: 1234567-8, extranjero, etc.">
          </div>

          <div class="form-field">
            <label for="pTipo">Tipo de proveedor</label>
            <select id="pTipo" class="input">
              <option value="mayorista">Mayorista</option>
              <option value="fabricante">Fabricante</option>
              <option value="importador">Importador</option>
              <option value="local">Local / minorista</option>
            </select>
          </div>

          <div class="form-field">
            <label for="pCondicionesPago">Condiciones de pago</label>
            <select id="pCondicionesPago" class="input">
              <option value="contado">Contado</option>
              <option value="credito_8_dias">Cr√©dito 8 d√≠as</option>
              <option value="credito_15_dias">Cr√©dito 15 d√≠as</option>
              <option value="credito_30_dias">Cr√©dito 30 d√≠as</option>
              <option value="otros">Otros</option>
            </select>
          </div>

          <div class="form-field" id="campoCondicionesDetalle" style="grid-column: 1 / -1; display: none;">
            <label for="pCondicionesDetalle">Detalle de condiciones (opcional)</label>
            <input id="pCondicionesDetalle" class="input" type="text"
                   placeholder="Ej: Paga 50% anticipo, resto contra entrega">
          </div>

          <div class="form-field" style="grid-column: 1 / -1;">
            <label for="pDireccion">Direcci√≥n</label>
            <input id="pDireccion" class="input" type="text"
                   placeholder="Ej: Bodega en zona 9, local en centro comercial, etc.">
          </div>

          <div class="form-field" style="grid-column: 1 / -1;">
            <label for="pNotas">Notas (opcional)</label>
            <input id="pNotas" class="input" type="text"
                   placeholder="Ej: Env√≠os por carga, da descuento por volumen, horarios, etc.">
          </div>
        </div>

        <button class="btn" id="btnGuardarProveedor" style="margin-top: 0.75rem;">
          Guardar proveedor
        </button>
      </section>

      <!-- Buscador y lista de proveedores -->
      <section class="card">
        <h2 class="card-title">2. Lista de proveedores</h2>
        <p class="card-description">
          Busca por nombre, contacto, tel√©fono, correo o NIT. Los m√°s recientes aparecen primero.
        </p>

        <div class="form-grid" style="margin-bottom: 0.75rem;">
          <div class="form-field" style="grid-column: 1 / -1;">
            <label for="buscarProveedor">Buscar proveedor</label>
            <input id="buscarProveedor" class="input" type="text"
                   placeholder="Escribe parte del nombre, contacto, tel√©fono, correo o NIT">
          </div>
        </div>

        <table class="table">
          <thead>
            <tr>
              <th>Nombre</th>
              <th>Contacto</th>
              <th>Tel√©fono</th>
              <th>Tipo</th>
              <th>Condiciones</th>
              <th>Creado</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="tabla-proveedores-body">
            <tr>
              <td colspan="7" class="table-empty">
                A√∫n no hay proveedores registrados.
              </td>
            </tr>
          </tbody>
        </table>
      </section>
    </main>
  </div>

  <!-- Scripts base -->
  <script src="alex-storage.js"></script>
  <script src="alex-roles.js"></script>

  <script>
    // ===== Men√∫ m√≥vil =====
    const btnMenuMobile = document.getElementById('btnMenuMobile');
    const sidebar = document.querySelector('.sidebar');
    if (btnMenuMobile) {
      btnMenuMobile.addEventListener('click', () => {
        sidebar.classList.toggle('sidebar-open');
      });
    }

    // ===== Usuario y permisos =====
    const usuarioActual = typeof getUsuarioActualObligatorio === "function"
      ? getUsuarioActualObligatorio()
      : null;

    if (typeof aplicarPermisosYProteger === "function") {
      aplicarPermisosYProteger("proveedores");
    }

    const labelUser = document.getElementById("topbar-user-label");
    if (usuarioActual && labelUser) {
      const rolTexto = usuarioActual.rol === "dueno" ? "Due√±o" : "Empleado";
      labelUser.textContent = `${usuarioActual.nombre} (${rolTexto})`;
    }

    // ===== Helpers =====
    function formatearFechaLocal(fechaIso) {
      const d = new Date(fechaIso);
      if (isNaN(d.getTime())) return "-";
      return d.toLocaleString("es-GT");
    }

    function tipoProveedorLegible(tipo) {
      switch (tipo) {
        case "mayorista": return "Mayorista";
        case "fabricante": return "Fabricante";
        case "importador": return "Importador";
        case "local": return "Local";
        default: return tipo || "-";
      }
    }

    function condicionesLegibles(cond) {
      switch (cond) {
        case "contado": return "Contado";
        case "credito_8_dias": return "Cr√©dito 8 d√≠as";
        case "credito_15_dias": return "Cr√©dito 15 d√≠as";
        case "credito_30_dias": return "Cr√©dito 30 d√≠as";
        case "otros": return "Otros";
        default: return cond || "-";
      }
    }

    // ===== Datos base: proveedores =====
    let proveedores = [];
    if (typeof load === "function") {
      const pData = load("proveedores", []);
      proveedores = Array.isArray(pData) ? pData : [];
    }

    function guardarProveedores() {
      if (typeof save === "function") {
        save("proveedores", proveedores);
      }
    }

    // ===== KPIs de proveedores =====
    function recalcularKPIsProveedores() {
      const total = proveedores.length;
      const mayoristas = proveedores.filter(p =>
        p.tipo === "mayorista" || p.tipo === "fabricante" || p.tipo === "importador"
      ).length;
      const locales = proveedores.filter(p => p.tipo === "local").length;

      const kpiTotal = document.getElementById("kpi-prov-total");
      const kpiMayoristas = document.getElementById("kpi-prov-mayoristas");
      const kpiLocales = document.getElementById("kpi-prov-locales");
      const kpiUltimo = document.getElementById("kpi-prov-ultimo");

      if (kpiTotal) kpiTotal.textContent = String(total);
      if (kpiMayoristas) kpiMayoristas.textContent = String(mayoristas);
      if (kpiLocales) kpiLocales.textContent = String(locales);

      if (kpiUltimo) {
        if (!proveedores.length) {
          kpiUltimo.textContent = "-";
        } else {
          const ultimo = proveedores[proveedores.length - 1];
          kpiUltimo.textContent = ultimo.nombre || "-";
        }
      }
    }

    // ===== Renderizar tabla de proveedores =====
    const tbodyProveedores = document.getElementById("tabla-proveedores-body");
    const inputBuscarProveedor = document.getElementById("buscarProveedor");

    function renderProveedores() {
      if (!tbodyProveedores) return;

      const filtro = (inputBuscarProveedor && inputBuscarProveedor.value.trim().toLowerCase()) || "";

      tbodyProveedores.innerHTML = "";

      if (!proveedores.length) {
        tbodyProveedores.innerHTML = `
          <tr>
            <td colspan="7" class="table-empty">
              A√∫n no hay proveedores registrados.
            </td>
          </tr>
        `;
        recalcularKPIsProveedores();
        return;
      }

      const ordenados = [...proveedores].sort((a, b) => {
        const fa = new Date(a.creadoEnIso || a.creadoEn || 0).getTime();
        const fb = new Date(b.creadoEnIso || b.creadoEn || 0).getTime();
        return fb - fa; // m√°s recientes primero
      });

      const filtrados = filtro
        ? ordenados.filter(p => {
            const texto = [
              p.nombre || "",
              p.contacto || "",
              p.telefono || "",
              p.email || "",
              p.nit || ""
            ].join(" ").toLowerCase();
            return texto.includes(filtro);
          })
        : ordenados;

      if (!filtrados.length) {
        tbodyProveedores.innerHTML = `
          <tr>
            <td colspan="7" class="table-empty">
              No se encontraron proveedores con ese texto.
            </td>
          </tr>
        `;
        recalcularKPIsProveedores();
        return;
      }

      filtrados.forEach((p, index) => {
        const tipo = tipoProveedorLegible(p.tipo);
        const cond = condicionesLegibles(p.condicionesPago);
        const detalleCond = p.condicionesDetalle ? (" - " + p.condicionesDetalle) : "";
        const fechaCreado = p.creadoEn || (p.creadoEnIso ? formatearFechaLocal(p.creadoEnIso) : "-");

        tbodyProveedores.innerHTML += `
          <tr>
            <td>${p.nombre || "-"}</td>
            <td>${p.contacto || "-"}</td>
            <td>${p.telefono || "-"}</td>
            <td>${tipo}</td>
            <td>${cond}${detalleCond}</td>
            <td>${fechaCreado}</td>
            <td>
              <button class="btn btn-small" data-delete-index="${index}">üóëÔ∏è</button>
            </td>
          </tr>
        `;
      });

      recalcularKPIsProveedores();
    }

    // ===== Mostrar detalle de condiciones seg√∫n selecci√≥n =====
    const selectCondicionesPago = document.getElementById("pCondicionesPago");
    const campoCondicionesDetalle = document.getElementById("campoCondicionesDetalle");
    const inpCondicionesDetalle = document.getElementById("pCondicionesDetalle");

    if (selectCondicionesPago && campoCondicionesDetalle) {
      selectCondicionesPago.addEventListener("change", () => {
        if (selectCondicionesPago.value === "otros") {
          campoCondicionesDetalle.style.display = "block";
        } else {
          campoCondicionesDetalle.style.display = "none";
          if (inpCondicionesDetalle) inpCondicionesDetalle.value = "";
        }
      });
    }

    // ===== Guardar nuevo proveedor =====
    const inpNombre = document.getElementById("pNombre");
    const inpContacto = document.getElementById("pContacto");
    const inpTelefono = document.getElementById("pTelefono");
    const inpEmail = document.getElementById("pEmail");
    const inpNit = document.getElementById("pNit");
    const inpTipo = document.getElementById("pTipo");
    const inpCondicionesPago = document.getElementById("pCondicionesPago");
    const inpDireccion = document.getElementById("pDireccion");
    const inpNotas = document.getElementById("pNotas");
    const btnGuardarProveedor = document.getElementById("btnGuardarProveedor");

    function guardarProveedor() {
      const nombre = (inpNombre.value || "").trim();
      const contacto = (inpContacto.value || "").trim();
      const telefono = (inpTelefono.value || "").trim();
      const email = (inpEmail.value || "").trim();
      const nit = (inpNit.value || "").trim();
      const tipo = inpTipo.value || "mayorista";
      const condicionesPago = inpCondicionesPago.value || "contado";
      const condicionesDetalle = (inpCondicionesDetalle && inpCondicionesDetalle.value.trim()) || "";
      const direccion = (inpDireccion.value || "").trim();
      const notas = (inpNotas.value || "").trim();

      if (!nombre) {
        alert("Escribe el nombre comercial del proveedor.");
        return;
      }

      // Validaciones suaves
      if (telefono && telefono.length < 6) {
        if (!confirm("El tel√©fono parece muy corto, ¬øseguro que es correcto?")) {
          return;
        }
      }

      const ahora = new Date();
      const creadoEnIso = ahora.toISOString();
      const creadoEn = ahora.toLocaleString("es-GT");

      const nuevo = {
        id: "proveedor_" + Date.now(),
        nombre,
        contacto,
        telefono,
        email,
        nit,
        tipo,
        condicionesPago,
        condicionesDetalle,
        direccion,
        notas,
        creadoEn,
        creadoEnIso,
        usuarioCreador: usuarioActual ? usuarioActual.usuario : null
      };

      proveedores.push(nuevo);
      guardarProveedores();

      // Limpiar formulario
      inpNombre.value = "";
      inpContacto.value = "";
      inpTelefono.value = "";
      inpEmail.value = "";
      inpNit.value = "";
      inpTipo.value = "mayorista";
      inpCondicionesPago.value = "contado";
      if (campoCondicionesDetalle) campoCondicionesDetalle.style.display = "none";
      if (inpCondicionesDetalle) inpCondicionesDetalle.value = "";
      inpDireccion.value = "";
      inpNotas.value = "";
      inpNombre.focus();

      renderProveedores();
      alert("Proveedor guardado correctamente.");
    }

    if (btnGuardarProveedor) {
      btnGuardarProveedor.addEventListener("click", guardarProveedor);
    }

    // Enter en NIT ‚Üí guardar
    if (inpNit) {
      inpNit.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          guardarProveedor();
        }
      });
    }

    // Buscar mientras se escribe
    if (inputBuscarProveedor) {
      inputBuscarProveedor.addEventListener("input", () => {
        renderProveedores();
      });
    }

    // Eliminar proveedor
    if (tbodyProveedores) {
      tbodyProveedores.addEventListener("click", (e) => {
        const btn = e.target.closest("button[data-delete-index]");
        if (!btn) return;
        const idx = parseInt(btn.getAttribute("data-delete-index"));
        if (isNaN(idx)) return;

        if (!confirm("¬øSeguro que quieres eliminar este proveedor?")) return;
        proveedores.splice(idx, 1);
        guardarProveedores();
        renderProveedores();
      });
    }

    // ===== Primera carga =====
    renderProveedores();
  </script>
</body>
</html>
