<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>ALEX 3.0 - Proveedores</title>
  <link rel="stylesheet" href="styles.css">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>

<body class="dashboard-body">
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <span class="logo-badge">A</span>
      <div class="sidebar-logo-text">
        <span class="sidebar-logo-main">ALEX 3.0</span>
        <span class="sidebar-logo-sub">Panel del negocio</span>
      </div>
    </div>

    <nav class="sidebar-nav">
      <a href="dashboard.html" class="sidebar-link">üìä Dashboard</a>
      <a href="ventas.html" class="sidebar-link">üíµ Ventas</a>
      <a href="inventario.html" class="sidebar-link">üì¶ Inventario</a>
      <a href="caja.html" class="sidebar-link">üí∞ Caja</a>
      <a href="compras.html" class="sidebar-link">üßæ Compras</a>
      <a href="gastos.html" class="sidebar-link">üìâ Gastos</a>
      <a href="clientes.html" class="sidebar-link">üë• Clientes</a>
      <a href="proveedores.html" class="sidebar-link active">üöö Proveedores</a>
      <a href="contabilidad.html" class="sidebar-link">üìö Contabilidad</a>
      <a href="sat.html" class="sidebar-link">üá¨üáπ SAT Guatemala</a>
      <a href="ia.html" class="sidebar-link">ü§ñ IA empresarial</a>
      <a href="configuracion.html" class="sidebar-link">‚öôÔ∏è Configuraci√≥n</a>
    </nav>

    <div class="sidebar-footer">
      <span class="sidebar-footer-title">Empresa demo</span>
      <span class="sidebar-footer-sub">Versi√≥n 1.0</span>
    </div>
  </aside>

  <!-- Layout principal -->
  <div class="main-layout">
    <!-- Topbar -->
    <header class="topbar">
      <button class="btn-menu-mobile" id="btnMenuMobile">‚ò∞</button>

      <div class="topbar-left">
        <h1 class="topbar-title">Proveedores del negocio</h1>
        <p class="topbar-subtitle">
          Registra a tus proveedores de mercanc√≠a, insumos y servicios para vincularlos con las compras.
        </p>
      </div>

      <div class="topbar-right">
        <span class="topbar-company">Mi tienda demo</span>
        <span class="topbar-divider">‚Ä¢</span>
        <span class="topbar-user" id="topbar-user-label">Usuario (Rol)</span>
        <button class="btn" id="btnLogout" type="button" style="margin-left: 0.75rem;">
          Cerrar sesi√≥n
        </button>
      </div>
    </header>

    <!-- Contenido principal -->
    <main class="main-content">
      <!-- Formulario alta proveedor -->
      <section class="card">
        <h2 class="card-title">Registrar nuevo proveedor</h2>
        <p class="card-description">
          Guarda tus proveedores principales para poder relacionar las compras, cr√©ditos y pagos en el futuro.
        </p>

        <div class="form-grid">
          <div class="form-field">
            <label for="prNombre">Nombre comercial / Proveedor</label>
            <input id="prNombre" class="input" type="text" placeholder="Ej: Bodega San Juan, Importadora XYZ">
          </div>

          <div class="form-field">
            <label for="prContacto">Persona de contacto</label>
            <input id="prContacto" class="input" type="text" placeholder="Ej: Carlos L√≥pez">
          </div>

          <div class="form-field">
            <label for="prTelefono">Tel√©fono</label>
            <input id="prTelefono" class="input" type="tel" placeholder="Ej: 5555-5555">
          </div>

          <div class="form-field">
            <label for="prNit">NIT</label>
            <input id="prNit" class="input" type="text" placeholder="NIT del proveedor">
          </div>

          <div class="form-field">
            <label for="prTipo">Tipo de proveedor</label>
            <select id="prTipo" class="input">
              <option value="LOCAL">Local (Guatemala)</option>
              <option value="INTERNACIONAL">Internacional</option>
            </select>
          </div>

          <div class="form-field">
            <label for="prFormaPago">Forma de pago principal</label>
            <select id="prFormaPago" class="input">
              <option value="EFECTIVO">Efectivo</option>
              <option value="TRANSFERENCIA">Transferencia / Dep√≥sito</option>
              <option value="TARJETA">Tarjeta</option>
              <option value="CREDITO">Cr√©dito</option>
              <option value="OTRO">Otro</option>
            </select>
          </div>

          <div class="form-field" style="grid-column: 1 / -1;">
            <label for="prDireccion">Direcci√≥n</label>
            <input id="prDireccion" class="input" type="text" placeholder="Zona, colonia, referencia, pa√≠s si aplica">
          </div>

          <div class="form-field" style="grid-column: 1 / -1;">
            <label for="prNotas">Notas</label>
            <input id="prNotas" class="input" type="text" placeholder="Condiciones especiales, horarios, etc.">
          </div>
        </div>

        <button class="btn" id="btnGuardarProveedor">Guardar proveedor</button>
      </section>

      <!-- Tabla de proveedores -->
      <section class="card">
        <h2 class="card-title">Listado de proveedores</h2>
        <p class="card-description">
          Aqu√≠ ver√°s todos los proveedores registrados. Luego se podr√°n vincular a las compras y reportes.
        </p>

        <table class="table">
          <thead>
            <tr>
              <th>Proveedor</th>
              <th>Contacto</th>
              <th>Tel√©fono</th>
              <th>NIT</th>
              <th>Tipo</th>
              <th>Forma de pago</th>
              <th>Direcci√≥n</th>
              <th>Creado</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="tabla-proveedores-body">
            <tr>
              <td colspan="9" class="table-empty">
                A√∫n no hay proveedores registrados.
              </td>
            </tr>
          </tbody>
        </table>
      </section>
    </main>
  </div>

  <!-- Scripts base -->
  <script src="alex-storage.js"></script>
  <script src="alex-roles.js"></script>

  <script>
    // Men√∫ m√≥vil
    const btnMenuMobile = document.getElementById('btnMenuMobile');
    const sidebar = document.querySelector('.sidebar');

    if (btnMenuMobile) {
      btnMenuMobile.addEventListener('click', () => {
        sidebar.classList.toggle('sidebar-open');
      });
    }

    // Usuario y permisos
    const usuarioActual = typeof getUsuarioActualObligatorio === "function"
      ? getUsuarioActualObligatorio()
      : null;

    if (typeof aplicarPermisosYProteger === "function") {
      aplicarPermisosYProteger("proveedores");
    }

    // Pintar nombre y rol en el topbar
    const labelUser = document.getElementById("topbar-user-label");
    if (usuarioActual && labelUser) {
      const rolTexto = usuarioActual.rol === "dueno" ? "Due√±o" : "Empleado";
      labelUser.textContent = `${usuarioActual.nombre} (${rolTexto})`;
    }

    // Bot√≥n Cerrar sesi√≥n
    const btnLogout = document.getElementById("btnLogout");
    if (btnLogout) {
      btnLogout.addEventListener("click", () => {
        if (!confirm("¬øQuieres cerrar sesi√≥n?")) return;

        if (typeof save === "function") {
          save("usuarioActual", null);
        } else {
          localStorage.removeItem("usuarioActual");
        }

        window.location.href = "index.html";
      });
    }

    // ====== L√ìGICA DE PROVEEDORES ======

    let proveedores = [];
    if (typeof load === "function") {
      const pData = load("proveedores", []);
      proveedores = Array.isArray(pData) ? pData : [];
    }

    function renderTablaProveedores() {
      const tbody = document.getElementById("tabla-proveedores-body");
      tbody.innerHTML = "";

      if (!proveedores.length) {
        tbody.innerHTML = `
          <tr>
            <td colspan="9" class="table-empty">A√∫n no hay proveedores registrados.</td>
          </tr>
        `;
        return;
      }

      const ordenados = [...proveedores].sort((a, b) => {
        const fa = new Date(a.creadoEnIso || a.creadoEn || 0).getTime();
        const fb = new Date(b.creadoEnIso || b.creadoEn || 0).getTime();
        return fb - fa;
      });

      ordenados.forEach((pr, index) => {
        let tipoTexto = "Local";
        if (pr.tipo === "INTERNACIONAL") tipoTexto = "Internacional";

        let formaPagoTexto = "";
        switch (pr.formaPagoPrincipal) {
          case "EFECTIVO": formaPagoTexto = "Efectivo"; break;
          case "TRANSFERENCIA": formaPagoTexto = "Transferencia / Dep√≥sito"; break;
          case "TARJETA": formaPagoTexto = "Tarjeta"; break;
          case "CREDITO": formaPagoTexto = "Cr√©dito"; break;
          case "OTRO": formaPagoTexto = "Otro"; break;
          default: formaPagoTexto = pr.formaPagoPrincipal || ""; break;
        }

        const creado = pr.creadoEn || "";

        tbody.innerHTML += `
          <tr>
            <td>${pr.nombre || ""}</td>
            <td>${pr.contacto || ""}</td>
            <td>${pr.telefono || ""}</td>
            <td>${pr.nit || ""}</td>
            <td>${tipoTexto}</td>
            <td>${formaPagoTexto}</td>
            <td>${pr.direccion || ""}</td>
            <td>${creado}</td>
            <td>
              <button onclick="eliminarProveedor(${index})">üóëÔ∏è</button>
            </td>
          </tr>
        `;
      });
    }

    function registrarProveedor() {
      const nombre = document.getElementById("prNombre").value.trim();
      const contacto = document.getElementById("prContacto").value.trim();
      const telefono = document.getElementById("prTelefono").value.trim();
      const nit = document.getElementById("prNit").value.trim();
      const tipo = document.getElementById("prTipo").value;
      const formaPago = document.getElementById("prFormaPago").value;
      const direccion = document.getElementById("prDireccion").value.trim();
      const notas = document.getElementById("prNotas").value.trim();

      if (!nombre) {
        alert("El nombre comercial del proveedor es obligatorio.");
        return;
      }

      const ahora = new Date();
      const nuevo = {
        id: Date.now(),
        nombre,
        contacto,
        telefono,
        nit,
        tipo, // LOCAL o INTERNACIONAL
        formaPagoPrincipal: formaPago,
        direccion,
        notas,
        creadoEn: ahora.toLocaleString("es-GT"),
        creadoEnIso: ahora.toISOString(),
        usuario: usuarioActual ? usuarioActual.usuario : null
      };

      proveedores.push(nuevo);
      if (typeof save === "function") {
        save("proveedores", proveedores);
      }

      // Limpiar formulario
      document.getElementById("prNombre").value = "";
      document.getElementById("prContacto").value = "";
      document.getElementById("prTelefono").value = "";
      document.getElementById("prNit").value = "";
      document.getElementById("prTipo").value = "LOCAL";
      document.getElementById("prFormaPago").value = "EFECTIVO";
      document.getElementById("prDireccion").value = "";
      document.getElementById("prNotas").value = "";

      renderTablaProveedores();
      alert("Proveedor registrado correctamente.");
    }

    function eliminarProveedor(index) {
      if (!confirm("¬øSeguro que quieres eliminar este proveedor?")) return;
      proveedores.splice(index, 1);
      if (typeof save === "function") {
        save("proveedores", proveedores);
      }
      renderTablaProveedores();
    }

    // Hacer accesible desde HTML
    window.eliminarProveedor = eliminarProveedor;

    // Bot√≥n guardar
    const btnGuardarProveedor = document.getElementById("btnGuardarProveedor");
    if (btnGuardarProveedor) {
      btnGuardarProveedor.addEventListener("click", registrarProveedor);
    }

    // Primera carga
    renderTablaProveedores();
  </script>
</body>
</html>
