<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>ALEX 3.0 - Inventario</title>
  <link rel="stylesheet" href="styles.css">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>

<body class="dashboard-body">
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <span class="logo-badge">A</span>
      <div class="sidebar-logo-text">
        <span class="sidebar-logo-main">ALEX 3.0</span>
        <span class="sidebar-logo-sub">Panel del negocio</span>
      </div>
    </div>

    <nav class="sidebar-nav">
      <a href="dashboard.html" class="sidebar-link">üìä Dashboard</a>
      <a href="ventas.html" class="sidebar-link">üíµ Ventas</a>
      <a href="inventario.html" class="sidebar-link active">üì¶ Inventario</a>
      <a href="caja.html" class="sidebar-link">üí∞ Caja</a>
      <a href="compras.html" class="sidebar-link">üßæ Compras</a>
      <a href="gastos.html" class="sidebar-link">üìâ Gastos</a>
      <a href="clientes.html" class="sidebar-link">üë• Clientes</a>
      <a href="proveedores.html" class="sidebar-link">üöö Proveedores</a>
      <a href="reportes.html" class="sidebar-link">üìö Reportes</a>
      <a href="ia.html" class="sidebar-link">ü§ñ IA empresarial</a>
      <a href="configuracion.html" class="sidebar-link">‚öôÔ∏è Configuraci√≥n</a>
    </nav>

    <div class="sidebar-footer">
      <span class="sidebar-footer-title" id="sidebar-footer-title">Empresa demo</span>
      <span class="sidebar-footer-sub">Versi√≥n 1.0</span>
    </div>
  </aside>

  <!-- Layout principal -->
  <div class="main-layout">
    <!-- Topbar -->
    <header class="topbar">
      <button class="btn-menu-mobile" id="btnMenuMobile">‚ò∞</button>

      <div class="topbar-left">
        <h1 class="topbar-title">Inventario</h1>
        <p class="topbar-subtitle">
          Control de productos, servicios, costos, precios y stock.
        </p>
      </div>

      <div class="topbar-right">
        <span class="topbar-company" id="topbar-company-label">Mi negocio</span>
        <span class="topbar-divider">‚Ä¢</span>
        <span class="topbar-user" id="topbar-user-label">Usuario (Rol)</span>
      </div>
    </header>

    <!-- Contenido principal -->
    <main class="main-content">
      <!-- Formulario en card -->
      <section class="card">
        <h2 class="card-title">Agregar √≠tem al inventario</h2>
        <p class="card-description">
          ALEX se adapta al tipo de negocio: productos por unidad, productos por peso (lb/kg) y servicios.
          Lo que veas aqu√≠ depende de lo que configuraste en "Configuraci√≥n del negocio".
        </p>

        <div class="form-grid">
          <div class="form-field">
            <label for="codigo">C√≥digo del √≠tem</label>
            <input id="codigo" class="input" type="text" placeholder="Ej: SKU-001 o c√≥digo de barras">
          </div>

          <!-- Tipo de √≠tem (se muestra solo si hay m√°s de un tipo posible) -->
          <div class="form-field" id="grupoTipoItem">
            <label for="tipoItem">Tipo de √≠tem</label>
            <select id="tipoItem" class="input">
              <!-- Se llena por JS seg√∫n negocio_config -->
            </select>
          </div>

          <div class="form-field">
            <label for="nombre">Nombre del √≠tem</label>
            <input id="nombre" class="input" type="text" placeholder="Ej: Perfume, corte de cabello, libra de carne, etc.">
          </div>

          <!-- Unidad de peso (solo si es producto por peso) -->
          <div class="form-field" id="grupoUnidadPeso">
            <label for="unidadPeso">Unidad de peso</label>
            <select id="unidadPeso" class="input">
              <option value="lb">Libra (lb)</option>
              <option value="kg">Kilogramo (kg)</option>
            </select>
          </div>

          <div class="form-field" id="grupoCompra">
            <label for="compra" id="labelCompra">Precio de compra (Q)</label>
            <input id="compra" class="input" type="number" placeholder="0.00" step="0.01" min="0">
          </div>

          <div class="form-field" id="grupoVenta">
            <label for="venta" id="labelVenta">Precio de venta (Q)</label>
            <input id="venta" class="input" type="number" placeholder="0.00" step="0.01" min="0">
          </div>

          <div class="form-field" id="grupoStock">
            <label for="stock" id="labelStock">Stock</label>
            <input id="stock" class="input" type="number" placeholder="0" step="0.01" min="0">
          </div>

          <!-- Duraci√≥n solo para servicios -->
          <div class="form-field" id="grupoDuracion">
            <label for="duracion">Duraci√≥n del servicio (opcional)</label>
            <input id="duracion" class="input" type="text" placeholder="Ej: 30 min, 1 hora, etc.">
          </div>
        </div>

        <!-- Esc√°ner con c√°mara para c√≥digo -->
        <button class="btn" id="btnEscanearCamaraInv" style="margin-top:0.5rem;">
          üì∑ Escanear c√≥digo con c√°mara
        </button>

        <div id="scannerContainerInv"
             style="display:none; margin-top:0.75rem; padding:0.75rem; border-radius:0.75rem; border:1px solid #ddd;">
          <p class="card-description" style="margin-bottom:0.5rem;">
            Apunta la c√°mara al c√≥digo de barras. Cuando se detecte, se llenar√° el campo "C√≥digo del √≠tem".
          </p>
          <video id="videoScannerInv" autoplay playsinline
                 style="width:100%; max-height:260px; border-radius:0.75rem; background:#000;"></video>
          <button class="btn btn-small" id="btnCerrarScannerInv" type="button" style="margin-top:0.5rem;">
            Cerrar c√°mara
          </button>
        </div>

        <button class="btn" onclick="agregarProducto()" style="margin-top:0.75rem;">
          Agregar al inventario
        </button>
      </section>

      <!-- Tabla en card -->
      <section class="card">
        <h2 class="card-title">Listado de √≠tems del inventario</h2>
        <p class="card-description">
          Aqu√≠ ver√°s todos los productos y servicios registrados, con su tipo, margen y stock.
        </p>

        <table class="table">
          <thead>
            <tr>
              <th>C√≥digo</th>
              <th>Nombre</th>
              <th>Tipo</th>
              <th>Unidad</th>
              <th>Compra (Q)</th>
              <th>Venta (Q)</th>
              <th>Ganancia (Q)</th>
              <th>Margen (%)</th>
              <th>Stock</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="tabla-body">
            <tr>
              <td colspan="10" class="table-empty">
                A√∫n no hay √≠tems registrados.
              </td>
            </tr>
          </tbody>
        </table>
      </section>
    </main>
  </div>

  <!-- Scripts base -->
  <script src="alex-storage.js"></script>
  <script src="alex-roles.js"></script>
  <!-- Librer√≠a ZXing para leer c√≥digos con la c√°mara -->
  <script src="https://unpkg.com/@zxing/library@0.20.0"></script>

  <script>
    // ===== Men√∫ m√≥vil =====
    const btnMenuMobile = document.getElementById('btnMenuMobile');
    const sidebar = document.querySelector('.sidebar');
    if (btnMenuMobile) {
      btnMenuMobile.addEventListener('click', () => {
        sidebar.classList.toggle('sidebar-open');
      });
    }

    // ===== Usuario y permisos =====
    const usuarioActual = typeof getUsuarioActualObligatorio === "function"
      ? getUsuarioActualObligatorio()
      : null;

    if (typeof aplicarPermisosYProteger === "function") {
      aplicarPermisosYProteger("inventario");
    }

    const labelUser = document.getElementById("topbar-user-label");
    const labelCompany = document.getElementById("topbar-company-label");
    const sidebarFooterTitle = document.getElementById("sidebar-footer-title");

    // ===== Cargar configuraci√≥n del negocio =====
    let negocioConfig = {
      nombre: "Mi negocio",
      tipo: "tienda",
      usaProductosUnidad: true,
      usaPorPeso: false,
      usaServicios: false
    };

    if (typeof load === "function") {
      const dataCfg = load("negocio_config", null);
      if (dataCfg && typeof dataCfg === "object") {
        negocioConfig = Object.assign(negocioConfig, dataCfg);
      }
    }

    if (labelCompany) {
      labelCompany.textContent = negocioConfig.nombre || "Mi negocio";
    }
    if (sidebarFooterTitle) {
      sidebarFooterTitle.textContent = negocioConfig.nombre || "Mi negocio";
    }
    if (usuarioActual && labelUser) {
      const rolTexto = usuarioActual.rol === "dueno" ? "Due√±o" : "Empleado";
      labelUser.textContent = `${usuarioActual.nombre} (${rolTexto})`;
    }

    // ===== Utilidad: tipos permitidos seg√∫n perfil =====
    function obtenerTiposDisponibles() {
      const tipos = [];
      if (negocioConfig.usaProductosUnidad) tipos.push("unidad");
      if (negocioConfig.usaPorPeso) tipos.push("peso");
      if (negocioConfig.usaServicios) tipos.push("servicio");
      if (!tipos.length) tipos.push("unidad"); // fallback
      return tipos;
    }

    function textoTipoItem(tipo) {
      switch (tipo) {
        case "unidad": return "Producto por unidad";
        case "peso": return "Producto por peso";
        case "servicio": return "Servicio";
        default: return "Producto";
      }
    }

    function textoUnidad(unidadPeso, tipoItem) {
      if (tipoItem === "servicio") return "-";
      if (tipoItem === "unidad") return "Unidad";
      if (tipoItem === "peso") {
        if (unidadPeso === "kg") return "KG";
        return "LB";
      }
      return "-";
    }

    // ===== Cargar productos desde almacenamiento =====
    let productos = [];
    if (typeof load === "function") {
      const data = load("productos", []);
      if (Array.isArray(data)) {
        productos = data.map(p => {
          // Normalizar modelos viejos (sin tipoItem)
          if (!p.tipoItem) {
            p.tipoItem = "unidad";
          }
          if (!p.unidadPeso && p.tipoItem === "peso") {
            p.unidadPeso = "lb";
          }
          return p;
        });
      }
    }

    // Formateador de moneda seguro
    function alex3FormatearMonedaSeguro(valor) {
      if (typeof alex3FormatearMoneda === "function") {
        return alex3FormatearMoneda(valor);
      }
      const num = Number(valor);
      if (isNaN(num)) return "Q 0.00";
      return "Q " + num.toFixed(2);
    }

    // ===== Controles del formulario =====
    const inpCodigo = document.getElementById("codigo");
    const inpNombre = document.getElementById("nombre");
    const selTipoItem = document.getElementById("tipoItem");
    const grupoTipoItem = document.getElementById("grupoTipoItem");
    const grupoUnidadPeso = document.getElementById("grupoUnidadPeso");
    const inpUnidadPeso = document.getElementById("unidadPeso");
    const grupoCompra = document.getElementById("grupoCompra");
    const grupoVenta = document.getElementById("grupoVenta");
    const grupoStock = document.getElementById("grupoStock");
    const grupoDuracion = document.getElementById("grupoDuracion");
    const inpCompra = document.getElementById("compra");
    const inpVenta = document.getElementById("venta");
    const inpStock = document.getElementById("stock");
    const inpDuracion = document.getElementById("duracion");
    const labelCompra = document.getElementById("labelCompra");
    const labelVenta = document.getElementById("labelVenta");
    const labelStock = document.getElementById("labelStock");

    // ===== Esc√°ner con c√°mara en inventario =====
    const btnEscanearCamaraInv = document.getElementById("btnEscanearCamaraInv");
    const scannerContainerInv = document.getElementById("scannerContainerInv");
    const videoScannerInv = document.getElementById("videoScannerInv");
    const btnCerrarScannerInv = document.getElementById("btnCerrarScannerInv");
    let scannerCodeReaderInv = null;

    async function iniciarEscaneoCamaraInv() {
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        alert("Este navegador no permite usar la c√°mara para escanear.");
        return;
      }

      if (typeof ZXing === "undefined" || !ZXing.BrowserMultiFormatReader) {
        alert("No se pudo cargar el lector de c√≥digos. Verifica tu conexi√≥n a internet.");
        return;
      }

      try {
        scannerContainerInv.style.display = "block";

        scannerCodeReaderInv = new ZXing.BrowserMultiFormatReader();

        const devices = await navigator.mediaDevices.enumerateDevices();
        const videoDevices = devices.filter(d => d.kind === "videoinput");
        let deviceId = undefined;

        if (videoDevices.length > 1) {
          deviceId = videoDevices[videoDevices.length - 1].deviceId;
        } else if (videoDevices.length === 1) {
          deviceId = videoDevices[0].deviceId;
        }

        await scannerCodeReaderInv.decodeFromVideoDevice(deviceId, videoScannerInv, (result, err) => {
          if (result) {
            const text = result.getText ? result.getText() : result.text || "";
            if (text) {
              manejarCodigoEscaneado(text);
            }
          }
        });
      } catch (e) {
        console.error(e);
        alert("No se pudo iniciar la c√°mara o el escaneo.");
        detenerEscaneoCamaraInv();
      }
    }

    function detenerEscaneoCamaraInv() {
      if (scannerCodeReaderInv) {
        try {
          scannerCodeReaderInv.reset();
        } catch (e) {
          console.error(e);
        }
        scannerCodeReaderInv = null;
      }
      if (scannerContainerInv) {
        scannerContainerInv.style.display = "none";
      }
    }

    function manejarCodigoEscaneado(textoCodigo) {
      if (inpCodigo) {
        inpCodigo.value = textoCodigo;
      }

      // Buscar si ya existe un producto con ese c√≥digo
      const existente = productos.find(p =>
        (p.codigo || "").toString().trim().toLowerCase() === textoCodigo.toString().trim().toLowerCase()
      );

      if (existente) {
        alert("Este c√≥digo ya est√° registrado en el inventario. Puedes agregar otro c√≥digo o revisar la lista.");
      } else {
        // No se crea autom√°tico el producto porque faltan nombre y precios,
        // pero dejamos el c√≥digo listo para que lo completes y guardes.
        alert("C√≥digo escaneado. Ahora completa nombre y precios para registrar el producto.");
      }

      if (inpNombre) inpNombre.focus();
      detenerEscaneoCamaraInv();
    }

    if (btnEscanearCamaraInv) {
      btnEscanearCamaraInv.addEventListener("click", (e) => {
        e.preventDefault();
        iniciarEscaneoCamaraInv();
      });
    }

    if (btnCerrarScannerInv) {
      btnCerrarScannerInv.addEventListener("click", (e) => {
        e.preventDefault();
        detenerEscaneoCamaraInv();
      });
    }

    // ===== Configurar el formulario seg√∫n el perfil =====
    function configurarFormularioPorPerfil() {
      const tiposDisponibles = obtenerTiposDisponibles();

      if (tiposDisponibles.length === 1) {
        // Solo un tipo -> no tiene sentido mostrar el select
        if (grupoTipoItem) grupoTipoItem.style.display = "none";
        if (selTipoItem) selTipoItem.innerHTML = "";
      } else {
        // Varios tipos -> mostramos el selector
        if (grupoTipoItem) grupoTipoItem.style.display = "block";
        if (selTipoItem) {
          selTipoItem.innerHTML = "";
          tiposDisponibles.forEach(tipo => {
            const opt = document.createElement("option");
            opt.value = tipo;
            opt.textContent = textoTipoItem(tipo);
            selTipoItem.appendChild(opt);
          });
        }
      }

      // Ajustar visibilidad inicial
      actualizarVisibilidadCampos();
    }

    function obtenerTipoSeleccionado() {
      const tiposDisponibles = obtenerTiposDisponibles();
      if (tiposDisponibles.length === 1) {
        return tiposDisponibles[0];
      }
      if (selTipoItem) {
        return selTipoItem.value || tiposDisponibles[0];
      }
      return tiposDisponibles[0];
    }

    function actualizarVisibilidadCampos() {
      const tipo = obtenerTipoSeleccionado();

      if (tipo === "servicio") {
        // Servicios: sin stock, sin unidad de peso, compra opcional/oculta
        if (grupoUnidadPeso) grupoUnidadPeso.style.display = "none";
        if (grupoStock) grupoStock.style.display = "none";
        if (grupoDuracion) grupoDuracion.style.display = "block";

        if (grupoCompra) grupoCompra.style.display = "none";
        if (labelVenta) labelVenta.textContent = "Precio del servicio (Q)";
        if (labelStock) labelStock.textContent = "Stock";

      } else if (tipo === "peso") {
        // Productos por peso: con unidad lb/kg, stock decimal, compra/venta normal
        if (grupoUnidadPeso) grupoUnidadPeso.style.display = "block";
        if (grupoStock) grupoStock.style.display = "block";
        if (grupoDuracion) grupoDuracion.style.display = "none";

        if (grupoCompra) grupoCompra.style.display = "block";
        if (labelVenta) labelVenta.textContent = "Precio por unidad de peso (Q)";
        if (labelStock) labelStock.textContent = "Stock disponible (LB/KG)";

      } else {
        // Productos por unidad
        if (grupoUnidadPeso) grupoUnidadPeso.style.display = "none";
        if (grupoStock) grupoStock.style.display = "block";
        if (grupoDuracion) grupoDuracion.style.display = "none";

        if (grupoCompra) grupoCompra.style.display = "block";
        if (labelVenta) labelVenta.textContent = "Precio de venta (Q)";
        if (labelStock) labelStock.textContent = "Stock (unidades)";
      }
    }

    if (selTipoItem) {
      selTipoItem.addEventListener("change", actualizarVisibilidadCampos);
    }

    // ===== Limpiar formulario =====
    function limpiarFormulario() {
      if (inpCodigo) inpCodigo.value = "";
      if (inpNombre) inpNombre.value = "";
      if (inpCompra) inpCompra.value = "";
      if (inpVenta) inpVenta.value = "";
      if (inpStock) inpStock.value = "";
      if (inpDuracion) inpDuracion.value = "";
      if (inpUnidadPeso) inpUnidadPeso.value = "lb";

      // No cambiamos el tipoItem para que el usuario pueda seguir agregando del mismo tipo
    }

    // ===== Agregar √≠tem al inventario =====
    function agregarProducto() {
      const codigo = inpCodigo ? inpCodigo.value.trim() : "";
      const nombre = inpNombre ? inpNombre.value.trim() : "";
      const tipoItem = obtenerTipoSeleccionado();

      if (!codigo || !nombre) {
        alert("Por favor completa al menos c√≥digo y nombre.");
        return;
      }

      // Validar que no haya c√≥digo duplicado
      const existente = productos.find(p =>
        (p.codigo || "").toString().trim().toLowerCase() === codigo.toString().trim().toLowerCase()
      );
      if (existente) {
        alert("Ya existe un √≠tem con ese c√≥digo en el inventario.");
        return;
      }

      let compra = 0;
      let venta = 0;
      let stock = undefined;
      let unidadPeso = null;
      let duracion = null;

      if (tipoItem === "servicio") {
        venta = parseFloat(inpVenta && inpVenta.value ? inpVenta.value : "0");
        if (isNaN(venta) || venta <= 0) {
          alert("Escribe un precio v√°lido para el servicio.");
          return;
        }
        duracion = inpDuracion && inpDuracion.value.trim() ? inpDuracion.value.trim() : null;
        // compra = 0, sin stock

      } else if (tipoItem === "peso") {
        compra = parseFloat(inpCompra && inpCompra.value ? inpCompra.value : "0");
        venta = parseFloat(inpVenta && inpVenta.value ? inpVenta.value : "0");
        stock = parseFloat(inpStock && inpStock.value ? inpStock.value : "0");

        if (isNaN(compra) || compra < 0 || isNaN(venta) || venta <= 0 || isNaN(stock) || stock < 0) {
          alert("Por favor completa compra, venta y stock con valores v√°lidos (mayores o iguales a 0).");
          return;
        }

        unidadPeso = inpUnidadPeso ? inpUnidadPeso.value : "lb";

      } else {
        // Producto por unidad
        compra = parseFloat(inpCompra && inpCompra.value ? inpCompra.value : "0");
        venta = parseFloat(inpVenta && inpVenta.value ? inpVenta.value : "0");
        stock = parseFloat(inpStock && inpStock.value ? inpStock.value : "0");

        if (isNaN(compra) || compra < 0 || isNaN(venta) || venta <= 0 || isNaN(stock) || stock < 0) {
          alert("Por favor completa compra, venta y stock con valores v√°lidos (mayores o iguales a 0).");
          return;
        }
      }

      let ganancia = 0;
      let margen = 0;
      if (tipoItem === "servicio") {
        // Por ahora, ganancia = venta (compra = 0)
        ganancia = venta;
        margen = 0;
      } else {
        ganancia = venta - compra;
        margen = compra > 0 ? ((ganancia / compra) * 100) : 0;
      }

      const nuevo = {
        codigo,
        nombre,
        tipoItem,          // "unidad" | "peso" | "servicio"
        unidadPeso: unidadPeso, // "lb" | "kg" (solo para peso)
        compra,
        venta,
        ganancia,
        margen: Number(margen.toFixed(1)),
        stock,             // undefined para servicios
        duracion           // solo servicios
      };

      productos.push(nuevo);
      if (typeof save === "function") {
        save("productos", productos);
      }

      limpiarFormulario();
      renderTabla();
      alert("√çtem agregado al inventario.");
    }

    // ===== Render de la tabla =====
    function renderTabla() {
      const tbody = document.getElementById("tabla-body");
      if (!tbody) return;

      tbody.innerHTML = "";

      if (!productos.length) {
        tbody.innerHTML = `
          <tr>
            <td colspan="10" class="table-empty">
              A√∫n no hay √≠tems registrados.
            </td>
          </tr>
        `;
        return;
      }

      productos.forEach((p, index) => {
        const tipoTxt = textoTipoItem(p.tipoItem);
        const unidadTxt = textoUnidad(p.unidadPeso, p.tipoItem);
        const compraFmt = p.tipoItem === "servicio"
          ? "-"
          : alex3FormatearMonedaSeguro(p.compra);
        const ventaFmt = alex3FormatearMonedaSeguro(p.venta);
        const gananciaFmt = p.tipoItem === "servicio"
          ? "-"
          : alex3FormatearMonedaSeguro(p.ganancia);
        const margenTxt = p.tipoItem === "servicio"
          ? "-"
          : ((p.margen != null ? p.margen : 0) + "%");

        let stockTxt = "-";
        if (p.tipoItem !== "servicio") {
          const st = (p.stock != null ? Number(p.stock) : 0);
          if (!isNaN(st)) {
            if (p.tipoItem === "peso") {
              stockTxt = st.toFixed(2) + " " + unidadTxt;
            } else {
              stockTxt = st.toString();
            }
          }
        }

        const fila = `
          <tr>
            <td>${p.codigo}</td>
            <td>${p.nombre}</td>
            <td>${tipoTxt}</td>
            <td>${unidadTxt}</td>
            <td>${compraFmt}</td>
            <td>${ventaFmt}</td>
            <td>${gananciaFmt}</td>
            <td>${margenTxt}</td>
            <td>${stockTxt}</td>
            <td>
              <button onclick="eliminarProducto(${index})">üóëÔ∏è</button>
            </td>
          </tr>
        `;
        tbody.innerHTML += fila;
      });
    }

    function eliminarProducto(index) {
      const confirmar = confirm("¬øSeguro que quieres eliminar este √≠tem del inventario?");
      if (!confirmar) return;

      productos.splice(index, 1);
      if (typeof save === "function") {
        save("productos", productos);
      }
      renderTabla();
    }

    // ===== Primera carga =====
    configurarFormularioPorPerfil();
    renderTabla();
  </script>
</body>
</html>
