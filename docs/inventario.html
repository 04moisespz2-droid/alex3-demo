<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>ALEX 3.0 - Inventario</title>
  <link rel="stylesheet" href="styles.css">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>

<body class="dashboard-body">
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <span class="logo-badge">A</span>
      <div class="sidebar-logo-text">
        <span class="sidebar-logo-main">ALEX 3.0</span>
        <span class="sidebar-logo-sub">Panel del negocio</span>
      </div>
    </div>

    <nav class="sidebar-nav">
      <a href="dashboard.html" class="sidebar-link">üìä Dashboard</a>
      <a href="ventas.html" class="sidebar-link">üíµ Ventas</a>
      <a href="inventario.html" class="sidebar-link active">üì¶ Inventario</a>
      <a href="caja.html" class="sidebar-link">üí∞ Caja</a>
      <a href="compras.html" class="sidebar-link">üßæ Compras</a>
      <a href="gastos.html" class="sidebar-link">üìâ Gastos</a>
      <a href="clientes.html" class="sidebar-link">üë• Clientes</a>
      <a href="proveedores.html" class="sidebar-link">üöö Proveedores</a>
      <a href="reportes.html" class="sidebar-link">üìö Reportes</a>
      <a href="ia.html" class="sidebar-link">ü§ñ IA empresarial</a>
      <a href="configuracion.html" class="sidebar-link">‚öôÔ∏è Configuraci√≥n</a>
    </nav>

    <div class="sidebar-footer">
      <span class="sidebar-footer-title">Empresa demo</span>
      <span class="sidebar-footer-sub">Versi√≥n 1.0</span>
    </div>
  </aside>

  <!-- Layout principal -->
  <div class="main-layout">
    <!-- Topbar -->
    <header class="topbar">
      <button class="btn-menu-mobile" id="btnMenuMobile">‚ò∞</button>

      <div class="topbar-left">
        <h1 class="topbar-title">Inventario</h1>
        <p class="topbar-subtitle">Control de productos, costos, precios y stock.</p>
      </div>

      <div class="topbar-right">
        <span class="topbar-company">Mi tienda demo</span>
        <span class="topbar-divider">‚Ä¢</span>
        <span class="topbar-user">Brayan (Due√±o)</span>
      </div>
    </header>

    <!-- Contenido principal -->
    <main class="main-content">
      <!-- Formulario en card -->
      <section class="card">
        <h2 class="card-title">Agregar producto</h2>
        <p class="card-description">
          Registra nuevos productos con su costo, precio de venta y stock inicial.
        </p>

        <div class="form-grid">
          <div class="form-field">
            <label for="codigo">C√≥digo del producto</label>
            <input id="codigo" class="input" type="text" placeholder="Ej: SKU-001 o c√≥digo de barras">
          </div>

          <div class="form-field">
            <label for="nombre">Nombre del producto</label>
            <input id="nombre" class="input" type="text" placeholder="Ej: Perfume, gorra, cable, etc.">
          </div>

          <div class="form-field">
            <label for="compra">Precio de compra (Q)</label>
            <input id="compra" class="input" type="number" placeholder="0.00" step="0.01" min="0">
          </div>

          <div class="form-field">
            <label for="venta">Precio de venta (Q)</label>
            <input id="venta" class="input" type="number" placeholder="0.00" step="0.01" min="0">
          </div>

          <div class="form-field">
            <label for="stock">Stock inicial</label>
            <input id="stock" class="input" type="number" placeholder="0" min="0">
          </div>
        </div>

        <!-- Esc√°ner con c√°mara para c√≥digo -->
        <button class="btn" id="btnEscanearCamaraInv" style="margin-top:0.5rem;">
          üì∑ Escanear c√≥digo con c√°mara
        </button>

        <div id="scannerContainerInv"
             style="display:none; margin-top:0.75rem; padding:0.75rem; border-radius:0.75rem; border:1px solid #ddd;">
          <p class="card-description" style="margin-bottom:0.5rem;">
            Apunta la c√°mara al c√≥digo de barras. Cuando se detecte, se llenar√° el campo "C√≥digo del producto".
          </p>
          <video id="videoScannerInv" autoplay playsinline
                 style="width:100%; max-height:260px; border-radius:0.75rem; background:#000;"></video>
          <button class="btn btn-small" id="btnCerrarScannerInv" type="button" style="margin-top:0.5rem;">
            Cerrar c√°mara
          </button>
        </div>

        <button class="btn" onclick="agregarProducto()" style="margin-top:0.75rem;">
          Agregar producto
        </button>
      </section>

      <!-- Tabla en card -->
      <section class="card">
        <h2 class="card-title">Listado de productos</h2>
        <p class="card-description">
          Aqu√≠ ver√°s todos los productos registrados con su margen y ganancia estimada.
        </p>

        <table class="table">
          <thead>
            <tr>
              <th>C√≥digo</th>
              <th>Nombre</th>
              <th>Compra (Q)</th>
              <th>Venta (Q)</th>
              <th>Ganancia (Q)</th>
              <th>Margen (%)</th>
              <th>Stock</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="tabla-body">
            <tr>
              <td colspan="8" class="table-empty">
                A√∫n no hay productos registrados.
              </td>
            </tr>
          </tbody>
        </table>
      </section>
    </main>
  </div>

  <!-- Scripts base -->
  <script src="alex-storage.js"></script>
  <script src="alex-roles.js"></script>
  <!-- Librer√≠a ZXing para leer c√≥digos con la c√°mara -->
  <script src="https://unpkg.com/@zxing/library@0.20.0"></script>

  <script>
    // Men√∫ m√≥vil
    const btnMenuMobile = document.getElementById('btnMenuMobile');
    const sidebar = document.querySelector('.sidebar');

    if (btnMenuMobile) {
      btnMenuMobile.addEventListener('click', () => {
        sidebar.classList.toggle('sidebar-open');
      });
    }

    // Usuario y permisos
    const usuarioActual = typeof getUsuarioActualObligatorio === "function"
      ? getUsuarioActualObligatorio()
      : null;

    if (typeof aplicarPermisosYProteger === "function") {
      aplicarPermisosYProteger("inventario");
    }

    // Cargar productos desde almacenamiento
    let productos = [];
    if (typeof load === "function") {
      const data = load("productos", []);
      productos = Array.isArray(data) ? data : [];
    }

    // Formateador de moneda seguro
    function alex3FormatearMonedaSeguro(valor) {
      if (typeof alex3FormatearMoneda === "function") {
        return alex3FormatearMoneda(valor);
      }
      const num = Number(valor);
      if (isNaN(num)) return "Q 0.00";
      return "Q " + num.toFixed(2);
    }

    function limpiarFormulario() {
      document.getElementById("codigo").value = "";
      document.getElementById("nombre").value = "";
      document.getElementById("compra").value = "";
      document.getElementById("venta").value = "";
      document.getElementById("stock").value = "";
    }

    function agregarProducto() {
      const codigo = document.getElementById("codigo").value.trim();
      const nombre = document.getElementById("nombre").value.trim();
      const compra = parseFloat(document.getElementById("compra").value);
      const venta = parseFloat(document.getElementById("venta").value);
      const stock = parseInt(document.getElementById("stock").value);

      if (!codigo || !nombre || isNaN(compra) || isNaN(venta) || isNaN(stock)) {
        alert("Por favor completa todos los campos.");
        return;
      }

      const ganancia = venta - compra;
      const margen = compra > 0 ? ((ganancia / compra) * 100) : 0;

      const nuevo = {
        codigo,
        nombre,
        compra,
        venta,
        ganancia,
        margen: Number(margen.toFixed(1)),
        stock
      };

      productos.push(nuevo);
      if (typeof save === "function") {
        save("productos", productos);
      }

      limpiarFormulario();
      renderTabla();
      alert("Producto agregado al inventario.");
    }

    function renderTabla() {
      const tbody = document.getElementById("tabla-body");
      tbody.innerHTML = "";

      if (!productos.length) {
        tbody.innerHTML = `
          <tr>
            <td colspan="8" class="table-empty">
              A√∫n no hay productos registrados.
            </td>
          </tr>
        `;
        return;
      }

      productos.forEach((p, index) => {
        const compraFmt = alex3FormatearMonedaSeguro(p.compra);
        const ventaFmt = alex3FormatearMonedaSeguro(p.venta);
        const gananciaFmt = alex3FormatearMonedaSeguro(p.ganancia);
        const margenTxt = (p.margen != null ? p.margen : 0) + "%";

        const fila = `
          <tr>
            <td>${p.codigo}</td>
            <td>${p.nombre}</td>
            <td>${compraFmt}</td>
            <td>${ventaFmt}</td>
            <td>${gananciaFmt}</td>
            <td>${margenTxt}</td>
            <td>${p.stock}</td>
            <td>
              <button onclick="eliminarProducto(${index})">üóëÔ∏è</button>
            </td>
          </tr>
        `;
        tbody.innerHTML += fila;
      });
    }

    function eliminarProducto(index) {
      productos.splice(index, 1);
      if (typeof save === "function") {
        save("productos", productos);
      }
      renderTabla();
    }

    // ===== Esc√°ner con c√°mara en inventario =====
    const inputCodigo = document.getElementById("codigo");
    const btnEscanearCamaraInv = document.getElementById("btnEscanearCamaraInv");
    const scannerContainerInv = document.getElementById("scannerContainerInv");
    const videoScannerInv = document.getElementById("videoScannerInv");
    const btnCerrarScannerInv = document.getElementById("btnCerrarScannerInv");
    let scannerCodeReaderInv = null;

    async function iniciarEscaneoCamaraInv() {
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        alert("Este navegador no permite usar la c√°mara para escanear.");
        return;
      }

      if (typeof ZXing === "undefined" || !ZXing.BrowserMultiFormatReader) {
        alert("No se pudo cargar el lector de c√≥digos. Verifica tu conexi√≥n a internet.");
        return;
      }

      try {
        scannerContainerInv.style.display = "block";

        scannerCodeReaderInv = new ZXing.BrowserMultiFormatReader();

        const devices = await navigator.mediaDevices.enumerateDevices();
        const videoDevices = devices.filter(d => d.kind === "videoinput");
        let deviceId = undefined;

        if (videoDevices.length > 1) {
          deviceId = videoDevices[videoDevices.length - 1].deviceId;
        } else if (videoDevices.length === 1) {
          deviceId = videoDevices[0].deviceId;
        }

        await scannerCodeReaderInv.decodeFromVideoDevice(deviceId, videoScannerInv, (result, err) => {
          if (result) {
            const text = result.getText ? result.getText() : result.text || "";
            if (text) {
              inputCodigo.value = text;
              detenerEscaneoCamaraInv();
              const nombreInput = document.getElementById("nombre");
              if (nombreInput) nombreInput.focus();
            }
          }
        });
      } catch (e) {
        console.error(e);
        alert("No se pudo iniciar la c√°mara o el escaneo.");
        detenerEscaneoCamaraInv();
      }
    }

    function detenerEscaneoCamaraInv() {
      if (scannerCodeReaderInv) {
        try {
          scannerCodeReaderInv.reset();
        } catch (e) {
          console.error(e);
        }
        scannerCodeReaderInv = null;
      }
      if (scannerContainerInv) {
        scannerContainerInv.style.display = "none";
      }
    }

    if (btnEscanearCamaraInv) {
      btnEscanearCamaraInv.addEventListener("click", (e) => {
        e.preventDefault();
        iniciarEscaneoCamaraInv();
      });
    }

    if (btnCerrarScannerInv) {
      btnCerrarScannerInv.addEventListener("click", (e) => {
        e.preventDefault();
        detenerEscaneoCamaraInv();
      });
    }

    // Primera carga
    renderTabla();
  </script>
</body>
</html>
