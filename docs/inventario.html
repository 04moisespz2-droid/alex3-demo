<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>ALEX 3.0 - Inventario</title>
  <link rel="stylesheet" href="styles.css">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>

<body class="dashboard-body">
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <span class="logo-badge">A</span>
      <div class="sidebar-logo-text">
        <span class="sidebar-logo-main">ALEX 3.0</span>
        <span class="sidebar-logo-sub">Panel del negocio</span>
      </div>
    </div>

    <nav class="sidebar-nav">
      <a href="dashboard.html" class="sidebar-link">ğŸ“Š Dashboard</a>
      <a href="ventas.html" class="sidebar-link">ğŸ’µ Ventas</a>
      <a href="inventario.html" class="sidebar-link active">ğŸ“¦ Inventario</a>
      <a href="caja.html" class="sidebar-link">ğŸ’° Caja</a>
      <a href="compras.html" class="sidebar-link">ğŸ§¾ Compras</a>
      <a href="gastos.html" class="sidebar-link">ğŸ“‰ Gastos</a>
      <a href="clientes.html" class="sidebar-link">ğŸ‘¥ Clientes</a>
      <a href="proveedores.html" class="sidebar-link">ğŸšš Proveedores</a>
      <a href="contabilidad.html" class="sidebar-link">ğŸ“š Contabilidad</a>
      <a href="sat.html" class="sidebar-link">ğŸ‡¬ğŸ‡¹ SAT Guatemala</a>
      <a href="ia.html" class="sidebar-link">ğŸ¤– IA empresarial</a>
      <a href="configuracion.html" class="sidebar-link">âš™ï¸ ConfiguraciÃ³n</a>
    </nav>

    <div class="sidebar-footer">
      <span class="sidebar-footer-title">Empresa demo</span>
      <span class="sidebar-footer-sub">VersiÃ³n 1.0</span>
    </div>
  </aside>

  <!-- Layout principal -->
  <div class="main-layout">
    <!-- Topbar -->
    <header class="topbar">
      <button class="btn-menu-mobile" id="btnMenuMobile">â˜°</button>

      <div class="topbar-left">
        <h1 class="topbar-title">Inventario</h1>
        <p class="topbar-subtitle">Control de productos, costos, precios y stock.</p>
      </div>

      <div class="topbar-right">
        <span class="topbar-company">Mi tienda demo</span>
        <span class="topbar-divider">â€¢</span>
        <span class="topbar-user">Brayan (DueÃ±o)</span>
      </div>
    </header>

    <!-- Contenido principal -->
    <main class="main-content">
      <!-- Formulario en card -->
      <section class="card">
        <h2 class="card-title">Agregar producto</h2>
        <p class="card-description">
          Registra nuevos productos con su costo, precio de venta y stock inicial.
        </p>

        <div class="form-grid">
          <div class="form-field">
            <label for="codigo">CÃ³digo del producto</label>
            <input id="codigo" class="input" type="text" placeholder="Ej: SKU-001">
          </div>

          <div class="form-field">
            <label for="nombre">Nombre del producto</label>
            <input id="nombre" class="input" type="text" placeholder="Ej: Perfume, gorra, cable, etc.">
          </div>

          <div class="form-field">
            <label for="compra">Precio de compra (Q)</label>
            <input id="compra" class="input" type="number" placeholder="0.00" step="0.01" min="0">
          </div>

          <div class="form-field">
            <label for="venta">Precio de venta (Q)</label>
            <input id="venta" class="input" type="number" placeholder="0.00" step="0.01" min="0">
          </div>

          <div class="form-field">
            <label for="stock">Stock inicial</label>
            <input id="stock" class="input" type="number" placeholder="0" min="0">
          </div>
        </div>

        <button class="btn" onclick="agregarProducto()">Agregar producto</button>
      </section>

      <!-- Tabla en card -->
      <section class="card">
        <h2 class="card-title">Listado de productos</h2>
        <p class="card-description">
          AquÃ­ verÃ¡s todos los productos registrados con su margen y ganancia estimada.
        </p>

        <table class="table">
          <thead>
            <tr>
              <th>CÃ³digo</th>
              <th>Nombre</th>
              <th>Compra (Q)</th>
              <th>Venta (Q)</th>
              <th>Ganancia (Q)</th>
              <th>Margen (%)</th>
              <th>Stock</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="tabla-body">
            <tr>
              <td colspan="8" class="table-empty">
                AÃºn no hay productos registrados.
              </td>
            </tr>
          </tbody>
        </table>
      </section>
    </main>
  </div>

  <!-- Scripts base -->
  <script src="alex-storage.js"></script>
  <script src="alex-roles.js"></script>

  <script>
    // MenÃº mÃ³vil
    const btnMenuMobile = document.getElementById('btnMenuMobile');
    const sidebar = document.querySelector('.sidebar');

    if (btnMenuMobile) {
      btnMenuMobile.addEventListener('click', () => {
        sidebar.classList.toggle('sidebar-open');
      });
    }

    // Usuario y permisos
    const usuarioActual = typeof getUsuarioActualObligatorio === "function"
      ? getUsuarioActualObligatorio()
      : null;

    if (typeof aplicarPermisosYProteger === "function") {
      aplicarPermisosYProteger("inventario");
    }

    // Cargar productos desde almacenamiento
    let productos = [];
    if (typeof load === "function") {
      const data = load("productos", []);
      productos = Array.isArray(data) ? data : [];
    }

    // Formateador de moneda seguro
    function alex3FormatearMonedaSeguro(valor) {
      if (typeof alex3FormatearMoneda === "function") {
        return alex3FormatearMoneda(valor);
      }
      const num = Number(valor);
      if (isNaN(num)) return "Q 0.00";
      return "Q " + num.toFixed(2);
    }

    function limpiarFormulario() {
      document.getElementById("codigo").value = "";
      document.getElementById("nombre").value = "";
      document.getElementById("compra").value = "";
      document.getElementById("venta").value = "";
      document.getElementById("stock").value = "";
    }

    function agregarProducto() {
      const codigo = document.getElementById("codigo").value.trim();
      const nombre = document.getElementById("nombre").value.trim();
      const compra = parseFloat(document.getElementById("compra").value);
      const venta = parseFloat(document.getElementById("venta").value);
      const stock = parseInt(document.getElementById("stock").value);

      if (!codigo || !nombre || isNaN(compra) || isNaN(venta) || isNaN(stock)) {
        alert("Por favor completa todos los campos.");
        return;
      }

      const ganancia = venta - compra;
      const margen = compra > 0 ? ((ganancia / compra) * 100) : 0;

      const nuevo = {
        codigo,
        nombre,
        compra,
        venta,
        ganancia,
        margen: Number(margen.toFixed(1)),
        stock
      };

      productos.push(nuevo);
      if (typeof save === "function") {
        save("productos", productos);
      }

      limpiarFormulario();
      renderTabla();
    }

    function renderTabla() {
      const tbody = document.getElementById("tabla-body");
      tbody.innerHTML = "";

      if (!productos.length) {
        tbody.innerHTML = `
          <tr>
            <td colspan="8" class="table-empty">
              AÃºn no hay productos registrados.
            </td>
          </tr>
        `;
        return;
      }

      productos.forEach((p, index) => {
        const compraFmt = alex3FormatearMonedaSeguro(p.compra);
        const ventaFmt = alex3FormatearMonedaSeguro(p.venta);
        const gananciaFmt = alex3FormatearMonedaSeguro(p.ganancia);
        const margenTxt = (p.margen != null ? p.margen : 0) + "%";

        const fila = `
          <tr>
            <td>${p.codigo}</td>
            <td>${p.nombre}</td>
            <td>${compraFmt}</td>
            <td>${ventaFmt}</td>
            <td>${gananciaFmt}</td>
            <td>${margenTxt}</td>
            <td>${p.stock}</td>
            <td>
              <button onclick="eliminarProducto(${index})">ğŸ—‘ï¸</button>
            </td>
          </tr>
        `;
        tbody.innerHTML += fila;
      });
    }

    function eliminarProducto(index) {
      productos.splice(index, 1);
      if (typeof save === "function") {
        save("productos", productos);
      }
      renderTabla();
    }

    // Primera carga
    renderTabla();
  </script>
</body>
</html>
