<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>ALEX 3.0 - Ventas</title>
  <link rel="stylesheet" href="styles.css">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>

<body class="dashboard-body">
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <span class="logo-badge">A</span>
      <div class="sidebar-logo-text">
        <span class="sidebar-logo-main">ALEX 3.0</span>
        <span class="sidebar-logo-sub">Panel del negocio</span>
      </div>
    </div>

    <nav class="sidebar-nav">
      <a href="dashboard.html" class="sidebar-link">üìä Dashboard</a>
      <a href="ventas.html" class="sidebar-link active">üíµ Ventas</a>
      <a href="inventario.html" class="sidebar-link">üì¶ Inventario</a>
      <a href="caja.html" class="sidebar-link">üí∞ Caja</a>
      <a href="compras.html" class="sidebar-link">üßæ Compras</a>
      <a href="gastos.html" class="sidebar-link">üìâ Gastos</a>
      <a href="clientes.html" class="sidebar-link">üë• Clientes</a>
      <a href="proveedores.html" class="sidebar-link">üöö Proveedores</a>
      <a href="contabilidad.html" class="sidebar-link">üìö Contabilidad</a>
      <a href="sat.html" class="sidebar-link">üá¨üáπ SAT Guatemala</a>
      <a href="ia.html" class="sidebar-link">ü§ñ IA empresarial</a>
      <a href="configuracion.html" class="sidebar-link">‚öôÔ∏è Configuraci√≥n</a>
    </nav>

    <div class="sidebar-footer">
      <span class="sidebar-footer-title">Empresa demo</span>
      <span class="sidebar-footer-sub">Versi√≥n 1.0</span>
    </div>
  </aside>

  <!-- Layout principal -->
  <div class="main-layout">
    <!-- Topbar -->
    <header class="topbar">
      <button class="btn-menu-mobile" id="btnMenuMobile">‚ò∞</button>

      <div class="topbar-left">
        <h1 class="topbar-title">Ventas</h1>
        <p class="topbar-subtitle">Registra ventas reales usando los productos del inventario.</p>
      </div>

      <div class="topbar-right">
        <span class="topbar-company">Mi tienda demo</span>
        <span class="topbar-divider">‚Ä¢</span>
        <span class="topbar-user" id="topbar-user-label">Usuario (Rol)</span>
        <button class="btn" id="btnLogout" type="button" style="margin-left: 0.75rem;">
          Cerrar sesi√≥n
        </button>
      </div>
    </header>

    <!-- Contenido principal -->
    <main class="main-content">
      <!-- Resumen de ventas -->
      <section class="cards-grid">
        <article class="card kpi-card">
          <h2 class="card-title">Ventas de hoy</h2>
          <p class="card-kpi" id="kpi-ventas-hoy">Q 0.00</p>
          <p class="card-kpi-sub">Incluye todas las formas de pago.</p>
        </article>

        <article class="card kpi-card">
          <h2 class="card-title">Ventas del mes</h2>
          <p class="card-kpi" id="kpi-ventas-mes">Q 0.00</p>
          <p class="card-kpi-sub">Total de ventas registradas este mes.</p>
        </article>

        <article class="card kpi-card">
          <h2 class="card-title">Tickets emitidos</h2>
          <p class="card-kpi" id="kpi-ventas-tickets">0</p>
          <p class="card-kpi-sub">Cantidad de ventas registradas.</p>
        </article>

        <article class="card kpi-card">
          <h2 class="card-title">Promedio por venta</h2>
          <p class="card-kpi" id="kpi-ventas-promedio">Q 0.00</p>
          <p class="card-kpi-sub">Total vendido / n√∫mero de ventas.</p>
        </article>
      </section>

      <!-- Zona de venta: buscador + carrito -->
      <section class="grid-2">
        <!-- Buscar producto -->
        <article class="card">
          <h2 class="card-title">1. Buscar producto del inventario</h2>
          <p class="card-description">
            Escribe c√≥digo o nombre para buscar productos y agr√©galos al carrito.
          </p>

          <div class="form-grid">
            <div class="form-field" style="grid-column: 1 / -1;">
              <label for="buscarTexto">Buscar producto</label>
              <input id="buscarTexto" class="input" type="text"
                     placeholder="Ej: 001, perfume, cargador, etc.">
            </div>
          </div>

          <button class="btn" id="btnBuscarProducto" style="margin-top: 0.75rem;">
            Buscar en inventario
          </button>

          <table class="table" style="margin-top: 1rem;">
            <thead>
              <tr>
                <th>C√≥digo</th>
                <th>Nombre</th>
                <th>Precio</th>
                <th>Stock</th>
                <th>Cant.</th>
                <th>Agregar</th>
              </tr>
            </thead>
            <tbody id="tabla-resultados-productos">
              <tr>
                <td colspan="6" class="table-empty">
                  Escribe algo y presiona ‚ÄúBuscar en inventario‚Äù.
                </td>
              </tr>
            </tbody>
          </table>
        </article>

        <!-- Carrito -->
        <article class="card">
          <h2 class="card-title">2. Carrito de venta</h2>
          <p class="card-description">
            Revisa los productos agregados antes de confirmar la venta.
          </p>

          <table class="table">
            <thead>
              <tr>
                <th>Producto</th>
                <th>Cant.</th>
                <th>P. unit</th>
                <th>Subtotal</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="tabla-carrito">
              <tr>
                <td colspan="5" class="table-empty">
                  A√∫n no hay productos en el carrito.
                </td>
              </tr>
            </tbody>
          </table>

          <div style="margin-top: 1rem; display: flex; justify-content: space-between; align-items: center;">
            <span class="card-title">Total:</span>
            <span class="card-kpi" id="lbl-total-carrito">Q 0.00</span>
          </div>
        </article>
      </section>

      <!-- Datos de la venta -->
      <section class="card">
        <h2 class="card-title">3. Datos de la venta</h2>
        <p class="card-description">
          Completa los datos del cliente y forma de pago para registrar la venta y actualizar inventario y caja.
        </p>

        <div class="form-grid">
          <div class="form-field">
            <label for="vFecha">Fecha y hora</label>
            <input id="vFecha" class="input" type="datetime-local">
          </div>

          <div class="form-field">
            <label for="vCliente">Cliente (opcional)</label>
            <input id="vCliente" class="input" type="text" placeholder="Ej: Cliente contado, Juan P√©rez">
          </div>

          <div class="form-field">
            <label for="vDocumento">Documento</label>
            <select id="vDocumento" class="input">
              <option value="Ticket interno">Ticket interno</option>
              <option value="Factura">Factura</option>
              <option value="Recibo">Recibo</option>
            </select>
          </div>

          <div class="form-field">
            <label for="vFormaPago">Forma de pago</label>
            <select id="vFormaPago" class="input">
              <option value="EFECTIVO">Efectivo</option>
              <option value="TRANSFERENCIA">Transferencia</option>
              <option value="TARJETA">Tarjeta</option>
            </select>
          </div>

          <div class="form-field" style="grid-column: 1 / -1;">
            <label for="vNotas">Notas (opcional)</label>
            <input id="vNotas" class="input" type="text" placeholder="Ej: Incluye env√≠o, promoci√≥n, etc.">
          </div>
        </div>

        <button class="btn" id="btnConfirmarVenta" style="margin-top: 1rem;">
          Confirmar venta y actualizar inventario
        </button>
      </section>

      <!-- Historial de ventas r√°pidas (√∫ltimas) -->
      <section class="card">
        <h2 class="card-title">4. √öltimas ventas registradas</h2>
        <p class="card-description">
          Las ventas m√°s recientes aparecen primero.
        </p>

        <table class="table">
          <thead>
            <tr>
              <th>Fecha</th>
              <th>Documento</th>
              <th>Cliente</th>
              <th>Forma de pago</th>
              <th>Total</th>
            </tr>
          </thead>
          <tbody id="tabla-ventas-body">
            <tr>
              <td colspan="5" class="table-empty">
                A√∫n no hay ventas registradas.
              </td>
            </tr>
          </tbody>
        </table>
      </section>
    </main>
  </div>

  <!-- Scripts base -->
  <script src="alex-storage.js"></script>
  <script src="alex-roles.js"></script>

  <script>
    // ===== Men√∫ m√≥vil =====
    const btnMenuMobile = document.getElementById('btnMenuMobile');
    const sidebar = document.querySelector('.sidebar');
    if (btnMenuMobile) {
      btnMenuMobile.addEventListener('click', () => {
        sidebar.classList.toggle('sidebar-open');
      });
    }

    // ===== Usuario y permisos =====
    const usuarioActual = typeof getUsuarioActualObligatorio === "function"
      ? getUsuarioActualObligatorio()
      : null;

    if (typeof aplicarPermisosYProteger === "function") {
      aplicarPermisosYProteger("ventas");
    }

    const labelUser = document.getElementById("topbar-user-label");
    if (usuarioActual && labelUser) {
      const rolTexto = usuarioActual.rol === "dueno" ? "Due√±o" : "Empleado";
      labelUser.textContent = `${usuarioActual.nombre} (${rolTexto})`;
    }

    // Cerrar sesi√≥n
    const btnLogout = document.getElementById("btnLogout");
    if (btnLogout) {
      btnLogout.addEventListener("click", () => {
        if (!confirm("¬øQuieres cerrar sesi√≥n?")) return;
        if (typeof save === "function") {
          save("usuarioActual", null);
        } else {
          localStorage.removeItem("usuarioActual");
        }
        window.location.href = "index.html";
      });
    }

    // ===== Helpers =====
    function alex3FormatearMonedaSeguro(valor) {
      if (typeof alex3FormatearMoneda === "function") {
        return alex3FormatearMoneda(valor);
      }
      const num = Number(valor);
      if (isNaN(num)) return "Q 0.00";
      return "Q " + num.toFixed(2);
    }

    function esMismoDia(a, b) {
      return a.getFullYear() === b.getFullYear() &&
             a.getMonth() === b.getMonth() &&
             a.getDate() === b.getDate();
    }

    function esMismoMes(a, b) {
      return a.getFullYear() === b.getFullYear() &&
             a.getMonth() === b.getMonth();
    }

    function formatearFechaLocal(fechaIso) {
      const d = new Date(fechaIso);
      if (isNaN(d.getTime())) return "-";
      return d.toLocaleString("es-GT");
    }

    // ===== Datos base (inventario, ventas, caja) =====
    let productos = [];
    let ventas = [];
    let movimientosCaja = [];

    if (typeof load === "function") {
      const pData = load("productos", []);
      productos = Array.isArray(pData) ? pData : [];

      const vData = load("ventas", []);
      ventas = Array.isArray(vData) ? vData : [];

      const mData = load("caja_movimientos", []);
      movimientosCaja = Array.isArray(mData) ? mData : [];
    }

    function guardarProductos() {
      if (typeof save === "function") {
        save("productos", productos);
      }
    }

    function guardarVentas() {
      if (typeof save === "function") {
        save("ventas", ventas);
      }
    }

    function guardarMovimientosCaja() {
      if (typeof save === "function") {
        save("caja_movimientos", movimientosCaja);
        save("movimientosCaja", movimientosCaja); // compatibilidad con otros m√≥dulos
      }
    }

    // ===== Carrito =====
    let carrito = []; // {codigo, nombre, precio, cantidad, subtotal}

    function recalcularTotalCarrito() {
      const total = carrito.reduce((acc, item) => acc + item.subtotal, 0);
      const lblTotal = document.getElementById("lbl-total-carrito");
      if (lblTotal) {
        lblTotal.textContent = alex3FormatearMonedaSeguro(total);
      }
      return total;
    }

    function renderCarrito() {
      const tbody = document.getElementById("tabla-carrito");
      tbody.innerHTML = "";

      if (!carrito.length) {
        tbody.innerHTML = `
          <tr>
            <td colspan="5" class="table-empty">
              A√∫n no hay productos en el carrito.
            </td>
          </tr>
        `;
        recalcularTotalCarrito();
        return;
      }

      carrito.forEach((item, index) => {
        tbody.innerHTML += `
          <tr>
            <td>${item.nombre}</td>
            <td>${item.cantidad}</td>
            <td>${alex3FormatearMonedaSeguro(item.precio)}</td>
            <td>${alex3FormatearMonedaSeguro(item.subtotal)}</td>
            <td>
              <button class="btn" data-remove-index="${index}">üóëÔ∏è</button>
            </td>
          </tr>
        `;
      });

      recalcularTotalCarrito();
    }

    // Eliminar item del carrito
    document.getElementById("tabla-carrito").addEventListener("click", (e) => {
      const btn = e.target.closest("button[data-remove-index]");
      if (!btn) return;
      const idx = parseInt(btn.getAttribute("data-remove-index"));
      if (isNaN(idx)) return;
      carrito.splice(idx, 1);
      renderCarrito();
    });

    // ===== B√∫squeda de productos =====
    const inputBuscarTexto = document.getElementById("buscarTexto");
    const btnBuscarProducto = document.getElementById("btnBuscarProducto");
    const tablaResultados = document.getElementById("tabla-resultados-productos");

    function buscarProductos() {
      const query = (inputBuscarTexto.value || "").trim().toLowerCase();
      let resultados = [];

      if (!productos.length) {
        tablaResultados.innerHTML = `
          <tr>
            <td colspan="6" class="table-empty">
              No hay productos en el inventario.
            </td>
          </tr>
        `;
        return;
      }

      if (!query) {
        // Sin texto: mostrar primeros 10 productos
        resultados = productos.slice(0, 10);
      } else {
        resultados = productos.filter(p => {
          const cod = String(p.codigo || "").toLowerCase();
          const nom = String(p.nombre || "").toLowerCase();
          return cod.includes(query) || nom.includes(query);
        });
      }

      if (!resultados.length) {
        tablaResultados.innerHTML = `
          <tr>
            <td colspan="6" class="table-empty">
              No se encontraron productos con ese texto.
            </td>
          </tr>
        `;
        return;
      }

      tablaResultados.innerHTML = "";
      resultados.forEach((p, idx) => {
        const stock = Number(p.stock) || 0;
        const precioVenta = Number(p.venta) || 0;

        tablaResultados.innerHTML += `
          <tr>
            <td>${p.codigo}</td>
            <td>${p.nombre}</td>
            <td>${alex3FormatearMonedaSeguro(precioVenta)}</td>
            <td>${stock}</td>
            <td>
              <input type="number"
                     class="input"
                     style="max-width: 80px;"
                     min="1"
                     max="${stock}"
                     value="1"
                     data-cant-codigo="${p.codigo}">
            </td>
            <td>
              <button class="btn"
                      data-add-codigo="${p.codigo}">
                Agregar
              </button>
            </td>
          </tr>
        `;
      });
    }

    if (btnBuscarProducto) {
      btnBuscarProducto.addEventListener("click", buscarProductos);
    }

    // Buscar tambi√©n al presionar Enter en el campo de texto
    if (inputBuscarTexto) {
      inputBuscarTexto.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          buscarProductos();
        }
      });
    }

    // Agregar producto al carrito
    tablaResultados.addEventListener("click", (e) => {
      const btn = e.target.closest("button[data-add-codigo]");
      if (!btn) return;

      const codigo = btn.getAttribute("data-add-codigo");
      const producto = productos.find(p => String(p.codigo) === String(codigo));
      if (!producto) {
        alert("Producto no encontrado en inventario.");
        return;
      }

      const inputCant = tablaResultados.querySelector(`input[data-cant-codigo="${codigo}"]`);
      let cant = inputCant ? parseInt(inputCant.value) : 1;
      if (isNaN(cant) || cant <= 0) cant = 1;

      const stockDisponible = Number(producto.stock) || 0;
      if (cant > stockDisponible) {
        alert("No hay suficiente stock para esa cantidad.");
        return;
      }

      const precioUnit = Number(producto.venta) || 0;
      const subtotal = cant * precioUnit;

      // Si ya existe en el carrito, solo sumar cantidad
      const existente = carrito.find(item => item.codigo === codigo);
      if (existente) {
        if (existente.cantidad + cant > stockDisponible) {
          alert("No hay suficiente stock para sumar esa cantidad.");
          return;
        }
        existente.cantidad += cant;
        existente.subtotal = existente.cantidad * existente.precio;
      } else {
        carrito.push({
          codigo: producto.codigo,
          nombre: producto.nombre,
          precio: precioUnit,
          cantidad: cant,
          subtotal: subtotal
        });
      }

      renderCarrito();
    });

    // ===== KPIs de ventas =====
    function recalcularKPIsVentas() {
      const hoy = new Date();
      let totalHoy = 0;
      let totalMes = 0;

      ventas.forEach(v => {
        const fecha = new Date(v.fechaHora || v.fecha || Date.now());
        const total = Number(v.total) || 0;

        if (esMismoDia(fecha, hoy)) {
          totalHoy += total;
        }
        if (esMismoMes(fecha, hoy)) {
          totalMes += total;
        }
      });

      const tickets = ventas.length;
      const promedio = tickets > 0 ? totalMes / tickets : 0;

      const elHoy = document.getElementById("kpi-ventas-hoy");
      const elMes = document.getElementById("kpi-ventas-mes");
      const elTickets = document.getElementById("kpi-ventas-tickets");
      const elProm = document.getElementById("kpi-ventas-promedio");

      if (elHoy) elHoy.textContent = alex3FormatearMonedaSeguro(totalHoy);
      if (elMes) elMes.textContent = alex3FormatearMonedaSeguro(totalMes);
      if (elTickets) elTickets.textContent = String(tickets);
      if (elProm) elProm.textContent = alex3FormatearMonedaSeguro(promedio);
    }

    // ===== Tabla de ventas =====
    function renderTablaVentas() {
      const tbody = document.getElementById("tabla-ventas-body");
      if (!tbody) return;

      tbody.innerHTML = "";

      if (!ventas.length) {
        tbody.innerHTML = `
          <tr>
            <td colspan="5" class="table-empty">
              A√∫n no hay ventas registradas.
            </td>
          </tr>
        `;
        return;
      }

      const ordenadas = [...ventas].sort((a, b) => {
        const fa = new Date(a.fechaHora || a.fecha || 0).getTime();
        const fb = new Date(b.fechaHora || b.fecha || 0).getTime();
        return fb - fa;
      });

      ordenadas.forEach(v => {
        const fechaTxt = v.fecha || formatearFechaLocal(v.fechaHora || "");
        const doc = v.documento || "-";
        const cliente = v.cliente || "Contado";
        const forma = v.formaPago || "-";
        const totalTxt = alex3FormatearMonedaSeguro(v.total);

        tbody.innerHTML += `
          <tr>
            <td>${fechaTxt}</td>
            <td>${doc}</td>
            <td>${cliente}</td>
            <td>${forma}</td>
            <td>${totalTxt}</td>
          </tr>
        `;
      });
    }

    // ===== Confirmar venta =====
    const btnConfirmarVenta = document.getElementById("btnConfirmarVenta");

    function confirmarVenta() {
      if (!carrito.length) {
        alert("Agrega al menos un producto al carrito antes de confirmar la venta.");
        return;
      }

      const total = recalcularTotalCarrito();
      if (total <= 0) {
        alert("El total de la venta debe ser mayor a cero.");
        return;
      }

      const inputFecha = document.getElementById("vFecha");
      const inputCliente = document.getElementById("vCliente");
      const inputDoc = document.getElementById("vDocumento");
      const inputForma = document.getElementById("vFormaPago");
      const inputNotas = document.getElementById("vNotas");

      const fechaVal = inputFecha.value;
      let fechaObj;
      if (fechaVal) {
        fechaObj = new Date(fechaVal);
      } else {
        fechaObj = new Date();
      }
      if (isNaN(fechaObj.getTime())) fechaObj = new Date();

      const fechaLocal = fechaObj.toLocaleString("es-GT");
      const fechaIso = fechaObj.toISOString();

      const cliente = inputCliente.value.trim() || "Cliente contado";
      const documento = inputDoc.value;
      const formaPago = inputForma.value;
      const notas = inputNotas.value.trim();

      if (!documento) {
        alert("Selecciona un tipo de documento.");
        return;
      }
      if (!formaPago) {
        alert("Selecciona una forma de pago.");
        return;
      }

      // Validar stock antes de confirmar
      for (const item of carrito) {
        const prod = productos.find(p => String(p.codigo) === String(item.codigo));
        const stockActual = prod ? Number(prod.stock) || 0 : 0;
        if (!prod || item.cantidad > stockActual) {
          alert("El producto " + item.nombre + " ya no tiene stock suficiente.");
          return;
        }
      }

      // Actualizar inventario (restar stock)
      carrito.forEach(item => {
        const prod = productos.find(p => String(p.codigo) === String(item.codigo));
        if (!prod) return;
        const stockActual = Number(prod.stock) || 0;
        prod.stock = stockActual - item.cantidad;
      });
      guardarProductos();

      // Construir venta
      const venta = {
        id: "venta_" + Date.now(),
        fecha: fechaLocal,
        fechaHora: fechaIso,
        cliente,
        documento,
        formaPago,
        total: total,
        notas,
        items: carrito.map(item => ({
          codigo: item.codigo,
          nombre: item.nombre,
          cantidad: item.cantidad,
          precio: item.precio,
          subtotal: item.subtotal
        })),
        origen: "venta_inventario",
        usuario: usuarioActual ? usuarioActual.usuario : null
      };

      ventas.push(venta);
      guardarVentas();

      // Registrar movimiento de caja si es EFECTIVO
      if (formaPago === "EFECTIVO") {
        const mov = {
          id: "caja_venta_" + Date.now(),
          fechaHora: fechaIso,
          fecha: fechaLocal,
          tipo: "INGRESO",
          categoria: "Ventas en efectivo",
          descripcion: `Venta a ${cliente}`,
          monto: total,
          origen: "venta",
          ventaId: venta.id,
          usuario: usuarioActual ? usuarioActual.usuario : null
        };
        movimientosCaja.push(mov);
        guardarMovimientosCaja();
      }

      // Limpiar carrito y formulario
      carrito = [];
      renderCarrito();

      inputFecha.value = "";
      inputCliente.value = "";
      inputDoc.value = "Ticket interno";
      inputForma.value = "EFECTIVO";
      inputNotas.value = "";

      // Refrescar KPI y tabla
      recalcularKPIsVentas();
      renderTablaVentas();

      alert("Venta registrada correctamente.");
    }

    if (btnConfirmarVenta) {
      btnConfirmarVenta.addEventListener("click", confirmarVenta);
    }

    // ===== Primera carga =====
    // Prellenar fecha con ahora
    const inputFechaVenta = document.getElementById("vFecha");
    if (inputFechaVenta) {
      const ahora = new Date();
      const isoLocal = new Date(ahora.getTime() - ahora.getTimezoneOffset() * 60000)
        .toISOString()
        .slice(0, 16);
      inputFechaVenta.value = isoLocal;
    }

    renderCarrito();
    recalcularKPIsVentas();
    renderTablaVentas();
  </script>
</body>
</html>
