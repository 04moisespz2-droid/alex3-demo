<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Ventas - ALEX 3.0</title>
  <link rel="stylesheet" href="styles.css">
</head>

<body class="dashboard-body">

  <div class="sidebar">
    <h2 class="logo">ALEX 3.0</h2>
    <ul class="menu">
      <li id="menu-dashboard"><a href="dashboard.html">ğŸ  Inicio</a></li>
      <li id="menu-inventario"><a href="inventario.html">ğŸ“¦ Inventario</a></li>
      <li id="menu-ventas"><a href="ventas.html">ğŸ’µ Ventas</a></li>
      <li id="menu-caja"><a href="caja.html">ğŸ’° Caja</a></li>
      <li id="menu-usuarios"><a href="usuarios.html">ğŸ‘¤ Usuarios</a></li>
      <li id="menu-reportes"><a href="reportes.html">ğŸ“Š Reportes</a></li>
    </ul>
  </div>

  <div class="main-content">
    <h1>Ventas (POS)</h1>

    <div class="inventario-form">
      <h3>Agregar producto a la venta</h3>

      <input id="ventaNombre" class="input" type="text" placeholder="Nombre del producto">
      <input id="ventaPrecio" class="input" type="number" step="0.01" placeholder="Precio unitario">
      <input id="ventaCantidad" class="input" type="number" step="1" placeholder="Cantidad">

      <button class="btn" onclick="agregarLineaVenta()">Agregar a la venta</button>
    </div>

    <table class="tabla">
      <thead>
        <tr>
          <th>Producto</th>
          <th>Precio</th>
          <th>Cantidad</th>
          <th>Subtotal</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody id="tabla-ventas-body"></tbody>
    </table>

    <h2>Total: <span id="totalVenta">0.00</span></h2>
  </div>

  <script src="alex-storage.js"></script>
  <script src="alex-dev.js"></script>
  <script src="alex-roles.js"></script>

  <script>
    const usuarioActual = getUsuarioActualObligatorio();
    aplicarPermisosYProteger("ventas");

    let lineasVenta = load("ventasActivas", []);

    function formatearMoneda(n) {
      return alex3FormatearMoneda(n);
    }

    function agregarLineaVenta() {
      const nombre = document.getElementById("ventaNombre").value.trim();
      const precio = parseFloat(document.getElementById("ventaPrecio").value);
      const cantidad = parseInt(document.getElementById("ventaCantidad").value);

      if (!nombre || isNaN(precio) || precio <= 0 || isNaN(cantidad) || cantidad <= 0) {
        alert("Ingresa un nombre vÃ¡lido, un precio mayor a 0 y una cantidad mayor a 0.");
        return;
      }

      const subtotal = precio * cantidad;
      const linea = { nombre, precio, cantidad, subtotal };

      lineasVenta.push(linea);
      save("ventasActivas", lineasVenta);

      limpiarFormularioVenta();
      renderTablaVentas();
    }

    function limpiarFormularioVenta() {
      document.getElementById("ventaNombre").value = "";
      document.getElementById("ventaPrecio").value = "";
      document.getElementById("ventaCantidad").value = "";
      document.getElementById("ventaNombre").focus();
    }

    function renderTablaVentas() {
      const tbody = document.getElementById("tabla-ventas-body");
      if (!tbody) return;

      tbody.innerHTML = "";
      let total = 0;

      lineasVenta.forEach((l, index) => {
        total += l.subtotal;

        tbody.innerHTML += `
          <tr>
            <td>${l.nombre}</td>
            <td>${formatearMoneda(l.precio)}</td>
            <td>${l.cantidad}</td>
            <td>${formatearMoneda(l.subtotal)}</td>
            <td><button onclick="eliminarLinea(${index})">ğŸ—‘ï¸</button></td>
          </tr>
        `;
      });

      document.getElementById("totalVenta").innerText = formatearMoneda(total);
    }

    function eliminarLinea(index) {
      if (!confirm("Â¿Eliminar esta lÃ­nea de venta?")) return;
      lineasVenta.splice(index, 1);
      save("ventasActivas", lineasVenta);
      renderTablaVentas();
    }

    // Inicializar tabla
    renderTablaVentas();
  </script>

</body>
</html>
