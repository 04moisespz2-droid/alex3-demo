<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>ALEX 3.0 - Ventas</title>
  <link rel="stylesheet" href="styles.css">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>

<body class="dashboard-body">
  <!-- Sidebar (MISMO DISEÃ‘O, SOLO CAMBIA LA PESTAÃ‘A ACTIVA) -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <span class="logo-badge">A</span>
      <div class="sidebar-logo-text">
        <span class="sidebar-logo-main">ALEX 3.0</span>
        <span class="sidebar-logo-sub">Panel del negocio</span>
      </div>
    </div>

    <nav class="sidebar-nav">
      <a href="dashboard.html" class="sidebar-link">ğŸ“Š Dashboard</a>
      <a href="ventas.html" class="sidebar-link active">ğŸ’µ Ventas</a>
      <a href="inventario.html" class="sidebar-link">ğŸ“¦ Inventario</a>
      <a href="caja.html" class="sidebar-link">ğŸ’° Caja</a>
      <a href="compras.html" class="sidebar-link">ğŸ§¾ Compras</a>
      <a href="gastos.html" class="sidebar-link">ğŸ“‰ Gastos</a>
      <a href="clientes.html" class="sidebar-link">ğŸ‘¥ Clientes</a>
      <a href="proveedores.html" class="sidebar-link">ğŸšš Proveedores</a>
      <a href="contabilidad.html" class="sidebar-link">ğŸ“š Contabilidad</a>
      <a href="sat.html" class="sidebar-link">ğŸ‡¬ğŸ‡¹ SAT Guatemala</a>
      <a href="ia.html" class="sidebar-link">ğŸ¤– IA empresarial</a>
      <a href="configuracion.html" class="sidebar-link">âš™ï¸ ConfiguraciÃ³n</a>
    </nav>

    <div class="sidebar-footer">
      <span class="sidebar-footer-title">Empresa demo</span>
      <span class="sidebar-footer-sub">VersiÃ³n 1.0</span>
    </div>
  </aside>

  <!-- Layout principal -->
  <div class="main-layout">
    <!-- Topbar -->
    <header class="topbar">
      <button class="btn-menu-mobile" id="btnMenuMobile">â˜°</button>

      <div class="topbar-left">
        <h1 class="topbar-title">Ventas</h1>
        <p class="topbar-subtitle">Registra y revisa todas las ventas del negocio.</p>
      </div>

      <div class="topbar-right">
        <span class="topbar-company">Mi tienda demo</span>
        <span class="topbar-divider">â€¢</span>
        <span class="topbar-user">Brayan (DueÃ±o)</span>
      </div>
    </header>

    <!-- Contenido principal -->
    <main class="main-content">
      <!-- Resumen de ventas -->
      <section class="cards-grid">
        <article class="card kpi-card">
          <h2 class="card-title">Ventas de hoy</h2>
          <p class="card-kpi" id="kpi-ventas-hoy">Q 0.00</p>
          <p class="card-kpi-sub">Incluye efectivo, tarjeta y transferencias.</p>
        </article>

        <article class="card kpi-card">
          <h2 class="card-title">Ventas del mes</h2>
          <p class="card-kpi" id="kpi-ventas-mes">Q 0.00</p>
          <p class="card-kpi-sub">Resumen de todas las ventas facturadas.</p>
        </article>

        <article class="card kpi-card">
          <h2 class="card-title">Tickets emitidos</h2>
          <p class="card-kpi" id="kpi-tickets">0</p>
          <p class="card-kpi-sub">Cantidad de comprobantes en el sistema.</p>
        </article>

        <article class="card kpi-card">
          <h2 class="card-title">Promedio por venta</h2>
          <p class="card-kpi" id="kpi-promedio">Q 0.00</p>
          <p class="card-kpi-sub">Total vendido / nÃºmero de ventas.</p>
        </article>
      </section>

      <!-- Registrar venta rÃ¡pida (versiÃ³n sencilla) -->
      <section class="card">
        <h2 class="card-title">Registrar venta rÃ¡pida</h2>
        <p class="card-description">
          Esta es una versiÃ³n sencilla para guardar ventas rÃ¡pidas. MÃ¡s adelante se puede conectar
          con productos del inventario y facturaciÃ³n SAT.
        </p>

        <div class="form-grid">
          <div class="form-field">
            <label for="venta-cliente">Cliente (opcional)</label>
            <input id="venta-cliente" type="text" class="input" placeholder="Cliente final / Consumidor">
          </div>

          <div class="form-field">
            <label for="venta-forma-pago">Forma de pago</label>
            <select id="venta-forma-pago" class="input">
              <option value="Efectivo">Efectivo</option>
              <option value="Tarjeta">Tarjeta</option>
              <option value="Transferencia">Transferencia</option>
              <option value="DepÃ³sito">DepÃ³sito</option>
              <option value="Otro">Otro</option>
            </select>
          </div>

          <div class="form-field">
            <label for="venta-total">Total (Q)</label>
            <input id="venta-total" type="number" class="input" placeholder="0.00" step="0.01" min="0">
          </div>
        </div>

        <button class="btn" id="btn-registrar-venta">Guardar venta</button>
      </section>

      <!-- Tabla de ventas -->
      <section class="card">
        <h2 class="card-title">Ãšltimas ventas registradas</h2>
        <p class="card-description">
          AquÃ­ aparecen las ventas mÃ¡s recientes registradas en el sistema.
        </p>

        <table class="table">
          <thead>
            <tr>
              <th>Fecha</th>
              <th>Documento</th>
              <th>Cliente</th>
              <th>Forma de pago</th>
              <th>Total</th>
            </tr>
          </thead>
          <tbody id="tabla-ventas-body">
            <tr>
              <td colspan="5" class="table-empty">
                AÃºn no hay ventas registradas.
              </td>
            </tr>
          </tbody>
        </table>
      </section>
    </main>
  </div>

  <!-- Scripts base -->
  <script src="alex-storage.js"></script>
  <script src="alex-roles.js"></script>

  <script>
    // MenÃº mÃ³vil
    const btnMenuMobile = document.getElementById('btnMenuMobile');
    const sidebar = document.querySelector('.sidebar');

    if (btnMenuMobile) {
      btnMenuMobile.addEventListener('click', () => {
        sidebar.classList.toggle('sidebar-open');
      });
    }

    // Usuario y permisos
    const usuarioActual = typeof getUsuarioActualObligatorio === "function"
      ? getUsuarioActualObligatorio()
      : null;

    if (typeof aplicarPermisosYProteger === "function") {
      aplicarPermisosYProteger("ventas");
    }

    // Cargar ventas desde almacenamiento
    let ventas = [];
    if (typeof load === "function") {
      const data = load("ventas", []);
      ventas = Array.isArray(data) ? data : [];
    }

    // Formateador de moneda seguro
    function alex3FormatearMonedaSeguro(valor) {
      if (typeof alex3FormatearMoneda === "function") {
        return alex3FormatearMoneda(valor);
      }
      const num = Number(valor);
      if (isNaN(num)) return "Q0.00";
      return "Q" + num.toFixed(2);
    }

    function formatearFechaBonita(fechaIso) {
      const d = new Date(fechaIso);
      if (isNaN(d.getTime())) return "-";
      const dia = String(d.getDate()).padStart(2, "0");
      const mes = String(d.getMonth() + 1).padStart(2, "0");
      const anio = d.getFullYear();
      const horas = String(d.getHours()).padStart(2, "0");
      const mins = String(d.getMinutes()).padStart(2, "0");
      return `${dia}/${mes}/${anio} ${horas}:${mins}`;
    }

    function mismaFecha(d1, d2) {
      return (
        d1.getFullYear() === d2.getFullYear() &&
        d1.getMonth() === d2.getMonth() &&
        d1.getDate() === d2.getDate()
      );
    }

    function mismoMes(d1, d2) {
      return (
        d1.getFullYear() === d2.getFullYear() &&
        d1.getMonth() === d2.getMonth()
      );
    }

    function actualizarKPIs() {
      const hoy = new Date();
      let totalHoy = 0;
      let totalMes = 0;
      let totalGlobal = 0;
      let conteoVentas = ventas.length;

      ventas.forEach(v => {
        const fecha = new Date(v.fecha || v.fechaHora || Date.now());
        const total = Number(v.total) || 0;
        totalGlobal += total;

        if (mismaFecha(fecha, hoy)) {
          totalHoy += total;
        }
        if (mismoMes(fecha, hoy)) {
          totalMes += total;
        }
      });

      const promedio = conteoVentas > 0 ? (totalGlobal / conteoVentas) : 0;

      document.getElementById("kpi-ventas-hoy").textContent = alex3FormatearMonedaSeguro(totalHoy);
      document.getElementById("kpi-ventas-mes").textContent = alex3FormatearMonedaSeguro(totalMes);
      document.getElementById("kpi-tickets").textContent = String(conteoVentas);
      document.getElementById("kpi-promedio").textContent = alex3FormatearMonedaSeguro(promedio);
    }

    function renderTablaVentas() {
      const tbody = document.getElementById("tabla-ventas-body");
      tbody.innerHTML = "";

      if (!ventas.length) {
        tbody.innerHTML = `
          <tr>
            <td colspan="5" class="table-empty">
              AÃºn no hay ventas registradas.
            </td>
          </tr>
        `;
        return;
      }

      // Mostrar ventas mÃ¡s recientes primero
      const ventasOrdenadas = [...ventas].sort((a, b) => {
        const fa = new Date(a.fecha || a.fechaHora || 0).getTime();
        const fb = new Date(b.fecha || b.fechaHora || 0).getTime();
        return fb - fa;
      });

      ventasOrdenadas.forEach(v => {
        const fecha = formatearFechaBonita(v.fecha || v.fechaHora || new Date().toISOString());
        const doc = v.documento || v.serie || v.numero || "TICKET";
        const cliente = v.cliente || "Consumidor final";
        const formaPago = v.formaPago || "N/D";
        const totalFmt = alex3FormatearMonedaSeguro(v.total);

        const fila = `
          <tr>
            <td>${fecha}</td>
            <td>${doc}</td>
            <td>${cliente}</td>
            <td>${formaPago}</td>
            <td>${totalFmt}</td>
          </tr>
        `;
        tbody.innerHTML += fila;
      });
    }

    function guardarVentas() {
      if (typeof save === "function") {
        save("ventas", ventas);
      }
    }

    function registrarVentaRapida() {
      const inputCliente = document.getElementById("venta-cliente");
      const selectFormaPago = document.getElementById("venta-forma-pago");
      const inputTotal = document.getElementById("venta-total");

      const cliente = inputCliente.value.trim() || "Consumidor final";
      const formaPago = selectFormaPago.value;
      const totalNum = parseFloat(inputTotal.value);

      if (isNaN(totalNum) || totalNum <= 0) {
        alert("Ingresa un total vÃ¡lido para la venta.");
        return;
      }

      const ahora = new Date();
      const correlativo = ventas.length + 1;
      const documento = "T-" + String(correlativo).padStart(4, "0");

      const nuevaVenta = {
        fecha: ahora.toISOString(),
        documento: documento,
        cliente: cliente,
        formaPago: formaPago,
        total: totalNum
      };

      ventas.push(nuevaVenta);
      guardarVentas();
      renderTablaVentas();
      actualizarKPIs();

      inputCliente.value = "";
      inputTotal.value = "";

      alert("Venta registrada correctamente.");
    }

    // Eventos
    const btnRegistrarVenta = document.getElementById("btn-registrar-venta");
    if (btnRegistrarVenta) {
      btnRegistrarVenta.addEventListener("click", registrarVentaRapida);
    }

    // Primera carga
    renderTablaVentas();
    actualizarKPIs();
  </script>
</body>
</html>
