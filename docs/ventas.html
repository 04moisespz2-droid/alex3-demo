<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>ALEX 3.0 - Ventas</title>
  <link rel="stylesheet" href="styles.css">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>

<body class="dashboard-body">
  <!-- Sidebar (mismo dise√±o que los dem√°s m√≥dulos) -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <span class="logo-badge">A</span>
      <div class="sidebar-logo-text">
        <span class="sidebar-logo-main">ALEX 3.0</span>
        <span class="sidebar-logo-sub">Panel del negocio</span>
      </div>
    </div>

    <nav class="sidebar-nav">
      <a href="dashboard.html" class="sidebar-link">üìä Dashboard</a>
      <a href="ventas.html" class="sidebar-link active">üíµ Ventas</a>
      <a href="inventario.html" class="sidebar-link">üì¶ Inventario</a>
      <a href="caja.html" class="sidebar-link">üí∞ Caja</a>
      <a href="compras.html" class="sidebar-link">üßæ Compras</a>
      <a href="gastos.html" class="sidebar-link">üìâ Gastos</a>
      <a href="clientes.html" class="sidebar-link">üë• Clientes</a>
      <a href="proveedores.html" class="sidebar-link">üöö Proveedores</a>
      <a href="reportes.html" class="sidebar-link">üìö Reportes</a>
      <a href="ia.html" class="sidebar-link">ü§ñ IA empresarial</a>
      <a href="configuracion.html" class="sidebar-link">‚öôÔ∏è Configuraci√≥n</a>
    </nav>

    <div class="sidebar-footer">
      <span class="sidebar-footer-title">Mi negocio</span>
      <span class="sidebar-footer-sub">M√≥dulo de ventas</span>
    </div>
  </aside>

  <!-- Layout principal -->
  <div class="main-layout">
    <!-- Topbar -->
    <header class="topbar">
      <button class="btn-menu-mobile" id="btnMenuMobile">‚ò∞</button>

      <div class="topbar-left">
        <h1 class="topbar-title">Ventas</h1>
        <p class="topbar-subtitle">
          Registra ventas reales y deja que ALEX actualice caja, inventario y dashboard autom√°ticamente.
        </p>
      </div>

      <div class="topbar-right">
        <span class="topbar-company">Mi negocio</span>
        <span class="topbar-divider">‚Ä¢</span>
        <span class="topbar-user" id="topbar-user-label">Usuario (Rol)</span>
      </div>
    </header>

    <!-- Contenido principal -->
    <main class="main-content">
      <!-- KPIs de ventas -->
      <section class="cards-grid">
        <article class="card kpi-card">
          <h2 class="card-title">Ventas de hoy</h2>
          <p class="card-kpi" id="kpi-ventas-hoy">Q 0.00</p>
          <p class="card-kpi-sub">Total de ventas registradas hoy.</p>
        </article>

        <article class="card kpi-card">
          <h2 class="card-title">Ventas del mes</h2>
          <p class="card-kpi" id="kpi-ventas-mes">Q 0.00</p>
          <p class="card-kpi-sub">Sumatoria del mes actual (todas las formas de pago).</p>
        </article>

        <article class="card kpi-card">
          <h2 class="card-title">Tickets emitidos</h2>
          <p class="card-kpi" id="kpi-ventas-cantidad">0</p>
          <p class="card-kpi-sub">N√∫mero de ventas registradas.</p>
        </article>

        <article class="card kpi-card">
          <h2 class="card-title">Promedio por venta</h2>
          <p class="card-kpi" id="kpi-ventas-promedio">Q 0.00</p>
          <p class="card-kpi-sub">Ventas del mes / tickets.</p>
        </article>
      </section>

      <!-- Formulario de nueva venta + carrito -->
      <section class="card">
        <h2 class="card-title">1. Registrar una nueva venta</h2>
        <p class="card-description">
          Puedes vender productos por unidad, productos por peso (lb/kg) y servicios,
          seg√∫n lo que tengas configurado en tu inventario.
        </p>

        <div class="form-grid">
          <div class="form-field">
            <label for="vFecha">Fecha y hora</label>
            <input id="vFecha" class="input" type="datetime-local">
          </div>

          <div class="form-field">
            <label for="vClienteSelect">Cliente guardado</label>
            <select id="vClienteSelect" class="input">
              <option value="">-- Selecciona cliente --</option>
            </select>
          </div>

          <div class="form-field">
            <label for="vClienteTexto">Cliente (texto libre)</label>
            <input id="vClienteTexto" class="input" type="text"
                   placeholder="Si no est√° en la lista, escribe el nombre aqu√≠">
          </div>

          <div class="form-field">
            <label for="vDocumentoTipo">Tipo de documento</label>
            <select id="vDocumentoTipo" class="input">
              <option value="Ticket">Ticket</option>
              <option value="Factura">Factura</option>
              <option value="Recibo">Recibo</option>
              <option value="Nota">Nota de venta</option>
              <option value="Otro">Otro</option>
            </select>
          </div>

          <div class="form-field">
            <label for="vDocumentoNumero">N√∫mero de documento</label>
            <input id="vDocumentoNumero" class="input" type="text"
                   placeholder="Ej: T-001, F001-12345 (opcional)">
          </div>

          <!-- C√ìDIGO + CANTIDAD (para usar productos del inventario) -->
          <div class="form-field">
            <label for="vCodigoProducto">C√≥digo / c√≥digo de barras</label>
            <input id="vCodigoProducto" class="input" type="text"
                   placeholder="Escribe o escanea el c√≥digo del √≠tem">
          </div>

          <div class="form-field">
            <label for="vCantidadProducto">Cantidad / peso</label>
            <input id="vCantidadProducto" class="input" type="number"
                   min="0.01" step="0.01" value="1">
          </div>

          <div class="form-field">
            <label for="vMonto">Monto total (Q)</label>
            <input id="vMonto" class="input" type="number" min="0" step="0.01"
                   placeholder="Se llena autom√°ticamente con el carrito (o escr√≠belo si es un servicio suelto)">
          </div>

          <div class="form-field">
            <label for="vFormaPago">Forma de pago</label>
            <select id="vFormaPago" class="input">
              <option value="EFECTIVO">Efectivo</option>
              <option value="TRANSFERENCIA">Transferencia</option>
              <option value="TARJETA">Tarjeta</option>
              <option value="MIXTO">Mixto (efectivo + otro)</option>
              <option value="CREDITO_CLIENTE">Cr√©dito / fiado</option>
            </select>
          </div>

          <div class="form-field" id="campoMontoEfectivo" style="display: none;">
            <label for="vMontoEfectivo">Parte en efectivo (Q)</label>
            <input id="vMontoEfectivo" class="input" type="number" min="0" step="0.01"
                   placeholder="Solo si la venta es mixta">
          </div>

          <div class="form-field" style="grid-column: 1 / -1;">
            <label for="vNotas">Notas (opcional)</label>
            <input id="vNotas" class="input" type="text"
                   placeholder="Ej: Incluye env√≠o, promoci√≥n, cliente nuevo, etc.">
          </div>
        </div>

        <!-- Esc√°ner con c√°mara -->
        <button class="btn" id="btnEscanearCamara" style="margin-top: 0.5rem;">
          üì∑ Escanear c√≥digo con c√°mara
        </button>

        <div id="scannerContainer"
             style="display:none; margin-top:0.75rem; padding:0.75rem; border-radius:0.75rem; border:1px solid #ddd;">
          <p class="card-description" style="margin-bottom:0.5rem;">
            Apunta la c√°mara al c√≥digo de barras. Al detectar un √≠tem del inventario, se agregar√° al carrito.
          </p>
          <video id="videoScanner" autoplay playsinline
                 style="width:100%; max-height:260px; border-radius:0.75rem; background:#000;"></video>
          <button class="btn btn-small" id="btnCerrarScanner" type="button" style="margin-top:0.5rem;">
            Cerrar c√°mara
          </button>
        </div>

        <!-- Carrito de productos -->
        <h3 class="card-title" style="margin-top:1.25rem;">2. Carrito de √≠tems de esta venta</h3>
        <p class="card-description">
          Escanea o escribe el c√≥digo y presiona Enter para agregar √≠tems. ALEX respetar√° si es por unidad, por peso o servicio.
        </p>

        <table class="table">
          <thead>
            <tr>
              <th>C√≥digo</th>
              <th>√çtem</th>
              <th>Cantidad / Peso</th>
              <th>Precio (Q)</th>
              <th>Subtotal (Q)</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="carrito-body">
            <tr>
              <td colspan="6" class="table-empty">
                A√∫n no hay √≠tems en el carrito.
              </td>
            </tr>
          </tbody>
        </table>

        <div style="text-align:right; margin-top:0.5rem;">
          <strong>Total de esta venta:</strong>
          <span id="total-carrito">Q 0.00</span>
        </div>

        <button class="btn" id="btnGuardarVenta" style="margin-top: 0.75rem;">
          Guardar venta y actualizar caja
        </button>
      </section>

      <!-- Historial de ventas -->
      <section class="card">
        <h2 class="card-title">3. √öltimas ventas registradas</h2>
        <p class="card-description">
          Las ventas m√°s recientes aparecen primero. Puedes buscar por cliente, documento o notas.
        </p>

        <div class="form-grid" style="margin-bottom: 0.75rem;">
          <div class="form-field" style="grid-column: 1 / -1;">
            <label for="buscarVenta">Buscar venta</label>
            <input id="buscarVenta" class="input" type="text"
                   placeholder="Escribe parte del cliente, documento o notas">
          </div>
        </div>

        <table class="table">
          <thead>
            <tr>
              <th>Fecha</th>
              <th>Cliente</th>
              <th>Documento</th>
              <th>Forma de pago</th>
              <th>Total</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="tabla-ventas-body">
            <tr>
              <td colspan="6" class="table-empty">
                A√∫n no hay ventas registradas.
              </td>
            </tr>
          </tbody>
        </table>
      </section>
    </main>
  </div>

  <!-- Scripts base -->
  <script src="alex-storage.js"></script>
  <script src="alex-roles.js"></script>
  <!-- Librer√≠a ZXing para leer c√≥digos de barras con la c√°mara -->
  <script src="https://unpkg.com/@zxing/library@0.20.0"></script>

  <script>
    // ===== Men√∫ m√≥vil =====
    const btnMenuMobile = document.getElementById('btnMenuMobile');
    const sidebar = document.querySelector('.sidebar');
    if (btnMenuMobile) {
      btnMenuMobile.addEventListener('click', () => {
        sidebar.classList.toggle('sidebar-open');
      });
    }

    // ===== Usuario y permisos =====
    const usuarioActual = typeof getUsuarioActualObligatorio === "function"
      ? getUsuarioActualObligatorio()
      : null;

    if (typeof aplicarPermisosYProteger === "function") {
      aplicarPermisosYProteger("ventas");
    }

    const labelUser = document.getElementById("topbar-user-label");
    if (usuarioActual && labelUser) {
      const rolTexto = usuarioActual.rol === "dueno" ? "Due√±o" : "Empleado";
      labelUser.textContent = `${usuarioActual.nombre} (${rolTexto})`;
    }

    // ===== Helpers =====
    function alex3FormatearMonedaSeguro(valor) {
      if (typeof alex3FormatearMoneda === "function") {
        return alex3FormatearMoneda(valor);
      }
      const num = Number(valor);
      if (isNaN(num)) return "Q 0.00";
      return "Q " + num.toFixed(2);
    }

    function esMismoDia(a, b) {
      return a.getFullYear() === b.getFullYear() &&
             a.getMonth() === b.getMonth() &&
             a.getDate() === b.getDate();
    }

    function esMismoMes(a, b) {
      return a.getFullYear() === b.getFullYear() &&
             a.getMonth() === b.getMonth();
    }

    function formatearFechaLocal(fechaIso) {
      const d = new Date(fechaIso);
      if (isNaN(d.getTime())) return "-";
      return d.toLocaleString("es-GT");
    }

    function textoTipoItem(tipo) {
      switch (tipo) {
        case "unidad": return "Producto por unidad";
        case "peso": return "Producto por peso";
        case "servicio": return "Servicio";
        default: return "Producto";
      }
    }

    function textoUnidadPeso(unidadPeso) {
      if (unidadPeso === "kg") return "KG";
      if (unidadPeso === "lb") return "LB";
      return "";
    }

    // ===== Datos base: ventas, clientes, caja, productos, carrito =====
    let ventas = [];
    let clientes = [];
    let movimientosCaja = [];
    let productos = [];
    let carrito = [];

    if (typeof load === "function") {
      const vData = load("ventas", []);
      ventas = Array.isArray(vData) ? vData : [];

      const cData = load("clientes", []);
      clientes = Array.isArray(cData) ? cData : [];

      const m1 = load("caja_movimientos", []);
      const m2 = load("movimientosCaja", []);
      if (Array.isArray(m1) && m1.length > 0) {
        movimientosCaja = m1;
      } else if (Array.isArray(m2)) {
        movimientosCaja = m2;
      }

      const pData = load("productos", []);
      if (Array.isArray(pData)) {
        productos = pData.map(p => {
          if (!p.tipoItem) p.tipoItem = "unidad";
          if (!p.unidadPeso && p.tipoItem === "peso") p.unidadPeso = "lb";
          return p;
        });
      }
    }

    function guardarVentas() {
      if (typeof save === "function") {
        save("ventas", ventas);
      }
    }

    function guardarMovimientosCaja() {
      if (typeof save === "function") {
        save("caja_movimientos", movimientosCaja);
        save("movimientosCaja", movimientosCaja);
      }
    }

    function guardarProductos() {
      if (typeof save === "function") {
        save("productos", productos);
      }
    }

    // ===== Controles del DOM =====
    const inpFecha = document.getElementById("vFecha");
    const selCliente = document.getElementById("vClienteSelect");
    const inpClienteTexto = document.getElementById("vClienteTexto");
    const selDocTipo = document.getElementById("vDocumentoTipo");
    const inpDocNumero = document.getElementById("vDocumentoNumero");
    const inpMonto = document.getElementById("vMonto");
    const selFormaPago = document.getElementById("vFormaPago");
    const inpMontoEfectivo = document.getElementById("vMontoEfectivo");
    const campoMontoEfectivo = document.getElementById("campoMontoEfectivo");
    const inpNotas = document.getElementById("vNotas");
    const btnGuardarVenta = document.getElementById("btnGuardarVenta");
    const tbodyVentas = document.getElementById("tabla-ventas-body");
    const inputBuscarVenta = document.getElementById("buscarVenta");

    const inpCodigoProducto = document.getElementById("vCodigoProducto");
    const inpCantidadProducto = document.getElementById("vCantidadProducto");
    const tbodyCarrito = document.getElementById("carrito-body");
    const spanTotalCarrito = document.getElementById("total-carrito");

    // C√°mara / esc√°ner
    const btnEscanearCamara = document.getElementById("btnEscanearCamara");
    const scannerContainer = document.getElementById("scannerContainer");
    const videoScanner = document.getElementById("videoScanner");
    const btnCerrarScanner = document.getElementById("btnCerrarScanner");
    let scannerCodeReader = null;

    // ===== Llenar select de clientes =====
    function llenarSelectClientes() {
      if (!selCliente) return;
      selCliente.innerHTML = `<option value="">-- Selecciona cliente --</option>`;
      clientes.forEach(c => {
        const opt = document.createElement("option");
        opt.value = c.id || "";
        opt.textContent = c.nombre || "(Sin nombre)";
        selCliente.appendChild(opt);
      });
    }

    // ===== Mostrar/ocultar campo de monto efectivo para ventas mixtas =====
    if (selFormaPago && campoMontoEfectivo) {
      selFormaPago.addEventListener("change", () => {
        if (selFormaPago.value === "MIXTO") {
          campoMontoEfectivo.style.display = "block";
        } else {
          campoMontoEfectivo.style.display = "none";
          if (inpMontoEfectivo) inpMontoEfectivo.value = "";
        }
      });
    }

    // ===== Buscar producto por c√≥digo =====
    function buscarProductoPorCodigo(codigo) {
      if (!codigo || !Array.isArray(productos)) return null;
      const code = String(codigo).trim().toLowerCase();
      if (!code) return null;
      return productos.find(p => (p.codigo || "").toString().trim().toLowerCase() === code) || null;
    }

    // ===== Carrito =====
    function calcularTotalCarrito() {
      return carrito.reduce((s, item) => {
        const st = Number(item.subtotal) || 0;
        return s + st;
      }, 0);
    }

    function actualizarTotalCarrito() {
      const total = calcularTotalCarrito();
      if (spanTotalCarrito) {
        spanTotalCarrito.textContent = alex3FormatearMonedaSeguro(total);
      }
      if (inpMonto) {
        inpMonto.value = total > 0 ? total.toFixed(2) : "";
      }
    }

    function renderCarrito() {
      if (!tbodyCarrito) return;

      tbodyCarrito.innerHTML = "";

      if (!carrito.length) {
        tbodyCarrito.innerHTML = `
          <tr>
            <td colspan="6" class="table-empty">
              A√∫n no hay √≠tems en el carrito.
            </td>
          </tr>
        `;
        actualizarTotalCarrito();
        return;
      }

      carrito.forEach((item, index) => {
        const precioFmt = alex3FormatearMonedaSeguro(item.precioUnit);
        const subtotalFmt = alex3FormatearMonedaSeguro(item.subtotal);

        let cantidadTxt = "";
        if (item.tipoItem === "peso") {
          const unidadTxt = textoUnidadPeso(item.unidadPeso);
          cantidadTxt = `${item.cantidad.toFixed(2)} ${unidadTxt}`;
        } else {
          cantidadTxt = String(item.cantidad);
        }

        tbodyCarrito.innerHTML += `
          <tr>
            <td>${item.codigo}</td>
            <td>${item.nombre}</td>
            <td>${cantidadTxt}</td>
            <td>${precioFmt}</td>
            <td>${subtotalFmt}</td>
            <td>
              <button class="btn btn-small" data-cart-index="${index}" data-cart-action="menos">‚àí</button>
              <button class="btn btn-small" data-cart-index="${index}" data-cart-action="mas">+</button>
              <button class="btn btn-small" data-cart-index="${index}" data-cart-action="eliminar">üóëÔ∏è</button>
            </td>
          </tr>
        `;
      });

      actualizarTotalCarrito();
    }

    if (tbodyCarrito) {
      tbodyCarrito.addEventListener("click", (e) => {
        const btn = e.target.closest("button[data-cart-index]");
        if (!btn) return;
        const idx = parseInt(btn.getAttribute("data-cart-index"));
        const action = btn.getAttribute("data-cart-action");
        if (isNaN(idx) || !carrito[idx]) return;

        const item = carrito[idx];
        const esPeso = item.tipoItem === "peso";
        const step = esPeso ? 0.10 : 1;

        if (action === "mas") {
          const nuevaCantidad = item.cantidad + step;
          item.cantidad = esPeso ? Number(nuevaCantidad.toFixed(2)) : Math.round(nuevaCantidad);
          item.subtotal = item.cantidad * item.precioUnit;
        } else if (action === "menos") {
          const nuevaCantidad = item.cantidad - step;
          if (esPeso) {
            if (nuevaCantidad <= 0.01) {
              if (confirm("¬øQuitar este √≠tem del carrito?")) {
                carrito.splice(idx, 1);
              }
            } else {
              item.cantidad = Number(nuevaCantidad.toFixed(2));
              item.subtotal = item.cantidad * item.precioUnit;
            }
          } else {
            if (nuevaCantidad < 1) {
              if (confirm("¬øQuitar este √≠tem del carrito?")) {
                carrito.splice(idx, 1);
              }
            } else {
              item.cantidad = Math.round(nuevaCantidad);
              item.subtotal = item.cantidad * item.precioUnit;
            }
          }
        } else if (action === "eliminar") {
          if (confirm("¬øQuitar este √≠tem del carrito?")) {
            carrito.splice(idx, 1);
          }
        }

        renderCarrito();
      });
    }

    // ===== Agregar √≠tem al carrito =====
    function usarProductoEnVenta() {
      if (!inpCodigoProducto) return;

      const codigo = inpCodigoProducto.value.trim();
      if (!codigo) {
        alert("Escribe o escanea un c√≥digo de √≠tem.");
        return;
      }

      const prod = buscarProductoPorCodigo(codigo);

      if (!prod) {
        alert("No se encontr√≥ ning√∫n √≠tem con ese c√≥digo en el inventario. Rev√≠salo en el m√≥dulo de Inventario.");
        return;
      }

      const tipoItem = prod.tipoItem || "unidad";
      const unidadPeso = prod.unidadPeso || null;

      let cantidad = 1;
      if (inpCantidadProducto && inpCantidadProducto.value) {
        const raw = parseFloat(inpCantidadProducto.value);
        if (!isNaN(raw) && raw > 0) {
          if (tipoItem === "peso") {
            cantidad = Math.round(raw * 100) / 100; // 2 decimales
          } else {
            cantidad = Math.max(1, Math.round(raw));
          }
        }
      }

      const precioUnit = Number(prod.venta) || 0;
      if (precioUnit <= 0) {
        alert("El √≠tem encontrado tiene un precio de venta inv√°lido o en 0.");
        return;
      }

      // Si ya existe en carrito, sumamos cantidad (tambi√©n para servicios, por si repiten)
      const existente = carrito.find(item =>
        String(item.codigo).trim().toLowerCase() === String(codigo).trim().toLowerCase()
      );

      if (existente) {
        existente.cantidad += cantidad;
        if (existente.tipoItem === "peso") {
          existente.cantidad = Number(existente.cantidad.toFixed(2));
        } else {
          existente.cantidad = Math.max(1, Math.round(existente.cantidad));
        }
        existente.subtotal = existente.cantidad * existente.precioUnit;
      } else {
        carrito.push({
          codigo: prod.codigo,
          nombre: prod.nombre || "(Sin nombre)",
          tipoItem,
          unidadPeso,
          cantidad,
          precioUnit,
          subtotal: precioUnit * cantidad
        });
      }

      if (inpNotas && !inpNotas.value.trim()) {
        inpNotas.value = `Venta con carrito (primer √≠tem: ${prod.nombre || ""})`;
      }

      // Limpiar inputs de c√≥digo/cantidad para el siguiente √≠tem
      inpCodigoProducto.value = "";
      if (inpCantidadProducto) inpCantidadProducto.value = "1";
      inpCodigoProducto.focus();

      renderCarrito();
    }

    // Enter en campo c√≥digo ‚Üí agregar al carrito
    if (inpCodigoProducto) {
      inpCodigoProducto.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          usarProductoEnVenta();
        }
      });
    }

    // ===== Escaneo con c√°mara (ZXing) =====
    async function iniciarEscaneoCamara() {
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        alert("Este navegador no permite usar la c√°mara para escanear.");
        return;
      }

      if (typeof ZXing === "undefined" || !ZXing.BrowserMultiFormatReader) {
        alert("No se pudo cargar el lector de c√≥digos. Verifica tu conexi√≥n a internet.");
        return;
      }

      try {
        scannerContainer.style.display = "block";

        scannerCodeReader = new ZXing.BrowserMultiFormatReader();

        const devices = await navigator.mediaDevices.enumerateDevices();
        const videoDevices = devices.filter(d => d.kind === "videoinput");
        let deviceId = undefined;

        if (videoDevices.length > 1) {
          deviceId = videoDevices[videoDevices.length - 1].deviceId;
        } else if (videoDevices.length === 1) {
          deviceId = videoDevices[0].deviceId;
        }

        await scannerCodeReader.decodeFromVideoDevice(deviceId, videoScanner, (result, err) => {
          if (result) {
            const text = result.getText ? result.getText() : result.text || "";
            if (text) {
              inpCodigoProducto.value = text;
              usarProductoEnVenta();
              detenerEscaneoCamara();
            }
          }
        });
      } catch (e) {
        console.error(e);
        alert("No se pudo iniciar la c√°mara o el escaneo.");
        detenerEscaneoCamara();
      }
    }

    function detenerEscaneoCamara() {
      if (scannerCodeReader) {
        try {
          scannerCodeReader.reset();
        } catch (e) {
          console.error(e);
        }
        scannerCodeReader = null;
      }
      if (scannerContainer) {
        scannerContainer.style.display = "none";
      }
    }

    if (btnEscanearCamara) {
      btnEscanearCamara.addEventListener("click", (e) => {
        e.preventDefault();
        iniciarEscaneoCamara();
      });
    }

    if (btnCerrarScanner) {
      btnCerrarScanner.addEventListener("click", (e) => {
        e.preventDefault();
        detenerEscaneoCamara();
      });
    }

    // ===== KPIs de ventas =====
    function recalcularKPIsVentas() {
      const hoy = new Date();
      let totalHoy = 0;
      let totalMes = 0;

      ventas.forEach(v => {
        const fecha = new Date(v.fechaHora || v.fecha || Date.now());
        const total = Number(v.total) || 0;

        if (esMismoDia(fecha, hoy)) {
          totalHoy += total;
        }
        if (esMismoMes(fecha, hoy)) {
          totalMes += total;
        }
      });

      const cantidad = ventas.length;
      const promedio = cantidad > 0 ? totalMes / cantidad : 0;

      const elHoy = document.getElementById("kpi-ventas-hoy");
      const elMes = document.getElementById("kpi-ventas-mes");
      const elCant = document.getElementById("kpi-ventas-cantidad");
      const elProm = document.getElementById("kpi-ventas-promedio");

      if (elHoy) elHoy.textContent = alex3FormatearMonedaSeguro(totalHoy);
      if (elMes) elMes.textContent = alex3FormatearMonedaSeguro(totalMes);
      if (elCant) elCant.textContent = String(cantidad);
      if (elProm) elProm.textContent = alex3FormatearMonedaSeguro(promedio);
    }

    // ===== Render tabla de ventas (historial) =====
    function renderVentas() {
      if (!tbodyVentas) return;

      const filtro = (inputBuscarVenta && inputBuscarVenta.value.trim().toLowerCase()) || "";
      tbodyVentas.innerHTML = "";

      if (!ventas.length) {
        tbodyVentas.innerHTML = `
          <tr>
            <td colspan="6" class="table-empty">
              A√∫n no hay ventas registradas.
            </td>
          </tr>
        `;
        recalcularKPIsVentas();
        return;
      }

      const ordenadas = [...ventas].sort((a, b) => {
        const fa = new Date(a.fechaHora || a.fecha || 0).getTime();
        const fb = new Date(b.fechaHora || b.fecha || 0).getTime();
        return fb - fa; // m√°s recientes primero
      });

      const filtradas = filtro
        ? ordenadas.filter(v => {
            const txt = [
              v.clienteNombre || "",
              v.documentoNumero || "",
              v.documentoTipo || "",
              v.notas || ""
            ].join(" ").toLowerCase();
            return txt.includes(filtro);
          })
        : ordenadas;

      if (!filtradas.length) {
        tbodyVentas.innerHTML = `
          <tr>
            <td colspan="6" class="table-empty">
              No se encontraron ventas con ese texto.
            </td>
          </tr>
        `;
        recalcularKPIsVentas();
        return;
      }

      filtradas.forEach((v, index) => {
        const fechaTxt = v.fecha || (v.fechaHora ? formatearFechaLocal(v.fechaHora) : "-");
        const clienteTxt = v.clienteNombre || "-";
        const docTxt = v.documentoTipo
          ? (v.documentoNumero ? `${v.documentoTipo} ${v.documentoNumero}` : v.documentoTipo)
          : (v.documentoNumero || "-");
        const formaPagoTxt = v.formaPago || "-";
        const totalTxt = alex3FormatearMonedaSeguro(v.total);

        tbodyVentas.innerHTML += `
          <tr>
            <td>${fechaTxt}</td>
            <td>${clienteTxt}</td>
            <td>${docTxt}</td>
            <td>${formaPagoTxt}</td>
            <td>${totalTxt}</td>
            <td>
              <button class="btn btn-small" data-delete-index="${index}">üóëÔ∏è</button>
            </td>
          </tr>
        `;
      });

      recalcularKPIsVentas();
    }

    // ===== Guardar venta =====
    function guardarVenta() {
      let fechaObj;
      if (inpFecha && inpFecha.value) {
        fechaObj = new Date(inpFecha.value);
      } else {
        fechaObj = new Date();
      }
      if (isNaN(fechaObj.getTime())) fechaObj = new Date();

      const fechaLocal = fechaObj.toLocaleString("es-GT");
      const fechaIso = fechaObj.toISOString();

      // Cliente
      let clienteId = selCliente ? selCliente.value : "";
      let clienteNombre = "";

      if (clienteId) {
        const cli = clientes.find(c => (c.id || "") === clienteId);
        clienteNombre = cli ? (cli.nombre || "") : "";
      }

      const clienteTexto = (inpClienteTexto && inpClienteTexto.value.trim()) || "";

      if (!clienteNombre && clienteTexto) {
        clienteNombre = clienteTexto;
        clienteId = null;
      }

      if (!clienteNombre) {
        clienteNombre = "Cliente general";
      }

      const documentoTipo = selDocTipo ? selDocTipo.value : "Ticket";
      const documentoNumero = (inpDocNumero && inpDocNumero.value.trim()) || "";

      // Total: si hay carrito, se usa el carrito, si no, el campo de monto
      let total = 0;
      if (carrito.length > 0) {
        total = calcularTotalCarrito();
        if (inpMonto) inpMonto.value = total.toFixed(2);
      } else {
        total = parseFloat(inpMonto && inpMonto.value);
      }

      const formaPago = selFormaPago ? selFormaPago.value : "EFECTIVO";
      const notas = (inpNotas && inpNotas.value.trim()) || "";

      if (isNaN(total) || total <= 0) {
        alert("Escribe un monto v√°lido mayor a 0, o agrega √≠tems al carrito.");
        return;
      }

      // Ajuste de inventario:
      // Si hay carrito, usamos todos los √≠tems del carrito
      if (carrito.length > 0) {
        for (const item of carrito) {
          const prod = buscarProductoPorCodigo(item.codigo);
          if (prod && typeof prod.stock !== "undefined") {
            const stockActual = Number(prod.stock) || 0;
            if (stockActual < item.cantidad) {
              const continuar = confirm(
                `El √≠tem "${item.nombre}" tiene stock ${stockActual} y est√°s vendiendo ${item.cantidad}. ` +
                `¬øDeseas continuar de todos modos?`
              );
              if (!continuar) {
                return;
              }
            }
          }
        }

        // Si el usuario acept√≥, restamos stock
        for (const item of carrito) {
          const prod = buscarProductoPorCodigo(item.codigo);
          if (prod && typeof prod.stock !== "undefined") {
            const stockActual = Number(prod.stock) || 0;
            prod.stock = stockActual - item.cantidad;
            if (prod.stock < 0) prod.stock = 0;
          }
        }
        guardarProductos();
      } else {
        // Modo antiguo: un solo √≠tem usando c√≥digo + cantidad (por si se quiere usar sin carrito)
        let codigoProd = inpCodigoProducto ? inpCodigoProducto.value.trim() : "";
        let cantidadProd = 0;
        if (inpCantidadProducto && inpCantidadProducto.value) {
          const c = parseFloat(inpCantidadProducto.value);
          if (!isNaN(c) && c > 0) cantidadProd = c;
        }

        if (codigoProd && cantidadProd > 0) {
          const prod = buscarProductoPorCodigo(codigoProd);
          if (prod && typeof prod.stock !== "undefined") {
            const stockActual = Number(prod.stock) || 0;
            if (stockActual < cantidadProd) {
              const continuar = confirm(
                `La cantidad vendida (${cantidadProd}) es mayor al stock disponible (${stockActual}). ` +
                `¬øDeseas continuar de todos modos?`
              );
              if (!continuar) {
                return;
              }
            }
            prod.stock = stockActual - cantidadProd;
            if (prod.stock < 0) prod.stock = 0;
            guardarProductos();
          }
        }
      }

      // Monto efectivo para caja
      let montoEfectivoParaCaja = 0;
      if (formaPago === "EFECTIVO") {
        montoEfectivoParaCaja = total;
      } else if (formaPago === "MIXTO") {
        const parcial = parseFloat(inpMontoEfectivo && inpMontoEfectivo.value);
        if (!isNaN(parcial) && parcial > 0) {
          montoEfectivoParaCaja = parcial;
        }
      } else {
        montoEfectivoParaCaja = 0;
      }

      const venta = {
        id: "venta_" + Date.now(),
        fecha: fechaLocal,
        fechaHora: fechaIso,
        clienteId,
        clienteNombre,
        documentoTipo,
        documentoNumero,
        total,
        formaPago,
        notas,
        origen: "venta",
        usuario: usuarioActual ? usuarioActual.usuario : null
      };

      ventas.push(venta);
      guardarVentas();

      // Registrar ingreso en caja si hay efectivo
      if (montoEfectivoParaCaja > 0) {
        const mov = {
          id: "caja_venta_" + Date.now(),
          fecha: fechaLocal,
          fechaHora: fechaIso,
          tipo: "INGRESO",
          categoria: "Ventas",
          descripcion: `Venta a ${clienteNombre}`,
          monto: montoEfectivoParaCaja,
          origen: "venta",
          ventaId: venta.id,
          usuario: usuarioActual ? usuarioActual.usuario : null
        };
        movimientosCaja.push(mov);
        guardarMovimientosCaja();
      }

      // Limpiar formulario (dejo fecha igual para seguir vendiendo)
      if (selCliente) selCliente.value = "";
      if (inpClienteTexto) inpClienteTexto.value = "";
      if (selDocTipo) selDocTipo.value = "Ticket";
      if (inpDocNumero) inpDocNumero.value = "";
      if (inpMonto) inpMonto.value = "";
      if (selFormaPago) selFormaPago.value = "EFECTIVO";
      if (campoMontoEfectivo) campoMontoEfectivo.style.display = "none";
      if (inpMontoEfectivo) inpMontoEfectivo.value = "";
      if (inpNotas) inpNotas.value = "";
      if (inpCodigoProducto) inpCodigoProducto.value = "";
      if (inpCantidadProducto) inpCantidadProducto.value = "1";

      // Limpiar carrito
      carrito = [];
      renderCarrito();

      if (inpMonto) inpMonto.focus();

      detenerEscaneoCamara();
      renderVentas();
      alert("Venta registrada correctamente.");
    }

    if (btnGuardarVenta) {
      btnGuardarVenta.addEventListener("click", guardarVenta);
    }

    // Enter en monto ‚Üí guardar (si ya est√° todo listo)
    if (inpMonto) {
      inpMonto.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          guardarVenta();
        }
      });
    }

    // Buscar ventas
    if (inputBuscarVenta) {
      inputBuscarVenta.addEventListener("input", () => {
        renderVentas();
      });
    }

    // Eliminar venta (no ajusta caja ni inventario)
    if (tbodyVentas) {
      tbodyVentas.addEventListener("click", (e) => {
        const btn = e.target.closest("button[data-delete-index]");
        if (!btn) return;
        const idx = parseInt(btn.getAttribute("data-delete-index"));
        if (isNaN(idx)) return;

        if (!confirm("¬øSeguro que quieres eliminar esta venta? (no ajustar√° caja ni inventario autom√°ticamente)")) return;
        ventas.splice(idx, 1);
        guardarVentas();
        renderVentas();
      });
    }

    // ===== Primera carga =====
    if (inpFecha) {
      const ahora = new Date();
      const isoLocal = new Date(ahora.getTime() - ahora.getTimezoneOffset() * 60000)
        .toISOString()
        .slice(0, 16);
      inpFecha.value = isoLocal;
    }

    llenarSelectClientes();
    renderVentas();
    renderCarrito();
  </script>
</body>
</html>
