<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>ALEX 3.0 - IA empresarial</title>
  <link rel="stylesheet" href="styles.css">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>

<body class="dashboard-body">
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <span class="logo-badge">A</span>
      <div class="sidebar-logo-text">
        <span class="sidebar-logo-main">ALEX 3.0</span>
        <span class="sidebar-logo-sub">Panel del negocio</span>
      </div>
    </div>

    <nav class="sidebar-nav">
      <a href="dashboard.html" class="sidebar-link">üìä Dashboard</a>
      <a href="ventas.html" class="sidebar-link">üíµ Ventas</a>
      <a href="inventario.html" class="sidebar-link">üì¶ Inventario</a>
      <a href="caja.html" class="sidebar-link">üí∞ Caja</a>
      <a href="compras.html" class="sidebar-link">üßæ Compras</a>
      <a href="gastos.html" class="sidebar-link">üìâ Gastos</a>
      <a href="clientes.html" class="sidebar-link">üë• Clientes</a>
      <a href="proveedores.html" class="sidebar-link">üöö Proveedores</a>
      <a href="contabilidad.html" class="sidebar-link">üìö Contabilidad</a>
      <a href="sat.html" class="sidebar-link">üá¨üáπ SAT Guatemala</a>
      <a href="ia.html" class="sidebar-link active">ü§ñ IA empresarial</a>
      <a href="configuracion.html" class="sidebar-link">‚öôÔ∏è Configuraci√≥n</a>
    </nav>

    <div class="sidebar-footer">
      <span class="sidebar-footer-title">Mi negocio</span>
      <span class="sidebar-footer-sub">IA en tiempo casi real</span>
    </div>
  </aside>

  <!-- Layout principal -->
  <div class="main-layout">
    <!-- Topbar -->
    <header class="topbar">
      <button class="btn-menu-mobile" id="btnMenuMobile">‚ò∞</button>

      <div class="topbar-left">
        <h1 class="topbar-title">IA empresarial ALEX 3.0</h1>
        <p class="topbar-subtitle">
          Alertas inteligentes y sugerencias autom√°ticas basadas en tus datos reales.
        </p>
      </div>

      <div class="topbar-right">
        <span class="topbar-company">Mi negocio</span>
        <span class="topbar-divider">‚Ä¢</span>
        <span class="topbar-user" id="topbar-user-label">Usuario (Rol)</span>
      </div>
    </header>

    <!-- Contenido principal -->
    <main class="main-content">
      <!-- Filtros -->
      <section class="card">
        <h2 class="card-title">1. Par√°metros de an√°lisis</h2>
        <p class="card-description">
          La IA analiza tus ventas, gastos, compras, caja e inventario del mes seleccionado.
          Adem√°s compara el <strong>d√≠a de hoy</strong> contra el promedio del mes.
        </p>

        <div class="form-grid">
          <div class="form-field">
            <label for="iaMes">Mes a analizar</label>
            <input id="iaMes" class="input" type="month">
          </div>
        </div>

        <p style="font-size: 0.85rem; margin-top: 0.5rem;">
          ‚ÑπÔ∏è Esto funciona completamente offline, solo con los datos que ya guardas en ALEX 3.0.
        </p>
      </section>

      <!-- Sem√°foro IA -->
      <section class="cards-grid">
        <article class="card kpi-card">
          <h2 class="card-title">Estado general del negocio</h2>
          <p class="card-kpi" id="ia-kpi-estado">Analizando...</p>
          <p class="card-kpi-sub" id="ia-kpi-estado-detalle">
            La IA combina ventas, gastos, caja e inventario para darte un sem√°foro.
          </p>
        </article>

        <article class="card kpi-card">
          <h2 class="card-title">Ventas de hoy vs promedio</h2>
          <p class="card-kpi" id="ia-kpi-ventas-hoy">Q 0.00</p>
          <p class="card-kpi-sub" id="ia-kpi-ventas-detalle">
            Promedio diario del mes: Q 0.00
          </p>
        </article>

        <article class="card kpi-card">
          <h2 class="card-title">Relaci√≥n gastos / ventas</h2>
          <p class="card-kpi gasto" id="ia-kpi-gastos-ventas">0 %</p>
          <p class="card-kpi-sub" id="ia-kpi-gastos-detalle">
            La IA revisa si est√°s gastando demasiado en comparaci√≥n a lo que vendes.
          </p>
        </article>

        <article class="card kpi-card">
          <h2 class="card-title">Caja neta del mes</h2>
          <p class="card-kpi" id="ia-kpi-caja-neta">Q 0.00</p>
          <p class="card-kpi-sub" id="ia-kpi-caja-detalle">
            Ingresos de caja - egresos de caja en el mes.
          </p>
        </article>
      </section>

      <!-- Alertas autom√°ticas -->
      <section class="card">
        <h2 class="card-title">2. Alertas r√°pidas de la IA</h2>
        <p class="card-description">
          Estas alertas se generan autom√°ticamente a partir de reglas inteligentes simples
          (sin servidor, sin internet). M√°s adelante se pueden volver m√°s avanzadas con modelos de IA.
        </p>

        <ul class="alerts-list" id="ia-alertas-list">
          <li class="alert-item">
            La IA est√° analizando tus datos...
          </li>
        </ul>
      </section>

      <!-- Sugerencias de acci√≥n -->
      <section class="card">
        <h2 class="card-title">3. Sugerencias de acci√≥n para hoy</h2>
        <p class="card-description">
          Basado en lo que detecta la IA, aqu√≠ tienes ideas concretas para mejorar ventas,
          controlar gastos y cuidar tu caja.
        </p>

        <ul class="alerts-list" id="ia-sugerencias-list">
          <li class="alert-item">
            A√∫n no hay sugerencias. ALEX generar√° recomendaciones cuando haya datos suficientes.
          </li>
        </ul>
      </section>

      <!-- Radar del negocio -->
      <section class="card">
        <h2 class="card-title">4. Radar del negocio</h2>
        <p class="card-description">
          Resumen r√°pido de puntos fuertes y d√©biles seg√∫n ventas, gastos, caja e inventario.
        </p>

        <table class="table">
          <thead>
            <tr>
              <th>√Årea</th>
              <th>Situaci√≥n</th>
              <th>Nivel</th>
            </tr>
          </thead>
          <tbody id="ia-radar-body">
            <tr>
              <td colspan="3" class="table-empty">
                La IA est√° construyendo tu radar...
              </td>
            </tr>
          </tbody>
        </table>
      </section>

      <!-- Inventario en riesgo -->
      <section class="card">
        <h2 class="card-title">5. Productos con alerta de stock</h2>
        <p class="card-description">
          La IA marca productos con stock muy bajo para que no te quedes sin mercader√≠a.
        </p>

        <table class="table">
          <thead>
            <tr>
              <th>C√≥digo</th>
              <th>Producto</th>
              <th>Stock</th>
              <th>Margen (%)</th>
            </tr>
          </thead>
          <tbody id="ia-tabla-stock">
            <tr>
              <td colspan="4" class="table-empty">
                No hay productos con alerta de stock por ahora.
              </td>
            </tr>
          </tbody>
        </table>
      </section>
    </main>
  </div>

  <!-- Scripts base -->
  <script src="alex-storage.js"></script>
  <script src="alex-roles.js"></script>
  <script src="alex-conta.js"></script>

  <script>
    // ===== Men√∫ m√≥vil =====
    const btnMenuMobile = document.getElementById('btnMenuMobile');
    const sidebar = document.querySelector('.sidebar');
    if (btnMenuMobile) {
      btnMenuMobile.addEventListener('click', () => {
        sidebar.classList.toggle('sidebar-open');
      });
    }

    // ===== Usuario y permisos =====
    const usuarioActual = typeof getUsuarioActualObligatorio === "function"
      ? getUsuarioActualObligatorio()
      : null;

    if (typeof aplicarPermisosYProteger === "function") {
      aplicarPermisosYProteger("ia");
    }

    const labelUser = document.getElementById("topbar-user-label");
    if (usuarioActual && labelUser) {
      const rolTexto = usuarioActual.rol === "dueno" ? "Due√±o" : "Empleado";
      labelUser.textContent = usuarioActual.nombre
        ? `${usuarioActual.nombre} (${rolTexto})`
        : `Usuario (${rolTexto})`;
    }

    // ===== Helpers =====
    function iaMoneda(n) {
      if (typeof alex3FormatearMoneda === "function") {
        return alex3FormatearMoneda(n);
      }
      const num = Number(n);
      if (isNaN(num)) return "Q 0.00";
      return "Q " + num.toFixed(2);
    }

    function iaLoad(nombre, defecto) {
      if (typeof load === "function") {
        const data = load(nombre, defecto);
        if (Array.isArray(defecto) && !Array.isArray(data)) return defecto;
        return data;
      }
      return defecto;
    }

    function iaMismoMes(fecha, ref) {
      return fecha.getFullYear() === ref.getFullYear() &&
             fecha.getMonth() === ref.getMonth();
    }

    const inputMes = document.getElementById("iaMes");

    // KPI elements
    const elEstado = document.getElementById("ia-kpi-estado");
    const elEstadoDet = document.getElementById("ia-kpi-estado-detalle");
    const elVentasHoy = document.getElementById("ia-kpi-ventas-hoy");
    const elVentasDet = document.getElementById("ia-kpi-ventas-detalle");
    const elGastosVentas = document.getElementById("ia-kpi-gastos-ventas");
    const elGastosDet = document.getElementById("ia-kpi-gastos-detalle");
    const elCajaNeta = document.getElementById("ia-kpi-caja-neta");
    const elCajaDet = document.getElementById("ia-kpi-caja-detalle");

    const ulAlertas = document.getElementById("ia-alertas-list");
    const ulSugerencias = document.getElementById("ia-sugerencias-list");
    const tbodyRadar = document.getElementById("ia-radar-body");
    const tbodyStock = document.getElementById("ia-tabla-stock");

    function obtenerFechaReferencia() {
      if (inputMes && inputMes.value) {
        const [year, month] = inputMes.value.split("-").map(Number);
        if (!isNaN(year) && !isNaN(month)) {
          return new Date(year, month - 1, 1);
        }
      }
      return new Date();
    }

    function analizarIA() {
      const ref = obtenerFechaReferencia();
      const hoy = new Date();

      // Datos base
      const ventas = iaLoad("ventas", []);
      const compras = iaLoad("compras", []);
      const gastos = iaLoad("gastos", []);
      const movCaja1 = iaLoad("caja_movimientos", []);
      const movCaja2 = iaLoad("movimientosCaja", []);
      const movimientosCaja =
        Array.isArray(movCaja1) && movCaja1.length ? movCaja1 : movCaja2;

      const productos = iaLoad("productos", []);

      // Filtrar por mes
      const ventasMes = ventas.filter(v => {
        const f = new Date(v.fechaHora || v.fecha || Date.now());
        return iaMismoMes(f, ref);
      });

      const comprasMes = compras.filter(c => {
        const f = new Date(c.fechaHora || c.fecha || Date.now());
        return iaMismoMes(f, ref);
      });

      const gastosMes = gastos.filter(g => {
        const f = new Date(g.fechaHora || g.fecha || Date.now());
        return iaMismoMes(f, ref);
      });

      const movCajaMes = movimientosCaja.filter(m => {
        const f = new Date(m.fechaHora || m.fecha || m.fecha || Date.now());
        return iaMismoMes(f, ref);
      });

      // === C√°lculos ventas ===
      let totalVentasMes = 0;
      let totalVentasHoy = 0;
      const diasConVentas = new Set();

      ventasMes.forEach(v => {
        const total = Number(v.total) || 0;
        const fecha = new Date(v.fechaHora || v.fecha || Date.now());
        totalVentasMes += total;

        if (fecha.getFullYear() === hoy.getFullYear() &&
            fecha.getMonth() === hoy.getMonth() &&
            fecha.getDate() === hoy.getDate()) {
          totalVentasHoy += total;
        }

        const claveDia = `${fecha.getFullYear()}-${fecha.getMonth()}-${fecha.getDate()}`;
        diasConVentas.add(claveDia);
      });

      const numDiasVentas = diasConVentas.size || 1;
      const promedioDiario = totalVentasMes / numDiasVentas;

      // === C√°lculos gastos ===
      const totalGastosMes = gastosMes.reduce(
        (acc, g) => acc + (Number(g.monto) || 0),
        0
      );

      // === Caja ===
      let ingresosCaja = 0;
      let egresosCaja = 0;
      movCajaMes.forEach(m => {
        const monto = Number(m.monto) || 0;
        if (m.tipo === "INGRESO" || m.tipo === "ingreso") {
          ingresosCaja += monto;
        } else if (m.tipo === "EGRESO" || m.tipo === "egreso") {
          egresosCaja += monto;
        }
      });
      const cajaNetaMes = ingresosCaja - egresosCaja;

      // === Ratios ===
      const ratioGastosVentas =
        totalVentasMes > 0 ? (totalGastosMes / totalVentasMes) : 0;

      // === Sem√°foro negocio ===
      let score = 0;
      const alertas = [];
      const sugerencias = [];
      const radar = [];

      // Regla 1: D√≠a flojo de ventas
      if (promedioDiario > 0) {
        const ratioHoy = totalVentasHoy / promedioDiario;
        if (ratioHoy < 0.5) {
          score += 2;
          alertas.push("üìâ Ventas de hoy muy por debajo del promedio del mes.");
          sugerencias.push(
            "Lanza una promoci√≥n r√°pida hoy (descuento peque√±o o env√≠o gratis) para mover inventario."
          );
          radar.push({
            area: "Ventas diarias",
            situacion: "D√≠a flojo vs promedio del mes.",
            nivel: "Alerta",
          });
        } else if (ratioHoy < 0.9) {
          score += 1;
          radar.push({
            area: "Ventas diarias",
            situacion: "Ventas de hoy ligeramente por debajo del promedio.",
            nivel: "Atenci√≥n",
          });
        } else {
          radar.push({
            area: "Ventas diarias",
            situacion: "Ventas de hoy en l√≠nea o por encima del promedio.",
            nivel: "OK",
          });
        }
      } else {
        radar.push({
          area: "Ventas diarias",
          situacion: "A√∫n no hay datos de ventas este mes.",
          nivel: "Sin datos",
        });
      }

      // Regla 2: Gastos muy altos vs ventas
      if (totalVentasMes > 0) {
        if (ratioGastosVentas > 0.6) {
          score += 2;
          alertas.push("üí∏ Tus gastos son muy altos en relaci√≥n a tus ventas (>60%).");
          sugerencias.push(
            "Revisa tus gastos fijos (renta, servicios, env√≠os) y recorta los que no generen ventas directas."
          );
          radar.push({
            area: "Gastos",
            situacion: "Gastos consumen gran parte de las ventas.",
            nivel: "Alerta",
          });
        } else if (ratioGastosVentas > 0.3) {
          score += 1;
          radar.push({
            area: "Gastos",
            situacion: "Gastos moderados respecto a ventas.",
            nivel: "Atenci√≥n",
          });
        } else {
          radar.push({
            area: "Gastos",
            situacion: "Gastos controlados en relaci√≥n a las ventas.",
            nivel: "OK",
          });
        }
      } else {
        radar.push({
          area: "Gastos",
          situacion: "Sin ventas registradas; no se puede comparar gastos.",
          nivel: "Sin datos",
        });
      }

      // Regla 3: Caja negativa o muy justa
      if (cajaNetaMes < 0) {
        score += 2;
        alertas.push("üö® Caja neta negativa en el mes (m√°s egresos que ingresos).");
        sugerencias.push(
          "Evita nuevas compras grandes al contado hasta equilibrar la caja; prioriza productos que roten r√°pido."
        );
        radar.push({
          area: "Caja",
          situacion: "Caja neta negativa.",
          nivel: "Alerta",
        });
      } else if (cajaNetaMes > 0 && cajaNetaMes < totalGastosMes * 0.5) {
        score += 1;
        radar.push({
          area: "Caja",
          situacion: "Caja positiva pero ajustada.",
          nivel: "Atenci√≥n",
        });
      } else {
        radar.push({
          area: "Caja",
          situacion: "Caja neta del mes en buen estado.",
          nivel: "OK",
        });
      }

      // Regla 4: Stock bajo
      const productosStockBajo = (productos || []).filter(p => {
        const stock = Number(p.stock) || 0;
        return stock > 0 && stock <= 3;
      });

      if (productosStockBajo.length > 0) {
        score += 1;
        alertas.push("üì¶ Tienes productos con stock muy bajo (‚â§ 3 unidades).");
        sugerencias.push(
          "Haz un peque√±o pedido de reposici√≥n para los productos con mayor margen y rotaci√≥n."
        );
        radar.push({
          area: "Inventario",
          situacion: "Varios productos con stock bajo.",
          nivel: "Atenci√≥n",
        });
      } else {
        radar.push({
          area: "Inventario",
          situacion: "No se detectan productos con stock cr√≠tico.",
          nivel: "OK",
        });
      }

      // === Estado general dependiendo del score ===
      let textoEstado = "Sin datos suficientes";
      let textoDetalleEstado =
        "Carga ventas, gastos, compras y movimientos de caja para que la IA pueda evaluarte.";

      if (ventasMes.length || gastosMes.length || movCajaMes.length || comprasMes.length) {
        if (score >= 4) {
          textoEstado = "‚ö†Ô∏è Alerta roja";
          textoDetalleEstado =
            "La IA detecta varios puntos cr√≠ticos. Revisa ventas, gastos y caja en detalle.";
        } else if (score >= 2) {
          textoEstado = "üü° Atenci√≥n";
          textoDetalleEstado =
            "Hay se√±ales a vigilar. Unos peque√±os ajustes pueden mejorar mucho tus n√∫meros.";
        } else {
          textoEstado = "üü¢ Estable";
          textoDetalleEstado =
            "En general, la salud de tu negocio se ve estable con los datos actuales.";
        }
      }

      // === Pintar KPIs ===
      if (elEstado) elEstado.textContent = textoEstado;
      if (elEstadoDet) elEstadoDet.textContent = textoDetalleEstado;

      if (elVentasHoy) elVentasHoy.textContent = iaMoneda(totalVentasHoy);
      if (elVentasDet) {
        elVentasDet.textContent =
          "Promedio diario del mes: " + iaMoneda(promedioDiario || 0);
      }

      if (elGastosVentas) {
        const pct = (ratioGastosVentas * 100).toFixed(1);
        elGastosVentas.textContent = pct + " %";
      }
      if (elGastosDet) {
        elGastosDet.textContent =
          "Gastos del mes: " + iaMoneda(totalGastosMes) +
          " vs ventas del mes: " + iaMoneda(totalVentasMes);
      }

      if (elCajaNeta) elCajaNeta.textContent = iaMoneda(cajaNetaMes);
      if (elCajaDet) {
        elCajaDet.textContent =
          "Ingresos caja: " + iaMoneda(ingresosCaja) +
          " | Egresos caja: " + iaMoneda(egresosCaja);
      }

      // === Alertas ===
      if (ulAlertas) {
        ulAlertas.innerHTML = "";
        if (!alertas.length) {
          ulAlertas.innerHTML = `
            <li class="alert-item">
              ‚úÖ Por ahora no se detectan alertas cr√≠ticas. Mant√©n tus registros al d√≠a.
            </li>
          `;
        } else {
          alertas.forEach(a => {
            ulAlertas.innerHTML += `<li class="alert-item">${a}</li>`;
          });
        }
      }

      // === Sugerencias ===
      if (ulSugerencias) {
        ulSugerencias.innerHTML = "";
        if (!sugerencias.length) {
          ulSugerencias.innerHTML = `
            <li class="alert-item">
              A medida que registres m√°s ventas, gastos y caja, ALEX te dar√° sugerencias espec√≠ficas.
            </li>
          `;
        } else {
          sugerencias.forEach(s => {
            ulSugerencias.innerHTML += `<li class="alert-item">${s}</li>`;
          });
        }
      }

      // === Radar ===
      if (tbodyRadar) {
        tbodyRadar.innerHTML = "";
        if (!radar.length) {
          tbodyRadar.innerHTML = `
            <tr>
              <td colspan="3" class="table-empty">
                A√∫n no se pudo generar radar. Registra m√°s informaci√≥n.
              </td>
            </tr>
          `;
        } else {
          radar.forEach(item => {
            tbodyRadar.innerHTML += `
              <tr>
                <td>${item.area}</td>
                <td>${item.situacion}</td>
                <td>${item.nivel}</td>
              </tr>
            `;
          });
        }
      }

      // === Tabla de productos con stock bajo ===
      if (tbodyStock) {
        tbodyStock.innerHTML = "";
        if (!productosStockBajo.length) {
          tbodyStock.innerHTML = `
            <tr>
              <td colspan="4" class="table-empty">
                No hay productos con stock cr√≠tico en este momento.
              </td>
            </tr>
          `;
        } else {
          productosStockBajo.forEach(p => {
            const margen = p.margen != null ? p.margen : "";
            tbodyStock.innerHTML += `
              <tr>
                <td>${p.codigo || "-"}</td>
                <td>${p.nombre || "-"}</td>
                <td>${p.stock || 0}</td>
                <td>${margen !== "" ? margen + " %" : "-"}</td>
              </tr>
            `;
          });
        }
      }
    }

    // Cambio de mes => recalcular
    if (inputMes) {
      inputMes.addEventListener("change", () => {
        analizarIA();
      });
    }

    // Inicializar mes actual
    (function initMesActual() {
      if (!inputMes) return;
      const hoy = new Date();
      const year = hoy.getFullYear();
      const month = String(hoy.getMonth() + 1).padStart(2, "0");
      inputMes.value = `${year}-${month}`;
    })();

    // Primera corrida
    analizarIA();
  </script>
</body>
</html>
