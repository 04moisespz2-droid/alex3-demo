<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>ALEX 3.0 - Clientes</title>
  <link rel="stylesheet" href="styles.css">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>

<body class="dashboard-body">
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <span class="logo-badge">A</span>
      <div class="sidebar-logo-text">
        <span class="sidebar-logo-main">ALEX 3.0</span>
        <span class="sidebar-logo-sub">Panel del negocio</span>
      </div>
    </div>

    <nav class="sidebar-nav">
      <a href="dashboard.html" class="sidebar-link">ğŸ“Š Dashboard</a>
      <a href="ventas.html" class="sidebar-link">ğŸ’µ Ventas</a>
      <a href="inventario.html" class="sidebar-link">ğŸ“¦ Inventario</a>
      <a href="caja.html" class="sidebar-link">ğŸ’° Caja</a>
      <a href="compras.html" class="sidebar-link">ğŸ§¾ Compras</a>
      <a href="gastos.html" class="sidebar-link">ğŸ“‰ Gastos</a>
      <a href="clientes.html" class="sidebar-link active">ğŸ‘¥ Clientes</a>
      <a href="proveedores.html" class="sidebar-link">ğŸšš Proveedores</a>
      <a href="contabilidad.html" class="sidebar-link">ğŸ“š Contabilidad</a>
      <a href="sat.html" class="sidebar-link">ğŸ‡¬ğŸ‡¹ SAT Guatemala</a>
      <a href="ia.html" class="sidebar-link">ğŸ¤– IA empresarial</a>
      <a href="configuracion.html" class="sidebar-link">âš™ï¸ ConfiguraciÃ³n</a>
    </nav>

    <div class="sidebar-footer">
      <span class="sidebar-footer-title">Empresa demo</span>
      <span class="sidebar-footer-sub">VersiÃ³n 1.0</span>
    </div>
  </aside>

  <!-- Layout principal -->
  <div class="main-layout">
    <!-- Topbar -->
    <header class="topbar">
      <button class="btn-menu-mobile" id="btnMenuMobile">â˜°</button>

      <div class="topbar-left">
        <h1 class="topbar-title">Clientes del negocio</h1>
        <p class="topbar-subtitle">
          Registra a tus clientes frecuentes, controla sus datos y prepÃ¡rate para manejar fiados y crÃ©ditos.
        </p>
      </div>

      <div class="topbar-right">
        <span class="topbar-company">Mi tienda demo</span>
        <span class="topbar-divider">â€¢</span>
        <span class="topbar-user" id="topbar-user-label">Usuario (Rol)</span>
        <button class="btn" id="btnLogout" type="button" style="margin-left: 0.75rem;">
          Cerrar sesiÃ³n
        </button>
      </div>
    </header>

    <!-- Contenido principal -->
    <main class="main-content">
      <!-- Formulario alta de cliente -->
      <section class="card">
        <h2 class="card-title">Registrar nuevo cliente</h2>
        <p class="card-description">
          Guarda la informaciÃ³n bÃ¡sica de tus clientes para poder relacionar ventas, fiados y reportes en el futuro.
        </p>

        <div class="form-grid">
          <div class="form-field">
            <label for="clNombre">Nombre completo</label>
            <input id="clNombre" class="input" type="text" placeholder="Ej: Juan PÃ©rez, Tienda La Esquina">
          </div>

          <div class="form-field">
            <label for="clTelefono">TelÃ©fono</label>
            <input id="clTelefono" class="input" type="tel" placeholder="Ej: 5555-5555">
          </div>

          <div class="form-field">
            <label for="clNit">NIT</label>
            <input id="clNit" class="input" type="text" placeholder="CF o NIT del cliente">
          </div>

          <div class="form-field">
            <label for="clTipo">Tipo de cliente</label>
            <select id="clTipo" class="input">
              <option value="CONTADO">Contado</option>
              <option value="FIADO">Fiado / CrÃ©dito</option>
            </select>
          </div>

          <div class="form-field">
            <label for="clLimite">LÃ­mite de crÃ©dito (Q)</label>
            <input id="clLimite" class="input" type="number" step="0.01" min="0" placeholder="Ej: 0.00 o 500.00">
          </div>

          <div class="form-field" style="grid-column: 1 / -1;">
            <label for="clDireccion">DirecciÃ³n</label>
            <input id="clDireccion" class="input" type="text" placeholder="Zona, colonia, referencia, etc.">
          </div>
        </div>

        <button class="btn" id="btnGuardarCliente">Guardar cliente</button>
      </section>

      <!-- Tabla de clientes -->
      <section class="card">
        <h2 class="card-title">Listado de clientes</h2>
        <p class="card-description">
          AquÃ­ verÃ¡s todos los clientes registrados. En versiones futuras se podrÃ¡n ver saldos de fiados y estado de cuenta.
        </p>

        <table class="table">
          <thead>
            <tr>
              <th>Nombre</th>
              <th>TelÃ©fono</th>
              <th>NIT</th>
              <th>Tipo</th>
              <th>LÃ­mite crÃ©dito</th>
              <th>DirecciÃ³n</th>
              <th>Creado</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="tabla-clientes-body">
            <tr>
              <td colspan="8" class="table-empty">
                AÃºn no hay clientes registrados.
              </td>
            </tr>
          </tbody>
        </table>
      </section>
    </main>
  </div>

  <!-- Scripts base -->
  <script src="alex-storage.js"></script>
  <script src="alex-roles.js"></script>

  <script>
    // MenÃº mÃ³vil
    const btnMenuMobile = document.getElementById('btnMenuMobile');
    const sidebar = document.querySelector('.sidebar');

    if (btnMenuMobile) {
      btnMenuMobile.addEventListener('click', () => {
        sidebar.classList.toggle('sidebar-open');
      });
    }

    // Usuario y permisos
    const usuarioActual = typeof getUsuarioActualObligatorio === "function"
      ? getUsuarioActualObligatorio()
      : null;

    if (typeof aplicarPermisosYProteger === "function") {
      aplicarPermisosYProteger("clientes");
    }

    // Pintar nombre y rol en el topbar
    const labelUser = document.getElementById("topbar-user-label");
    if (usuarioActual && labelUser) {
      const rolTexto = usuarioActual.rol === "dueno" ? "DueÃ±o" : "Empleado";
      labelUser.textContent = `${usuarioActual.nombre} (${rolTexto})`;
    }

    // BotÃ³n Cerrar sesiÃ³n
    const btnLogout = document.getElementById("btnLogout");
    if (btnLogout) {
      btnLogout.addEventListener("click", () => {
        if (!confirm("Â¿Quieres cerrar sesiÃ³n?")) return;

        if (typeof save === "function") {
          save("usuarioActual", null);
        } else {
          localStorage.removeItem("usuarioActual");
        }

        window.location.href = "index.html";
      });
    }

    // ====== LÃ“GICA DE CLIENTES ======

    let clientes = [];
    if (typeof load === "function") {
      const cData = load("clientes", []);
      clientes = Array.isArray(cData) ? cData : [];
    }

    function alex3FormatearMonedaSeguro(valor) {
      if (typeof alex3FormatearMoneda === "function") {
        return alex3FormatearMoneda(valor);
      }
      const num = Number(valor);
      if (isNaN(num)) return "Q 0.00";
      return "Q " + num.toFixed(2);
    }

    function renderTablaClientes() {
      const tbody = document.getElementById("tabla-clientes-body");
      tbody.innerHTML = "";

      if (!clientes.length) {
        tbody.innerHTML = `
          <tr>
            <td colspan="8" class="table-empty">AÃºn no hay clientes registrados.</td>
          </tr>
        `;
        return;
      }

      const ordenados = [...clientes].sort((a, b) => {
        const fa = new Date(a.creadoEnIso || a.creadoEn || 0).getTime();
        const fb = new Date(b.creadoEnIso || b.creadoEn || 0).getTime();
        return fb - fa;
      });

      ordenados.forEach((cl, index) => {
        const tipoTexto = cl.tipo === "FIADO" ? "Fiado / CrÃ©dito" : "Contado";
        const limiteTxt = cl.tipo === "FIADO"
          ? alex3FormatearMonedaSeguro(cl.limiteCredito)
          : "â€”";
        const creado = cl.creadoEn || "";

        tbody.innerHTML += `
          <tr>
            <td>${cl.nombre || ""}</td>
            <td>${cl.telefono || ""}</td>
            <td>${cl.nit || ""}</td>
            <td>${tipoTexto}</td>
            <td>${limiteTxt}</td>
            <td>${cl.direccion || ""}</td>
            <td>${creado}</td>
            <td>
              <button onclick="eliminarCliente(${index})">ğŸ—‘ï¸</button>
            </td>
          </tr>
        `;
      });
    }

    function registrarCliente() {
      const nombre = document.getElementById("clNombre").value.trim();
      const telefono = document.getElementById("clTelefono").value.trim();
      const nit = document.getElementById("clNit").value.trim();
      const tipo = document.getElementById("clTipo").value;
      const limite = parseFloat(document.getElementById("clLimite").value);
      const direccion = document.getElementById("clDireccion").value.trim();

      if (!nombre) {
        alert("El nombre del cliente es obligatorio.");
        return;
      }

      if (tipo === "FIADO" && (isNaN(limite) || limite <= 0)) {
        alert("Para clientes fiados debes definir un lÃ­mite de crÃ©dito mayor a 0.");
        return;
      }

      const ahora = new Date();
      const nuevo = {
        id: Date.now(),
        nombre,
        telefono,
        nit,
        tipo, // CONTADO o FIADO
        limiteCredito: !isNaN(limite) ? limite : 0,
        direccion,
        creadoEn: ahora.toLocaleString("es-GT"),
        creadoEnIso: ahora.toISOString(),
        usuario: usuarioActual ? usuarioActual.usuario : null
      };

      clientes.push(nuevo);
      if (typeof save === "function") {
        save("clientes", clientes);
      }

      // Limpiar formulario
      document.getElementById("clNombre").value = "";
      document.getElementById("clTelefono").value = "";
      document.getElementById("clNit").value = "";
      document.getElementById("clTipo").value = "CONTADO";
      document.getElementById("clLimite").value = "";
      document.getElementById("clDireccion").value = "";

      renderTablaClientes();
      alert("Cliente registrado correctamente.");
    }

    function eliminarCliente(index) {
      if (!confirm("Â¿Seguro que quieres eliminar este cliente?")) return;
      clientes.splice(index, 1);
      if (typeof save === "function") {
        save("clientes", clientes);
      }
      renderTablaClientes();
    }

    // Hacer las funciones accesibles desde HTML
    window.eliminarCliente = eliminarCliente;

    // Evento del botÃ³n
    const btnGuardarCliente = document.getElementById("btnGuardarCliente");
    if (btnGuardarCliente) {
      btnGuardarCliente.addEventListener("click", registrarCliente);
    }

    // Primera carga
    renderTablaClientes();
  </script>
</body>
</html>
