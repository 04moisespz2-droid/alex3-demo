<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>ALEX 3.0 - Clientes</title>
  <link rel="stylesheet" href="styles.css">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>

<body class="dashboard-body">
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <span class="logo-badge">A</span>
      <div class="sidebar-logo-text">
        <span class="sidebar-logo-main">ALEX 3.0</span>
        <span class="sidebar-logo-sub">Panel del negocio</span>
      </div>
    </div>

    <nav class="sidebar-nav">
      <a href="dashboard.html" class="sidebar-link">üìä Dashboard</a>
      <a href="ventas.html" class="sidebar-link">üíµ Ventas</a>
      <a href="inventario.html" class="sidebar-link">üì¶ Inventario</a>
      <a href="caja.html" class="sidebar-link">üí∞ Caja</a>
      <a href="compras.html" class="sidebar-link">üßæ Compras</a>
      <a href="gastos.html" class="sidebar-link">üìâ Gastos</a>
      <a href="clientes.html" class="sidebar-link active">üë• Clientes</a>
      <a href="proveedores.html" class="sidebar-link">üöö Proveedores</a>
      <a href="reportes.html" class="sidebar-link">üìö Reportes</a>
      <a href="ia.html" class="sidebar-link">ü§ñ IA empresarial</a>
      <a href="configuracion.html" class="sidebar-link">‚öôÔ∏è Configuraci√≥n</a>
    </nav>

    <div class="sidebar-footer">
      <span class="sidebar-footer-title" id="sidebar-footer-title">Mi negocio</span>
      <span class="sidebar-footer-sub">M√≥dulo de clientes</span>
    </div>
  </aside>

  <!-- Layout principal -->
  <div class="main-layout">
    <!-- Topbar -->
    <header class="topbar">
      <button class="btn-menu-mobile" id="btnMenuMobile">‚ò∞</button>

      <div class="topbar-left">
        <h1 class="topbar-title">Clientes</h1>
        <p class="topbar-subtitle">
          Registra y administra tus clientes para usarlos en el m√≥dulo de ventas y cr√©ditos.
        </p>
      </div>

      <div class="topbar-right">
        <span class="topbar-company" id="topbar-company-label">Mi negocio</span>
        <span class="topbar-divider">‚Ä¢</span>
        <span class="topbar-user" id="topbar-user-label">Usuario (Rol)</span>
      </div>
    </header>

    <!-- Contenido principal -->
    <main class="main-content">
      <!-- Formulario -->
      <section class="card">
        <h2 class="card-title">Agregar cliente</h2>
        <p class="card-description">
          Guarda datos b√°sicos del cliente. Luego podr√°s seleccionarlo f√°cilmente desde el m√≥dulo de Ventas.
        </p>

        <div class="form-grid">
          <div class="form-field">
            <label for="clNombre">Nombre del cliente</label>
            <input id="clNombre" class="input" type="text"
                   placeholder="Ej: Juan P√©rez, Tienda La Esquina, etc.">
          </div>

          <div class="form-field">
            <label for="clTelefono">Tel√©fono</label>
            <input id="clTelefono" class="input" type="tel"
                   placeholder="Ej: 5555-5555">
          </div>

          <div class="form-field">
            <label for="clNit">NIT / DPI</label>
            <input id="clNit" class="input" type="text"
                   placeholder="Ej: C/F, 1234567-8, DPI, etc.">
          </div>

          <div class="form-field">
            <label for="clCorreo">Correo (opcional)</label>
            <input id="clCorreo" class="input" type="email"
                   placeholder="Ej: cliente@correo.com">
          </div>

          <div class="form-field">
            <label for="clTipo">Tipo de cliente</label>
            <select id="clTipo" class="input">
              <option value="contado">Contado</option>
              <option value="credito">Cr√©dito / fiado</option>
            </select>
          </div>

          <div class="form-field" style="grid-column:1 / -1;">
            <label for="clNotas">Notas (opcional)</label>
            <input id="clNotas" class="input" type="text"
                   placeholder="Ej: Cliente frecuente, paga los viernes, etc.">
          </div>
        </div>

        <button class="btn" id="btnGuardarCliente" style="margin-top:0.75rem;">
          Guardar cliente
        </button>
      </section>

      <!-- Listado -->
      <section class="card">
        <h2 class="card-title">Lista de clientes</h2>
        <p class="card-description">
          Estos clientes aparecer√°n en el campo "Cliente guardado" del m√≥dulo de Ventas.
        </p>

        <div class="form-grid" style="margin-bottom:0.75rem;">
          <div class="form-field" style="grid-column:1 / -1;">
            <label for="buscarCliente">Buscar cliente</label>
            <input id="buscarCliente" class="input" type="text"
                   placeholder="Filtra por nombre, tel√©fono, NIT o notas">
          </div>
        </div>

        <table class="table">
          <thead>
            <tr>
              <th>Nombre</th>
              <th>Tel√©fono</th>
              <th>NIT / DPI</th>
              <th>Tipo</th>
              <th>Notas</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="tabla-clientes-body">
            <tr>
              <td colspan="6" class="table-empty">
                A√∫n no hay clientes registrados.
              </td>
            </tr>
          </tbody>
        </table>
      </section>
    </main>
  </div>

  <!-- Scripts base -->
  <script src="alex-storage.js"></script>
  <script src="alex-roles.js"></script>

  <script>
    // ===== Men√∫ m√≥vil =====
    const btnMenuMobile = document.getElementById('btnMenuMobile');
    const sidebar = document.querySelector('.sidebar');
    if (btnMenuMobile) {
      btnMenuMobile.addEventListener('click', () => {
        sidebar.classList.toggle('sidebar-open');
      });
    }

    // ===== Usuario, permisos y negocio =====
    const usuarioActual = typeof getUsuarioActualObligatorio === "function"
      ? getUsuarioActualObligatorio()
      : null;

    if (typeof aplicarPermisosYProteger === "function") {
      aplicarPermisosYProteger("clientes");
    }

    const labelUser = document.getElementById("topbar-user-label");
    const labelCompany = document.getElementById("topbar-company-label");
    const sidebarFooterTitle = document.getElementById("sidebar-footer-title");

    let negocioConfig = {
      nombre: "Mi negocio"
    };

    if (typeof load === "function") {
      const cfg = load("negocio_config", null);
      if (cfg && typeof cfg === "object") {
        negocioConfig = Object.assign(negocioConfig, cfg);
      }
    }

    if (labelCompany) labelCompany.textContent = negocioConfig.nombre || "Mi negocio";
    if (sidebarFooterTitle) sidebarFooterTitle.textContent = negocioConfig.nombre || "Mi negocio";

    if (usuarioActual && labelUser) {
      const rolTexto = usuarioActual.rol === "dueno" ? "Due√±o" : "Empleado";
      labelUser.textContent = `${usuarioActual.nombre} (${rolTexto})`;
    }

    // ===== Storage clientes =====
    let clientes = [];
    if (typeof load === "function") {
      const data = load("clientes", []);
      clientes = Array.isArray(data) ? data : [];
    }

    function guardarClientes() {
      if (typeof save === "function") {
        save("clientes", clientes);
      }
    }

    // ===== DOM =====
    const inpNombre = document.getElementById("clNombre");
    const inpTelefono = document.getElementById("clTelefono");
    const inpNit = document.getElementById("clNit");
    const inpCorreo = document.getElementById("clCorreo");
    const selTipo = document.getElementById("clTipo");
    const inpNotas = document.getElementById("clNotas");
    const btnGuardarCliente = document.getElementById("btnGuardarCliente");
    const inpBuscar = document.getElementById("buscarCliente");
    const tbodyClientes = document.getElementById("tabla-clientes-body");

    // ===== Render tabla =====
    function renderClientes() {
      if (!tbodyClientes) return;

      const filtro = inpBuscar ? inpBuscar.value.trim().toLowerCase() : "";
      tbodyClientes.innerHTML = "";

      if (!clientes.length) {
        tbodyClientes.innerHTML = `
          <tr>
            <td colspan="6" class="table-empty">
              A√∫n no hay clientes registrados.
            </td>
          </tr>
        `;
        return;
      }

      const filtrados = filtro
        ? clientes.filter(c => {
            const txt = [
              c.nombre || "",
              c.telefono || "",
              c.nit || "",
              c.correo || "",
              c.notas || ""
            ].join(" ").toLowerCase();
            return txt.includes(filtro);
          })
        : clientes;

      if (!filtrados.length) {
        tbodyClientes.innerHTML = `
          <tr>
            <td colspan="6" class="table-empty">
              No se encontraron clientes con ese texto.
            </td>
          </tr>
        `;
        return;
      }

      filtrados.forEach((c, index) => {
        const tipoTxt = c.tipo === "credito" ? "Cr√©dito / fiado" : "Contado";

        tbodyClientes.innerHTML += `
          <tr>
            <td>${c.nombre || "-"}</td>
            <td>${c.telefono || "-"}</td>
            <td>${c.nit || "-"}</td>
            <td>${tipoTxt}</td>
            <td>${c.notas || "-"}</td>
            <td>
              <button class="btn btn-small" data-index="${index}" data-action="eliminar">üóëÔ∏è</button>
            </td>
          </tr>
        `;
      });
    }

    // ===== Guardar cliente =====
    function guardarCliente() {
      const nombre = inpNombre ? inpNombre.value.trim() : "";
      const telefono = inpTelefono ? inpTelefono.value.trim() : "";
      const nit = inpNit ? inpNit.value.trim() : "";
      const correo = inpCorreo ? inpCorreo.value.trim() : "";
      const tipo = selTipo ? selTipo.value : "contado";
      const notas = inpNotas ? inpNotas.value.trim() : "";

      if (!nombre) {
        alert("Escribe al menos el nombre del cliente.");
        return;
      }

      const nuevo = {
        id: "cliente_" + Date.now(),
        nombre,
        telefono,
        nit,
        correo,
        tipo,  // contado / credito
        notas
      };

      clientes.push(nuevo);
      guardarClientes();

      if (inpNombre) inpNombre.value = "";
      if (inpTelefono) inpTelefono.value = "";
      if (inpNit) inpNit.value = "";
      if (inpCorreo) inpCorreo.value = "";
      if (inpNotas) inpNotas.value = "";
      if (selTipo) selTipo.value = "contado";

      renderClientes();
      alert("Cliente guardado correctamente.");
    }

    if (btnGuardarCliente) {
      btnGuardarCliente.addEventListener("click", guardarCliente);
    }

    if (inpNombre) {
      inpNombre.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          guardarCliente();
        }
      });
    }
    if (inpTelefono) {
      inpTelefono.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          guardarCliente();
        }
      });
    }
    if (inpNit) {
      inpNit.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          guardarCliente();
        }
      });
    }

    // Buscar
    if (inpBuscar) {
      inpBuscar.addEventListener("input", renderClientes);
    }

    // Eliminar
    if (tbodyClientes) {
      tbodyClientes.addEventListener("click", (e) => {
        const btn = e.target.closest("button[data-index][data-action]");
        if (!btn) return;
        const idx = parseInt(btn.getAttribute("data-index"));
        const action = btn.getAttribute("data-action");
        if (isNaN(idx) || !clientes[idx]) return;

        if (action === "eliminar") {
          const c = clientes[idx];
          const confirmar = confirm(`¬øEliminar al cliente "${c.nombre}"? (No lo quitar√° de ventas pasadas).`);
          if (!confirmar) return;
          clientes.splice(idx, 1);
          guardarClientes();
          renderClientes();
        }
      });
    }

    // ===== Primera carga =====
    renderClientes();
  </script>
</body>
</html>
