<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>ALEX 3.0 - Clientes</title>
  <link rel="stylesheet" href="styles.css">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>

<body class="dashboard-body">
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <span class="logo-badge">A</span>
      <div class="sidebar-logo-text">
        <span class="sidebar-logo-main">ALEX 3.0</span>
        <span class="sidebar-logo-sub">Panel del negocio</span>
      </div>
    </div>

    <nav class="sidebar-nav">
      <a href="dashboard.html" class="sidebar-link">üìä Dashboard</a>
      <a href="ventas.html" class="sidebar-link">üíµ Ventas</a>
      <a href="inventario.html" class="sidebar-link">üì¶ Inventario</a>
      <a href="caja.html" class="sidebar-link">üí∞ Caja</a>
      <a href="compras.html" class="sidebar-link">üßæ Compras</a>
      <a href="gastos.html" class="sidebar-link">üìâ Gastos</a>
      <a href="clientes.html" class="sidebar-link active">üë• Clientes</a>
      <a href="proveedores.html" class="sidebar-link">üöö Proveedores</a>
      <a href="contabilidad.html" class="sidebar-link">üìö Contabilidad</a>
      <a href="sat.html" class="sidebar-link">üá¨üáπ SAT Guatemala</a>
      <a href="ia.html" class="sidebar-link">ü§ñ IA empresarial</a>
      <a href="configuracion.html" class="sidebar-link">‚öôÔ∏è Configuraci√≥n</a>
    </nav>

    <div class="sidebar-footer">
      <span class="sidebar-footer-title">Mi negocio</span>
      <span class="sidebar-footer-sub">Gesti√≥n de clientes</span>
    </div>
  </aside>

  <!-- Layout principal -->
  <div class="main-layout">
    <!-- Topbar -->
    <header class="topbar">
      <button class="btn-menu-mobile" id="btnMenuMobile">‚ò∞</button>

      <div class="topbar-left">
        <h1 class="topbar-title">Clientes</h1>
        <p class="topbar-subtitle">
          Registra y administra los clientes de tu negocio.
        </p>
      </div>

      <div class="topbar-right">
        <span class="topbar-company">Mi negocio</span>
        <span class="topbar-divider">‚Ä¢</span>
        <span class="topbar-user" id="topbar-user-label">Usuario (Rol)</span>
      </div>
    </header>

    <!-- Contenido principal -->
    <main class="main-content">
      <!-- KPIs de clientes -->
      <section class="cards-grid">
        <article class="card kpi-card">
          <h2 class="card-title">Clientes totales</h2>
          <p class="card-kpi" id="kpi-clientes-total">0</p>
          <p class="card-kpi-sub">Cantidad de clientes registrados.</p>
        </article>

        <article class="card kpi-card">
          <h2 class="card-title">Clientes de contado</h2>
          <p class="card-kpi" id="kpi-clientes-contado">0</p>
          <p class="card-kpi-sub">Compran sin cr√©dito.</p>
        </article>

        <article class="card kpi-card">
          <h2 class="card-title">Clientes a cr√©dito</h2>
          <p class="card-kpi" id="kpi-clientes-credito">0</p>
          <p class="card-kpi-sub">Autorizados para fiado / cr√©dito.</p>
        </article>

        <article class="card kpi-card">
          <h2 class="card-title">√öltimo cliente agregado</h2>
          <p class="card-kpi" id="kpi-clientes-ultimo">-</p>
          <p class="card-kpi-sub">Nombre del √∫ltimo registro.</p>
        </article>
      </section>

      <!-- Formulario de nuevo cliente -->
      <section class="card">
        <h2 class="card-title">1. Registrar nuevo cliente</h2>
        <p class="card-description">
          Guarda los datos b√°sicos para usar despu√©s en ventas, facturaci√≥n y control de cartera.
        </p>

        <div class="form-grid">
          <div class="form-field">
            <label for="cNombre">Nombre completo</label>
            <input id="cNombre" class="input" type="text"
                   placeholder="Ej: Juan P√©rez, Tienda La Esquina">
          </div>

          <div class="form-field">
            <label for="cTelefono">Tel√©fono / WhatsApp</label>
            <input id="cTelefono" class="input" type="tel"
                   placeholder="Ej: 5555-5555">
          </div>

          <div class="form-field">
            <label for="cNit">NIT / DPI</label>
            <input id="cNit" class="input" type="text"
                   placeholder="Ej: 1234567-8, C/F">
          </div>

          <div class="form-field">
            <label for="cTipo">Tipo de cliente</label>
            <select id="cTipo" class="input">
              <option value="contado">Contado</option>
              <option value="credito">Cr√©dito</option>
            </select>
          </div>

          <div class="form-field" id="campoLimiteCredito" style="display: none;">
            <label for="cLimiteCredito">L√≠mite de cr√©dito (Q)</label>
            <input id="cLimiteCredito" class="input" type="number" min="0" step="0.01"
                   placeholder="Ej: 500.00">
          </div>

          <div class="form-field" style="grid-column: 1 / -1;">
            <label for="cDireccion">Direcci√≥n</label>
            <input id="cDireccion" class="input" type="text"
                   placeholder="Ej: Zona 1, Guatemala, domicilio, referencia, etc.">
          </div>

          <div class="form-field" style="grid-column: 1 / -1;">
            <label for="cNotas">Notas (opcional)</label>
            <input id="cNotas" class="input" type="text"
                   placeholder="Ej: Prefiere pago contra entrega, horarios de atenci√≥n, etc.">
          </div>
        </div>

        <button class="btn" id="btnGuardarCliente" style="margin-top: 0.75rem;">
          Guardar cliente
        </button>
      </section>

      <!-- Buscador y lista de clientes -->
      <section class="card">
        <h2 class="card-title">2. Lista de clientes</h2>
        <p class="card-description">
          Busca por nombre, tel√©fono o NIT. Los m√°s recientes aparecen primero.
        </p>

        <div class="form-grid" style="margin-bottom: 0.75rem;">
          <div class="form-field" style="grid-column: 1 / -1;">
            <label for="buscarCliente">Buscar cliente</label>
            <input id="buscarCliente" class="input" type="text"
                   placeholder="Escribe parte del nombre, tel√©fono o NIT">
          </div>
        </div>

        <table class="table">
          <thead>
            <tr>
              <th>Nombre</th>
              <th>Tel√©fono</th>
              <th>NIT / DPI</th>
              <th>Tipo</th>
              <th>Direcci√≥n</th>
              <th>Creado</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="tabla-clientes-body">
            <tr>
              <td colspan="7" class="table-empty">
                A√∫n no hay clientes registrados.
              </td>
            </tr>
          </tbody>
        </table>
      </section>
    </main>
  </div>

  <!-- Scripts base -->
  <script src="alex-storage.js"></script>
  <script src="alex-roles.js"></script>

  <script>
    // ===== Men√∫ m√≥vil =====
    const btnMenuMobile = document.getElementById('btnMenuMobile');
    const sidebar = document.querySelector('.sidebar');
    if (btnMenuMobile) {
      btnMenuMobile.addEventListener('click', () => {
        sidebar.classList.toggle('sidebar-open');
      });
    }

    // ===== Usuario y permisos =====
    const usuarioActual = typeof getUsuarioActualObligatorio === "function"
      ? getUsuarioActualObligatorio()
      : null;

    if (typeof aplicarPermisosYProteger === "function") {
      aplicarPermisosYProteger("clientes");
    }

    const labelUser = document.getElementById("topbar-user-label");
    if (usuarioActual && labelUser) {
      const rolTexto = usuarioActual.rol === "dueno" ? "Due√±o" : "Empleado";
      labelUser.textContent = `${usuarioActual.nombre} (${rolTexto})`;
    }

    // ===== Helpers =====
    function formatearFechaLocal(fechaIso) {
      const d = new Date(fechaIso);
      if (isNaN(d.getTime())) return "-";
      return d.toLocaleString("es-GT");
    }

    // ===== Datos base: clientes =====
    let clientes = [];
    if (typeof load === "function") {
      const cData = load("clientes", []);
      clientes = Array.isArray(cData) ? cData : [];
    }

    function guardarClientes() {
      if (typeof save === "function") {
        save("clientes", clientes);
      }
    }

    // ===== KPIs de clientes =====
    function recalcularKPIsClientes() {
      const total = clientes.length;
      const contados = clientes.filter(c => c.tipo === "contado").length;
      const creditos = clientes.filter(c => c.tipo === "credito").length;
      const kpiTotal = document.getElementById("kpi-clientes-total");
      const kpiContado = document.getElementById("kpi-clientes-contado");
      const kpiCredito = document.getElementById("kpi-clientes-credito");
      const kpiUltimo = document.getElementById("kpi-clientes-ultimo");

      if (kpiTotal) kpiTotal.textContent = String(total);
      if (kpiContado) kpiContado.textContent = String(contados);
      if (kpiCredito) kpiCredito.textContent = String(creditos);
      
      if (kpiUltimo) {
        if (!clientes.length) {
          kpiUltimo.textContent = "-";
        } else {
          const ultimo = clientes[clientes.length - 1];
          kpiUltimo.textContent = ultimo.nombre || "-";
        }
      }
    }

    // ===== Renderizar tabla de clientes =====
    const tbodyClientes = document.getElementById("tabla-clientes-body");
    const inputBuscarCliente = document.getElementById("buscarCliente");

    function renderClientes() {
      if (!tbodyClientes) return;

      const filtro = (inputBuscarCliente && inputBuscarCliente.value.trim().toLowerCase()) || "";

      tbodyClientes.innerHTML = "";

      if (!clientes.length) {
        tbodyClientes.innerHTML = `
          <tr>
            <td colspan="7" class="table-empty">
              A√∫n no hay clientes registrados.
            </td>
          </tr>
        `;
        recalcularKPIsClientes();
        return;
      }

      const ordenados = [...clientes].sort((a, b) => {
        const fa = new Date(a.creadoEnIso || a.creadoEn || 0).getTime();
        const fb = new Date(b.creadoEnIso || b.creadoEn || 0).getTime();
        return fb - fa; // m√°s recientes primero
      });

      const filtrados = filtro
        ? ordenados.filter(c => {
            const nombre = (c.nombre || "").toLowerCase();
            const tel = (c.telefono || "").toLowerCase();
            const nit = (c.nit || "").toLowerCase();
            return (
              nombre.includes(filtro) ||
              tel.includes(filtro) ||
              nit.includes(filtro)
            );
          })
        : ordenados;

      if (!filtrados.length) {
        tbodyClientes.innerHTML = `
          <tr>
            <td colspan="7" class="table-empty">
              No se encontraron clientes con ese texto.
            </td>
          </tr>
        `;
        recalcularKPIsClientes();
        return;
      }

      filtrados.forEach((c, index) => {
        const tipoLegible = c.tipo === "credito" ? "Cr√©dito" : "Contado";
        const fechaCreado = c.creadoEn || (c.creadoEnIso ? formatearFechaLocal(c.creadoEnIso) : "-");

        tbodyClientes.innerHTML += `
          <tr>
            <td>${c.nombre || "-"}</td>
            <td>${c.telefono || "-"}</td>
            <td>${c.nit || "-"}</td>
            <td>${tipoLegible}</td>
            <td>${c.direccion || "-"}</td>
            <td>${fechaCreado}</td>
            <td>
              <button class="btn btn-small" data-delete-index="${index}">üóëÔ∏è</button>
            </td>
          </tr>
        `;
      });

      recalcularKPIsClientes();
    }

    // ===== Mostrar / ocultar l√≠mite de cr√©dito seg√∫n tipo =====
    const selectTipoCliente = document.getElementById("cTipo");
    const campoLimiteCredito = document.getElementById("campoLimiteCredito");

    if (selectTipoCliente && campoLimiteCredito) {
      selectTipoCliente.addEventListener("change", () => {
        if (selectTipoCliente.value === "credito") {
          campoLimiteCredito.style.display = "block";
        } else {
          campoLimiteCredito.style.display = "none";
        }
      });
    }

    // ===== Guardar nuevo cliente =====
    const inpNombre = document.getElementById("cNombre");
    const inpTelefono = document.getElementById("cTelefono");
    const inpNit = document.getElementById("cNit");
    const inpTipo = document.getElementById("cTipo");
    const inpLimiteCredito = document.getElementById("cLimiteCredito");
    const inpDireccion = document.getElementById("cDireccion");
    const inpNotas = document.getElementById("cNotas");
    const btnGuardarCliente = document.getElementById("btnGuardarCliente");

    function guardarCliente() {
      const nombre = (inpNombre.value || "").trim();
      const telefono = (inpTelefono.value || "").trim();
      const nit = (inpNit.value || "").trim() || "C/F";
      const tipo = inpTipo.value || "contado";
      const limiteCredito = tipo === "credito"
        ? (parseFloat(inpLimiteCredito.value) || 0)
        : 0;
      const direccion = (inpDireccion.value || "").trim();
      const notas = (inpNotas.value || "").trim();

      if (!nombre) {
        alert("Escribe el nombre del cliente.");
        return;
      }

      // Opcional: validar tel√©fono m√≠nimo 6 caracteres
      if (telefono && telefono.length < 6) {
        if (!confirm("El tel√©fono parece muy corto, ¬øseguro que es correcto?")) {
          return;
        }
      }

      const ahora = new Date();
      const creadoEnIso = ahora.toISOString();
      const creadoEn = ahora.toLocaleString("es-GT");

      const nuevo = {
        id: "cliente_" + Date.now(),
        nombre,
        telefono,
        nit,
        tipo,
        limiteCredito,
        direccion,
        notas,
        creadoEn,
        creadoEnIso,
        usuarioCreador: usuarioActual ? usuarioActual.usuario : null
      };

      clientes.push(nuevo);
      guardarClientes();

      // Limpiar formulario
      inpNombre.value = "";
      inpTelefono.value = "";
      inpNit.value = "";
      inpDireccion.value = "";
      inpNotas.value = "";
      inpTipo.value = "contado";
      if (inpLimiteCredito) inpLimiteCredito.value = "";
      if (campoLimiteCredito) campoLimiteCredito.style.display = "none";
      inpNombre.focus();

      renderClientes();
      alert("Cliente guardado correctamente.");
    }

    if (btnGuardarCliente) {
      btnGuardarCliente.addEventListener("click", guardarCliente);
    }

    // Enter en NIT ‚Üí guardar
    if (inpNit) {
      inpNit.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          guardarCliente();
        }
      });
    }

    // Buscar mientras se escribe
    if (inputBuscarCliente) {
      inputBuscarCliente.addEventListener("input", () => {
        renderClientes();
      });
    }

    // Eliminar cliente (por ahora permitimos que cualquiera que est√© logueado pueda borrar;
    // si quieres, luego lo hacemos solo para rol "dueno").
    if (tbodyClientes) {
      tbodyClientes.addEventListener("click", (e) => {
        const btn = e.target.closest("button[data-delete-index]");
        if (!btn) return;
        const idx = parseInt(btn.getAttribute("data-delete-index"));
        if (isNaN(idx)) return;

        if (!confirm("¬øSeguro que quieres eliminar este cliente?")) return;
        clientes.splice(idx, 1);
        guardarClientes();
        renderClientes();
      });
    }

    // ===== Primera carga =====
    renderClientes();
  </script>
</body>
</html>
