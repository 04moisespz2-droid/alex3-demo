<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>ALEX 3.0 - Reportes</title>
  <link rel="stylesheet" href="styles.css">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>

<body class="dashboard-body">
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <span class="logo-badge">A</span>
      <div class="sidebar-logo-text">
        <span class="sidebar-logo-main">ALEX 3.0</span>
        <span class="sidebar-logo-sub">Panel del negocio</span>
      </div>
    </div>

    <nav class="sidebar-nav">
      <a href="dashboard.html" class="sidebar-link">üìä Dashboard</a>
      <a href="ventas.html" class="sidebar-link">üíµ Ventas</a>
      <a href="inventario.html" class="sidebar-link">üì¶ Inventario</a>
      <a href="caja.html" class="sidebar-link">üí∞ Caja</a>
      <a href="compras.html" class="sidebar-link">üßæ Compras</a>
      <a href="gastos.html" class="sidebar-link">üìâ Gastos</a>
      <a href="clientes.html" class="sidebar-link">üë• Clientes</a>
      <a href="proveedores.html" class="sidebar-link">üöö Proveedores</a>
      <a href="reportes.html" class="sidebar-link active">üìö Reportes</a>
      <a href="ia.html" class="sidebar-link">ü§ñ IA empresarial</a>
      <a href="configuracion.html" class="sidebar-link">‚öôÔ∏è Configuraci√≥n</a>
    </nav>

    <div class="sidebar-footer">
      <span class="sidebar-footer-title" id="sidebar-footer-title">Mi negocio</span>
      <span class="sidebar-footer-sub">M√≥dulo de reportes</span>
    </div>
  </aside>

  <!-- Layout principal -->
  <div class="main-layout">
    <!-- Topbar -->
    <header class="topbar">
      <button class="btn-menu-mobile" id="btnMenuMobile">‚ò∞</button>

      <div class="topbar-left">
        <h1 class="topbar-title">Reportes</h1>
        <p class="topbar-subtitle">
          Resumen inteligente de ventas, compras y gastos. ALEX te muestra el resultado del negocio por periodo.
        </p>
      </div>

      <div class="topbar-right">
        <span class="topbar-company" id="topbar-company-label">Mi negocio</span>
        <span class="topbar-divider">‚Ä¢</span>
        <span class="topbar-user" id="topbar-user-label">Usuario (Rol)</span>
      </div>
    </header>

    <!-- Contenido principal -->
    <main class="main-content">
      <!-- Filtros generales -->
      <section class="card">
        <h2 class="card-title">Filtro de periodo</h2>
        <p class="card-description">
          Escoge el periodo para ver los reportes. ALEX recalcula todo: ventas, compras, gastos y resultado.
        </p>

        <div class="form-grid">
          <div class="form-field">
            <label for="filtroPeriodo">Periodo</label>
            <select id="filtroPeriodo" class="input">
              <option value="hoy">Hoy</option>
              <option value="mes">Este mes</option>
              <option value="todos">Toda la historia</option>
            </select>
          </div>
        </div>
      </section>

      <!-- KPIs -->
      <section class="cards-grid">
        <article class="card kpi-card">
          <h2 class="card-title">Ingresos por ventas</h2>
          <p class="card-kpi" id="rep-ventas-total">Q 0.00</p>
          <p class="card-kpi-sub">Suma de ventas en el periodo.</p>
        </article>

        <article class="card kpi-card">
          <h2 class="card-title">Compras a proveedores</h2>
          <p class="card-kpi" id="rep-compras-total">Q 0.00</p>
          <p class="card-kpi-sub">Suma de compras en el periodo.</p>
        </article>

        <article class="card kpi-card">
          <h2 class="card-title">Gastos del negocio</h2>
          <p class="card-kpi" id="rep-gastos-total">Q 0.00</p>
          <p class="card-kpi-sub">Suma de gastos (no inventario).</p>
        </article>

        <article class="card kpi-card">
          <h2 class="card-title">Resultado operativo</h2>
          <p class="card-kpi" id="rep-resultado">Q 0.00</p>
          <p class="card-kpi-sub">Ventas - compras - gastos.</p>
        </article>
      </section>

      <!-- Resumen texto -->
      <section class="card">
        <h2 class="card-title">Resumen del periodo</h2>
        <p class="card-description" id="rep-resumen-texto">
          Cargando resumen del periodo...
        </p>

        <ul class="bullet-list" id="rep-resumen-detalle">
          <!-- Se llena por JS -->
        </ul>
      </section>

      <!-- Tabla por d√≠a -->
      <section class="card">
        <h2 class="card-title">Detalle por d√≠a</h2>
        <p class="card-description">
          Aqu√≠ ves c√≥mo se movi√≥ el negocio d√≠a por d√≠a: cu√°nto vendiste, cu√°nto compraste,
          cu√°nto gastaste y cu√°l fue el resultado de cada d√≠a.
        </p>

        <table class="table">
          <thead>
            <tr>
              <th>Fecha</th>
              <th>Ventas</th>
              <th>Compras</th>
              <th>Gastos</th>
              <th>Resultado</th>
            </tr>
          </thead>
          <tbody id="rep-tabla-dias-body">
            <tr>
              <td colspan="5" class="table-empty">
                A√∫n no hay movimientos para este periodo.
              </td>
            </tr>
          </tbody>
        </table>
      </section>

      <!-- Mini resumen de vol√∫menes -->
      <section class="card">
        <h2 class="card-title">Volumen de documentos</h2>
        <p class="card-description">
          Cantidad de documentos del periodo seleccionado.
        </p>

        <ul class="bullet-list" id="rep-volumen-detalle">
          <!-- Se llena por JS -->
        </ul>
      </section>
    </main>
  </div>

  <!-- Scripts base -->
  <script src="alex-storage.js"></script>
  <script src="alex-roles.js"></script>

  <script>
    // ===== Men√∫ m√≥vil =====
    const btnMenuMobile = document.getElementById('btnMenuMobile');
    const sidebar = document.querySelector('.sidebar');
    if (btnMenuMobile) {
      btnMenuMobile.addEventListener('click', () => {
        sidebar.classList.toggle('sidebar-open');
      });
    }

    // ===== Usuario, permisos y negocio =====
    const usuarioActual = typeof getUsuarioActualObligatorio === "function"
      ? getUsuarioActualObligatorio()
      : null;

    if (typeof aplicarPermisosYProteger === "function") {
      aplicarPermisosYProteger("reportes");
    }

    const labelUser = document.getElementById("topbar-user-label");
    const labelCompany = document.getElementById("topbar-company-label");
    const sidebarFooterTitle = document.getElementById("sidebar-footer-title");

    let negocioConfig = {
      nombre: "Mi negocio"
    };

    if (typeof load === "function") {
      const cfg = load("negocio_config", null);
      if (cfg && typeof cfg === "object") {
        negocioConfig = Object.assign(negocioConfig, cfg);
      }
    }

    if (labelCompany) labelCompany.textContent = negocioConfig.nombre || "Mi negocio";
    if (sidebarFooterTitle) sidebarFooterTitle.textContent = negocioConfig.nombre || "Mi negocio";

    if (usuarioActual && labelUser) {
      const rolTexto = usuarioActual.rol === "dueno" ? "Due√±o" : "Empleado";
      labelUser.textContent = `${usuarioActual.nombre} (${rolTexto})`;
    }

    // ===== Helpers =====
    function alex3FormatearMonedaSeguro(valor) {
      if (typeof alex3FormatearMoneda === "function") {
        return alex3FormatearMoneda(valor);
      }
      const num = Number(valor);
      if (isNaN(num)) return "Q 0.00";
      return "Q " + num.toFixed(2);
    }

    function esMismoDia(a, b) {
      return a.getFullYear() === b.getFullYear() &&
             a.getMonth() === b.getMonth() &&
             a.getDate() === b.getDate();
    }

    function esMismoMes(a, b) {
      return a.getFullYear() === b.getFullYear() &&
             a.getMonth() === b.getMonth();
    }

    function normalizarFechaSolo(dateObj) {
      const y = dateObj.getFullYear();
      const m = String(dateObj.getMonth() + 1).padStart(2, "0");
      const d = String(dateObj.getDate()).padStart(2, "0");
      return `${y}-${m}-${d}`;
    }

    function formatearFechaBonita(fechaStr) {
      // fechaStr: YYYY-MM-DD
      const [y, m, d] = fechaStr.split("-");
      const date = new Date(Number(y), Number(m)-1, Number(d));
      return date.toLocaleDateString("es-GT", {
        year: "numeric",
        month: "short",
        day: "2-digit"
      });
    }

    // ===== Datos: ventas, compras, gastos =====
    let ventas = [];
    let compras = [];
    let gastos = [];

    if (typeof load === "function") {
      const vData = load("ventas", []);
      ventas = Array.isArray(vData) ? vData : [];

      const cData = load("compras", []);
      compras = Array.isArray(cData) ? cData : [];

      const gData = load("gastos", []);
      gastos = Array.isArray(gData) ? gData : [];
    }

    // ===== DOM =====
    const filtroPeriodo = document.getElementById("filtroPeriodo");

    const lblVentasTotal = document.getElementById("rep-ventas-total");
    const lblComprasTotal = document.getElementById("rep-compras-total");
    const lblGastosTotal = document.getElementById("rep-gastos-total");
    const lblResultado = document.getElementById("rep-resultado");

    const resumenTexto = document.getElementById("rep-resumen-texto");
    const resumenDetalle = document.getElementById("rep-resumen-detalle");
    const tablaDiasBody = document.getElementById("rep-tabla-dias-body");
    const volumenDetalle = document.getElementById("rep-volumen-detalle");

    // ===== Funciones de filtro por periodo =====
    function estaEnPeriodo(fecha, periodo) {
      const hoy = new Date();
      if (periodo === "hoy") {
        return esMismoDia(fecha, hoy);
      }
      if (periodo === "mes") {
        return esMismoMes(fecha, hoy);
      }
      return true; // "todos"
    }

    function filtrarPorPeriodo(array, campoFecha, periodo) {
      return array.filter(item => {
        const fecha = new Date(item[campoFecha] || item.fecha || Date.now());
        if (isNaN(fecha.getTime())) return false;
        return estaEnPeriodo(fecha, periodo);
      });
    }

    // ===== Recalcular reportes =====
    function recalcularReportes() {
      if (!filtroPeriodo) return;
      const periodo = filtroPeriodo.value || "hoy";

      // Filtrar
      const ventasFiltradas = filtrarPorPeriodo(ventas, "fechaHora", periodo);
      const comprasFiltradas = filtrarPorPeriodo(compras, "fechaHora", periodo);
      const gastosFiltrados = filtrarPorPeriodo(gastos, "fechaHora", periodo);

      // Totales
      const totalVentas = ventasFiltradas.reduce((s, v) => s + (Number(v.total) || 0), 0);
      const totalCompras = comprasFiltradas.reduce((s, c) => s + (Number(c.total) || 0), 0);
      const totalGastos = gastosFiltrados.reduce((s, g) => s + (Number(g.monto) || 0), 0);

      const resultado = totalVentas - totalCompras - totalGastos;

      if (lblVentasTotal) lblVentasTotal.textContent = alex3FormatearMonedaSeguro(totalVentas);
      if (lblComprasTotal) lblComprasTotal.textContent = alex3FormatearMonedaSeguro(totalCompras);
      if (lblGastosTotal) lblGastosTotal.textContent = alex3FormatearMonedaSeguro(totalGastos);
      if (lblResultado) lblResultado.textContent = alex3FormatearMonedaSeguro(resultado);

      // Resumen texto
      if (resumenTexto && resumenDetalle) {
        let textoPeriodo = "el d√≠a de hoy";
        if (periodo === "mes") textoPeriodo = "este mes";
        if (periodo === "todos") textoPeriodo = "toda la historia registrada";

        if (!ventasFiltradas.length && !comprasFiltradas.length && !gastosFiltrados.length) {
          resumenTexto.textContent = `No hay movimientos registrados para ${textoPeriodo}.`;
          resumenDetalle.innerHTML = "";
        } else {
          resumenTexto.textContent = `Resumen del negocio para ${textoPeriodo}:`;
          const signoResultado = resultado >= 0 ? "positivo" : "negativo";

          resumenDetalle.innerHTML = `
            <li><strong>Ingresos por ventas:</strong> ${alex3FormatearMonedaSeguro(totalVentas)}</li>
            <li><strong>Compras a proveedores:</strong> ${alex3FormatearMonedaSeguro(totalCompras)}</li>
            <li><strong>Gastos del negocio:</strong> ${alex3FormatearMonedaSeguro(totalGastos)}</li>
            <li><strong>Resultado operativo (${signoResultado}):</strong> ${alex3FormatearMonedaSeguro(resultado)}</li>
          `;
        }
      }

      // Tabla por d√≠a
      if (tablaDiasBody) {
        tablaDiasBody.innerHTML = "";

        if (!ventasFiltradas.length && !comprasFiltradas.length && !gastosFiltrados.length) {
          tablaDiasBody.innerHTML = `
            <tr>
              <td colspan="5" class="table-empty">
                A√∫n no hay movimientos para este periodo.
              </td>
            </tr>
          `;
        } else {
          const mapaDias = {};

          // Ventas
          ventasFiltradas.forEach(v => {
            const fecha = new Date(v.fechaHora || v.fecha || Date.now());
            if (isNaN(fecha.getTime())) return;
            const key = normalizarFechaSolo(fecha);
            if (!mapaDias[key]) {
              mapaDias[key] = { ventas: 0, compras: 0, gastos: 0 };
            }
            mapaDias[key].ventas += Number(v.total) || 0;
          });

          // Compras
          comprasFiltradas.forEach(c => {
            const fecha = new Date(c.fechaHora || c.fecha || Date.now());
            if (isNaN(fecha.getTime())) return;
            const key = normalizarFechaSolo(fecha);
            if (!mapaDias[key]) {
              mapaDias[key] = { ventas: 0, compras: 0, gastos: 0 };
            }
            mapaDias[key].compras += Number(c.total) || 0;
          });

          // Gastos
          gastosFiltrados.forEach(g => {
            const fecha = new Date(g.fechaHora || g.fecha || Date.now());
            if (isNaN(fecha.getTime())) return;
            const key = normalizarFechaSolo(fecha);
            if (!mapaDias[key]) {
              mapaDias[key] = { ventas: 0, compras: 0, gastos: 0 };
            }
            mapaDias[key].gastos += Number(g.monto) || 0;
          });

          const fechasOrdenadas = Object.keys(mapaDias).sort((a, b) => {
            return new Date(a).getTime() - new Date(b).getTime();
          });

          fechasOrdenadas.forEach(fechaKey => {
            const data = mapaDias[fechaKey];
            const resultadoDia = data.ventas - data.compras - data.gastos;

            tablaDiasBody.innerHTML += `
              <tr>
                <td>${formatearFechaBonita(fechaKey)}</td>
                <td>${alex3FormatearMonedaSeguro(data.ventas)}</td>
                <td>${alex3FormatearMonedaSeguro(data.compras)}</td>
                <td>${alex3FormatearMonedaSeguro(data.gastos)}</td>
                <td>${alex3FormatearMonedaSeguro(resultadoDia)}</td>
              </tr>
            `;
          });
        }
      }

      // Volumen de documentos
      if (volumenDetalle) {
        const cantVentas = ventasFiltradas.length;
        const cantCompras = comprasFiltradas.length;
        const cantGastos = gastosFiltrados.length;

        volumenDetalle.innerHTML = `
          <li><strong>Tickets de venta:</strong> ${cantVentas}</li>
          <li><strong>Documentos de compra:</strong> ${cantCompras}</li>
          <li><strong>Registros de gastos:</strong> ${cantGastos}</li>
        `;
      }
    }

    // ===== Eventos =====
    if (filtroPeriodo) {
      filtroPeriodo.addEventListener("change", recalcularReportes);
    }

    // ===== Primera carga =====
    recalcularReportes();
  </script>
</body>
</html>
