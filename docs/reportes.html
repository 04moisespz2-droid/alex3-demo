<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Reportes - ALEX 3.0</title>
  <link rel="stylesheet" href="styles.css">
</head>

<body class="dashboard-body">

  <div class="sidebar">
    <h2 class="logo">ALEX 3.0</h2>
    <ul class="menu">
      <li id="menu-dashboard"><a href="dashboard.html"> Inicio</a></li>
      <li id="menu-inventario"><a href="inventario.html"> Inventario</a></li>
      <li id="menu-ventas"><a href="ventas.html"> Ventas</a></li>
      <li id="menu-caja"><a href="caja.html"> Caja</a></li>
      <li id="menu-usuarios"><a href="usuarios.html"> Usuarios</a></li>
      <li id="menu-reportes"><a href="reportes.html"> Reportes</a></li>
      <li id="menu-configuracion"><a href="configuracion.html">锔 Configuraci贸n</a></li>
    </ul>
  </div>

  <div class="main-content">
    <h1>Reportes generales</h1>

    <!-- RESUMEN PRINCIPAL -->
    <div class="resumen-caja">
      <div class="card-resumen">
        <h4>Total de productos</h4>
        <p><span id="rep-total-productos">0</span></p>
      </div>
      <div class="card-resumen">
        <h4>Stock total</h4>
        <p><span id="rep-stock-total">0</span></p>
      </div>
      <div class="card-resumen ingreso">
        <h4>Ingresos caja (hist贸rico)</h4>
        <p><span id="rep-total-ingresos">Q 0.00</span></p>
      </div>
      <div class="card-resumen egreso">
        <h4>Egresos caja (hist贸rico)</h4>
        <p><span id="rep-total-egresos">Q 0.00</span></p>
      </div>
      <div class="card-resumen saldo">
        <h4>Saldo actual estimado</h4>
        <p><span id="rep-saldo-actual">Q 0.00</span></p>
      </div>
    </div>

    <!-- INVENTARIO -->
    <h2>Inventario (resumen)</h2>
    <p>Listado r谩pido de productos registrados en el sistema.</p>
    <table class="tabla">
      <thead>
        <tr>
          <th>C贸digo</th>
          <th>Nombre</th>
          <th>Compra</th>
          <th>Venta</th>
          <th>Ganancia</th>
          <th>Margen (%)</th>
          <th>Stock</th>
        </tr>
      </thead>
      <tbody id="tabla-inventario-reporte"></tbody>
    </table>

    <!-- MOVIMIENTOS DE CAJA -->
    <h2>Movimientos de caja</h2>
    <p>Historial de ingresos y egresos registrados en la caja profesional.</p>
    <table class="tabla">
      <thead>
        <tr>
          <th>Fecha/Hora</th>
          <th>Tipo</th>
          <th>Categor铆a</th>
          <th>Descripci贸n</th>
          <th>Monto</th>
        </tr>
      </thead>
      <tbody id="tabla-movimientos-reporte"></tbody>
    </table>

    <!-- CIERRES DE CAJA -->
    <h2>Cierres de caja</h2>
    <p>Resumen de cada cierre registrado.</p>
    <table class="tabla">
      <thead>
        <tr>
          <th>Fecha/Hora</th>
          <th>Saldo al cierre</th>
          <th>Observaciones</th>
        </tr>
      </thead>
      <tbody id="tabla-cierres-reporte"></tbody>
    </table>

  </div>

  <script src="alex-storage.js"></script>
  <script src="alex-dev.js"></script>
  <script src="alex-roles.js"></script>

  <script>
    // Usuario y permisos
    const usuarioActual = typeof getUsuarioActualObligatorio === "function"
      ? getUsuarioActualObligatorio()
      : null;

    if (typeof aplicarPermisosYProteger === "function") {
      aplicarPermisosYProteger("reportes");
    }

    // Helpers
    function alex3FormatearMonedaSeguro(n) {
      if (typeof alex3FormatearMoneda === "function") {
        return alex3FormatearMoneda(n);
      }
      const num = Number(n);
      if (isNaN(num)) return "Q 0.00";
      return "Q " + num.toFixed(2);
    }

    function formatearFechaBonita(fechaIso) {
      const d = new Date(fechaIso);
      if (isNaN(d.getTime())) return fechaIso || "-";
      const dia = String(d.getDate()).padStart(2, "0");
      const mes = String(d.getMonth() + 1).padStart(2, "0");
      const anio = d.getFullYear();
      const horas = String(d.getHours()).padStart(2, "0");
      const mins = String(d.getMinutes()).padStart(2, "0");
      return `${dia}/${mes}/${anio} ${horas}:${mins}`;
    }

    // Cargar datos guardados con las claves nuevas que usamos en el sistema
    const productos = (typeof load === "function" ? load("productos", []) : []) || [];
    const movimientos = (typeof load === "function" ? load("caja_movimientos", []) : []) || [];
    const cierres = (typeof load === "function" ? load("caja_cortes", []) : []) || [];
    const ventas = (typeof load === "function" ? load("ventas", []) : []) || [];

    // ===== RESUMEN PRINCIPAL =====
    function calcularResumen() {
      const totalProductos = Array.isArray(productos) ? productos.length : 0;
      const stockTotal = Array.isArray(productos)
        ? productos.reduce((acc, p) => acc + (Number(p.stock) || 0), 0)
        : 0;

      let totalIngresosMov = 0;
      let totalEgresosMov = 0;

      if (Array.isArray(movimientos)) {
        movimientos.forEach(m => {
          const monto = Number(m.monto) || 0;
          if (m.tipo === "INGRESO") {
            totalIngresosMov += monto;
          } else if (m.tipo === "EGRESO") {
            totalEgresosMov += monto;
          }
        });
      }

      let totalVentas = 0;
      if (Array.isArray(ventas)) {
        ventas.forEach(v => {
          totalVentas += Number(v.total) || 0;
        });
      }

      const totalIngresos = totalIngresosMov + totalVentas;
      const totalEgresos = totalEgresosMov;
      const saldoActual = totalIngresos - totalEgresos;

      document.getElementById("rep-total-productos").innerText = totalProductos;
      document.getElementById("rep-stock-total").innerText = stockTotal;
      document.getElementById("rep-total-ingresos").innerText = alex3FormatearMonedaSeguro(totalIngresos);
      document.getElementById("rep-total-egresos").innerText = alex3FormatearMonedaSeguro(totalEgresos);
      document.getElementById("rep-saldo-actual").innerText = alex3FormatearMonedaSeguro(saldoActual);
    }

    // ===== TABLA DE INVENTARIO =====
    function renderInventario() {
      const tbody = document.getElementById("tabla-inventario-reporte");
      tbody.innerHTML = "";

      if (!Array.isArray(productos) || !productos.length) {
        tbody.innerHTML = `
          <tr>
            <td colspan="7" class="table-empty">No hay productos registrados.</td>
          </tr>
        `;
        return;
      }

      productos.forEach(p => {
        const compra = alex3FormatearMonedaSeguro(p.compra);
        const venta = alex3FormatearMonedaSeguro(p.venta);
        const ganancia = alex3FormatearMonedaSeguro(p.ganancia);
        const margen = (p.margen != null ? p.margen : 0) + "%";

        tbody.innerHTML += `
          <tr>
            <td>${p.codigo || ""}</td>
            <td>${p.nombre || ""}</td>
            <td>${compra}</td>
            <td>${venta}</td>
            <td>${ganancia}</td>
            <td>${margen}</td>
            <td>${p.stock != null ? p.stock : 0}</td>
          </tr>
        `;
      });
    }

    // ===== TABLA DE MOVIMIENTOS DE CAJA =====
    function renderMovimientos() {
      const tbody = document.getElementById("tabla-movimientos-reporte");
      tbody.innerHTML = "";

      if (!Array.isArray(movimientos) || !movimientos.length) {
        tbody.innerHTML = `
          <tr>
            <td colspan="5" class="table-empty">No hay movimientos de caja registrados.</td>
          </tr>
        `;
        return;
      }

      // M谩s recientes primero
      const ordenados = [...movimientos].sort((a, b) => {
        const fa = new Date(a.fecha || a.fechaHora || 0).getTime();
        const fb = new Date(b.fecha || b.fechaHora || 0).getTime();
        return fb - fa;
      });

      ordenados.forEach(m => {
        const fecha = formatearFechaBonita(m.fecha || m.fechaHora || "");
        const tipoTexto = m.tipo === "EGRESO" ? "Egreso" : "Ingreso";
        const categoria = m.categoria || "";
        const desc = m.descripcion || "";
        const monto = alex3FormatearMonedaSeguro(m.monto);

        tbody.innerHTML += `
          <tr>
            <td>${fecha}</td>
            <td>${tipoTexto}</td>
            <td>${categoria}</td>
            <td>${desc}</td>
            <td>${monto}</td>
          </tr>
        `;
      });
    }

    // ===== TABLA DE CIERRES DE CAJA =====
    function renderCierres() {
      const tbody = document.getElementById("tabla-cierres-reporte");
      tbody.innerHTML = "";

      if (!Array.isArray(cierres) || !cierres.length) {
        tbody.innerHTML = `
          <tr>
            <td colspan="3" class="table-empty">No hay cierres de caja registrados.</td>
          </tr>
        `;
        return;
      }

      // M谩s recientes primero
      const ordenados = [...cierres].sort((a, b) => {
        const fa = new Date(a.fecha || a.fechaHora || 0).getTime();
        const fb = new Date(b.fecha || b.fechaHora || 0).getTime();
        return fb - fa;
      });

      ordenados.forEach(c => {
        const fecha = formatearFechaBonita(c.fecha || c.fechaHora || "");
        const saldoFinal = alex3FormatearMonedaSeguro(c.saldoFinal);
        const obs = c.observaciones || "";

        tbody.innerHTML += `
          <tr>
            <td>${fecha}</td>
            <td>${saldoFinal}</td>
            <td>${obs}</td>
          </tr>
        `;
      });
    }

    // Inicializar p谩gina de reportes
    calcularResumen();
    renderInventario();
    renderMovimientos();
    renderCierres();
  </script>

</body>
</html>
