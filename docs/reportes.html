<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Reportes - ALEX 3.0</title>
  <link rel="stylesheet" href="styles.css">
</head>

<body class="dashboard-body">

  <div class="sidebar">
    <h2 class="logo">ALEX 3.0</h2>
    <ul class="menu">
      <li id="menu-dashboard"><a href="dashboard.html"> Inicio</a></li>
      <li id="menu-inventario"><a href="inventario.html"> Inventario</a></li>
      <li id="menu-ventas"><a href="ventas.html"> Ventas</a></li>
      <li id="menu-caja"><a href="caja.html"> Caja</a></li>
      <li id="menu-usuarios"><a href="usuarios.html"> Usuarios</a></li>
      <li id="menu-reportes" class="active"><a href="reportes.html"> Reportes</a></li>
      <li><a href="configuracion.html">锔 Configuraci贸n</a></li>
    </ul>
  </div>

  <div class="main-content">
    <h1>Reportes generales</h1>

    <!-- RESUMEN DE INVENTARIO -->
    <section class="report-section">
      <h2> Resumen de inventario</h2>
      <p>Resumen basado en los productos registrados actualmente.</p>

      <div class="resumen-caja">
        <div class="card-resumen">
          <h4>Valor de compra (todo el inventario)</h4>
          <p><span id="repInvTotalCompra">0.00</span></p>
        </div>
        <div class="card-resumen ingreso">
          <h4>Valor de venta (si se vende todo)</h4>
          <p><span id="repInvTotalVenta">0.00</span></p>
        </div>
        <div class="card-resumen saldo">
          <h4>Ganancia potencial total</h4>
          <p><span id="repInvGanancia">0.00</span></p>
        </div>
      </div>

      <table class="tabla" style="margin-top: 16px;">
        <thead>
          <tr>
            <th>C贸digo</th>
            <th>Nombre</th>
            <th>Compra</th>
            <th>Venta</th>
            <th>Stock</th>
            <th>Valor compra</th>
            <th>Valor venta</th>
          </tr>
        </thead>
        <tbody id="repInvTablaBody"></tbody>
      </table>
    </section>

    <!-- MOVIMIENTOS DE CAJA -->
    <section class="report-section">
      <h2> Movimientos de caja</h2>
      <p>Listado de movimientos registrados en m贸dulo de caja.</p>

      <table class="tabla">
        <thead>
          <tr>
            <th>Fecha/Hora</th>
            <th>Tipo</th>
            <th>Descripci贸n</th>
            <th>Categor铆a</th>
            <th>Monto</th>
          </tr>
        </thead>
        <tbody id="repCajaMovimientosBody"></tbody>
      </table>
    </section>

    <!-- CIERRES DE CAJA -->
    <section class="report-section">
      <h2>Ь Cierres de caja</h2>
      <p>Historial de cierres registrados.</p>

      <table class="tabla">
        <thead>
          <tr>
            <th>Fecha/Hora</th>
            <th>Saldo al cierre</th>
            <th>Observaciones</th>
          </tr>
        </thead>
        <tbody id="repCajaCierresBody"></tbody>
      </table>
    </section>

    <!-- VENTAS ACTIVAS (CARRITO) -->
    <section class="report-section">
      <h2> Ventas activas (POS)</h2>
      <p>Estado actual de la venta en curso del m贸dulo POS.</p>

      <table class="tabla">
        <thead>
          <tr>
            <th>Producto</th>
            <th>Precio unitario</th>
            <th>Cantidad</th>
            <th>Subtotal</th>
          </tr>
        </thead>
        <tbody id="repVentasActivasBody"></tbody>
      </table>

      <h3 style="margin-top: 10px;">
        Total venta activa:
        <span id="repVentasActivasTotal">0.00</span>
      </h3>
    </section>

  </div>

  <script src="alex-storage.js"></script>
  <script src="alex-roles.js"></script>
  <script>
    const usuarioActual = getUsuarioActualObligatorio();
    aplicarPermisosYProteger("reportes");

    function fm(v) {
      return alex3FormatearMoneda(v);
    }

    // =======================
    // REPORTE DE INVENTARIO
    // =======================
    function cargarReporteInventario() {
      const productos = load("productos", []);
      const tbody = document.getElementById("repInvTablaBody");

      let totalCompra = 0;
      let totalVenta = 0;

      tbody.innerHTML = "";

      productos.forEach(p => {
        const valorCompra = p.compra * p.stock;
        const valorVenta  = p.venta * p.stock;

        totalCompra += valorCompra;
        totalVenta  += valorVenta;

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${p.codigo}</td>
          <td>${p.nombre}</td>
          <td>${fm(p.compra)}</td>
          <td>${fm(p.venta)}</td>
          <td>${p.stock}</td>
          <td>${fm(valorCompra)}</td>
          <td>${fm(valorVenta)}</td>
        `;
        tbody.appendChild(tr);
      });

      const ganancia = totalVenta - totalCompra;

      document.getElementById("repInvTotalCompra").innerText = fm(totalCompra);
      document.getElementById("repInvTotalVenta").innerText  = fm(totalVenta);
      document.getElementById("repInvGanancia").innerText    = fm(ganancia);
    }

    // =======================
    // MOVIMIENTOS DE CAJA
    // =======================
    function cargarReporteCajaMovimientos() {
      const movimientos = load("movimientosCaja", []);
      const tbody = document.getElementById("repCajaMovimientosBody");
      tbody.innerHTML = "";

      movimientos.forEach(m => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${m.fecha}</td>
          <td>${m.tipo === "ingreso" ? "Ingreso" : "Egreso"}</td>
          <td>${m.descripcion}</td>
          <td>${m.categoria}</td>
          <td>${m.tipo === "ingreso" ? "+" : "-"}${fm(m.monto)}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    // =======================
    // CIERRES DE CAJA
    // =======================
    function cargarReporteCajaCierres() {
      const cierres = load("cierresCaja", []);
      const tbody = document.getElementById("repCajaCierresBody");
      tbody.innerHTML = "";

      cierres.forEach(c => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${c.fecha}</td>
          <td>${fm(c.saldoFinal)}</td>
          <td>${c.observaciones}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    // =======================
    // VENTAS ACTIVAS (POS)
    // =======================
    function cargarReporteVentasActivas() {
      const lineas = load("ventasActivas", []);
      const tbody = document.getElementById("repVentasActivasBody");
      const totalSpan = document.getElementById("repVentasActivasTotal");

      tbody.innerHTML = "";
      let total = 0;

      lineas.forEach(l => {
        total += l.subtotal;

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${l.nombre}</td>
          <td>${fm(l.precio)}</td>
          <td>${l.cantidad}</td>
          <td>${fm(l.subtotal)}</td>
        `;
        tbody.appendChild(tr);
      });

      totalSpan.innerText = fm(total);
    }

    // =======================
    // INICIALIZAR REPORTES
    // =======================
    function initReportes() {
      cargarReporteInventario();
      cargarReporteCajaMovimientos();
      cargarReporteCajaCierres();
      cargarReporteVentasActivas();
    }

    initReportes();
  </script>

</body>
</html>
