<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Usuarios - ALEX 3.0</title>
  <link rel="stylesheet" href="styles.css">
</head>

<body class="dashboard-body">

  <div class="sidebar">
    <h2 class="logo">ALEX 3.0</h2>
    <ul class="menu">
      <li id="menu-dashboard"><a href="dashboard.html">ğŸ  Inicio</a></li>
      <li id="menu-inventario"><a href="inventario.html">ğŸ“¦ Inventario</a></li>
      <li id="menu-ventas"><a href="ventas.html">ğŸ’µ Ventas</a></li>
      <li id="menu-caja"><a href="caja.html">ğŸ’° Caja</a></li>
      <li id="menu-usuarios"><a href="usuarios.html">ğŸ‘¤ Usuarios</a></li>
      <li id="menu-reportes"><a href="reportes.html">ğŸ“Š Reportes</a></li>
      <li id="menu-configuracion"><a href="configuracion.html">âš™ï¸ ConfiguraciÃ³n</a></li>
    </ul>
  </div>

  <div class="main-content">
    <h1>GestiÃ³n de usuarios</h1>

    <div class="usuarios-form inventario-form">
      <h3>Agregar usuario</h3>

      <input id="uNombre" class="input" type="text" placeholder="Nombre completo">
      <input id="uUsuario" class="input" type="text" placeholder="Usuario (login)">
      
      <!-- SOLO DUEÃ‘O O EMPLEADO -->
      <select id="uRol" class="input">
        <option value="dueno">DueÃ±o / Administrador</option>
        <option value="empleado">Empleado</option>
      </select>

      <input id="uPassword" class="input" type="password" placeholder="ContraseÃ±a (solo demo)">

      <button class="btn" onclick="agregarUsuario()">Guardar usuario</button>
    </div>

    <h3>Lista de usuarios</h3>
    <table class="tabla">
      <thead>
        <tr>
          <th>Nombre</th>
          <th>Usuario</th>
          <th>Rol</th>
          <th>Creado</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody id="tabla-usuarios-body"></tbody>
    </table>
  </div>

  <script src="alex-storage.js"></script>
  <script src="alex-roles.js"></script>
  <script>
    const usuarioActual = getUsuarioActualObligatorio();
    aplicarPermisosYProteger("usuarios");

    let usuarios = load("usuarios", []);
    if (!Array.isArray(usuarios)) {
      usuarios = [];
    }

    function rolLegible(rol) {
      switch (rol) {
        case "dueno": return "DueÃ±o / Admin";
        case "empleado": return "Empleado";
        default: return rol;
      }
    }

    function contarDuenos() {
      return usuarios.filter(u => u.rol === "dueno").length;
    }

    function agregarUsuario() {
      const nombre = document.getElementById("uNombre").value;
      const usuario = document.getElementById("uUsuario").value;
      const rol = document.getElementById("uRol").value;
      const password = document.getElementById("uPassword").value;

      if (nombre.trim() === "" || usuario.trim() === "" || password.trim() === "") {
        alert("Por favor completa nombre, usuario y contraseÃ±a.");
        return;
      }

      const yaExiste = usuarios.find(u => u.usuario === usuario);
      if (yaExiste) {
        alert("Ya existe un usuario con ese nombre de usuario.");
        return;
      }

      const nuevo = {
        nombre,
        usuario,
        rol,              // solo 'dueno' o 'empleado'
        password,
        creadoEn: new Date().toLocaleString("es-GT")
      };

      usuarios.push(nuevo);
      save("usuarios", usuarios);

      limpiarFormulario();
      renderUsuarios();
    }

    function limpiarFormulario() {
      document.getElementById("uNombre").value = "";
      document.getElementById("uUsuario").value = "";
      document.getElementById("uRol").value = "dueno";
      document.getElementById("uPassword").value = "";
      document.getElementById("uNombre").focus();
    }

    function renderUsuarios() {
      const tbody = document.getElementById("tabla-usuarios-body");
      tbody.innerHTML = "";

      if (!usuarios.length) {
        tbody.innerHTML = `
          <tr>
            <td colspan="5" class="table-empty">AÃºn no hay usuarios registrados.</td>
          </tr>
        `;
        return;
      }

      usuarios.forEach((u, index) => {
        tbody.innerHTML += `
          <tr>
            <td>${u.nombre}</td>
            <td>${u.usuario}</td>
            <td>${rolLegible(u.rol)}</td>
            <td>${u.creadoEn}</td>
            <td><button onclick="eliminarUsuario(${index})">ğŸ—‘ï¸</button></td>
          </tr>
        `;
      });
    }

    function eliminarUsuario(index) {
      const user = usuarios[index];
      if (!user) return;

      if (!confirm("Â¿Seguro que quieres eliminar este usuario?")) return;

      // Evitar quedarte sin ningÃºn dueÃ±o
      if (user.rol === "dueno" && contarDuenos() <= 1) {
        alert("No puedes eliminar el Ãºltimo usuario dueÃ±o. Crea otro dueÃ±o antes de borrar este.");
        return;
      }

      usuarios.splice(index, 1);
      save("usuarios", usuarios);
      renderUsuarios();
    }

    renderUsuarios();
  </script>

</body>
</html>
