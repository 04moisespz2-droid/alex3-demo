<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>ALEX 3.0 - Compras</title>
  <link rel="stylesheet" href="styles.css">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>

<body class="dashboard-body">
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <span class="logo-badge">A</span>
      <div class="sidebar-logo-text">
        <span class="sidebar-logo-main">ALEX 3.0</span>
        <span class="sidebar-logo-sub">Panel del negocio</span>
      </div>
    </div>

    <nav class="sidebar-nav">
      <a href="dashboard.html" class="sidebar-link">üìä Dashboard</a>
      <a href="ventas.html" class="sidebar-link">üíµ Ventas</a>
      <a href="inventario.html" class="sidebar-link">üì¶ Inventario</a>
      <a href="caja.html" class="sidebar-link">üí∞ Caja</a>
      <a href="compras.html" class="sidebar-link active">üßæ Compras</a>
      <a href="gastos.html" class="sidebar-link">üìâ Gastos</a>
      <a href="clientes.html" class="sidebar-link">üë• Clientes</a>
      <a href="proveedores.html" class="sidebar-link">üöö Proveedores</a>
      <a href="contabilidad.html" class="sidebar-link">üìö Contabilidad</a>
      <a href="sat.html" class="sidebar-link">üá¨üáπ SAT Guatemala</a>
      <a href="ia.html" class="sidebar-link">ü§ñ IA empresarial</a>
      <a href="configuracion.html" class="sidebar-link">‚öôÔ∏è Configuraci√≥n</a>
    </nav>

    <div class="sidebar-footer">
      <span class="sidebar-footer-title">Empresa demo</span>
      <span class="sidebar-footer-sub">Versi√≥n 1.0</span>
    </div>
  </aside>

  <!-- Layout principal -->
  <div class="main-layout">
    <!-- Topbar -->
    <header class="topbar">
      <button class="btn-menu-mobile" id="btnMenuMobile">‚ò∞</button>

      <div class="topbar-left">
        <h1 class="topbar-title">Compras y proveedores</h1>
        <p class="topbar-subtitle">Registra las compras de mercanc√≠a y otros insumos del negocio.</p>
      </div>

      <div class="topbar-right">
        <span class="topbar-company">Mi tienda demo</span>
        <span class="topbar-divider">‚Ä¢</span>
        <span class="topbar-user" id="topbar-user-label">Usuario (Rol)</span>
        <button class="btn" id="btnLogout" type="button" style="margin-left: 0.75rem;">
          Cerrar sesi√≥n
        </button>
      </div>
    </header>

    <!-- Contenido principal -->
    <main class="main-content">
      <!-- Formulario de compras -->
      <section class="card">
        <h2 class="card-title">Registrar nueva compra</h2>
        <p class="card-description">
          Usa este m√≥dulo para registrar compras de mercanc√≠a, insumos y otros gastos directos a proveedores.
          Si pagas en efectivo desde caja, se crear√° autom√°ticamente un <strong>EGRESO</strong> en la caja.
        </p>

        <div class="form-grid">
          <div class="form-field">
            <label for="cProveedor">Proveedor</label>
            <input id="cProveedor" class="input" type="text" placeholder="Ej: Proveedor XYZ, bodega, mercado, etc.">
          </div>

          <div class="form-field">
            <label for="cCategoria">Categor√≠a de compra</label>
            <select id="cCategoria" class="input">
              <option value="">Selecciona una categor√≠a</option>
              <option value="Mercanc√≠a para venta">Mercanc√≠a para venta</option>
              <option value="Materia prima">Materia prima</option>
              <option value="Insumos de empaque">Insumos de empaque</option>
              <option value="Herramientas / Equipo">Herramientas / Equipo</option>
              <option value="Mantenimiento / Reparaciones">Mantenimiento / Reparaciones</option>
              <option value="Otros">Otros</option>
            </select>
          </div>

          <div class="form-field">
            <label for="cDescripcion">Descripci√≥n</label>
            <input id="cDescripcion" class="input" type="text" placeholder="Ej: Lote de 20 perfumes, cajas, bolsas, etc.">
          </div>

          <div class="form-field">
            <label for="cMonto">Monto total (Q)</label>
            <input id="cMonto" class="input" type="number" step="0.01" min="0" placeholder="0.00">
          </div>

          <div class="form-field">
            <label for="cFormaPago">Forma de pago</label>
            <select id="cFormaPago" class="input">
              <option value="EFECTIVO_CAJA">Efectivo en caja</option>
              <option value="TRANSFERENCIA">Transferencia / Dep√≥sito</option>
              <option value="TARJETA">Tarjeta</option>
              <option value="CREDITO">Cr√©dito con proveedor</option>
              <option value="OTRO">Otro</option>
            </select>
          </div>
        </div>

        <button class="btn" id="btnGuardarCompra">Guardar compra</button>
      </section>

      <!-- Tabla de compras -->
      <section class="card">
        <h2 class="card-title">Historial de compras</h2>
        <p class="card-description">
          Aqu√≠ ver√°s las compras registradas a lo largo del tiempo. En futuras versiones se podr√°n
          vincular directamente con el inventario para actualizar el stock.
        </p>

        <table class="table">
          <thead>
            <tr>
              <th>Fecha / Hora</th>
              <th>Proveedor</th>
              <th>Categor√≠a</th>
              <th>Descripci√≥n</th>
              <th>Forma de pago</th>
              <th>Monto</th>
            </tr>
          </thead>
          <tbody id="tabla-compras-body">
            <tr>
              <td colspan="6" class="table-empty">
                A√∫n no hay compras registradas.
              </td>
            </tr>
          </tbody>
        </table>
      </section>
    </main>
  </div>

  <!-- Scripts base -->
  <script src="alex-storage.js"></script>
  <script src="alex-roles.js"></script>

  <script>
    // Men√∫ m√≥vil
    const btnMenuMobile = document.getElementById('btnMenuMobile');
    const sidebar = document.querySelector('.sidebar');

    if (btnMenuMobile) {
      btnMenuMobile.addEventListener('click', () => {
        sidebar.classList.toggle('sidebar-open');
      });
    }

    // Usuario y permisos
    const usuarioActual = typeof getUsuarioActualObligatorio === "function"
      ? getUsuarioActualObligatorio()
      : null;

    if (typeof aplicarPermisosYProteger === "function") {
      aplicarPermisosYProteger("compras");
    }

    // Pintar nombre y rol en el topbar
    const labelUser = document.getElementById("topbar-user-label");
    if (usuarioActual && labelUser) {
      const rolTexto = usuarioActual.rol === "dueno" ? "Due√±o" : "Empleado";
      labelUser.textContent = `${usuarioActual.nombre} (${rolTexto})`;
    }

    // Bot√≥n Cerrar sesi√≥n
    const btnLogout = document.getElementById("btnLogout");
    if (btnLogout) {
      btnLogout.addEventListener("click", () => {
        if (!confirm("¬øQuieres cerrar sesi√≥n?")) return;

        if (typeof save === "function") {
          save("usuarioActual", null);
        } else {
          localStorage.removeItem("usuarioActual");
        }

        window.location.href = "index.html";
      });
    }

    // ====== L√ìGICA DE COMPRAS ======
    let compras = [];
    let cajaMovimientos = [];

    if (typeof load === "function") {
      const cData = load("compras", []);
      compras = Array.isArray(cData) ? cData : [];

      const movData = load("caja_movimientos", []);
      cajaMovimientos = Array.isArray(movData) ? movData : [];
    }

    function alex3FormatearMonedaSeguro(valor) {
      if (typeof alex3FormatearMoneda === "function") {
        return alex3FormatearMoneda(valor);
      }
      const num = Number(valor);
      if (isNaN(num)) return "Q 0.00";
      return "Q " + num.toFixed(2);
    }

    function formatearFechaBonita(fechaIso) {
      const d = new Date(fechaIso);
      if (isNaN(d.getTime())) return fechaIso || "-";
      const dia = String(d.getDate()).padStart(2, "0");
      const mes = String(d.getMonth() + 1).padStart(2, "0");
      const anio = d.getFullYear();
      const horas = String(d.getHours()).padStart(2, "0");
      const mins = String(d.getMinutes()).padStart(2, "0");
      return `${dia}/${mes}/${anio} ${horas}:${mins}`;
    }

    function renderTablaCompras() {
      const tbody = document.getElementById("tabla-compras-body");
      tbody.innerHTML = "";

      if (!compras.length) {
        tbody.innerHTML = `
          <tr>
            <td colspan="6" class="table-empty">A√∫n no hay compras registradas.</td>
          </tr>
        `;
        return;
      }

      const ordenadas = [...compras].sort((a, b) => {
        const fa = new Date(a.fechaHora || a.fecha || 0).getTime();
        const fb = new Date(b.fechaHora || b.fecha || 0).getTime();
        return fb - fa;
      });

      ordenadas.forEach(c => {
        const fecha = formatearFechaBonita(c.fechaHora || c.fecha || "");
        const proveedor = c.proveedor || "";
        const categoria = c.categoria || "";
        const descripcion = c.descripcion || "";
        const formaPagoTexto = (function (fp) {
          switch (fp) {
            case "EFECTIVO_CAJA": return "Efectivo en caja";
            case "TRANSFERENCIA": return "Transferencia / Dep√≥sito";
            case "TARJETA": return "Tarjeta";
            case "CREDITO": return "Cr√©dito con proveedor";
            case "OTRO": return "Otro";
            default: return fp || "";
          }
        })(c.formaPago);
        const monto = alex3FormatearMonedaSeguro(c.monto);

        tbody.innerHTML += `
          <tr>
            <td>${fecha}</td>
            <td>${proveedor}</td>
            <td>${categoria}</td>
            <td>${descripcion}</td>
            <td>${formaPagoTexto}</td>
            <td>${monto}</td>
          </tr>
        `;
      });
    }

    function registrarCompra() {
      const proveedor = document.getElementById("cProveedor").value.trim();
      const categoria = document.getElementById("cCategoria").value;
      const descripcion = document.getElementById("cDescripcion").value.trim();
      const monto = parseFloat(document.getElementById("cMonto").value);
      const formaPago = document.getElementById("cFormaPago").value;

      if (!proveedor || !categoria || !descripcion || isNaN(monto) || monto <= 0) {
        alert("Por favor completa proveedor, categor√≠a, descripci√≥n y un monto v√°lido.");
        return;
      }

      const ahora = new Date().toISOString();

      const nuevaCompra = {
        id: Date.now(),
        fechaHora: ahora,
        proveedor,
        categoria,
        descripcion,
        monto,
        formaPago,
        usuario: usuarioActual ? usuarioActual.usuario : null
      };

      compras.push(nuevaCompra);
      if (typeof save === "function") {
        save("compras", compras);
      }

      // Si pagaste con efectivo de caja, registrar EGRESO en caja_movimientos
      if (formaPago === "EFECTIVO_CAJA") {
        const mov = {
          id: "compra_" + Date.now(),
          fechaHora: ahora,
          tipo: "EGRESO",
          categoria: "Compra - " + categoria,
          descripcion: "Compra a " + proveedor + " - " + descripcion,
          monto: monto,
          origen: "compra",
          usuario: usuarioActual ? usuarioActual.usuario : null
        };
        cajaMovimientos.push(mov);
        if (typeof save === "function") {
          save("caja_movimientos", cajaMovimientos);
        }
      }

      // Limpiar formulario
      document.getElementById("cProveedor").value = "";
      document.getElementById("cCategoria").value = "";
      document.getElementById("cDescripcion").value = "";
      document.getElementById("cMonto").value = "";
      document.getElementById("cFormaPago").value = "EFECTIVO_CAJA";

      renderTablaCompras();
      alert("Compra registrada correctamente.");
    }

    const btnGuardarCompra = document.getElementById("btnGuardarCompra");
    if (btnGuardarCompra) {
      btnGuardarCompra.addEventListener("click", registrarCompra);
    }

    // Primera carga
    renderTablaCompras();
  </script>
</body>
</html>
