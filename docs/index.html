<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>ALEX 3.0 - Iniciar sesión</title>
  <link rel="stylesheet" href="styles.css">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>

<body class="auth-body">
  <div class="auth-wrapper">
    <div class="auth-card">
      <div class="auth-logo">
        <span class="logo-badge">A</span>
        <div class="logo-text-group">
          <h1 class="logo-title">ALEX 3.0</h1>
          <p class="logo-subtitle">Contador y administrador digital para tu negocio</p>
        </div>
      </div>

      <h2 class="auth-title">Iniciar sesión</h2>
      <p class="auth-subtitle">
        Ingresa con tu usuario y contraseña. En esta versión demo puedes crear usuarios desde el módulo <strong>Usuarios</strong>.
      </p>

      <form class="auth-form" id="loginForm">
        <label class="form-label">
          Usuario
          <input
            type="text"
            id="loginUsuario"
            class="form-input"
            placeholder="Ej: admin"
            autocomplete="username"
            required
          >
        </label>

        <label class="form-label">
          Contraseña
          <input
            type="password"
            id="loginPassword"
            class="form-input"
            placeholder="••••••••"
            autocomplete="current-password"
            required
          >
        </label>

        <button type="submit" class="btn btn-primary btn-full">
          Ingresar
        </button>
      </form>

      <p class="auth-footer-text" id="demoInfo">
        Versión demo en la nube para pequeños y medianos negocios.
      </p>
    </div>
  </div>

  <!-- Scripts base -->
  <script src="alex-storage.js"></script>

  <script>
    // Helper por si aún no existe
    function alex3FormatearMonedaSeguro(valor) {
      const num = Number(valor);
      if (isNaN(num)) return "Q 0.00";
      return "Q " + num.toFixed(2);
    }

    // Cargar usuarioActual y usuarios desde almacenamiento
    let usuarioActual = null;
    let usuarios = [];

    if (typeof load === "function") {
      usuarioActual = load("usuarioActual", null);
      const uData = load("usuarios", []);
      usuarios = Array.isArray(uData) ? uData : [];
    }

    // 1) Si ya hay usuario logueado, ir directo al dashboard
    if (usuarioActual && usuarioActual.usuario && usuarioActual.rol) {
      window.location.href = "dashboard.html";
    }

    // 2) Si NO hay usuarios, crear uno demo por defecto (admin / 1234)
    (function crearUsuarioDemoSiHaceFalta() {
      if (!Array.isArray(usuarios) || usuarios.length === 0) {
        const ahora = new Date();
        const demo = {
          nombre: "Demo ALEX (Dueño)",
          usuario: "admin",
          rol: "dueno", // Dueño
          password: "1234",
          creadoEn: ahora.toLocaleString("es-GT")
        };
        usuarios = [demo];
        if (typeof save === "function") {
          save("usuarios", usuarios);
        }
        const demoInfo = document.getElementById("demoInfo");
        if (demoInfo) {
          demoInfo.innerHTML = `
            Usuario demo creado automáticamente:<br>
            <strong>Usuario:</strong> admin &nbsp;|&nbsp; <strong>Contraseña:</strong> 1234
          `;
        }
      } else {
        const demoInfo = document.getElementById("demoInfo");
        if (demoInfo) {
          demoInfo.textContent =
            "Si olvidas un usuario, puedes gestionarlos desde el módulo Usuarios dentro de ALEX 3.0.";
        }
      }
    })();

    // 3) Lógica de login real
    function encontrarUsuarioPorLogin(loginText) {
      const login = (loginText || "").trim().toLowerCase();
      if (!login) return null;

      // Buscamos por "usuario" (campo principal)
      let u = usuarios.find(u => (u.usuario || "").toLowerCase() === login);
      if (u) return u;

      // Extra: intentamos por nombre por si alguien prueba
      u = usuarios.find(u => (u.nombre || "").toLowerCase() === login);
      return u || null;
    }

    function manejarLogin(event) {
      event.preventDefault();

      const inputUsuario = document.getElementById("loginUsuario");
      const inputPassword = document.getElementById("loginPassword");

      const loginText = inputUsuario.value;
      const passText = inputPassword.value;

      if (!loginText.trim() || !passText.trim()) {
        alert("Por favor ingresa usuario y contraseña.");
        return;
      }

      const usuario = encontrarUsuarioPorLogin(loginText);
      if (!usuario) {
        alert("Usuario no encontrado. Verifica el usuario o crea uno nuevo en el módulo Usuarios.");
        return;
      }

      if ((usuario.password || "") !== passText) {
        alert("Contraseña incorrecta. Intenta de nuevo.");
        return;
      }

      // Armar objeto ligero para usuarioActual
      const usuarioSesion = {
        nombre: usuario.nombre,
        usuario: usuario.usuario,
        rol: usuario.rol
      };

      if (typeof save === "function") {
        save("usuarioActual", usuarioSesion);
      } else {
        localStorage.setItem("usuarioActual", JSON.stringify(usuarioSesion));
      }

      window.location.href = "dashboard.html";
    }

    const loginForm = document.getElementById("loginForm");
    if (loginForm) {
      loginForm.addEventListener("submit", manejarLogin);
    }
  </script>
</body>
</html>
