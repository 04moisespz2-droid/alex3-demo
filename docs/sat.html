<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>ALEX 3.0 - SAT Guatemala</title>
  <link rel="stylesheet" href="styles.css">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>

<body class="dashboard-body">
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <span class="logo-badge">A</span>
      <div class="sidebar-logo-text">
        <span class="sidebar-logo-main">ALEX 3.0</span>
        <span class="sidebar-logo-sub">Panel del negocio</span>
      </div>
    </div>

    <nav class="sidebar-nav">
      <a href="dashboard.html" class="sidebar-link">üìä Dashboard</a>
      <a href="ventas.html" class="sidebar-link">üíµ Ventas</a>
      <a href="inventario.html" class="sidebar-link">üì¶ Inventario</a>
      <a href="caja.html" class="sidebar-link">üí∞ Caja</a>
      <a href="compras.html" class="sidebar-link">üßæ Compras</a>
      <a href="gastos.html" class="sidebar-link">üìâ Gastos</a>
      <a href="clientes.html" class="sidebar-link">üë• Clientes</a>
      <a href="proveedores.html" class="sidebar-link">üöö Proveedores</a>
      <a href="contabilidad.html" class="sidebar-link">üìö Contabilidad</a>
      <a href="sat.html" class="sidebar-link active">üá¨üáπ SAT Guatemala</a>
      <a href="ia.html" class="sidebar-link">ü§ñ IA empresarial</a>
      <a href="configuracion.html" class="sidebar-link">‚öôÔ∏è Configuraci√≥n</a>
    </nav>

    <div class="sidebar-footer">
      <span class="sidebar-footer-title">Mi negocio</span>
      <span class="sidebar-footer-sub">Simulador SAT</span>
    </div>
  </aside>

  <!-- Layout principal -->
  <div class="main-layout">
    <!-- Topbar -->
    <header class="topbar">
      <button class="btn-menu-mobile" id="btnMenuMobile">‚ò∞</button>

      <div class="topbar-left">
        <h1 class="topbar-title">SAT Guatemala (simulador)</h1>
        <p class="topbar-subtitle">
          C√°lculo aproximado de impuestos mensuales seg√∫n tus ventas y compras registradas.
        </p>
      </div>

      <div class="topbar-right">
        <span class="topbar-company">Mi negocio</span>
        <span class="topbar-divider">‚Ä¢</span>
        <span class="topbar-user" id="topbar-user-label">Usuario (Rol)</span>
      </div>
    </header>

    <!-- Contenido principal -->
    <main class="main-content">
      <!-- Selector de mes -->
      <section class="card">
        <h2 class="card-title">1. Selecciona el mes a analizar</h2>
        <p class="card-description">
          ALEX usar√° tus <strong>ventas</strong> y <strong>compras</strong> guardadas para ese mes
          y simular√° cu√°nto pagar√≠as en cada r√©gimen.
        </p>

        <div class="form-grid">
          <div class="form-field">
            <label for="satMes">Mes</label>
            <input id="satMes" class="input" type="month">
          </div>
        </div>

        <p style="font-size: 0.85rem; margin-top: 0.5rem;">
          ‚ö†Ô∏è <strong>Nota:</strong> Esto es un simulador educativo. No es una declaraci√≥n oficial ni reemplaza al contador.
        </p>
      </section>

      <!-- KPIs de resumen SAT -->
      <section class="cards-grid">
        <article class="card kpi-card">
          <h2 class="card-title">Ventas del mes (base)</h2>
          <p class="card-kpi" id="sat-kpi-ventas">Q 0.00</p>
          <p class="card-kpi-sub">Total de ventas registradas en el mes seleccionado.</p>
        </article>

        <article class="card kpi-card">
          <h2 class="card-title">Compras del mes</h2>
          <p class="card-kpi gasto" id="sat-kpi-compras">Q 0.00</p>
          <p class="card-kpi-sub">Usadas como referencia de costo / IVA cr√©dito.</p>
        </article>

        <article class="card kpi-card">
          <h2 class="card-title">Peque√±o contribuyente</h2>
          <p class="card-kpi" id="sat-kpi-peq">Q 0.00</p>
          <p class="card-kpi-sub">
            Estimaci√≥n 5% sobre ventas del mes (solo referencia).
          </p>
        </article>

        <article class="card kpi-card">
          <h2 class="card-title">IVA r√©gimen general</h2>
          <p class="card-kpi" id="sat-kpi-iva-pagar">Q 0.00</p>
          <p class="card-kpi-sub">
            IVA por pagar ‚âà d√©bito (ventas) - cr√©dito (compras).
          </p>
        </article>
      </section>

      <!-- Desglose de reg√≠menes -->
      <section class="grid-2">
        <!-- Peque√±o contribuyente -->
        <article class="card">
          <h2 class="card-title">2. Escenario: Peque√±o contribuyente</h2>
          <p class="card-description">
            C√°lculo b√°sico tomando el total de ventas del mes. No considera facturas exentas ni
            detalles avanzados, solo una gu√≠a r√°pida.
          </p>

          <table class="table">
            <thead>
              <tr>
                <th>Concepto</th>
                <th>Monto</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>Ventas del mes (base)</td>
                <td id="sat-peq-base"></td>
              </tr>
              <tr>
                <td>Tasa usada (aprox.)</td>
                <td>5 %</td>
              </tr>
              <tr>
                <td><strong>Impuesto estimado</strong></td>
                <td id="sat-peq-impuesto"></td>
              </tr>
            </tbody>
          </table>
        </article>

        <!-- R√©gimen general IVA -->
        <article class="card">
          <h2 class="card-title">3. Escenario: R√©gimen general (IVA)</h2>
          <p class="card-description">
            Estimaci√≥n del IVA usando tus ventas y compras del mes. No contempla
            toda la normativa, solo una aproximaci√≥n:
          </p>

          <table class="table">
            <thead>
              <tr>
                <th>Concepto</th>
                <th>Monto</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>Ventas gravadas (base IVA d√©bito)</td>
                <td id="sat-iva-base-ventas"></td>
              </tr>
              <tr>
                <td>Compras gravadas (base IVA cr√©dito)</td>
                <td id="sat-iva-base-compras"></td>
              </tr>
              <tr>
                <td>IVA sobre ventas (12%)</td>
                <td id="sat-iva-debito"></td>
              </tr>
              <tr>
                <td>IVA sobre compras (12%)</td>
                <td id="sat-iva-credito"></td>
              </tr>
              <tr>
                <td><strong>IVA estimado por pagar</strong></td>
                <td id="sat-iva-por-pagar"></td>
              </tr>
            </tbody>
          </table>
        </article>
      </section>

      <!-- Exportar libros -->
      <section class="card">
        <h2 class="card-title">4. Exportar libros SAT (CSV)</h2>
        <p class="card-description">
          Descarga un archivo CSV (compatible con Excel) con todas las ventas y compras del mes seleccionado.
          Estos archivos se parecen a un libro de ventas / libro de compras b√°sico.
        </p>

        <div class="form-grid">
          <button class="btn" id="btnExportVentas">
            üì§ Exportar libro de ventas (CSV)
          </button>
          <button class="btn" id="btnExportCompras">
            üì§ Exportar libro de compras (CSV)
          </button>
        </div>
      </section>

      <!-- Listado de movimientos usados -->
      <section class="card">
        <h2 class="card-title">5. Movimientos usados para el c√°lculo</h2>
        <p class="card-description">
          Estas tablas muestran las ventas y compras del mes seleccionado que ALEX toma en cuenta
          para los c√°lculos de arriba.
        </p>

        <div class="grid-2">
          <article>
            <h3>Ventas del mes</h3>
            <table class="table">
              <thead>
                <tr>
                  <th>Fecha</th>
                  <th>Cliente</th>
                  <th>Documento</th>
                  <th>Total</th>
                </tr>
              </thead>
              <tbody id="sat-tabla-ventas">
                <tr>
                  <td colspan="4" class="table-empty">
                    No hay ventas registradas en este mes.
                  </td>
                </tr>
              </tbody>
            </table>
          </article>

          <article>
            <h3>Compras del mes</h3>
            <table class="table">
              <thead>
                <tr>
                  <th>Fecha</th>
                  <th>Proveedor</th>
                  <th>Documento</th>
                  <th>Monto</th>
                </tr>
              </thead>
              <tbody id="sat-tabla-compras">
                <tr>
                  <td colspan="4" class="table-empty">
                    No hay compras registradas en este mes.
                  </td>
                </tr>
              </tbody>
            </table>
          </article>
        </div>
      </section>
    </main>
  </div>

  <!-- Scripts base -->
  <script src="alex-storage.js"></script>
  <script src="alex-roles.js"></script>

  <script>
    // ===== Men√∫ m√≥vil =====
    const btnMenuMobile = document.getElementById('btnMenuMobile');
    const sidebar = document.querySelector('.sidebar');
    if (btnMenuMobile) {
      btnMenuMobile.addEventListener('click', () => {
        sidebar.classList.toggle('sidebar-open');
      });
    }

    // ===== Usuario y permisos =====
    const usuarioActual = typeof getUsuarioActualObligatorio === "function"
      ? getUsuarioActualObligatorio()
      : null;

    if (typeof aplicarPermisosYProteger === "function") {
      aplicarPermisosYProteger("sat");
    }

    const labelUser = document.getElementById("topbar-user-label");
    if (usuarioActual && labelUser) {
      const rolTexto = usuarioActual.rol === "dueno" ? "Due√±o" : "Empleado";
      labelUser.textContent = \`\${usuarioActual.nombre} (\${rolTexto})\`;
    }

    // ===== Helpers =====
    function alex3FormatearMonedaSeguro(valor) {
      if (typeof alex3FormatearMoneda === "function") {
        return alex3FormatearMoneda(valor);
      }
      const num = Number(valor);
      if (isNaN(num)) return "Q 0.00";
      return "Q " + num.toFixed(2);
    }

    function esMismoMesReferencia(fecha, referencia) {
      return fecha.getFullYear() === referencia.getFullYear() &&
             fecha.getMonth() === referencia.getMonth();
    }

    function formatearFechaLocal(fechaIso) {
      const d = new Date(fechaIso);
      if (isNaN(d.getTime())) return "-";
      return d.toLocaleString("es-GT");
    }

    function formatearFechaISOaYYYYMMDD(fechaIso) {
      const d = new Date(fechaIso);
      if (isNaN(d.getTime())) return "";
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const dia = String(d.getDate()).padStart(2, "0");
      return \`\${y}-\${m}-\${dia}\`;
    }

    // ===== Cargar datos =====
    let ventas = [];
    let compras = [];

    if (typeof load === "function") {
      const vData = load("ventas", []);
      ventas = Array.isArray(vData) ? vData : [];

      const cData = load("compras", []);
      compras = Array.isArray(cData) ? cData : [];
    }

    const inputMes = document.getElementById("satMes");

    const kpiVentas = document.getElementById("sat-kpi-ventas");
    const kpiCompras = document.getElementById("sat-kpi-compras");
    const kpiPeq = document.getElementById("sat-kpi-peq");
    const kpiIvaPagar = document.getElementById("sat-kpi-iva-pagar");

    const peqBase = document.getElementById("sat-peq-base");
    const peqImpuesto = document.getElementById("sat-peq-impuesto");

    const ivaBaseVentas = document.getElementById("sat-iva-base-ventas");
    const ivaBaseCompras = document.getElementById("sat-iva-base-compras");
    const ivaDebitoEl = document.getElementById("sat-iva-debito");
    const ivaCreditoEl = document.getElementById("sat-iva-credito");
    const ivaPorPagarEl = document.getElementById("sat-iva-por-pagar");

    const tablaVentasBody = document.getElementById("sat-tabla-ventas");
    const tablaComprasBody = document.getElementById("sat-tabla-compras");

    const btnExportVentas = document.getElementById("btnExportVentas");
    const btnExportCompras = document.getElementById("btnExportCompras");

    function obtenerFechaReferencia() {
      if (inputMes && inputMes.value) {
        const [year, month] = inputMes.value.split("-").map(Number);
        if (!isNaN(year) && !isNaN(month)) {
          return new Date(year, month - 1, 1);
        }
      }
      return new Date();
    }

    function getVentasMesActual() {
      const ref = obtenerFechaReferencia();
      return ventas.filter(v => {
        const f = new Date(v.fechaHora || v.fecha || Date.now());
        return esMismoMesReferencia(f, ref);
      });
    }

    function getComprasMesActual() {
      const ref = obtenerFechaReferencia();
      return compras.filter(c => {
        const f = new Date(c.fechaHora || c.fecha || Date.now());
        return esMismoMesReferencia(f, ref);
      });
    }

    // ===== C√°lculo principal SAT =====
    function recalcularSAT() {
      const ref = obtenerFechaReferencia();

      const ventasMes = getVentasMesActual();
      const comprasMes = getComprasMesActual();

      const totalVentas = ventasMes.reduce((acc, v) => acc + (Number(v.total) || 0), 0);
      const totalCompras = comprasMes.reduce((acc, c) => acc + (Number(c.monto) || 0), 0);

      // Peque√±o contribuyente (aprox 5%)
      const tasaPeq = 0.05;
      const impuestoPeq = totalVentas * tasaPeq;

      // IVA r√©gimen general (12%)
      const tasaIVA = 0.12;
      const ivaDebito = totalVentas * tasaIVA;
      const ivaCredito = totalCompras * tasaIVA;
      const ivaPorPagar = Math.max(0, ivaDebito - ivaCredito);

      // KPIs
      if (kpiVentas) kpiVentas.textContent = alex3FormatearMonedaSeguro(totalVentas);
      if (kpiCompras) kpiCompras.textContent = alex3FormatearMonedaSeguro(totalCompras);
      if (kpiPeq) kpiPeq.textContent = alex3FormatearMonedaSeguro(impuestoPeq);
      if (kpiIvaPagar) kpiIvaPagar.textContent = alex3FormatearMonedaSeguro(ivaPorPagar);

      // Detalle peque√±o contribuyente
      if (peqBase) peqBase.textContent = alex3FormatearMonedaSeguro(totalVentas);
      if (peqImpuesto) peqImpuesto.textContent = alex3FormatearMonedaSeguro(impuestoPeq);

      // Detalle IVA
      if (ivaBaseVentas) ivaBaseVentas.textContent = alex3FormatearMonedaSeguro(totalVentas);
      if (ivaBaseCompras) ivaBaseCompras.textContent = alex3FormatearMonedaSeguro(totalCompras);
      if (ivaDebitoEl) ivaDebitoEl.textContent = alex3FormatearMonedaSeguro(ivaDebito);
      if (ivaCreditoEl) ivaCreditoEl.textContent = alex3FormatearMonedaSeguro(ivaCredito);
      if (ivaPorPagarEl) ivaPorPagarEl.textContent = alex3FormatearMonedaSeguro(ivaPorPagar);

      // Tablas detalle
      renderTablaVentasMes(ventasMes);
      renderTablaComprasMes(comprasMes);
    }

    // ===== Tablas de detalle =====
    function renderTablaVentasMes(lista) {
      if (!tablaVentasBody) return;
      tablaVentasBody.innerHTML = "";

      if (!lista.length) {
        tablaVentasBody.innerHTML = `
          <tr>
            <td colspan="4" class="table-empty">
              No hay ventas registradas en este mes.
            </td>
          </tr>
        `;
        return;
      }

      const ordenadas = [...lista].sort((a, b) => {
        const fa = new Date(a.fechaHora || a.fecha || 0).getTime();
        const fb = new Date(b.fechaHora || b.fecha || 0).getTime();
        return fb - fa;
      });

      ordenadas.forEach(v => {
        const fechaTxt = v.fecha || (v.fechaHora ? formatearFechaLocal(v.fechaHora) : "-");
        const clienteTxt = v.clienteNombre || "Cliente general";
        const docTxt = v.documentoTipo
          ? (v.documentoNumero ? \`\${v.documentoTipo} \${v.documentoNumero}\` : v.documentoTipo)
          : (v.documentoNumero || "-");
        const totalTxt = alex3FormatearMonedaSeguro(v.total);

        tablaVentasBody.innerHTML += `
          <tr>
            <td>${fechaTxt}</td>
            <td>${clienteTxt}</td>
            <td>${docTxt}</td>
            <td>${totalTxt}</td>
          </tr>
        `;
      });
    }

    function renderTablaComprasMes(lista) {
      if (!tablaComprasBody) return;
      tablaComprasBody.innerHTML = "";

      if (!lista.length) {
        tablaComprasBody.innerHTML = `
          <tr>
            <td colspan="4" class="table-empty">
              No hay compras registradas en este mes.
            </td>
          </tr>
        `;
        return;
      }

      const ordenadas = [...lista].sort((a, b) => {
        const fa = new Date(a.fechaHora || a.fecha || 0).getTime();
        const fb = new Date(b.fechaHora || b.fecha || 0).getTime();
        return fb - fa;
      });

      ordenadas.forEach(c => {
        const fechaTxt = c.fecha || (c.fechaHora ? formatearFechaLocal(c.fechaHora) : "-");
        const provTxt = c.proveedorNombre || "-";
        const docTxt = c.documentoTipo
          ? (c.documentoNumero ? \`\${c.documentoTipo} \${c.documentoNumero}\` : c.documentoTipo)
          : (c.documentoNumero || "-");
        const montoTxt = alex3FormatearMonedaSeguro(c.monto);

        tablaComprasBody.innerHTML += `
          <tr>
            <td>${fechaTxt}</td>
            <td>${provTxt}</td>
            <td>${docTxt}</td>
            <td>${montoTxt}</td>
          </tr>
        `;
      });
    }

    // ===== Exportar CSV =====
    function descargarCSV(nombreArchivo, encabezados, filas) {
      let contenido = encabezados.join(",") + "\\n";
      filas.forEach(fila => {
        const linea = fila.map(v => {
          const str = (v ?? "").toString().replace(/"/g, '""');
          if (str.includes(",") || str.includes("\"") || str.includes("\\n")) {
            return \`"\${str}"\`;
          }
          return str;
        }).join(",");
        contenido += linea + "\\n";
      });

      const blob = new Blob([contenido], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);

      const link = document.createElement("a");
      link.href = url;
      link.download = nombreArchivo;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    }

    function exportarLibroVentasCSV() {
      const ventasMes = getVentasMesActual();
      if (!ventasMes.length) {
        alert("No hay ventas en el mes seleccionado para exportar.");
        return;
      }

      const ref = obtenerFechaReferencia();
      const year = ref.getFullYear();
      const month = String(ref.getMonth() + 1).padStart(2, "0");

      const encabezados = [
        "Fecha",
        "Cliente",
        "Documento",
        "Total",
        "FormaPago",
        "Notas"
      ];

      const filas = ventasMes.map(v => {
        const fechaISO = v.fechaHora || "";
        const fecha = fechaISO ? formatearFechaISOaYYYYMMDD(fechaISO) : (v.fecha || "");
        const cliente = v.clienteNombre || "Cliente general";
        const doc = v.documentoTipo
          ? (v.documentoNumero ? \`\${v.documentoTipo} \${v.documentoNumero}\` : v.documentoTipo)
          : (v.documentoNumero || "");
        const total = Number(v.total || 0).toFixed(2);
        const formaPago = v.formaPago || "";
        const notas = v.notas || "";

        return [fecha, cliente, doc, total, formaPago, notas];
      });

      const nombreArchivo = \`libro_ventas_\${year}_\${month}.csv\`;
      descargarCSV(nombreArchivo, encabezados, filas);
    }

    function exportarLibroComprasCSV() {
      const comprasMes = getComprasMesActual();
      if (!comprasMes.length) {
        alert("No hay compras en el mes seleccionado para exportar.");
        return;
      }

      const ref = obtenerFechaReferencia();
      const year = ref.getFullYear();
      const month = String(ref.getMonth() + 1).padStart(2, "0");

      const encabezados = [
        "Fecha",
        "Proveedor",
        "Documento",
        "Monto",
        "FormaPago",
        "Notas"
      ];

      const filas = comprasMes.map(c => {
        const fechaISO = c.fechaHora || "";
        const fecha = fechaISO ? formatearFechaISOaYYYYMMDD(fechaISO) : (c.fecha || "");
        const proveedor = c.proveedorNombre || "";
        const doc = c.documentoTipo
          ? (c.documentoNumero ? \`\${c.documentoTipo} \${c.documentoNumero}\` : c.documentoTipo)
          : (c.documentoNumero || "");
        const monto = Number(c.monto || 0).toFixed(2);
        const formaPago = c.formaPago || "";
        const notas = c.notas || "";

        return [fecha, proveedor, doc, monto, formaPago, notas];
      });

      const nombreArchivo = \`libro_compras_\${year}_\${month}.csv\`;
      descargarCSV(nombreArchivo, encabezados, filas);
    }

    if (btnExportVentas) {
      btnExportVentas.addEventListener("click", exportarLibroVentasCSV);
    }

    if (btnExportCompras) {
      btnExportCompras.addEventListener("click", exportarLibroComprasCSV);
    }

    // Cambiar mes ‚Üí recalcular
    if (inputMes) {
      inputMes.addEventListener("change", () => {
        recalcularSAT();
      });
    }

    // Primera carga: dejar mes actual seleccionado
    (function initMesActual() {
      if (!inputMes) return;
      const hoy = new Date();
      const year = hoy.getFullYear();
      const month = String(hoy.getMonth() + 1).padStart(2, "0");
      inputMes.value = \`\${year}-\${month}\`;
    })();

    // Recalcular al entrar a la p√°gina
    recalcularSAT();
  </script>
</body>
</html>
