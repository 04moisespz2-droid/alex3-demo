<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>ALEX 3.0 - Contabilidad</title>
  <link rel="stylesheet" href="styles.css">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>

<body class="dashboard-body">
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <span class="logo-badge">A</span>
      <div class="sidebar-logo-text">
        <span class="sidebar-logo-main">ALEX 3.0</span>
        <span class="sidebar-logo-sub">Panel del negocio</span>
      </div>
    </div>

    <nav class="sidebar-nav">
      <a href="dashboard.html" class="sidebar-link">üìä Dashboard</a>
      <a href="ventas.html" class="sidebar-link">üíµ Ventas</a>
      <a href="inventario.html" class="sidebar-link">üì¶ Inventario</a>
      <a href="caja.html" class="sidebar-link">üí∞ Caja</a>
      <a href="compras.html" class="sidebar-link">üßæ Compras</a>
      <a href="gastos.html" class="sidebar-link">üìâ Gastos</a>
      <a href="clientes.html" class="sidebar-link">üë• Clientes</a>
      <a href="proveedores.html" class="sidebar-link">üöö Proveedores</a>
      <a href="contabilidad.html" class="sidebar-link active">üìö Contabilidad</a>
      <a href="sat.html" class="sidebar-link">üá¨üáπ SAT Guatemala</a>
      <a href="ia.html" class="sidebar-link">ü§ñ IA empresarial</a>
      <a href="configuracion.html" class="sidebar-link">‚öôÔ∏è Configuraci√≥n</a>
    </nav>

    <div class="sidebar-footer">
      <span class="sidebar-footer-title">Mi negocio</span>
      <span class="sidebar-footer-sub">Contabilidad b√°sica</span>
    </div>
  </aside>

  <!-- Layout principal -->
  <div class="main-layout">
    <!-- Topbar -->
    <header class="topbar">
      <button class="btn-menu-mobile" id="btnMenuMobile">‚ò∞</button>

      <div class="topbar-left">
        <h1 class="topbar-title">Contabilidad del negocio</h1>
        <p class="topbar-subtitle">
          Vista contable (devengado) y vista de caja para el mes seleccionado.
        </p>
      </div>

      <div class="topbar-right">
        <span class="topbar-company">Mi negocio</span>
        <span class="topbar-divider">‚Ä¢</span>
        <span class="topbar-user" id="topbar-user-label">Usuario (Rol)</span>
      </div>
    </header>

    <!-- Contenido principal -->
    <main class="main-content">
      <!-- Selecci√≥n de mes -->
      <section class="card">
        <h2 class="card-title">1. Selecciona el mes a analizar</h2>
        <p class="card-description">
          ALEX tomar√° tus ventas, compras, gastos y movimientos de caja de ese mes
          para generar libro diario, estado de resultados, balance y flujo de efectivo.
        </p>

        <div class="form-grid">
          <div class="form-field">
            <label for="contaMes">Mes</label>
            <input id="contaMes" class="input" type="month">
          </div>
        </div>

        <p style="font-size: 0.85rem; margin-top: 0.5rem;">
          ‚ÑπÔ∏è <strong>Devengado</strong> = contabilidad cl√°sica (ventas, compras, gastos).  
          üí∏ <strong>Caja</strong> = entradas y salidas de efectivo (lo que realmente se cobr√≥ y pag√≥).
        </p>
      </section>

      <!-- KPIs principales -->
      <section class="cards-grid">
        <article class="card kpi-card">
          <h2 class="card-title">Ingresos por ventas (devengado)</h2>
          <p class="card-kpi" id="kpi-conta-ingresos">Q 0.00</p>
          <p class="card-kpi-sub">Ventas registradas del mes.</p>
        </article>

        <article class="card kpi-card">
          <h2 class="card-title">Costos (compras)</h2>
          <p class="card-kpi gasto" id="kpi-conta-costos">Q 0.00</p>
          <p class="card-kpi-sub">Compras de mercader√≠a del mes.</p>
        </article>

        <article class="card kpi-card">
          <h2 class="card-title">Gastos operativos</h2>
          <p class="card-kpi gasto" id="kpi-conta-gastos">Q 0.00</p>
          <p class="card-kpi-sub">Luz, renta, n√≥mina, env√≠os, etc.</p>
        </article>

        <article class="card kpi-card">
          <h2 class="card-title">Utilidad bruta (devengado)</h2>
          <p class="card-kpi utilidad" id="kpi-conta-utilidad-bruta">Q 0.00</p>
          <p class="card-kpi-sub">Ingresos - costos.</p>
        </article>

        <article class="card kpi-card">
          <h2 class="card-title">Utilidad neta (devengado)</h2>
          <p class="card-kpi utilidad" id="kpi-conta-utilidad-neta">Q 0.00</p>
          <p class="card-kpi-sub">Ingresos - costos - gastos.</p>
        </article>

        <article class="card kpi-card">
          <h2 class="card-title">Flujo de caja neto</h2>
          <p class="card-kpi" id="kpi-conta-caja-neta">Q 0.00</p>
          <p class="card-kpi-sub">Ingresos de caja - egresos de caja (m√©todo de caja).</p>
        </article>
      </section>

      <!-- Resumen contable -->
      <section class="card">
        <h2 class="card-title">2. Resumen contable del mes</h2>
        <p class="card-description">
          Aqu√≠ ves el estado de resultados (devengado) y un resumen de flujo de caja para
          comparar lo que ‚Äúdeber√≠a‚Äù vs lo que realmente entr√≥ y sali√≥ de efectivo.
        </p>

        <table class="table">
          <thead>
            <tr>
              <th>Concepto</th>
              <th>M√©todo devengado</th>
              <th>Vista caja (si aplica)</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Ingresos por ventas</td>
              <td id="tbl-dev-ingresos"></td>
              <td>-</td>
            </tr>
            <tr>
              <td>Costos de compras</td>
              <td id="tbl-dev-costos"></td>
              <td>-</td>
            </tr>
            <tr>
              <td>Gastos operativos</td>
              <td id="tbl-dev-gastos"></td>
              <td id="tbl-caja-egresos"></td>
            </tr>
            <tr>
              <td><strong>Utilidad bruta</strong></td>
              <td id="tbl-dev-ub"></td>
              <td>-</td>
            </tr>
            <tr>
              <td><strong>Utilidad neta</strong></td>
              <td id="tbl-dev-un"></td>
              <td id="tbl-caja-neta"></td>
            </tr>
          </tbody>
        </table>
      </section>

      <!-- Balance b√°sico -->
      <section class="card">
        <h2 class="card-title">3. Balance general b√°sico</h2>
        <p class="card-description">
          Esta es una versi√≥n muy simplificada del balance (solo para entender c√≥mo se reparte el dinero).
        </p>

        <table class="table">
          <thead>
            <tr>
              <th>Grupo</th>
              <th>Cuenta</th>
              <th>Monto</th>
            </tr>
          </thead>
          <tbody id="tabla-balance">
            <tr>
              <td colspan="3" class="table-empty">
                A√∫n no hay datos contables para este mes.
              </td>
            </tr>
          </tbody>
        </table>
      </section>

      <!-- Libro diario -->
      <section class="card">
        <h2 class="card-title">4. Libro diario (devengado simple)</h2>
        <p class="card-description">
          ALEX genera asientos autom√°ticos a partir de ventas, compras y gastos.
          Cada l√≠nea representa un movimiento contable (doble partida).
        </p>

        <div class="form-grid" style="margin-bottom: 0.75rem;">
          <button class="btn" id="btnExportLibro">
            üì§ Exportar libro diario (CSV)
          </button>
        </div>

        <table class="table">
          <thead>
            <tr>
              <th>Fecha</th>
              <th>Descripci√≥n</th>
              <th>Cuenta</th>
              <th>Debe</th>
              <th>Haber</th>
            </tr>
          </thead>
          <tbody id="tabla-libro-diario">
            <tr>
              <td colspan="5" class="table-empty">
                A√∫n no hay asientos contables en este mes.
              </td>
            </tr>
          </tbody>
        </table>
      </section>

      <!-- Detalle de origen (ventas / compras / gastos) -->
      <section class="grid-2">
        <article class="card">
          <h2 class="card-title">5. Ventas y compras del mes</h2>
          <p class="card-description">
            Movimientos que alimentan el motor contable.
          </p>

          <h3>Ventas</h3>
          <table class="table">
            <thead>
              <tr>
                <th>Fecha</th>
                <th>Cliente</th>
                <th>Total</th>
              </tr>
            </thead>
            <tbody id="tabla-ventas-mes">
              <tr>
                <td colspan="3" class="table-empty">
                  A√∫n no hay ventas en este mes.
                </td>
              </tr>
            </tbody>
          </table>

          <h3>Compras</h3>
          <table class="table">
            <thead>
              <tr>
                <th>Fecha</th>
                <th>Proveedor</th>
                <th>Monto</th>
              </tr>
            </thead>
            <tbody id="tabla-compras-mes">
              <tr>
                <td colspan="3" class="table-empty">
                  A√∫n no hay compras en este mes.
                </td>
              </tr>
            </tbody>
          </table>
        </article>

        <article class="card">
          <h2 class="card-title">6. Gastos y caja del mes</h2>
          <p class="card-description">
            Gastos operativos y movimientos de caja (para vista de caja).
          </p>

          <h3>Gastos</h3>
          <table class="table">
            <thead>
              <tr>
                <th>Fecha</th>
                <th>Categor√≠a</th>
                <th>Monto</th>
              </tr>
            </thead>
            <tbody id="tabla-gastos-mes">
              <tr>
                <td colspan="3" class="table-empty">
                  A√∫n no hay gastos en este mes.
                </td>
              </tr>
            </tbody>
          </table>

          <h3>Movimientos de caja</h3>
          <table class="table">
            <thead>
              <tr>
                <th>Fecha</th>
                <th>Tipo</th>
                <th>Descripci√≥n</th>
                <th>Monto</th>
              </tr>
            </thead>
            <tbody id="tabla-caja-mes">
              <tr>
                <td colspan="4" class="table-empty">
                  A√∫n no hay movimientos de caja en este mes.
                </td>
              </tr>
            </tbody>
          </table>
        </article>
      </section>
    </main>
  </div>

  <!-- Scripts base -->
  <script src="alex-storage.js"></script>
  <script src="alex-roles.js"></script>
  <script src="alex-conta.js"></script>

  <script>
    // ===== Men√∫ m√≥vil =====
    const btnMenuMobile = document.getElementById('btnMenuMobile');
    const sidebar = document.querySelector('.sidebar');
    if (btnMenuMobile) {
      btnMenuMobile.addEventListener('click', () => {
        sidebar.classList.toggle('sidebar-open');
      });
    }

    // ===== Usuario y permisos =====
    const usuarioActual = typeof getUsuarioActualObligatorio === "function"
      ? getUsuarioActualObligatorio()
      : null;

    if (typeof aplicarPermisosYProteger === "function") {
      aplicarPermisosYProteger("contabilidad");
    }

    const labelUser = document.getElementById("topbar-user-label");
    if (usuarioActual && labelUser) {
      const rolTexto = usuarioActual.rol === "dueno" ? "Due√±o" : "Empleado";
      labelUser.textContent = `${usuarioActual.nombre} (${rolTexto})`;
    }

    function contaMoneda(n) {
      if (typeof alex3FormatearMoneda === "function") {
        return alex3FormatearMoneda(n);
      }
      const num = Number(n);
      if (isNaN(num)) return "Q 0.00";
      return "Q " + num.toFixed(2);
    }

    const inputMes = document.getElementById("contaMes");

    const kpiIng = document.getElementById("kpi-conta-ingresos");
    const kpiCos = document.getElementById("kpi-conta-costos");
    const kpiGas = document.getElementById("kpi-conta-gastos");
    const kpiUB  = document.getElementById("kpi-conta-utilidad-bruta");
    const kpiUN  = document.getElementById("kpi-conta-utilidad-neta");
    const kpiCaja = document.getElementById("kpi-conta-caja-neta");

    const tblDevIng = document.getElementById("tbl-dev-ingresos");
    const tblDevCos = document.getElementById("tbl-dev-costos");
    const tblDevGas = document.getElementById("tbl-dev-gastos");
    const tblDevUB  = document.getElementById("tbl-dev-ub");
    const tblDevUN  = document.getElementById("tbl-dev-un");
    const tblCajaEg = document.getElementById("tbl-caja-egresos");
    const tblCajaNet= document.getElementById("tbl-caja-neta");

    const tbodyBalance = document.getElementById("tabla-balance");
    const tbodyLibro   = document.getElementById("tabla-libro-diario");

    const tbodyVentasMes  = document.getElementById("tabla-ventas-mes");
    const tbodyComprasMes = document.getElementById("tabla-compras-mes");
    const tbodyGastosMes  = document.getElementById("tabla-gastos-mes");
    const tbodyCajaMes    = document.getElementById("tabla-caja-mes");

    const btnExportLibro = document.getElementById("btnExportLibro");

    function obtenerFechaReferencia() {
      if (inputMes && inputMes.value) {
        const [year, month] = inputMes.value.split("-").map(Number);
        if (!isNaN(year) && !isNaN(month)) {
          return new Date(year, month - 1, 1);
        }
      }
      return new Date();
    }

    function recalcularContabilidad() {
      if (typeof alexContaCalcularMes !== "function") return;

      const ref = obtenerFechaReferencia();
      const resultado = alexContaCalcularMes(ref);
      if (!resultado) return;

      const {
        ingresosVentas,
        costosCompras,
        gastosOperativos,
        utilidadBruta,
        utilidadNeta,
        cajaIngresos,
        cajaEgresos,
        cajaNeta,
        balance,
        libroDiario,
        ventasMes,
        comprasMes,
        gastosMes,
        movCajaMes
      } = resultado;

      // KPIs
      if (kpiIng) kpiIng.textContent = contaMoneda(ingresosVentas);
      if (kpiCos) kpiCos.textContent = contaMoneda(costosCompras);
      if (kpiGas) kpiGas.textContent = contaMoneda(gastosOperativos);
      if (kpiUB)  kpiUB.textContent  = contaMoneda(utilidadBruta);
      if (kpiUN)  kpiUN.textContent  = contaMoneda(utilidadNeta);
      if (kpiCaja) kpiCaja.textContent = contaMoneda(cajaNeta);

      // Resumen tabla devengado / caja
      if (tblDevIng) tblDevIng.textContent = contaMoneda(ingresosVentas);
      if (tblDevCos) tblDevCos.textContent = contaMoneda(costosCompras);
      if (tblDevGas) tblDevGas.textContent = contaMoneda(gastosOperativos);
      if (tblDevUB)  tblDevUB.textContent  = contaMoneda(utilidadBruta);
      if (tblDevUN)  tblDevUN.textContent  = contaMoneda(utilidadNeta);
      if (tblCajaEg) tblCajaEg.textContent = contaMoneda(cajaEgresos);
      if (tblCajaNet) tblCajaNet.textContent = contaMoneda(cajaNeta);

      // Balance
      if (tbodyBalance) {
        tbodyBalance.innerHTML = "";
        if (!balance) {
          tbodyBalance.innerHTML = `
            <tr><td colspan="3" class="table-empty">Sin datos de balance.</td></tr>
          `;
        } else {
          const act = balance.activos || {};
          const pas = balance.pasivos || {};
          const pat = balance.patrimonio || {};

          const filas = [
            ["Activos", "Caja / Bancos", act.caja || 0],
            ["Activos", "Inventario mercader√≠as", act.inventario || 0],
            ["Activos", "Total activos", act.total || 0],
            ["Pasivos", "Total pasivos", pas.total || 0],
            [
              "Patrimonio",
              "Utilidad acumulada / capital",
              pat.utilidadAcumulada || pat.total || 0
            ],
            ["Patrimonio", "Total patrimonio", pat.total || 0],
          ];

          filas.forEach(([grupo, cuenta, monto]) => {
            tbodyBalance.innerHTML += `
              <tr>
                <td>${grupo}</td>
                <td>${cuenta}</td>
                <td>${contaMoneda(monto)}</td>
              </tr>
            `;
          });
        }
      }

      // Libro diario
      if (tbodyLibro) {
        tbodyLibro.innerHTML = "";
        if (!libroDiario || !libroDiario.length) {
          tbodyLibro.innerHTML = `
            <tr>
              <td colspan="5" class="table-empty">
                A√∫n no hay asientos contables en este mes.
              </td>
            </tr>
          `;
        } else {
          libroDiario.forEach((asiento) => {
            asiento.lineas.forEach((linea, idx) => {
              const fechaTxt = asiento.fechaTexto || "-";
              const desc = asiento.descripcion || "-";
              const cuenta = linea.cuenta || "-";
              const debe = Number(linea.debe) || 0;
              const haber = Number(linea.haber) || 0;

              tbodyLibro.innerHTML += `
                <tr>
                  <td>${idx === 0 ? fechaTxt : ""}</td>
                  <td>${idx === 0 ? desc : ""}</td>
                  <td>${cuenta}</td>
                  <td>${debe ? contaMoneda(debe) : ""}</td>
                  <td>${haber ? contaMoneda(haber) : ""}</td>
                </tr>
              `;
            });
          });
        }
      }

      // Ventas
      if (tbodyVentasMes) {
        tbodyVentasMes.innerHTML = "";
        if (!ventasMes || !ventasMes.length) {
          tbodyVentasMes.innerHTML = `
            <tr><td colspan="3" class="table-empty">A√∫n no hay ventas en este mes.</td></tr>
          `;
        } else {
          ventasMes.forEach((v) => {
            const fechaTxt =
              v.fecha ||
              (v.fechaHora
                ? new Date(v.fechaHora).toLocaleString("es-GT")
                : "-");
            const cliente = v.clienteNombre || "Cliente general";
            const total = contaMoneda(v.total || 0);
            tbodyVentasMes.innerHTML += `
              <tr>
                <td>${fechaTxt}</td>
                <td>${cliente}</td>
                <td>${total}</td>
              </tr>
            `;
          });
        }
      }

      // Compras
      if (tbodyComprasMes) {
        tbodyComprasMes.innerHTML = "";
        if (!comprasMes || !comprasMes.length) {
          tbodyComprasMes.innerHTML = `
            <tr><td colspan="3" class="table-empty">A√∫n no hay compras en este mes.</td></tr>
          `;
        } else {
          comprasMes.forEach((c) => {
            const fechaTxt =
              c.fecha ||
              (c.fechaHora
                ? new Date(c.fechaHora).toLocaleString("es-GT")
                : "-");
            const prov = c.proveedorNombre || "-";
            const monto = contaMoneda(c.monto || 0);
            tbodyComprasMes.innerHTML += `
              <tr>
                <td>${fechaTxt}</td>
                <td>${prov}</td>
                <td>${monto}</td>
              </tr>
            `;
          });
        }
      }

      // Gastos
      if (tbodyGastosMes) {
        tbodyGastosMes.innerHTML = "";
        if (!gastosMes || !gastosMes.length) {
          tbodyGastosMes.innerHTML = `
            <tr><td colspan="3" class="table-empty">A√∫n no hay gastos en este mes.</td></tr>
          `;
        } else {
          gastosMes.forEach((g) => {
            const fechaTxt =
              g.fecha ||
              (g.fechaHora
                ? new Date(g.fechaHora).toLocaleString("es-GT")
                : "-");
            const cat = g.categoria || "-";
            const monto = contaMoneda(g.monto || 0);
            tbodyGastosMes.innerHTML += `
              <tr>
                <td>${fechaTxt}</td>
                <td>${cat}</td>
                <td>${monto}</td>
              </tr>
            `;
          });
        }
      }

      // Caja
      if (tbodyCajaMes) {
        tbodyCajaMes.innerHTML = "";
        if (!movCajaMes || !movCajaMes.length) {
          tbodyCajaMes.innerHTML = `
            <tr><td colspan="4" class="table-empty">A√∫n no hay movimientos de caja en este mes.</td></tr>
          `;
        } else {
          movCajaMes.forEach((m) => {
            const fechaTxt =
              m.fecha ||
              (m.fechaHora
                ? new Date(m.fechaHora).toLocaleString("es-GT")
                : "-");
            const tipo = m.tipo || "-";
            const desc = m.descripcion || m.categoria || "-";
            const monto = contaMoneda(m.monto || 0);
            tbodyCajaMes.innerHTML += `
              <tr>
                <td>${fechaTxt}</td>
                <td>${tipo}</td>
                <td>${desc}</td>
                <td>${monto}</td>
              </tr>
            `;
          });
        }
      }

      // Guardar libro en window para exportar
      window.__alexLibroDiarioMes = libroDiario || [];
    }

    function descargarCSV(nombreArchivo, encabezados, filas) {
      let contenido = encabezados.join(",") + "\n";
      filas.forEach((fila) => {
        const linea = fila
          .map((v) => {
            const str = (v ?? "").toString().replace(/"/g, '""');
            if (
              str.includes(",") ||
              str.includes('"') ||
              str.includes("\n")
            ) {
              return `"${str}"`;
            }
            return str;
          })
          .join(",");
        contenido += linea + "\n";
      });

      const blob = new Blob([contenido], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);

      const link = document.createElement("a");
      link.href = url;
      link.download = nombreArchivo;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    }

    function exportarLibroDiarioCSV() {
      const libro = window.__alexLibroDiarioMes || [];
      if (!libro.length) {
        alert("No hay asientos en el libro diario de este mes.");
        return;
      }

      const ref = obtenerFechaReferencia();
      const year = ref.getFullYear();
      const month = String(ref.getMonth() + 1).padStart(2, "0");

      const encabezados = ["Fecha", "Descripci√≥n", "Cuenta", "Debe", "Haber"];

      const filas = [];
      libro.forEach((as) => {
        const fechaISO = as.fecha;
        const fecha = alexConta_formatearYYYYMMDD(fechaISO);
        const desc = as.descripcion || "";
        as.lineas.forEach((l, idx) => {
          filas.push([
            idx === 0 ? fecha : "",
            idx === 0 ? desc : "",
            l.cuenta || "",
            (Number(l.debe) || 0).toFixed(2),
            (Number(l.haber) || 0).toFixed(2),
          ]);
        });
      });

      const nombreArchivo = `libro_diario_${year}_${month}.csv`;
      descargarCSV(nombreArchivo, encabezados, filas);
    }

    if (btnExportLibro) {
      btnExportLibro.addEventListener("click", exportarLibroDiarioCSV);
    }

    // Cambio de mes ‚Üí recalcula
    if (inputMes) {
      inputMes.addEventListener("change", () => {
        recalcularContabilidad();
      });
    }

    // Inicializar mes actual
    (function initMesActual() {
      if (!inputMes) return;
      const hoy = new Date();
      const year = hoy.getFullYear();
      const month = String(hoy.getMonth() + 1).padStart(2, "0");
      inputMes.value = `${year}-${month}`;
    })();

    // Primera carga
    recalcularContabilidad();
  </script>
</body>
</html>
