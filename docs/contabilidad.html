<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>ALEX 3.0 - Contabilidad</title>
  <link rel="stylesheet" href="styles.css">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>

<body class="dashboard-body">
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <span class="logo-badge">A</span>
      <div class="sidebar-logo-text">
        <span class="sidebar-logo-main">ALEX 3.0</span>
        <span class="sidebar-logo-sub">Panel del negocio</span>
      </div>
    </div>

    <nav class="sidebar-nav">
      <a href="dashboard.html" class="sidebar-link">üìä Dashboard</a>
      <a href="ventas.html" class="sidebar-link">üíµ Ventas</a>
      <a href="inventario.html" class="sidebar-link">üì¶ Inventario</a>
      <a href="caja.html" class="sidebar-link">üí∞ Caja</a>
      <a href="compras.html" class="sidebar-link">üßæ Compras</a>
      <a href="gastos.html" class="sidebar-link">üìâ Gastos</a>
      <a href="clientes.html" class="sidebar-link">üë• Clientes</a>
      <a href="proveedores.html" class="sidebar-link">üöö Proveedores</a>
      <a href="contabilidad.html" class="sidebar-link active">üìö Contabilidad</a>
      <a href="sat.html" class="sidebar-link">üá¨üáπ SAT Guatemala</a>
      <a href="ia.html" class="sidebar-link">ü§ñ IA empresarial</a>
      <a href="configuracion.html" class="sidebar-link">‚öôÔ∏è Configuraci√≥n</a>
    </nav>

    <div class="sidebar-footer">
      <span class="sidebar-footer-title">Mi negocio</span>
      <span class="sidebar-footer-sub">Resumen contable</span>
    </div>
  </aside>

  <!-- Layout principal -->
  <div class="main-layout">
    <!-- Topbar -->
    <header class="topbar">
      <button class="btn-menu-mobile" id="btnMenuMobile">‚ò∞</button>

      <div class="topbar-left">
        <h1 class="topbar-title">Contabilidad b√°sica</h1>
        <p class="topbar-subtitle">
          Resumen simple de ingresos, costos, gastos y utilidad del mes actual.
        </p>
      </div>

      <div class="topbar-right">
        <span class="topbar-company">Mi negocio</span>
        <span class="topbar-divider">‚Ä¢</span>
        <span class="topbar-user" id="topbar-user-label">Usuario (Rol)</span>
      </div>
    </header>

    <!-- Contenido principal -->
    <main class="main-content">
      <!-- KPIs principales del mes -->
      <section class="cards-grid">
        <article class="card kpi-card">
          <h2 class="card-title">Ingresos del mes</h2>
          <p class="card-kpi" id="kpi-conta-ingresos">Q 0.00</p>
          <p class="card-kpi-sub">Ventas totales del mes (todas las formas de pago).</p>
        </article>

        <article class="card kpi-card">
          <h2 class="card-title">Costos (compras)</h2>
          <p class="card-kpi gasto" id="kpi-conta-costos">Q 0.00</p>
          <p class="card-kpi-sub">Compras registradas en el mes.</p>
        </article>

        <article class="card kpi-card">
          <h2 class="card-title">Gastos del mes</h2>
          <p class="card-kpi gasto" id="kpi-conta-gastos">Q 0.00</p>
          <p class="card-kpi-sub">Gastos operativos (luz, renta, n√≥mina, etc.).</p>
        </article>

        <article class="card kpi-card">
          <h2 class="card-title">Utilidad bruta</h2>
          <p class="card-kpi utilidad" id="kpi-conta-utilidad-bruta">Q 0.00</p>
          <p class="card-kpi-sub">Ingresos - costos (ventas - compras).</p>
        </article>

        <article class="card kpi-card">
          <h2 class="card-title">Utilidad neta</h2>
          <p class="card-kpi utilidad" id="kpi-conta-utilidad-neta">Q 0.00</p>
          <p class="card-kpi-sub">Ingresos - costos - gastos.</p>
        </article>
      </section>

      <!-- Resumen num√©rico -->
      <section class="card">
        <h2 class="card-title">1. Resumen contable del mes actual</h2>
        <p class="card-description">
          Este resumen NO es todav√≠a un estado financiero oficial para SAT, pero te da una idea
          clara de c√≥mo va el negocio.
        </p>

        <table class="table">
          <thead>
            <tr>
              <th>Concepto</th>
              <th>Monto</th>
              <th>Detalle</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Ingresos por ventas</td>
              <td id="tbl-ingresos"></td>
              <td>Sumatoria de todas las ventas del mes.</td>
            </tr>
            <tr>
              <td>Costos por compras</td>
              <td id="tbl-costos"></td>
              <td>Compras a proveedores (inventario, mercader√≠a, etc.).</td>
            </tr>
            <tr>
              <td>Gastos operativos</td>
              <td id="tbl-gastos"></td>
              <td>Servicios b√°sicos, renta, n√≥mina, publicidad, otros.</td>
            </tr>
            <tr>
              <td><strong>Utilidad bruta</strong></td>
              <td id="tbl-utilidad-bruta"></td>
              <td>Ingresos - costos.</td>
            </tr>
            <tr>
              <td><strong>Utilidad neta</strong></td>
              <td id="tbl-utilidad-neta"></td>
              <td>Ingresos - costos - gastos.</td>
            </tr>
          </tbody>
        </table>
      </section>

      <!-- Detalle de movimientos del mes -->
      <section class="grid-2">
        <article class="card">
          <h2 class="card-title">2. Ventas del mes</h2>
          <p class="card-description">
            Listado de todas las ventas del mes actual que se usan para el c√°lculo de ingresos.
          </p>

          <table class="table">
            <thead>
              <tr>
                <th>Fecha</th>
                <th>Cliente</th>
                <th>Documento</th>
                <th>Forma de pago</th>
                <th>Total</th>
              </tr>
            </thead>
            <tbody id="tabla-conta-ventas">
              <tr>
                <td colspan="5" class="table-empty">
                  A√∫n no hay ventas registradas en este mes.
                </td>
              </tr>
            </tbody>
          </table>
        </article>

        <article class="card">
          <h2 class="card-title">3. Compras del mes</h2>
          <p class="card-description">
            Todas las compras del mes actual que se consideran como costo.
          </p>

          <table class="table">
            <thead>
              <tr>
                <th>Fecha</th>
                <th>Proveedor</th>
                <th>Documento</th>
                <th>Forma de pago</th>
                <th>Monto</th>
              </tr>
            </thead>
            <tbody id="tabla-conta-compras">
              <tr>
                <td colspan="5" class="table-empty">
                  A√∫n no hay compras registradas en este mes.
                </td>
              </tr>
            </tbody>
          </table>
        </article>
      </section>

      <section class="card">
        <h2 class="card-title">4. Gastos del mes</h2>
        <p class="card-description">
          Todos los gastos operativos del mes actual.
        </p>

        <table class="table">
          <thead>
            <tr>
              <th>Fecha</th>
              <th>Categor√≠a</th>
              <th>Descripci√≥n</th>
              <th>Forma de pago</th>
              <th>Monto</th>
            </tr>
          </thead>
          <tbody id="tabla-conta-gastos">
            <tr>
              <td colspan="5" class="table-empty">
                A√∫n no hay gastos registrados en este mes.
              </td>
            </tr>
          </tbody>
        </table>
      </section>
    </main>
  </div>

  <!-- Scripts base -->
  <script src="alex-storage.js"></script>
  <script src="alex-roles.js"></script>

  <script>
    // ===== Men√∫ m√≥vil =====
    const btnMenuMobile = document.getElementById('btnMenuMobile');
    const sidebar = document.querySelector('.sidebar');
    if (btnMenuMobile) {
      btnMenuMobile.addEventListener('click', () => {
        sidebar.classList.toggle('sidebar-open');
      });
    }

    // ===== Usuario y permisos =====
    const usuarioActual = typeof getUsuarioActualObligatorio === "function"
      ? getUsuarioActualObligatorio()
      : null;

    if (typeof aplicarPermisosYProteger === "function") {
      aplicarPermisosYProteger("contabilidad");
    }

    const labelUser = document.getElementById("topbar-user-label");
    if (usuarioActual && labelUser) {
      const rolTexto = usuarioActual.rol === "dueno" ? "Due√±o" : "Empleado";
      labelUser.textContent = `${usuarioActual.nombre} (${rolTexto})`;
    }

    // ===== Helpers =====
    function alex3FormatearMonedaSeguro(valor) {
      if (typeof alex3FormatearMoneda === "function") {
        return alex3FormatearMoneda(valor);
      }
      const num = Number(valor);
      if (isNaN(num)) return "Q 0.00";
      return "Q " + num.toFixed(2);
    }

    function esMismoMes(a, b) {
      return a.getFullYear() === b.getFullYear() &&
             a.getMonth() === b.getMonth();
    }

    function formatearFechaLocal(fechaIso) {
      const d = new Date(fechaIso);
      if (isNaN(d.getTime())) return "-";
      return d.toLocaleString("es-GT");
    }

    // ===== Cargar datos reales =====
    let ventas = [];
    let compras = [];
    let gastos = [];

    if (typeof load === "function") {
      const vData = load("ventas", []);
      ventas = Array.isArray(vData) ? vData : [];

      const cData = load("compras", []);
      compras = Array.isArray(cData) ? cData : [];

      const gData = load("gastos", []);
      gastos = Array.isArray(gData) ? gData : [];
    }

    // ===== C√°lculo principal del mes =====
    function recalcularContabilidad() {
      const hoy = new Date();

      // Filtrar por mes actual
      const ventasMes = ventas.filter(v => {
        const f = new Date(v.fechaHora || v.fecha || Date.now());
        return esMismoMes(f, hoy);
      });

      const comprasMes = compras.filter(c => {
        const f = new Date(c.fechaHora || c.fecha || Date.now());
        return esMismoMes(f, hoy);
      });

      const gastosMes = gastos.filter(g => {
        const f = new Date(g.fechaHora || g.fecha || Date.now());
        return esMismoMes(f, hoy);
      });

      // Totales
      const ingresos = ventasMes.reduce((acc, v) => acc + (Number(v.total) || 0), 0);
      const costos = comprasMes.reduce((acc, c) => acc + (Number(c.monto) || 0), 0);
      const gastosTot = gastosMes.reduce((acc, g) => acc + (Number(g.monto) || 0), 0);

      const utilidadBruta = ingresos - costos;
      const utilidadNeta = ingresos - costos - gastosTot;

      // Actualizar KPIs
      const elIng = document.getElementById("kpi-conta-ingresos");
      const elCos = document.getElementById("kpi-conta-costos");
      const elGas = document.getElementById("kpi-conta-gastos");
      const elUB  = document.getElementById("kpi-conta-utilidad-bruta");
      const elUN  = document.getElementById("kpi-conta-utilidad-neta");

      if (elIng) elIng.textContent = alex3FormatearMonedaSeguro(ingresos);
      if (elCos) elCos.textContent = alex3FormatearMonedaSeguro(costos);
      if (elGas) elGas.textContent = alex3FormatearMonedaSeguro(gastosTot);
      if (elUB)  elUB.textContent  = alex3FormatearMonedaSeguro(utilidadBruta);
      if (elUN)  elUN.textContent  = alex3FormatearMonedaSeguro(utilidadNeta);

      // Tabla resumen
      const tIng = document.getElementById("tbl-ingresos");
      const tCos = document.getElementById("tbl-costos");
      const tGas = document.getElementById("tbl-gastos");
      const tUB  = document.getElementById("tbl-utilidad-bruta");
      const tUN  = document.getElementById("tbl-utilidad-neta");

      if (tIng) tIng.textContent = alex3FormatearMonedaSeguro(ingresos);
      if (tCos) tCos.textContent = alex3FormatearMonedaSeguro(costos);
      if (tGas) tGas.textContent = alex3FormatearMonedaSeguro(gastosTot);
      if (tUB)  tUB.textContent  = alex3FormatearMonedaSeguro(utilidadBruta);
      if (tUN)  tUN.textContent  = alex3FormatearMonedaSeguro(utilidadNeta);

      // Detalle tablas
      renderTablaVentasMes(ventasMes);
      renderTablaComprasMes(comprasMes);
      renderTablaGastosMes(gastosMes);
    }

    // ===== Tablas de detalle =====
    const tbodyVentas = document.getElementById("tabla-conta-ventas");
    const tbodyCompras = document.getElementById("tabla-conta-compras");
    const tbodyGastos = document.getElementById("tabla-conta-gastos");

    function renderTablaVentasMes(lista) {
      if (!tbodyVentas) return;
      tbodyVentas.innerHTML = "";

      if (!lista.length) {
        tbodyVentas.innerHTML = `
          <tr>
            <td colspan="5" class="table-empty">
              A√∫n no hay ventas registradas en este mes.
            </td>
          </tr>
        `;
        return;
      }

      const ordenadas = [...lista].sort((a, b) => {
        const fa = new Date(a.fechaHora || a.fecha || 0).getTime();
        const fb = new Date(b.fechaHora || b.fecha || 0).getTime();
        return fb - fa;
      });

      ordenadas.forEach(v => {
        const fechaTxt = v.fecha || (v.fechaHora ? formatearFechaLocal(v.fechaHora) : "-");
        const clienteTxt = v.clienteNombre || "Cliente general";
        const docTxt = v.documentoTipo
          ? (v.documentoNumero ? `${v.documentoTipo} ${v.documentoNumero}` : v.documentoTipo)
          : (v.documentoNumero || "-");
        const formaPagoTxt = v.formaPago || "-";
        const totalTxt = alex3FormatearMonedaSeguro(v.total);

        tbodyVentas.innerHTML += `
          <tr>
            <td>${fechaTxt}</td>
            <td>${clienteTxt}</td>
            <td>${docTxt}</td>
            <td>${formaPagoTxt}</td>
            <td>${totalTxt}</td>
          </tr>
        `;
      });
    }

    function renderTablaComprasMes(lista) {
      if (!tbodyCompras) return;
      tbodyCompras.innerHTML = "";

      if (!lista.length) {
        tbodyCompras.innerHTML = `
          <tr>
            <td colspan="5" class="table-empty">
              A√∫n no hay compras registradas en este mes.
            </td>
          </tr>
        `;
        return;
      }

      const ordenadas = [...lista].sort((a, b) => {
        const fa = new Date(a.fechaHora || a.fecha || 0).getTime();
        const fb = new Date(b.fechaHora || b.fecha || 0).getTime();
        return fb - fa;
      });

      ordenadas.forEach(c => {
        const fechaTxt = c.fecha || (c.fechaHora ? formatearFechaLocal(c.fechaHora) : "-");
        const proveedorTxt = c.proveedorNombre || "-";
        const docTxt = c.documentoTipo
          ? (c.documentoNumero ? `${c.documentoTipo} ${c.documentoNumero}` : c.documentoTipo)
          : (c.documentoNumero || "-");
        const formaPagoTxt = c.formaPago || "-";
        const montoTxt = alex3FormatearMonedaSeguro(c.monto);

        tbodyCompras.innerHTML += `
          <tr>
            <td>${fechaTxt}</td>
            <td>${proveedorTxt}</td>
            <td>${docTxt}</td>
            <td>${formaPagoTxt}</td>
            <td>${montoTxt}</td>
          </tr>
        `;
      });
    }

    function renderTablaGastosMes(lista) {
      if (!tbodyGastos) return;
      tbodyGastos.innerHTML = "";

      if (!lista.length) {
        tbodyGastos.innerHTML = `
          <tr>
            <td colspan="5" class="table-empty">
              A√∫n no hay gastos registrados en este mes.
            </td>
          </tr>
        `;
        return;
      }

      const ordenados = [...lista].sort((a, b) => {
        const fa = new Date(a.fechaHora || a.fecha || 0).getTime();
        const fb = new Date(b.fechaHora || b.fecha || 0).getTime();
        return fb - fa;
      });

      ordenados.forEach(g => {
        const fechaTxt = g.fecha || (g.fechaHora ? formatearFechaLocal(g.fechaHora) : "-");
        const categoriaTxt = g.categoria || "-";
        const descTxt = g.descripcion || "-";
        const formaPagoTxt = g.formaPago || "-";
        const montoTxt = alex3FormatearMonedaSeguro(g.monto);

        tbodyGastos.innerHTML += `
          <tr>
            <td>${fechaTxt}</td>
            <td>${categoriaTxt}</td>
            <td>${descTxt}</td>
            <td>${formaPagoTxt}</td>
            <td>${montoTxt}</td>
          </tr>
        `;
      });
    }

    // ===== Primera carga =====
    recalcularContabilidad();
  </script>
</body>
</html>
