<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>ALEX 3.0 - Contabilidad</title>
  <link rel="stylesheet" href="styles.css">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>

<body class="dashboard-body">
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <span class="logo-badge">A</span>
      <div class="sidebar-logo-text">
        <span class="sidebar-logo-main">ALEX 3.0</span>
        <span class="sidebar-logo-sub">Panel del negocio</span>
      </div>
    </div>

    <nav class="sidebar-nav">
      <a href="dashboard.html" class="sidebar-link">üìä Dashboard</a>
      <a href="ventas.html" class="sidebar-link">üíµ Ventas</a>
      <a href="inventario.html" class="sidebar-link">üì¶ Inventario</a>
      <a href="caja.html" class="sidebar-link">üí∞ Caja</a>
      <a href="compras.html" class="sidebar-link">üßæ Compras</a>
      <a href="gastos.html" class="sidebar-link">üìâ Gastos</a>
      <a href="clientes.html" class="sidebar-link">üë• Clientes</a>
      <a href="proveedores.html" class="sidebar-link">üöö Proveedores</a>
      <a href="contabilidad.html" class="sidebar-link active">üìö Contabilidad</a>
      <a href="sat.html" class="sidebar-link">üá¨üáπ SAT Guatemala</a>
      <a href="ia.html" class="sidebar-link">ü§ñ IA empresarial</a>
      <a href="configuracion.html" class="sidebar-link">‚öôÔ∏è Configuraci√≥n</a>
    </nav>

    <div class="sidebar-footer">
      <span class="sidebar-footer-title">Empresa demo</span>
      <span class="sidebar-footer-sub">Versi√≥n 1.0</span>
    </div>
  </aside>

  <!-- Layout principal -->
  <div class="main-layout">
    <!-- Topbar -->
    <header class="topbar">
      <button class="btn-menu-mobile" id="btnMenuMobile">‚ò∞</button>

      <div class="topbar-left">
        <h1 class="topbar-title">Resumen contable</h1>
        <p class="topbar-subtitle">
          Resumen de ventas, compras, gastos y caja por per√≠odo contable.
        </p>
      </div>

      <div class="topbar-right">
        <span class="topbar-company">Mi tienda demo</span>
        <span class="topbar-divider">‚Ä¢</span>
        <span class="topbar-user" id="topbar-user-label">Usuario (Rol)</span>
        <button class="btn" id="btnLogout" type="button" style="margin-left: 0.75rem;">
          Cerrar sesi√≥n
        </button>
      </div>
    </header>

    <!-- Contenido principal -->
    <main class="main-content">
      <!-- Filtros -->
      <section class="card">
        <h2 class="card-title">Per√≠odo contable</h2>
        <p class="card-description">
          Selecciona un rango r√°pido para ver el resumen contable del negocio.
        </p>

        <div class="form-grid">
          <div class="form-field">
            <label for="filtroPeriodo">Rango r√°pido</label>
            <select id="filtroPeriodo" class="input">
              <option value="HOY">Hoy</option>
              <option value="MES">Este mes</option>
              <option value="ANIO">Este a√±o</option>
              <option value="TODO" selected>Todo el historial</option>
            </select>
          </div>
        </div>

        <button class="btn" id="btnAplicarFiltro">Aplicar filtro</button>
      </section>

      <!-- Resumen principal -->
      <section class="cards-grid">
        <article class="card kpi-card">
          <h2 class="card-title">Ventas del per√≠odo</h2>
          <p class="card-kpi" id="cont-ventas">Q 0.00</p>
          <p class="card-kpi-sub">Total facturado / vendido.</p>
        </article>

        <article class="card kpi-card">
          <h2 class="card-title">Compras del per√≠odo</h2>
          <p class="card-kpi gasto" id="cont-compras">Q 0.00</p>
          <p class="card-kpi-sub">Compras a proveedores, mercanc√≠a y otros.</p>
        </article>

        <article class="card kpi-card">
          <h2 class="card-title">Gastos del per√≠odo</h2>
          <p class="card-kpi gasto" id="cont-gastos">Q 0.00</p>
          <p class="card-kpi-sub">Renta, servicios, n√≥mina, env√≠os, etc.</p>
        </article>

        <article class="card kpi-card">
          <h2 class="card-title">Resultado del per√≠odo</h2>
          <p class="card-kpi utilidad" id="cont-resultado">Q 0.00</p>
          <p class="card-kpi-sub">Ventas - Compras - Gastos.</p>
        </article>
      </section>

      <!-- Caja e info extra -->
      <section class="grid-2">
        <article class="card">
          <h2 class="card-title">Resumen de caja</h2>
          <p class="card-description">
            Ingresos y egresos registrados en la caja profesional. Esto no reemplaza el corte f√≠sico,
            pero te da una referencia r√°pida.
          </p>

          <table class="table">
            <tbody>
              <tr>
                <th>Ingresos en caja (hist√≥rico)</th>
                <td id="cont-caja-ingresos">Q 0.00</td>
              </tr>
              <tr>
                <th>Egresos en caja (hist√≥rico)</th>
                <td id="cont-caja-egresos">Q 0.00</td>
              </tr>
              <tr>
                <th>Saldo caja (estimado)</th>
                <td id="cont-caja-saldo">Q 0.00</td>
              </tr>
            </tbody>
          </table>
        </article>

        <article class="card">
          <h2 class="card-title">Notas contables</h2>
          <ul class="alerts-list">
            <li class="alert-item">
              üìå <strong>Ventas del per√≠odo:</strong> Se calculan con las ventas registradas en el sistema.
            </li>
            <li class="alert-item">
              üìå <strong>Compras del per√≠odo:</strong> Basadas en el m√≥dulo de compras.
            </li>
            <li class="alert-item">
              üìå <strong>Gastos del per√≠odo:</strong> Basados en el m√≥dulo de gastos.
            </li>
            <li class="alert-item">
              üìå <strong>Caja:</strong> Se alimenta de ingresos/egresos de la caja y egresos de gastos/compras.
            </li>
          </ul>
          <p class="card-description">
            En versiones futuras, este m√≥dulo se conectar√° con SAT Guatemala y generar√° estados financieros
            m√°s avanzados (balance general, estado de resultados, etc.).
          </p>
        </article>
      </section>
    </main>
  </div>

  <!-- Scripts base -->
  <script src="alex-storage.js"></script>
  <script src="alex-roles.js"></script>

  <script>
    // Men√∫ m√≥vil
    const btnMenuMobile = document.getElementById('btnMenuMobile');
    const sidebar = document.querySelector('.sidebar');

    if (btnMenuMobile) {
      btnMenuMobile.addEventListener('click', () => {
        sidebar.classList.toggle('sidebar-open');
      });
    }

    // Usuario y permisos
    const usuarioActual = typeof getUsuarioActualObligatorio === "function"
      ? getUsuarioActualObligatorio()
      : null;

    if (typeof aplicarPermisosYProteger === "function") {
      aplicarPermisosYProteger("contabilidad");
    }

    // Pintar nombre y rol en el topbar
    const labelUser = document.getElementById("topbar-user-label");
    if (usuarioActual && labelUser) {
      const rolTexto = usuarioActual.rol === "dueno" ? "Due√±o" : "Empleado";
      labelUser.textContent = `${usuarioActual.nombre} (${rolTexto})`;
    }

    // Bot√≥n Cerrar sesi√≥n
    const btnLogout = document.getElementById("btnLogout");
    if (btnLogout) {
      btnLogout.addEventListener("click", () => {
        if (!confirm("¬øQuieres cerrar sesi√≥n?")) return;

        if (typeof save === "function") {
          save("usuarioActual", null);
        } else {
          localStorage.removeItem("usuarioActual");
        }

        window.location.href = "index.html";
      });
    }

    // ====== DATOS BASE ======
    let ventas = [];
    let compras = [];
    let gastos = [];
    let cajaMovs = [];

    if (typeof load === "function") {
      const vData = load("ventas", []);
      ventas = Array.isArray(vData) ? vData : [];

      const cData = load("compras", []);
      compras = Array.isArray(cData) ? cData : [];

      const gData = load("gastos", []);
      gastos = Array.isArray(gData) ? gData : [];

      const mData = load("caja_movimientos", []);
      cajaMovs = Array.isArray(mData) ? mData : [];
    }

    // ====== HELPERS ======
    function alex3FormatearMonedaSeguro(valor) {
      if (typeof alex3FormatearMoneda === "function") {
        return alex3FormatearMoneda(valor);
      }
      const num = Number(valor);
      if (isNaN(num)) return "Q 0.00";
      return "Q " + num.toFixed(2);
    }

    function getFecha(obj) {
      if (!obj) return null;
      const f = obj.fechaHora || obj.fecha || null;
      if (!f) return null;
      const d = new Date(f);
      if (isNaN(d.getTime())) return null;
      return d;
    }

    function esMismoDia(a, b) {
      return a.getFullYear() === b.getFullYear() &&
             a.getMonth() === b.getMonth() &&
             a.getDate() === b.getDate();
    }

    function esMismoMes(a, b) {
      return a.getFullYear() === b.getFullYear() &&
             a.getMonth() === b.getMonth();
    }

    function esMismoAnio(a, b) {
      return a.getFullYear() === b.getFullYear();
    }

    function dentroDelPeriodo(fecha, periodo, referencia) {
      if (!fecha) return false;
      if (periodo === "HOY") {
        return esMismoDia(fecha, referencia);
      } else if (periodo === "MES") {
        return esMismoMes(fecha, referencia);
      } else if (periodo === "ANIO") {
        return esMismoAnio(fecha, referencia);
      } else {
        // TODO = todo historial
        return true;
      }
    }

    // ====== C√ÅLCULOS PRINCIPALES ======
    function recalcularContabilidad() {
      const selectPeriodo = document.getElementById("filtroPeriodo");
      const periodo = selectPeriodo ? selectPeriodo.value : "TODO";
      const hoy = new Date();

      let totalVentas = 0;
      let totalCompras = 0;
      let totalGastos = 0;

      // Ventas del per√≠odo
      ventas.forEach(v => {
        const fecha = getFecha(v) || hoy;
        if (!dentroDelPeriodo(fecha, periodo, hoy)) return;
        const total = Number(v.total) || 0;
        totalVentas += total;
      });

      // Compras del per√≠odo
      compras.forEach(c => {
        const fecha = getFecha(c) || hoy;
        if (!dentroDelPeriodo(fecha, periodo, hoy)) return;
        const monto = Number(c.monto) || 0;
        totalCompras += monto;
      });

      // Gastos del per√≠odo
      gastos.forEach(g => {
        const fecha = getFecha(g) || hoy;
        if (!dentroDelPeriodo(fecha, periodo, hoy)) return;
        const monto = Number(g.monto) || 0;
        totalGastos += monto;
      });

      // Resultado del per√≠odo
      const resultado = totalVentas - totalCompras - totalGastos;

      // Resumen de caja (hist√≥rico, no por per√≠odo)
      let ingresosCaja = 0;
      let egresosCaja = 0;

      cajaMovs.forEach(m => {
        const monto = Number(m.monto) || 0;
        const tipo = (m.tipo || "").toUpperCase();
        if (tipo === "INGRESO") {
          ingresosCaja += monto;
        } else if (tipo === "EGRESO") {
          egresosCaja += monto;
        }
      });

      const saldoCaja = ingresosCaja - egresosCaja;

      // Pintar resultados
      const elVentas = document.getElementById("cont-ventas");
      const elCompras = document.getElementById("cont-compras");
      const elGastos = document.getElementById("cont-gastos");
      const elResultado = document.getElementById("cont-resultado");

      const elCajaIng = document.getElementById("cont-caja-ingresos");
      const elCajaEgr = document.getElementById("cont-caja-egresos");
      const elCajaSaldo = document.getElementById("cont-caja-saldo");

      if (elVentas) elVentas.textContent = alex3FormatearMonedaSeguro(totalVentas);
      if (elCompras) elCompras.textContent = alex3FormatearMonedaSeguro(totalCompras);
      if (elGastos) elGastos.textContent = alex3FormatearMonedaSeguro(totalGastos);
      if (elResultado) elResultado.textContent = alex3FormatearMonedaSeguro(resultado);

      if (elCajaIng) elCajaIng.textContent = alex3FormatearMonedaSeguro(ingresosCaja);
      if (elCajaEgr) elCajaEgr.textContent = alex3FormatearMonedaSeguro(egresosCaja);
      if (elCajaSaldo) elCajaSaldo.textContent = alex3FormatearMonedaSeguro(saldoCaja);
    }

    // Evento del bot√≥n de filtro
    const btnAplicarFiltro = document.getElementById("btnAplicarFiltro");
    if (btnAplicarFiltro) {
      btnAplicarFiltro.addEventListener("click", recalcularContabilidad);
    }

    // Primera carga
    recalcularContabilidad();
  </script>
</body>
</html>
