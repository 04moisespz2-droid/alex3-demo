<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>ALEX 3.0 - Gastos</title>
  <link rel="stylesheet" href="styles.css">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>

<body class="dashboard-body">
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <span class="logo-badge">A</span>
      <div class="sidebar-logo-text">
        <span class="sidebar-logo-main">ALEX 3.0</span>
        <span class="sidebar-logo-sub">Panel del negocio</span>
      </div>
    </div>

    <nav class="sidebar-nav">
      <a href="dashboard.html" class="sidebar-link">üìä Dashboard</a>
      <a href="ventas.html" class="sidebar-link">üíµ Ventas</a>
      <a href="inventario.html" class="sidebar-link">üì¶ Inventario</a>
      <a href="caja.html" class="sidebar-link">üí∞ Caja</a>
      <a href="compras.html" class="sidebar-link">üßæ Compras</a>
      <a href="gastos.html" class="sidebar-link active">üìâ Gastos</a>
      <a href="clientes.html" class="sidebar-link">üë• Clientes</a>
      <a href="proveedores.html" class="sidebar-link">üöö Proveedores</a>
      <a href="contabilidad.html" class="sidebar-link">üìö Contabilidad</a>
      <a href="sat.html" class="sidebar-link">üá¨üáπ SAT Guatemala</a>
      <a href="ia.html" class="sidebar-link">ü§ñ IA empresarial</a>
      <a href="configuracion.html" class="sidebar-link">‚öôÔ∏è Configuraci√≥n</a>
    </nav>

    <div class="sidebar-footer">
      <span class="sidebar-footer-title">Mi negocio</span>
      <span class="sidebar-footer-sub">M√≥dulo de gastos</span>
    </div>
  </aside>

  <!-- Layout principal -->
  <div class="main-layout">
    <!-- Topbar -->
    <header class="topbar">
      <button class="btn-menu-mobile" id="btnMenuMobile">‚ò∞</button>

      <div class="topbar-left">
        <h1 class="topbar-title">Gastos</h1>
        <p class="topbar-subtitle">
          Registra gastos reales del negocio y que ALEX actualice caja y dashboard.
        </p>
      </div>

      <div class="topbar-right">
        <span class="topbar-company">Mi negocio</span>
        <span class="topbar-divider">‚Ä¢</span>
        <span class="topbar-user" id="topbar-user-label">Usuario (Rol)</span>
      </div>
    </header>

    <!-- Contenido principal -->
    <main class="main-content">
      <!-- KPIs de gastos -->
      <section class="cards-grid">
        <article class="card kpi-card">
          <h2 class="card-title">Gastos de hoy</h2>
          <p class="card-kpi gasto" id="kpi-gastos-hoy">Q 0.00</p>
          <p class="card-kpi-sub">Total de gastos registrados hoy.</p>
        </article>

        <article class="card kpi-card">
          <h2 class="card-title">Gastos del mes</h2>
          <p class="card-kpi gasto" id="kpi-gastos-mes">Q 0.00</p>
          <p class="card-kpi-sub">Sumatoria del mes actual.</p>
        </article>

        <article class="card kpi-card">
          <h2 class="card-title">Registros de gastos</h2>
          <p class="card-kpi" id="kpi-gastos-cantidad">0</p>
          <p class="card-kpi-sub">N√∫mero total de gastos guardados.</p>
        </article>

        <article class="card kpi-card">
          <h2 class="card-title">Promedio por gasto</h2>
          <p class="card-kpi" id="kpi-gastos-promedio">Q 0.00</p>
          <p class="card-kpi-sub">Gastos del mes / registros.</p>
        </article>
      </section>

      <!-- Formulario de nuevo gasto -->
      <section class="card">
        <h2 class="card-title">1. Registrar un nuevo gasto</h2>
        <p class="card-description">
          Usa este m√≥dulo para registrar luz, internet, renta, sueldos, env√≠os, etc.
          Si el gasto es en efectivo, ALEX restar√° autom√°ticamente de la caja.
        </p>

        <div class="form-grid">
          <div class="form-field">
            <label for="gFecha">Fecha y hora</label>
            <input id="gFecha" class="input" type="datetime-local">
          </div>

          <div class="form-field">
            <label for="gCategoria">Categor√≠a</label>
            <select id="gCategoria" class="input">
              <option value="Servicios b√°sicos">Servicios b√°sicos (luz, agua, internet)</option>
              <option value="Renta">Renta / alquiler</option>
              <option value="N√≥mina">N√≥mina / sueldos</option>
              <option value="Publicidad">Publicidad / marketing</option>
              <option value="Env√≠os">Env√≠os / log√≠stica</option>
              <option value="Impuestos">Impuestos y tasas</option>
              <option value="Mantenimiento">Mantenimiento / reparaciones</option>
              <option value="Otros">Otros gastos</option>
            </select>
          </div>

          <div class="form-field">
            <label for="gDescripcion">Descripci√≥n</label>
            <input id="gDescripcion" class="input" type="text"
                   placeholder="Ej: Luz del local, pago internet, sueldo ayudante">
          </div>

          <div class="form-field">
            <label for="gMonto">Monto (Q)</label>
            <input id="gMonto" class="input" type="number" min="0" step="0.01">
          </div>

          <div class="form-field">
            <label for="gFormaPago">Forma de pago</label>
            <select id="gFormaPago" class="input">
              <option value="EFECTIVO">Efectivo (sale de caja)</option>
              <option value="TRANSFERENCIA">Transferencia</option>
              <option value="TARJETA">Tarjeta</option>
              <option value="OTRO">Otro</option>
            </select>
          </div>

          <div class="form-field" style="grid-column: 1 / -1;">
            <label for="gNotas">Notas (opcional)</label>
            <input id="gNotas" class="input" type="text"
                   placeholder="Ej: Mes de noviembre, proveedor de servicio, referencia, etc.">
          </div>
        </div>

        <button class="btn" id="btnGuardarGasto" style="margin-top: 0.75rem;">
          Guardar gasto y actualizar caja
        </button>
      </section>

      <!-- Historial de gastos -->
      <section class="card">
        <h2 class="card-title">2. Historial de gastos</h2>
        <p class="card-description">
          Los gastos m√°s recientes aparecen primero. Puedes filtrar por descripci√≥n, categor√≠a o notas.
        </p>

        <div class="form-grid" style="margin-bottom: 0.75rem;">
          <div class="form-field" style="grid-column: 1 / -1;">
            <label for="buscarGasto">Buscar gasto</label>
            <input id="buscarGasto" class="input" type="text"
                   placeholder="Escribe parte de la descripci√≥n, categor√≠a o notas">
          </div>
        </div>

        <table class="table">
          <thead>
            <tr>
              <th>Fecha</th>
              <th>Categor√≠a</th>
              <th>Descripci√≥n</th>
              <th>Forma de pago</th>
              <th>Monto</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="tabla-gastos-body">
            <tr>
              <td colspan="6" class="table-empty">
                A√∫n no hay gastos registrados.
              </td>
            </tr>
          </tbody>
        </table>
      </section>
    </main>
  </div>

  <!-- Scripts base -->
  <script src="alex-storage.js"></script>
  <script src="alex-roles.js"></script>

  <script>
    // ===== Men√∫ m√≥vil =====
    const btnMenuMobile = document.getElementById('btnMenuMobile');
    const sidebar = document.querySelector('.sidebar');
    if (btnMenuMobile) {
      btnMenuMobile.addEventListener('click', () => {
        sidebar.classList.toggle('sidebar-open');
      });
    }

    // ===== Usuario y permisos =====
    const usuarioActual = typeof getUsuarioActualObligatorio === "function"
      ? getUsuarioActualObligatorio()
      : null;

    if (typeof aplicarPermisosYProteger === "function") {
      aplicarPermisosYProteger("gastos");
    }

    const labelUser = document.getElementById("topbar-user-label");
    if (usuarioActual && labelUser) {
      const rolTexto = usuarioActual.rol === "dueno" ? "Due√±o" : "Empleado";
      labelUser.textContent = `${usuarioActual.nombre} (${rolTexto})`;
    }

    // ===== Helpers =====
    function alex3FormatearMonedaSeguro(valor) {
      if (typeof alex3FormatearMoneda === "function") {
        return alex3FormatearMoneda(valor);
      }
      const num = Number(valor);
      if (isNaN(num)) return "Q 0.00";
      return "Q " + num.toFixed(2);
    }

    function esMismoDia(a, b) {
      return a.getFullYear() === b.getFullYear() &&
             a.getMonth() === b.getMonth() &&
             a.getDate() === b.getDate();
    }

    function esMismoMes(a, b) {
      return a.getFullYear() === b.getFullYear() &&
             a.getMonth() === b.getMonth();
    }

    function formatearFechaLocal(fechaIso) {
      const d = new Date(fechaIso);
      if (isNaN(d.getTime())) return "-";
      return d.toLocaleString("es-GT");
    }

    // ===== Datos base: gastos y caja =====
    let gastos = [];
    let movimientosCaja = [];

    if (typeof load === "function") {
      const gData = load("gastos", []);
      gastos = Array.isArray(gData) ? gData : [];

      const m1 = load("caja_movimientos", []);
      const m2 = load("movimientosCaja", []);
      if (Array.isArray(m1) && m1.length > 0) {
        movimientosCaja = m1;
      } else if (Array.isArray(m2)) {
        movimientosCaja = m2;
      }
    }

    function guardarGastos() {
      if (typeof save === "function") {
        save("gastos", gastos);
      }
    }

    function guardarMovimientosCaja() {
      if (typeof save === "function") {
        save("caja_movimientos", movimientosCaja);
        save("movimientosCaja", movimientosCaja);
      }
    }

    // ===== Controles del DOM =====
    const inpFecha = document.getElementById("gFecha");
    const selCategoria = document.getElementById("gCategoria");
    const inpDescripcion = document.getElementById("gDescripcion");
    const inpMonto = document.getElementById("gMonto");
    const selFormaPago = document.getElementById("gFormaPago");
    const inpNotas = document.getElementById("gNotas");
    const btnGuardarGasto = document.getElementById("btnGuardarGasto");
    const tbodyGastos = document.getElementById("tabla-gastos-body");
    const inputBuscarGasto = document.getElementById("buscarGasto");

    // ===== KPIs de gastos =====
    function recalcularKPIsGastos() {
      const hoy = new Date();
      let totalHoy = 0;
      let totalMes = 0;

      gastos.forEach(g => {
        const fecha = new Date(g.fechaHora || g.fecha || Date.now());
        const monto = Number(g.monto) || 0;

        if (esMismoDia(fecha, hoy)) {
          totalHoy += monto;
        }
        if (esMismoMes(fecha, hoy)) {
          totalMes += monto;
        }
      });

      const cantidad = gastos.length;
      const promedio = cantidad > 0 ? totalMes / cantidad : 0;

      const elHoy = document.getElementById("kpi-gastos-hoy");
      const elMes = document.getElementById("kpi-gastos-mes");
      const elCant = document.getElementById("kpi-gastos-cantidad");
      const elProm = document.getElementById("kpi-gastos-promedio");

      if (elHoy) elHoy.textContent = alex3FormatearMonedaSeguro(totalHoy);
      if (elMes) elMes.textContent = alex3FormatearMonedaSeguro(totalMes);
      if (elCant) elCant.textContent = String(cantidad);
      if (elProm) elProm.textContent = alex3FormatearMonedaSeguro(promedio);
    }

    // ===== Render tabla de gastos =====
    function renderGastos() {
      if (!tbodyGastos) return;

      const filtro = (inputBuscarGasto && inputBuscarGasto.value.trim().toLowerCase()) || "";
      tbodyGastos.innerHTML = "";

      if (!gastos.length) {
        tbodyGastos.innerHTML = `
          <tr>
            <td colspan="6" class="table-empty">
              A√∫n no hay gastos registrados.
            </td>
          </tr>
        `;
        recalcularKPIsGastos();
        return;
      }

      const ordenados = [...gastos].sort((a, b) => {
        const fa = new Date(a.fechaHora || a.fecha || 0).getTime();
        const fb = new Date(b.fechaHora || b.fecha || 0).getTime();
        return fb - fa; // m√°s recientes primero
      });

      const filtrados = filtro
        ? ordenados.filter(g => {
            const txt = [
              g.descripcion || "",
              g.categoria || "",
              g.notas || ""
            ].join(" ").toLowerCase();
            return txt.includes(filtro);
          })
        : ordenados;

      if (!filtrados.length) {
        tbodyGastos.innerHTML = `
          <tr>
            <td colspan="6" class="table-empty">
              No se encontraron gastos con ese texto.
            </td>
          </tr>
        `;
        recalcularKPIsGastos();
        return;
      }

      filtrados.forEach((g, index) => {
        const fechaTxt = g.fecha || (g.fechaHora ? formatearFechaLocal(g.fechaHora) : "-");
        const categoriaTxt = g.categoria || "-";
        const descTxt = g.descripcion || "-";
        const formaPagoTxt = g.formaPago || "-";
        const montoTxt = alex3FormatearMonedaSeguro(g.monto);

        tbodyGastos.innerHTML += `
          <tr>
            <td>${fechaTxt}</td>
            <td>${categoriaTxt}</td>
            <td>${descTxt}</td>
            <td>${formaPagoTxt}</td>
            <td>${montoTxt}</td>
            <td>
              <button class="btn btn-small" data-delete-index="${index}">üóëÔ∏è</button>
            </td>
          </tr>
        `;
      });

      recalcularKPIsGastos();
    }

    // ===== Guardar gasto =====
    function guardarGasto() {
      let fechaObj;
      if (inpFecha && inpFecha.value) {
        fechaObj = new Date(inpFecha.value);
      } else {
        fechaObj = new Date();
      }
      if (isNaN(fechaObj.getTime())) fechaObj = new Date();

      const fechaLocal = fechaObj.toLocaleString("es-GT");
      const fechaIso = fechaObj.toISOString();

      const categoria = selCategoria ? selCategoria.value : "Otros";
      const descripcion = (inpDescripcion && inpDescripcion.value.trim()) || "";
      const monto = parseFloat(inpMonto && inpMonto.value);
      const formaPago = selFormaPago ? selFormaPago.value : "EFECTIVO";
      const notas = (inpNotas && inpNotas.value.trim()) || "";

      if (!descripcion) {
        alert("Escribe una descripci√≥n del gasto.");
        return;
      }

      if (isNaN(monto) || monto <= 0) {
        alert("Escribe un monto v√°lido mayor a 0.");
        return;
      }

      const gasto = {
        id: "gasto_" + Date.now(),
        fecha: fechaLocal,
        fechaHora: fechaIso,
        categoria,
        descripcion,
        monto,
        formaPago,
        notas,
        origen: "gasto",
        usuario: usuarioActual ? usuarioActual.usuario : null
      };

      gastos.push(gasto);
      guardarGastos();

      // Si es efectivo, registrar EGRESO en caja
      if (formaPago === "EFECTIVO") {
        const mov = {
          id: "caja_gasto_" + Date.now(),
          fecha: fechaLocal,
          fechaHora: fechaIso,
          tipo: "EGRESO",
          categoria: "Gastos",
          descripcion: `${categoria} - ${descripcion}`,
          monto: monto,
          origen: "gasto",
          gastoId: gasto.id,
          usuario: usuarioActual ? usuarioActual.usuario : null
        };
        movimientosCaja.push(mov);
        guardarMovimientosCaja();
      }

      // Limpiar formulario (dejo fecha igual)
      if (selCategoria) selCategoria.value = "Servicios b√°sicos";
      if (inpDescripcion) inpDescripcion.value = "";
      if (inpMonto) inpMonto.value = "";
      if (selFormaPago) selFormaPago.value = "EFECTIVO";
      if (inpNotas) inpNotas.value = "";
      if (inpDescripcion) inpDescripcion.focus();

      renderGastos();
      alert("Gasto registrado correctamente.");
    }

    if (btnGuardarGasto) {
      btnGuardarGasto.addEventListener("click", guardarGasto);
    }

    // Enter en monto ‚Üí guardar
    if (inpMonto) {
      inpMonto.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          guardarGasto();
        }
      });
    }

    // Buscar gastos
    if (inputBuscarGasto) {
      inputBuscarGasto.addEventListener("input", () => {
        renderGastos();
      });
    }

    // Eliminar gasto (no ajusta caja para no complicar la contabilidad todav√≠a)
    if (tbodyGastos) {
      tbodyGastos.addEventListener("click", (e) => {
        const btn = e.target.closest("button[data-delete-index]");
        if (!btn) return;
        const idx = parseInt(btn.getAttribute("data-delete-index"));
        if (isNaN(idx)) return;

        if (!confirm("¬øSeguro que quieres eliminar este gasto? (no ajustar√° caja autom√°ticamente)")) return;
        gastos.splice(idx, 1);
        guardarGastos();
        renderGastos();
      });
    }

    // ===== Primera carga =====
    // Prellenar fecha con ahora
    if (inpFecha) {
      const ahora = new Date();
      const isoLocal = new Date(ahora.getTime() - ahora.getTimezoneOffset() * 60000)
        .toISOString()
        .slice(0, 16);
      inpFecha.value = isoLocal;
    }

    renderGastos();
  </script>
</body>
</html>
