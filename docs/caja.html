<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>ALEX 3.0 - Caja</title>
  <link rel="stylesheet" href="styles.css">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>

<body class="dashboard-body">
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <span class="logo-badge">A</span>
      <div class="sidebar-logo-text">
        <span class="sidebar-logo-main">ALEX 3.0</span>
        <span class="sidebar-logo-sub">Panel del negocio</span>
      </div>
    </div>

    <nav class="sidebar-nav">
      <a href="dashboard.html" class="sidebar-link">üìä Dashboard</a>
      <a href="ventas.html" class="sidebar-link">üíµ Ventas</a>
      <a href="inventario.html" class="sidebar-link">üì¶ Inventario</a>
      <a href="caja.html" class="sidebar-link active">üí∞ Caja</a>
      <a href="compras.html" class="sidebar-link">üßæ Compras</a>
      <a href="gastos.html" class="sidebar-link">üìâ Gastos</a>
      <a href="clientes.html" class="sidebar-link">üë• Clientes</a>
      <a href="proveedores.html" class="sidebar-link">üöö Proveedores</a>
      <a href="contabilidad.html" class="sidebar-link">üìö Contabilidad</a>
      <a href="sat.html" class="sidebar-link">üá¨üáπ SAT Guatemala</a>
      <a href="ia.html" class="sidebar-link">ü§ñ IA empresarial</a>
      <a href="configuracion.html" class="sidebar-link">‚öôÔ∏è Configuraci√≥n</a>
    </nav>

    <div class="sidebar-footer">
      <span class="sidebar-footer-title">Empresa demo</span>
      <span class="sidebar-footer-sub">Versi√≥n 1.0</span>
    </div>
  </aside>

  <!-- Layout principal -->
  <div class="main-layout">
    <!-- Topbar -->
    <header class="topbar">
      <button class="btn-menu-mobile" id="btnMenuMobile">‚ò∞</button>

      <div class="topbar-left">
        <h1 class="topbar-title">Caja</h1>
        <p class="topbar-subtitle">Control de entradas y salidas de efectivo.</p>
      </div>

      <div class="topbar-right">
        <span class="topbar-company">Mi tienda demo</span>
        <span class="topbar-divider">‚Ä¢</span>
        <span class="topbar-user">Brayan (Due√±o)</span>
      </div>
    </header>

    <!-- Contenido principal -->
    <main class="main-content">
      <section class="cards-grid">
        <article class="card kpi-card">
          <h2 class="card-title">Saldo en caja</h2>
          <p class="card-kpi" id="kpi-caja-saldo">Q 0.00</p>
          <p class="card-kpi-sub">Saldo calculado con los movimientos registrados y ventas del d√≠a.</p>
        </article>

        <article class="card kpi-card">
          <h2 class="card-title">Ingresos de hoy</h2>
          <p class="card-kpi" id="kpi-caja-ingresos-hoy">Q 0.00</p>
          <p class="card-kpi-sub">Entradas directas a caja + ventas de hoy.</p>
        </article>

        <article class="card kpi-card">
          <h2 class="card-title">Egresos de hoy</h2>
          <p class="card-kpi gasto" id="kpi-caja-egresos-hoy">Q 0.00</p>
          <p class="card-kpi-sub">Salidas por gastos, compras u otros.</p>
        </article>

        <article class="card kpi-card">
          <h2 class="card-title">Cortes realizados</h2>
          <p class="card-kpi" id="kpi-caja-cortes">0</p>
          <p class="card-kpi-sub">N√∫mero de cortes de caja registrados.</p>
        </article>
      </section>

      <section class="card">
        <h2 class="card-title">Movimientos de caja</h2>
        <p class="card-description">
          Registra ingresos y egresos de caja. En la versi√≥n completa se puede integrar con cortes, arqueos y SAT.
        </p>

        <!-- Formulario de movimiento -->
        <div class="form-grid">
          <div class="form-field">
            <label for="mov-tipo">Tipo de movimiento</label>
            <select id="mov-tipo" class="input">
              <option value="INGRESO">Ingreso</option>
              <option value="EGRESO">Egreso</option>
            </select>
          </div>

          <div class="form-field">
            <label for="mov-descripcion">Descripci√≥n</label>
            <input id="mov-descripcion" type="text" class="input" placeholder="Ej: Venta en efectivo, pago de luz, etc.">
          </div>

          <div class="form-field">
            <label for="mov-monto">Monto (Q)</label>
            <input id="mov-monto" type="number" class="input" placeholder="0.00" step="0.01" min="0">
          </div>
        </div>

        <button class="btn" id="btn-registrar-movimiento">Guardar movimiento</button>

        <!-- Tabla de movimientos -->
        <table class="table" style="margin-top: 1.5rem;">
          <thead>
            <tr>
              <th>Fecha</th>
              <th>Tipo</th>
              <th>Descripci√≥n</th>
              <th>Monto</th>
            </tr>
          </thead>
          <tbody id="tabla-movimientos-body">
            <tr>
              <td colspan="4" class="table-empty">
                A√∫n no hay movimientos registrados.
              </td>
            </tr>
          </tbody>
        </table>
      </section>
    </main>
  </div>

  <!-- Scripts base -->
  <script src="alex-storage.js"></script>
  <script src="alex-roles.js"></script>

  <script>
    // Men√∫ m√≥vil
    const btnMenuMobile = document.getElementById('btnMenuMobile');
    const sidebar = document.querySelector('.sidebar');

    if (btnMenuMobile) {
      btnMenuMobile.addEventListener('click', () => {
        sidebar.classList.toggle('sidebar-open');
      });
    }

    // Usuario y permisos
    const usuarioActual = typeof getUsuarioActualObligatorio === "function"
      ? getUsuarioActualObligatorio()
      : null;

    if (typeof aplicarPermisosYProteger === "function") {
      aplicarPermisosYProteger("caja");
    }

    // Cargar datos desde almacenamiento
    let movimientos = [];
    let cortes = [];
    let ventas = [];

    if (typeof load === "function") {
      const movData = load("caja_movimientos", []);
      movimientos = Array.isArray(movData) ? movData : [];

      const cortesData = load("caja_cortes", []);
      cortes = Array.isArray(cortesData) ? cortesData : [];

      const ventasData = load("ventas", []);
      ventas = Array.isArray(ventasData) ? ventasData : [];
    }

    // Formateadores
    function alex3FormatearMonedaSeguro(valor) {
      if (typeof alex3FormatearMoneda === "function") {
        return alex3FormatearMoneda(valor);
      }
      const num = Number(valor);
      if (isNaN(num)) return "Q 0.00";
      return "Q " + num.toFixed(2);
    }

    function formatearFechaBonita(fechaIso) {
      const d = new Date(fechaIso);
      if (isNaN(d.getTime())) return "-";
      const dia = String(d.getDate()).padStart(2, "0");
      const mes = String(d.getMonth() + 1).padStart(2, "0");
      const anio = d.getFullYear();
      const horas = String(d.getHours()).padStart(2, "0");
      const mins = String(d.getMinutes()).padStart(2, "0");
      return `${dia}/${mes}/${anio} ${horas}:${mins}`;
    }

    function mismaFecha(d1, d2) {
      return (
        d1.getFullYear() === d2.getFullYear() &&
        d1.getMonth() === d2.getMonth() &&
        d1.getDate() === d2.getDate()
      );
    }

    // Guardar en storage
    function guardarMovimientos() {
      if (typeof save === "function") {
        save("caja_movimientos", movimientos);
      }
    }

    function guardarCortes() {
      if (typeof save === "function") {
        save("caja_cortes", cortes);
      }
    }

    // KPIs
    function actualizarKPIsCaja() {
      const hoy = new Date();

      let ingresosHoy = 0;
      let egresosHoy = 0;
      let ingresosTotales = 0;
      let egresosTotales = 0;

      // Movimientos manuales
      movimientos.forEach(m => {
        const fecha = new Date(m.fecha || m.fechaHora || Date.now());
        const monto = Number(m.monto) || 0;

        if (m.tipo === "INGRESO") {
          ingresosTotales += monto;
          if (mismaFecha(fecha, hoy)) ingresosHoy += monto;
        } else if (m.tipo === "EGRESO") {
          egresosTotales += monto;
          if (mismaFecha(fecha, hoy)) egresosHoy += monto;
        }
      });

      // Ventas del d√≠a (se asumen como ingreso a caja)
      let ventasHoy = 0;
      ventas.forEach(v => {
        const fecha = new Date(v.fecha || v.fechaHora || Date.now());
        const total = Number(v.total) || 0;
        if (mismaFecha(fecha, hoy)) ventasHoy += total;
      });

      const saldo = ingresosTotales - egresosTotales + ventasHoy;

      const kpiSaldo = document.getElementById("kpi-caja-saldo");
      const kpiIngresosHoy = document.getElementById("kpi-caja-ingresos-hoy");
      const kpiEgresosHoy = document.getElementById("kpi-caja-egresos-hoy");
      const kpiCortes = document.getElementById("kpi-caja-cortes");

      if (kpiSaldo) kpiSaldo.textContent = alex3FormatearMonedaSeguro(saldo);
      if (kpiIngresosHoy) kpiIngresosHoy.textContent = alex3FormatearMonedaSeguro(ingresosHoy + ventasHoy);
      if (kpiEgresosHoy) kpiEgresosHoy.textContent = alex3FormatearMonedaSeguro(egresosHoy);
      if (kpiCortes) kpiCortes.textContent = String(cortes.length || 0);
    }

    // Render tabla movimientos
    function renderTablaMovimientos() {
      const tbody = document.getElementById("tabla-movimientos-body");
      if (!tbody) return;

      tbody.innerHTML = "";

      if (!movimientos.length) {
        tbody.innerHTML = `
          <tr>
            <td colspan="4" class="table-empty">
              A√∫n no hay movimientos registrados.
            </td>
          </tr>
        `;
        return;
      }

      const ordenados = [...movimientos].sort((a, b) => {
        const fa = new Date(a.fecha || a.fechaHora || 0).getTime();
        const fb = new Date(b.fecha || b.fechaHora || 0).getTime();
        return fb - fa; // M√°s recientes primero
      });

      ordenados.forEach(m => {
        const fecha = formatearFechaBonita(m.fecha || m.fechaHora || new Date().toISOString());
        const tipo = m.tipo === "EGRESO" ? "Egreso" : "Ingreso";
        const desc = m.descripcion || "-";
        const montoFmt = alex3FormatearMonedaSeguro(m.monto);

        const fila = `
          <tr>
            <td>${fecha}</td>
            <td>${tipo}</td>
            <td>${desc}</td>
            <td>${montoFmt}</td>
          </tr>
        `;
        tbody.innerHTML += fila;
      });
    }

    // Registrar movimiento
    function registrarMovimientoCaja() {
      const selectTipo = document.getElementById("mov-tipo");
      const inputDesc = document.getElementById("mov-descripcion");
      const inputMonto = document.getElementById("mov-monto");

      const tipo = selectTipo ? selectTipo.value : "INGRESO";
      const descripcion = inputDesc ? inputDesc.value.trim() : "";
      const montoNum = parseFloat(inputMonto ? inputMonto.value : "0");

      if (!descripcion) {
        alert("Agrega una descripci√≥n para el movimiento.");
        return;
      }

      if (isNaN(montoNum) || montoNum <= 0) {
        alert("Ingresa un monto v√°lido.");
        return;
      }

      const ahora = new Date();
      const mov = {
        fecha: ahora.toISOString(),
        tipo,
        descripcion,
        monto: montoNum
      };

      movimientos.push(mov);
      guardarMovimientos();
      renderTablaMovimientos();
      actualizarKPIsCaja();

      if (inputDesc) inputDesc.value = "";
      if (inputMonto) inputMonto.value = "";
    }

    // Eventos
    const btnRegistrarMovimiento = document.getElementById("btn-registrar-movimiento");
    if (btnRegistrarMovimiento) {
      btnRegistrarMovimiento.addEventListener("click", registrarMovimientoCaja);
    }

    // Primera carga
    renderTablaMovimientos();
    actualizarKPIsCaja();
  </script>
</body>
</html>
