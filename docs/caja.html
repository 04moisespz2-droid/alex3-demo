<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>ALEX 3.0 - Caja</title>
  <link rel="stylesheet" href="styles.css">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>

<body class="dashboard-body">
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <span class="logo-badge">A</span>
      <div class="sidebar-logo-text">
        <span class="sidebar-logo-main">ALEX 3.0</span>
        <span class="sidebar-logo-sub">Panel del negocio</span>
      </div>
    </div>

    <nav class="sidebar-nav">
      <a href="dashboard.html" class="sidebar-link">üìä Dashboard</a>
      <a href="ventas.html" class="sidebar-link">üíµ Ventas</a>
      <a href="inventario.html" class="sidebar-link">üì¶ Inventario</a>
      <a href="caja.html" class="sidebar-link active">üí∞ Caja</a>
      <a href="compras.html" class="sidebar-link">üßæ Compras</a>
      <a href="gastos.html" class="sidebar-link">üìâ Gastos</a>
      <a href="clientes.html" class="sidebar-link">üë• Clientes</a>
      <a href="proveedores.html" class="sidebar-link">üöö Proveedores</a>
      <a href="reportes.html" class="sidebar-link">üìö Reportes</a>
      <a href="ia.html" class="sidebar-link">ü§ñ IA empresarial</a>
      <a href="configuracion.html" class="sidebar-link">‚öôÔ∏è Configuraci√≥n</a>
    </nav>

    <div class="sidebar-footer">
      <span class="sidebar-footer-title" id="sidebar-footer-title">Mi negocio</span>
      <span class="sidebar-footer-sub">M√≥dulo de caja</span>
    </div>
  </aside>

  <!-- Layout principal -->
  <div class="main-layout">
    <!-- Topbar -->
    <header class="topbar">
      <button class="btn-menu-mobile" id="btnMenuMobile">‚ò∞</button>

      <div class="topbar-left">
        <h1 class="topbar-title">Caja</h1>
        <p class="topbar-subtitle">
          Control de ingresos y egresos en efectivo. ALEX suma autom√°ticamente las ventas en efectivo y mixtas.
        </p>
      </div>

      <div class="topbar-right">
        <span class="topbar-company" id="topbar-company-label">Mi negocio</span>
        <span class="topbar-divider">‚Ä¢</span>
        <span class="topbar-user" id="topbar-user-label">Usuario (Rol)</span>
      </div>
    </header>

    <!-- Contenido principal -->
    <main class="main-content">
      <!-- KPIs -->
      <section class="cards-grid">
        <article class="card kpi-card">
          <h2 class="card-title">Saldo actual en caja</h2>
          <p class="card-kpi" id="kpi-saldo-actual">Q 0.00</p>
          <p class="card-kpi-sub">Ingresos - egresos (toda la historia).</p>
        </article>

        <article class="card kpi-card">
          <h2 class="card-title">Ingresos de hoy</h2>
          <p class="card-kpi" id="kpi-ingresos-hoy">Q 0.00</p>
          <p class="card-kpi-sub">Ventas en efectivo y otros ingresos de hoy.</p>
        </article>

        <article class="card kpi-card">
          <h2 class="card-title">Egresos de hoy</h2>
          <p class="card-kpi" id="kpi-egresos-hoy">Q 0.00</p>
          <p class="card-kpi-sub">Gastos, retiros y salidas de efectivo de hoy.</p>
        </article>

        <article class="card kpi-card">
          <h2 class="card-title">Saldo al cierre de hoy</h2>
          <p class="card-kpi" id="kpi-saldo-hoy">Q 0.00</p>
          <p class="card-kpi-sub">Saldo actual tomando solo movimientos de hoy.</p>
        </article>
      </section>

      <!-- Registrar movimiento manual -->
      <section class="card">
        <h2 class="card-title">1. Registrar movimiento manual en caja</h2>
        <p class="card-description">
          Usa esto para registrar **ingresos o egresos en efectivo** que no vienen de una venta,
          por ejemplo: retiros de caja, pagos en efectivo, ingresos extra, etc.
        </p>

        <div class="form-grid">
          <div class="form-field">
            <label for="cFecha">Fecha y hora</label>
            <input id="cFecha" class="input" type="datetime-local">
          </div>

          <div class="form-field">
            <label for="cTipo">Tipo de movimiento</label>
            <select id="cTipo" class="input">
              <option value="INGRESO">INGRESO</option>
              <option value="EGRESO">EGRESO</option>
            </select>
          </div>

          <div class="form-field">
            <label for="cCategoria">Categor√≠a</label>
            <select id="cCategoria" class="input">
              <option value="Ventas">Ventas</option>
              <option value="Retiros due√±o">Retiros due√±o</option>
              <option value="Gastos del d√≠a">Gastos del d√≠a</option>
              <option value="Pago proveedores">Pago a proveedores</option>
              <option value="Otros ingresos">Otros ingresos</option>
              <option value="Otros egresos">Otros egresos</option>
            </select>
          </div>

          <div class="form-field">
            <label for="cDescripcion">Descripci√≥n</label>
            <input id="cDescripcion" class="input" type="text"
                   placeholder="Ej: retiro personal, pago de luz, abono proveedor, etc.">
          </div>

          <div class="form-field">
            <label for="cMonto">Monto (Q)</label>
            <input id="cMonto" class="input" type="number" min="0" step="0.01">
          </div>
        </div>

        <button class="btn" id="btnGuardarMovimiento" style="margin-top:0.75rem;">
          Guardar movimiento en caja
        </button>
      </section>

      <!-- Historial de caja -->
      <section class="card">
        <h2 class="card-title">2. Historial de movimientos de caja</h2>
        <p class="card-description">
          ALEX mezcla aqu√≠ las ventas en efectivo/mixto con los movimientos manuales de caja.
          Usa los filtros para ver solo lo que necesites.
        </p>

        <div class="form-grid" style="margin-bottom:0.75rem;">
          <div class="form-field">
            <label for="filtroFecha">Filtro r√°pido</label>
            <select id="filtroFecha" class="input">
              <option value="hoy">Hoy</option>
              <option value="mes">Este mes</option>
              <option value="todos">Todos los movimientos</option>
            </select>
          </div>

          <div class="form-field">
            <label for="filtroTipo">Tipo</label>
            <select id="filtroTipo" class="input">
              <option value="todos">Todos</option>
              <option value="INGRESO">Ingresos</option>
              <option value="EGRESO">Egresos</option>
            </select>
          </div>

          <div class="form-field" style="grid-column:1 / -1;">
            <label for="buscarCaja">Buscar</label>
            <input id="buscarCaja" class="input" type="text"
                   placeholder="Filtra por categor√≠a, descripci√≥n o usuario">
          </div>
        </div>

        <table class="table">
          <thead>
            <tr>
              <th>Fecha</th>
              <th>Tipo</th>
              <th>Categor√≠a</th>
              <th>Descripci√≥n</th>
              <th>Monto</th>
              <th>Origen</th>
              <th>Usuario</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="tabla-caja-body">
            <tr>
              <td colspan="8" class="table-empty">
                A√∫n no hay movimientos en caja.
              </td>
            </tr>
          </tbody>
        </table>
      </section>
    </main>
  </div>

  <!-- Scripts base -->
  <script src="alex-storage.js"></script>
  <script src="alex-roles.js"></script>

  <script>
    // ===== Men√∫ m√≥vil =====
    const btnMenuMobile = document.getElementById('btnMenuMobile');
    const sidebar = document.querySelector('.sidebar');
    if (btnMenuMobile) {
      btnMenuMobile.addEventListener('click', () => {
        sidebar.classList.toggle('sidebar-open');
      });
    }

    // ===== Usuario y permisos =====
    const usuarioActual = typeof getUsuarioActualObligatorio === "function"
      ? getUsuarioActualObligatorio()
      : null;

    if (typeof aplicarPermisosYProteger === "function") {
      aplicarPermisosYProteger("caja");
    }

    const labelUser = document.getElementById("topbar-user-label");
    const labelCompany = document.getElementById("topbar-company-label");
    const sidebarFooterTitle = document.getElementById("sidebar-footer-title");

    // Config negocio (nombre)
    let negocioConfig = {
      nombre: "Mi negocio"
    };
    if (typeof load === "function") {
      const cfg = load("negocio_config", null);
      if (cfg && typeof cfg === "object") {
        negocioConfig = Object.assign(negocioConfig, cfg);
      }
    }
    if (labelCompany) labelCompany.textContent = negocioConfig.nombre || "Mi negocio";
    if (sidebarFooterTitle) sidebarFooterTitle.textContent = negocioConfig.nombre || "Mi negocio";

    if (usuarioActual && labelUser) {
      const rolTexto = usuarioActual.rol === "dueno" ? "Due√±o" : "Empleado";
      labelUser.textContent = `${usuarioActual.nombre} (${rolTexto})`;
    }

    // ===== Helpers =====
    function alex3FormatearMonedaSeguro(valor) {
      if (typeof alex3FormatearMoneda === "function") {
        return alex3FormatearMoneda(valor);
      }
      const num = Number(valor);
      if (isNaN(num)) return "Q 0.00";
      return "Q " + num.toFixed(2);
    }

    function esMismoDia(a, b) {
      return a.getFullYear() === b.getFullYear() &&
             a.getMonth() === b.getMonth() &&
             a.getDate() === b.getDate();
    }

    function esMismoMes(a, b) {
      return a.getFullYear() === b.getFullYear() &&
             a.getMonth() === b.getMonth();
    }

    function formatearFechaLocal(fechaIso) {
      const d = new Date(fechaIso);
      if (isNaN(d.getTime())) return "-";
      return d.toLocaleString("es-GT");
    }

    // ===== Datos de caja =====
    let movimientosCaja = [];

    if (typeof load === "function") {
      const m1 = load("caja_movimientos", []);
      const m2 = load("movimientosCaja", []);
      if (Array.isArray(m1) && m1.length > 0) {
        movimientosCaja = m1;
      } else if (Array.isArray(m2) && m2.length > 0) {
        movimientosCaja = m2;
      }
    }

    function guardarMovimientosCaja() {
      if (typeof save === "function") {
        save("caja_movimientos", movimientosCaja);
        save("movimientosCaja", movimientosCaja);
      }
    }

    // ===== Controles del DOM =====
    const inpFecha = document.getElementById("cFecha");
    const selTipo = document.getElementById("cTipo");
    const selCategoria = document.getElementById("cCategoria");
    const inpDescripcion = document.getElementById("cDescripcion");
    const inpMonto = document.getElementById("cMonto");
    const btnGuardarMovimiento = document.getElementById("btnGuardarMovimiento");

    const kpiSaldoActual = document.getElementById("kpi-saldo-actual");
    const kpiIngresosHoy = document.getElementById("kpi-ingresos-hoy");
    const kpiEgresosHoy = document.getElementById("kpi-egresos-hoy");
    const kpiSaldoHoy = document.getElementById("kpi-saldo-hoy");

    const filtroFecha = document.getElementById("filtroFecha");
    const filtroTipo = document.getElementById("filtroTipo");
    const buscarCaja = document.getElementById("buscarCaja");
    const tbodyCaja = document.getElementById("tabla-caja-body");

    // ===== KPIs =====
    function recalcularKPIs() {
      const hoy = new Date();
      let saldoActual = 0;
      let ingresosHoy = 0;
      let egresosHoy = 0;

      movimientosCaja.forEach(mov => {
        const monto = Number(mov.monto) || 0;
        const tipo = mov.tipo || "INGRESO";
        const fecha = new Date(mov.fechaHora || mov.fecha || Date.now());

        if (tipo === "INGRESO") {
          saldoActual += monto;
          if (esMismoDia(fecha, hoy)) {
            ingresosHoy += monto;
          }
        } else if (tipo === "EGRESO") {
          saldoActual -= monto;
          if (esMismoDia(fecha, hoy)) {
            egresosHoy += monto;
          }
        }
      });

      const saldoHoy = ingresosHoy - egresosHoy;

      if (kpiSaldoActual) kpiSaldoActual.textContent = alex3FormatearMonedaSeguro(saldoActual);
      if (kpiIngresosHoy) kpiIngresosHoy.textContent = alex3FormatearMonedaSeguro(ingresosHoy);
      if (kpiEgresosHoy) kpiEgresosHoy.textContent = alex3FormatearMonedaSeguro(egresosHoy);
      if (kpiSaldoHoy) kpiSaldoHoy.textContent = alex3FormatearMonedaSeguro(saldoHoy);
    }

    // ===== Render tabla de movimientos =====
    function renderMovimientos() {
      if (!tbodyCaja) return;

      const filtroFechaVal = filtroFecha ? filtroFecha.value : "hoy";
      const filtroTipoVal = filtroTipo ? filtroTipo.value : "todos";
      const textoBuscar = buscarCaja ? buscarCaja.value.trim().toLowerCase() : "";

      tbodyCaja.innerHTML = "";

      if (!movimientosCaja.length) {
        tbodyCaja.innerHTML = `
          <tr>
            <td colspan="8" class="table-empty">
              A√∫n no hay movimientos en caja.
            </td>
          </tr>
        `;
        recalcularKPIs();
        return;
      }

      const hoy = new Date();
      const mesActual = hoy.getMonth();
      const anioActual = hoy.getFullYear();

      const filtrados = movimientosCaja.filter(mov => {
        const fecha = new Date(mov.fechaHora || mov.fecha || Date.now());
        const tipo = mov.tipo || "INGRESO";
        let pasaFecha = true;

        if (filtroFechaVal === "hoy") {
          pasaFecha = esMismoDia(fecha, hoy);
        } else if (filtroFechaVal === "mes") {
          pasaFecha = (fecha.getFullYear() === anioActual && fecha.getMonth() === mesActual);
        }

        let pasaTipo = (filtroTipoVal === "todos") || (tipo === filtroTipoVal);
        let pasaTexto = true;

        if (textoBuscar) {
          const txt = [
            mov.categoria || "",
            mov.descripcion || "",
            mov.usuario || "",
            mov.origen || ""
          ].join(" ").toLowerCase();
          pasaTexto = txt.includes(textoBuscar);
        }

        return pasaFecha && pasaTipo && pasaTexto;
      });

      if (!filtrados.length) {
        tbodyCaja.innerHTML = `
          <tr>
            <td colspan="8" class="table-empty">
              No se encontraron movimientos con esos filtros.
            </td>
          </tr>
        `;
        recalcularKPIs();
        return;
      }

      // Ordenar por fecha m√°s reciente
      filtrados.sort((a, b) => {
        const fa = new Date(a.fechaHora || a.fecha || 0).getTime();
        const fb = new Date(b.fechaHora || b.fecha || 0).getTime();
        return fb - fa;
      });

      filtrados.forEach((mov, index) => {
        const fechaTxt = mov.fecha || (mov.fechaHora ? formatearFechaLocal(mov.fechaHora) : "-");
        const tipoTxt = mov.tipo || "-";
        const catTxt = mov.categoria || "-";
        const descTxt = mov.descripcion || "-";
        const montoTxt = alex3FormatearMonedaSeguro(mov.monto || 0);
        const origenTxt = mov.origen || "-";
        const usuarioTxt = mov.usuario || "-";

        tbodyCaja.innerHTML += `
          <tr>
            <td>${fechaTxt}</td>
            <td>${tipoTxt}</td>
            <td>${catTxt}</td>
            <td>${descTxt}</td>
            <td>${montoTxt}</td>
            <td>${origenTxt}</td>
            <td>${usuarioTxt}</td>
            <td>
              <button class="btn btn-small" data-delete-id="${mov.id || ''}">üóëÔ∏è</button>
            </td>
          </tr>
        `;
      });

      recalcularKPIs();
    }

    // ===== Guardar movimiento manual =====
    function guardarMovimientoManual() {
      let fechaObj;
      if (inpFecha && inpFecha.value) {
        fechaObj = new Date(inpFecha.value);
      } else {
        fechaObj = new Date();
      }
      if (isNaN(fechaObj.getTime())) fechaObj = new Date();

      const fechaLocal = fechaObj.toLocaleString("es-GT");
      const fechaIso = fechaObj.toISOString();

      const tipo = selTipo ? selTipo.value : "INGRESO";
      const categoria = selCategoria ? selCategoria.value : "Otros ingresos";
      const descripcion = inpDescripcion ? inpDescripcion.value.trim() : "";
      const monto = parseFloat(inpMonto && inpMonto.value ? inpMonto.value : "0");

      if (isNaN(monto) || monto <= 0) {
        alert("Escribe un monto v√°lido mayor a 0.");
        return;
      }

      const mov = {
        id: "caja_manual_" + Date.now(),
        fecha: fechaLocal,
        fechaHora: fechaIso,
        tipo,
        categoria,
        descripcion,
        monto,
        origen: "manual",
        usuario: usuarioActual ? usuarioActual.usuario : null
      };

      movimientosCaja.push(mov);
      guardarMovimientosCaja();

      // Limpiar formulario
      if (inpDescripcion) inpDescripcion.value = "";
      if (inpMonto) inpMonto.value = "";
      if (selTipo) selTipo.value = "INGRESO";
      if (selCategoria) selCategoria.value = "Otros ingresos";

      renderMovimientos();
      alert("Movimiento registrado en caja.");
    }

    if (btnGuardarMovimiento) {
      btnGuardarMovimiento.addEventListener("click", guardarMovimientoManual);
    }

    // Enter en monto -> guardar movimiento
    if (inpMonto) {
      inpMonto.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          guardarMovimientoManual();
        }
      });
    }

    // Filtros
    if (filtroFecha) {
      filtroFecha.addEventListener("change", renderMovimientos);
    }
    if (filtroTipo) {
      filtroTipo.addEventListener("change", renderMovimientos);
    }
    if (buscarCaja) {
      buscarCaja.addEventListener("input", renderMovimientos);
    }

    // Eliminar movimiento
    if (tbodyCaja) {
      tbodyCaja.addEventListener("click", (e) => {
        const btn = e.target.closest("button[data-delete-id]");
        if (!btn) return;
        const id = btn.getAttribute("data-delete-id");
        if (!id) return;

        if (!confirm("¬øSeguro que quieres eliminar este movimiento de caja?")) return;

        const idx = movimientosCaja.findIndex(m => (m.id || "") === id);
        if (idx >= 0) {
          movimientosCaja.splice(idx, 1);
          guardarMovimientosCaja();
          renderMovimientos();
        }
      });
    }

    // ===== Primera carga =====
    if (inpFecha) {
      const ahora = new Date();
      const isoLocal = new Date(ahora.getTime() - ahora.getTimezoneOffset() * 60000)
        .toISOString()
        .slice(0, 16);
      inpFecha.value = isoLocal;
    }

    renderMovimientos();
  </script>
</body>
</html>
