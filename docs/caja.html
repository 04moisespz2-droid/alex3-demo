<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>ALEX 3.0 - Caja</title>
  <link rel="stylesheet" href="styles.css">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>

<body class="dashboard-body">
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <span class="logo-badge">A</span>
      <div class="sidebar-logo-text">
        <span class="sidebar-logo-main">ALEX 3.0</span>
        <span class="sidebar-logo-sub">Panel del negocio</span>
      </div>
    </div>

    <nav class="sidebar-nav">
      <a href="dashboard.html" class="sidebar-link">üìä Dashboard</a>
      <a href="ventas.html" class="sidebar-link">üíµ Ventas</a>
      <a href="inventario.html" class="sidebar-link">üì¶ Inventario</a>
      <a href="caja.html" class="sidebar-link active">üí∞ Caja</a>
      <a href="compras.html" class="sidebar-link">üßæ Compras</a>
      <a href="gastos.html" class="sidebar-link">üìâ Gastos</a>
      <a href="clientes.html" class="sidebar-link">üë• Clientes</a>
      <a href="proveedores.html" class="sidebar-link">üöö Proveedores</a>
      <a href="contabilidad.html" class="sidebar-link">üìö Contabilidad</a>
      <a href="sat.html" class="sidebar-link">üá¨üáπ SAT Guatemala</a>
      <a href="ia.html" class="sidebar-link">ü§ñ IA empresarial</a>
      <a href="configuracion.html" class="sidebar-link">‚öôÔ∏è Configuraci√≥n</a>
    </nav>

    <div class="sidebar-footer">
      <span class="sidebar-footer-title">Empresa demo</span>
      <span class="sidebar-footer-sub">Versi√≥n 1.0</span>
    </div>
  </aside>

  <!-- Layout principal -->
  <div class="main-layout">
    <!-- Topbar -->
    <header class="topbar">
      <button class="btn-menu-mobile" id="btnMenuMobile">‚ò∞</button>

      <div class="topbar-left">
        <h1 class="topbar-title">Caja</h1>
        <p class="topbar-subtitle">Control de entradas y salidas de efectivo.</p>
      </div>

      <div class="topbar-right">
        <span class="topbar-company">Mi tienda demo</span>
        <span class="topbar-divider">‚Ä¢</span>
        <span class="topbar-user" id="topbar-user-label">Usuario (Rol)</span>
        <button class="btn" id="btnLogout" type="button" style="margin-left: 0.75rem;">
          Cerrar sesi√≥n
        </button>
      </div>
    </header>

    <!-- Contenido principal -->
    <main class="main-content">
      <!-- Resumen de caja -->
      <section class="cards-grid">
        <article class="card kpi-card">
          <h2 class="card-title">Saldo en caja</h2>
          <p class="card-kpi" id="kpi-caja-saldo">Q 0.00</p>
          <p class="card-kpi-sub">Saldo estimado seg√∫n movimientos registrados.</p>
        </article>

        <article class="card kpi-card">
          <h2 class="card-title">Ingresos de hoy</h2>
          <p class="card-kpi" id="kpi-caja-ingresos-hoy">Q 0.00</p>
          <p class="card-kpi-sub">Entradas directas a caja.</p>
        </article>

        <article class="card kpi-card">
          <h2 class="card-title">Egresos de hoy</h2>
          <p class="card-kpi gasto" id="kpi-caja-egresos-hoy">Q 0.00</p>
          <p class="card-kpi-sub">Salidas por gastos, compras u otros.</p>
        </article>

        <article class="card kpi-card">
          <h2 class="card-title">Cortes realizados</h2>
          <p class="card-kpi" id="kpi-caja-cortes">0</p>
          <p class="card-kpi-sub">N√∫mero de cierres de caja registrados.</p>
        </article>
      </section>

      <!-- Formulario de movimientos -->
      <section class="card">
        <h2 class="card-title">Registrar movimiento de caja</h2>
        <p class="card-description">
          Usa este formulario para registrar entradas (INGRESO) y salidas (EGRESO) de efectivo de la caja.
        </p>

        <div class="form-grid">
          <div class="form-field">
            <label for="movTipo">Tipo de movimiento</label>
            <select id="movTipo" class="input">
              <option value="INGRESO">INGRESO</option>
              <option value="EGRESO">EGRESO</option>
            </select>
          </div>

          <div class="form-field">
            <label for="movCategoria">Categor√≠a</label>
            <select id="movCategoria" class="input">
              <option value="">Selecciona una categor√≠a</option>
              <option value="Ventas en efectivo">Ventas en efectivo</option>
              <option value="Abono de fiado">Abono de fiado</option>
              <option value="Aporte del due√±o">Aporte del due√±o</option>
              <option value="Pago a proveedor">Pago a proveedor</option>
              <option value="Gasto de operaci√≥n">Gasto de operaci√≥n</option>
              <option value="Retiro del due√±o">Retiro del due√±o</option>
              <option value="Otros">Otros</option>
            </select>
          </div>

          <div class="form-field">
            <label for="movDescripcion">Descripci√≥n</label>
            <input id="movDescripcion" class="input" type="text" placeholder="Ej: Venta contado, pago luz, etc.">
          </div>

          <div class="form-field">
            <label for="movMonto">Monto (Q)</label>
            <input id="movMonto" class="input" type="number" step="0.01" min="0" placeholder="0.00">
          </div>
        </div>

        <button class="btn" id="btnRegistrarMovimiento">Guardar movimiento</button>
      </section>

      <!-- Corte de caja -->
      <section class="card">
        <h2 class="card-title">Corte de caja</h2>
        <p class="card-description">
          Realiza un corte de caja registrando el saldo contado f√≠sicamente y compar√°ndolo con el saldo del sistema.
        </p>

        <div class="form-grid">
          <div class="form-field">
            <label for="corteSaldoFisico">Saldo contado en efectivo (Q)</label>
            <input id="corteSaldoFisico" class="input" type="number" step="0.01" min="0" placeholder="0.00">
          </div>

          <div class="form-field" style="grid-column: 1 / -1;">
            <label for="corteObservaciones">Observaciones</label>
            <input id="corteObservaciones" class="input" type="text" placeholder="Ej: Diferencia por error de billetes, etc.">
          </div>
        </div>

        <button class="btn" id="btnRegistrarCorte">Registrar corte de caja</button>
      </section>

      <!-- Tabla de movimientos -->
      <section class="card">
        <h2 class="card-title">Movimientos de caja</h2>
        <p class="card-description">
          Historial de ingresos y egresos registrados. Los m√°s recientes aparecen primero.
        </p>

        <table class="table">
          <thead>
            <tr>
              <th>Fecha / Hora</th>
              <th>Tipo</th>
              <th>Categor√≠a</th>
              <th>Descripci√≥n</th>
              <th>Monto</th>
            </tr>
          </thead>
          <tbody id="tabla-movimientos-body">
            <tr>
              <td colspan="5" class="table-empty">
                A√∫n no hay movimientos en esta versi√≥n demo.
              </td>
            </tr>
          </tbody>
        </table>
      </section>
    </main>
  </div>

  <!-- Scripts base -->
  <script src="alex-storage.js"></script>
  <script src="alex-roles.js"></script>

  <script>
    // Men√∫ m√≥vil
    const btnMenuMobile = document.getElementById('btnMenuMobile');
    const sidebar = document.querySelector('.sidebar');

    if (btnMenuMobile) {
      btnMenuMobile.addEventListener('click', () => {
        sidebar.classList.toggle('sidebar-open');
      });
    }

    // Usuario y permisos
    const usuarioActual = typeof getUsuarioActualObligatorio === "function"
      ? getUsuarioActualObligatorio()
      : null;

    if (typeof aplicarPermisosYProteger === "function") {
      aplicarPermisosYProteger("caja");
    }

    // Pintar nombre y rol en el topbar
    const labelUser = document.getElementById("topbar-user-label");
    if (usuarioActual && labelUser) {
      const rolTexto = usuarioActual.rol === "dueno" ? "Due√±o" : "Empleado";
      labelUser.textContent = `${usuarioActual.nombre} (${rolTexto})`;
    }

    // Bot√≥n Cerrar sesi√≥n
    const btnLogout = document.getElementById("btnLogout");
    if (btnLogout) {
      btnLogout.addEventListener("click", () => {
        if (!confirm("¬øQuieres cerrar sesi√≥n?")) return;

        if (typeof save === "function") {
          save("usuarioActual", null);
        } else {
          localStorage.removeItem("usuarioActual");
        }

        window.location.href = "index.html";
      });
    }

    // ====== DATOS BASE DE CAJA ======
    let movimientos = [];
    let cierres = [];
    let saldoInicial = 0;

    if (typeof load === "function") {
      const movA = load("caja_movimientos", []);
      const movB = load("movimientosCaja", []);
      const map = new Map();

      if (Array.isArray(movA)) {
        movA.forEach(m => {
          const id = m.id || JSON.stringify(m) + "_a";
          map.set(id, { ...m, id });
        });
      }
      if (Array.isArray(movB)) {
        movB.forEach(m => {
          const id = m.id || JSON.stringify(m) + "_b";
          if (!map.has(id)) {
            map.set(id, { ...m, id });
          }
        });
      }
      movimientos = Array.from(map.values());

      const cData = load("cierresCaja", []);
      cierres = Array.isArray(cData) ? cData : [];

      const sData = load("saldoInicial", 0);
      saldoInicial = Number(sData) || 0;
    }

    function guardarMovimientos() {
      if (typeof save === "function") {
        save("caja_movimientos", movimientos);
        save("movimientosCaja", movimientos);
      }
    }

    function guardarCierres() {
      if (typeof save === "function") {
        save("cierresCaja", cierres);
      }
    }

    function alex3FormatearMonedaSeguro(valor) {
      if (typeof alex3FormatearMoneda === "function") {
        return alex3FormatearMoneda(valor);
      }
      const num = Number(valor);
      if (isNaN(num)) return "Q 0.00";
      return "Q " + num.toFixed(2);
    }

    function formatearFechaBonita(fechaIso) {
      const d = new Date(fechaIso);
      if (isNaN(d.getTime())) return fechaIso || "-";
      const dia = String(d.getDate()).padStart(2, "0");
      const mes = String(d.getMonth() + 1).padStart(2, "0");
      const anio = d.getFullYear();
      const horas = String(d.getHours()).padStart(2, "0");
      const mins = String(d.getMinutes()).padStart(2, "0");
      return `${dia}/${mes}/${anio} ${horas}:${mins}`;
    }

    function esMismoDia(a, b) {
      return a.getFullYear() === b.getFullYear() &&
             a.getMonth() === b.getMonth() &&
             a.getDate() === b.getDate();
    }

    // ====== RESUMEN KPI ======
    function recalcularResumenCaja() {
      const hoy = new Date();
      let ingresosTotales = 0;
      let egresosTotales = 0;
      let ingresosHoy = 0;
      let egresosHoy = 0;

      movimientos.forEach(m => {
        const tipo = (m.tipo || "").toUpperCase();
        const monto = Number(m.monto) || 0;
        const fecha = new Date(m.fechaHora || m.fecha || Date.now());

        if (tipo === "INGRESO") {
          ingresosTotales += monto;
          if (esMismoDia(fecha, hoy)) ingresosHoy += monto;
        } else if (tipo === "EGRESO") {
          egresosTotales += monto;
          if (esMismoDia(fecha, hoy)) egresosHoy += monto;
        }
      });

      const saldo = saldoInicial + ingresosTotales - egresosTotales;
      const numCortes = cierres.length;

      const elSaldo = document.getElementById("kpi-caja-saldo");
      const elIngHoy = document.getElementById("kpi-caja-ingresos-hoy");
      const elEgrHoy = document.getElementById("kpi-caja-egresos-hoy");
      const elCortes = document.getElementById("kpi-caja-cortes");

      if (elSaldo) elSaldo.textContent = alex3FormatearMonedaSeguro(saldo);
      if (elIngHoy) elIngHoy.textContent = alex3FormatearMonedaSeguro(ingresosHoy);
      if (elEgrHoy) elEgrHoy.textContent = alex3FormatearMonedaSeguro(egresosHoy);
      if (elCortes) elCortes.textContent = String(numCortes);
    }

    // ====== TABLA DE MOVIMIENTOS ======
    function renderTablaMovimientos() {
      const tbody = document.getElementById("tabla-movimientos-body");
      tbody.innerHTML = "";

      if (!movimientos.length) {
        tbody.innerHTML = `
          <tr>
            <td colspan="5" class="table-empty">A√∫n no hay movimientos en esta versi√≥n demo.</td>
          </tr>
        `;
        return;
      }

      const ordenados = [...movimientos].sort((a, b) => {
        const fa = new Date(a.fechaHora || a.fecha || 0).getTime();
        const fb = new Date(b.fechaHora || b.fecha || 0).getTime();
        return fb - fa;
      });

      ordenados.forEach(m => {
        const fecha = formatearFechaBonita(m.fechaHora || m.fecha || "");
        const tipo = (m.tipo || "").toUpperCase() === "EGRESO" ? "EGRESO" : "INGRESO";
        const categoria = m.categoria || "";
        const desc = m.descripcion || "";
        const monto = alex3FormatearMonedaSeguro(m.monto);

        tbody.innerHTML += `
          <tr>
            <td>${fecha}</td>
            <td>${tipo}</td>
            <td>${categoria}</td>
            <td>${desc}</td>
            <td>${monto}</td>
          </tr>
        `;
      });
    }

    // ====== REGISTRAR MOVIMIENTO ======
    function registrarMovimiento() {
      const tipo = document.getElementById("movTipo").value;
      const categoria = document.getElementById("movCategoria").value;
      const descripcion = document.getElementById("movDescripcion").value.trim();
      const montoVal = parseFloat(document.getElementById("movMonto").value);

      if (!tipo || !categoria || !descripcion || isNaN(montoVal) || montoVal <= 0) {
        alert("Por favor completa tipo, categor√≠a, descripci√≥n y un monto v√°lido.");
        return;
      }

      const ahora = new Date();
      const mov = {
        id: "caja_" + Date.now(),
        fechaHora: ahora.toISOString(),
        tipo: tipo.toUpperCase() === "EGRESO" ? "EGRESO" : "INGRESO",
        categoria,
        descripcion,
        monto: montoVal,
        origen: "caja_manual",
        usuario: usuarioActual ? usuarioActual.usuario : null
      };

      movimientos.push(mov);
      guardarMovimientos();
      renderTablaMovimientos();
      recalcularResumenCaja();

      // Limpiar
      document.getElementById("movCategoria").value = "";
      document.getElementById("movDescripcion").value = "";
      document.getElementById("movMonto").value = "";

      alert("Movimiento de caja registrado correctamente.");
    }

    const btnRegistrarMovimiento = document.getElementById("btnRegistrarMovimiento");
    if (btnRegistrarMovimiento) {
      btnRegistrarMovimiento.addEventListener("click", registrarMovimiento);
    }

    // ====== REGISTRAR CORTE ======
    function registrarCorte() {
      const saldoFisicoVal = parseFloat(document.getElementById("corteSaldoFisico").value);
      const observaciones = document.getElementById("corteObservaciones").value.trim();

      if (isNaN(saldoFisicoVal) || saldoFisicoVal < 0) {
        alert("Ingresa un saldo f√≠sico v√°lido para el corte de caja.");
        return;
      }

      // Calcular saldo del sistema al momento del corte
      let ingresosTotales = 0;
      let egresosTotales = 0;
      movimientos.forEach(m => {
        const tipo = (m.tipo || "").toUpperCase();
        const monto = Number(m.monto) || 0;
        if (tipo === "INGRESO") ingresosTotales += monto;
        else if (tipo === "EGRESO") egresosTotales += monto;
      });

      const saldoSistema = saldoInicial + ingresosTotales - egresosTotales;
      const diferencia = saldoFisicoVal - saldoSistema;

      const ahora = new Date();
      const cierre = {
        id: "cierre_" + Date.now(),
        fecha: ahora.toLocaleString("es-GT"),
        fechaIso: ahora.toISOString(),
        saldoSistema: saldoSistema,
        saldoFisico: saldoFisicoVal,
        diferencia: diferencia,
        observaciones: observaciones,
        usuario: usuarioActual ? usuarioActual.usuario : null
      };

      cierres.push(cierre);
      guardarCierres();
      recalcularResumenCaja();

      // Limpiar
      document.getElementById("corteSaldoFisico").value = "";
      document.getElementById("corteObservaciones").value = "";

      alert("Corte de caja registrado. Diferencia: " + alex3FormatearMonedaSeguro(diferencia));
    }

    const btnRegistrarCorte = document.getElementById("btnRegistrarCorte");
    if (btnRegistrarCorte) {
      btnRegistrarCorte.addEventListener("click", registrarCorte);
    }

    // ====== PRIMERA CARGA ======
    renderTablaMovimientos();
    recalcularResumenCaja();
  </script>
</body>
</html>
