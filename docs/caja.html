<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>ALEX 3.0 - Caja</title>
  <link rel="stylesheet" href="styles.css">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>

<body class="dashboard-body">
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <span class="logo-badge">A</span>
      <div class="sidebar-logo-text">
        <span class="sidebar-logo-main">ALEX 3.0</span>
        <span class="sidebar-logo-sub">Panel del negocio</span>
      </div>
    </div>

    <nav class="sidebar-nav">
      <a href="dashboard.html" class="sidebar-link">üìä Dashboard</a>
      <a href="ventas.html" class="sidebar-link">üíµ Ventas</a>
      <a href="inventario.html" class="sidebar-link">üì¶ Inventario</a>
      <a href="caja.html" class="sidebar-link active">üí∞ Caja</a>
      <a href="compras.html" class="sidebar-link">üßæ Compras</a>
      <a href="gastos.html" class="sidebar-link">üìâ Gastos</a>
      <a href="clientes.html" class="sidebar-link">üë• Clientes</a>
      <a href="proveedores.html" class="sidebar-link">üöö Proveedores</a>
      <a href="contabilidad.html" class="sidebar-link">üìö Contabilidad</a>
      <a href="sat.html" class="sidebar-link">üá¨üáπ SAT Guatemala</a>
      <a href="ia.html" class="sidebar-link">ü§ñ IA empresarial</a>
      <a href="configuracion.html" class="sidebar-link">‚öôÔ∏è Configuraci√≥n</a>
    </nav>

    <div class="sidebar-footer">
      <span class="sidebar-footer-title">Empresa demo</span>
      <span class="sidebar-footer-sub">Versi√≥n 1.0</span>
    </div>
  </aside>

  <!-- Layout principal -->
  <div class="main-layout">
    <!-- Topbar -->
    <header class="topbar">
      <button class="btn-menu-mobile" id="btnMenuMobile">‚ò∞</button>

      <div class="topbar-left">
        <h1 class="topbar-title">Caja</h1>
        <p class="topbar-subtitle">
          Control de entradas y salidas de efectivo del negocio.
        </p>
      </div>

      <div class="topbar-right">
        <span class="topbar-company">Mi tienda demo</span>
        <span class="topbar-divider">‚Ä¢</span>
        <span class="topbar-user" id="topbar-user-label">Usuario (Rol)</span>
        <button class="btn" id="btnLogout" type="button" style="margin-left: 0.75rem;">
          Cerrar sesi√≥n
        </button>
      </div>
    </header>

    <!-- Contenido principal -->
    <main class="main-content">
      <!-- KPIs de caja -->
      <section class="cards-grid">
        <article class="card kpi-card">
          <h2 class="card-title">Saldo en caja</h2>
          <p class="card-kpi" id="kpi-caja-saldo">Q 0.00</p>
          <p class="card-kpi-sub">Saldo calculado con ingresos y egresos.</p>
        </article>

        <article class="card kpi-card">
          <h2 class="card-title">Ingresos de hoy</h2>
          <p class="card-kpi" id="kpi-caja-ingresos-hoy">Q 0.00</p>
          <p class="card-kpi-sub">Entradas directas a caja.</p>
        </article>

        <article class="card kpi-card">
          <h2 class="card-title">Egresos de hoy</h2>
          <p class="card-kpi gasto" id="kpi-caja-egresos-hoy">Q 0.00</p>
          <p class="card-kpi-sub">Salidas por compras, gastos u otros.</p>
        </article>

        <article class="card kpi-card">
          <h2 class="card-title">Cortes realizados</h2>
          <p class="card-kpi" id="kpi-caja-cortes">0</p>
          <p class="card-kpi-sub">N√∫mero de cortes de caja registrados.</p>
        </article>
      </section>

      <!-- Movimientos de caja -->
      <section class="card">
        <h2 class="card-title">Movimientos de caja</h2>
        <p class="card-description">
          Aqu√≠ ves todos los ingresos y egresos registrados por ventas, compras, gastos u otros m√≥dulos.
        </p>

        <table class="table">
          <thead>
            <tr>
              <th>Fecha</th>
              <th>Tipo</th>
              <th>Categor√≠a</th>
              <th>Descripci√≥n</th>
              <th>Monto</th>
            </tr>
          </thead>
          <tbody id="tabla-movimientos-caja">
            <tr>
              <td colspan="5" class="table-empty">
                A√∫n no hay movimientos en caja.
              </td>
            </tr>
          </tbody>
        </table>
      </section>

      <!-- Corte de caja r√°pido -->
      <section class="card">
        <h2 class="card-title">Corte de caja r√°pido</h2>
        <p class="card-description">
          Guarda un corte de caja con el saldo actual. Esto se reflejar√° tambi√©n en el m√≥dulo de reportes.
        </p>

        <div class="form-grid">
          <div class="form-field">
            <label for="corteSaldoActual">Saldo actual (solo lectura)</label>
            <input id="corteSaldoActual" class="input" type="text" readonly value="Q 0.00">
          </div>

          <div class="form-field" style="grid-column: 1 / -1;">
            <label for="corteObservaciones">Observaciones (opcional)</label>
            <input id="corteObservaciones" class="input" type="text"
                   placeholder="Ej: Corte de cierre del d√≠a, turno de la ma√±ana, etc.">
          </div>
        </div>

        <button class="btn" id="btnRegistrarCorte" style="margin-top: 0.75rem;">
          Registrar corte de caja
        </button>
      </section>
    </main>
  </div>

  <!-- Scripts base -->
  <script src="alex-storage.js"></script>
  <script src="alex-roles.js"></script>

  <script>
    // ===== Men√∫ m√≥vil =====
    const btnMenuMobile = document.getElementById('btnMenuMobile');
    const sidebar = document.querySelector('.sidebar');
    if (btnMenuMobile) {
      btnMenuMobile.addEventListener('click', () => {
        sidebar.classList.toggle('sidebar-open');
      });
    }

    // ===== Usuario y permisos =====
    const usuarioActual = typeof getUsuarioActualObligatorio === "function"
      ? getUsuarioActualObligatorio()
      : null;

    if (typeof aplicarPermisosYProteger === "function") {
      aplicarPermisosYProteger("caja");
    }

    const labelUser = document.getElementById("topbar-user-label");
    if (usuarioActual && labelUser) {
      const rolTexto = usuarioActual.rol === "dueno" ? "Due√±o" : "Empleado";
      labelUser.textContent = `${usuarioActual.nombre} (${rolTexto})`;
    }

    // Cerrar sesi√≥n
    const btnLogout = document.getElementById("btnLogout");
    if (btnLogout) {
      btnLogout.addEventListener("click", () => {
        if (!confirm("¬øQuieres cerrar sesi√≥n?")) return;
        if (typeof save === "function") {
          save("usuarioActual", null);
        } else {
          localStorage.removeItem("usuarioActual");
        }
        window.location.href = "index.html";
      });
    }

    // ===== Helpers =====
    function alex3FormatearMonedaSeguro(valor) {
      if (typeof alex3FormatearMoneda === "function") {
        return alex3FormatearMoneda(valor);
      }
      const num = Number(valor);
      if (isNaN(num)) return "Q 0.00";
      return "Q " + num.toFixed(2);
    }

    function esMismoDia(a, b) {
      return a.getFullYear() === b.getFullYear() &&
             a.getMonth() === b.getMonth() &&
             a.getDate() === b.getDate();
    }

    function formatearFechaLocal(fechaIso) {
      const d = new Date(fechaIso);
      if (isNaN(d.getTime())) return "-";
      return d.toLocaleString("es-GT");
    }

    // ===== Datos base: movimientos de caja, saldo inicial, cierres =====
    let movimientosCaja = [];
    let saldoInicial = 0;
    let cierresCaja = [];
    let ultimoSaldoCalculado = 0;

    if (typeof load === "function") {
      const m1 = load("caja_movimientos", []);
      const m2 = load("movimientosCaja", []);
      if (Array.isArray(m1) && m1.length > 0) {
        movimientosCaja = m1;
      } else if (Array.isArray(m2)) {
        movimientosCaja = m2;
      }

      saldoInicial = Number(load("saldoInicial", 0)) || 0;

      const cData = load("cierresCaja", []);
      cierresCaja = Array.isArray(cData) ? cData : [];
    }

    function guardarMovimientosCaja() {
      if (typeof save === "function") {
        save("caja_movimientos", movimientosCaja);
        save("movimientosCaja", movimientosCaja); // compatibilidad
      }
    }

    function guardarCierresCaja() {
      if (typeof save === "function") {
        save("cierresCaja", cierresCaja);
      }
    }

    // ===== KPIs de caja =====
    function recalcularKPIsCaja() {
      const hoy = new Date();

      let totalIngresos = 0;
      let totalEgresos = 0;
      let ingresosHoy = 0;
      let egresosHoy = 0;

      movimientosCaja.forEach(m => {
        const fechaRef = new Date(m.fechaHora || m.fecha || Date.now());
        const monto = Number(m.monto) || 0;
        const tipo = (m.tipo || "").toUpperCase();

        if (tipo === "INGRESO") {
          totalIngresos += monto;
          if (esMismoDia(fechaRef, hoy)) {
            ingresosHoy += monto;
          }
        } else if (tipo === "EGRESO") {
          totalEgresos += monto;
          if (esMismoDia(fechaRef, hoy)) {
            egresosHoy += monto;
          }
        }
      });

      const saldoActual = saldoInicial + totalIngresos - totalEgresos;
      ultimoSaldoCalculado = saldoActual;

      const elSaldo = document.getElementById("kpi-caja-saldo");
      const elIngHoy = document.getElementById("kpi-caja-ingresos-hoy");
      const elEgrHoy = document.getElementById("kpi-caja-egresos-hoy");
      const elCortes = document.getElementById("kpi-caja-cortes");
      const inputSaldoCorte = document.getElementById("corteSaldoActual");

      if (elSaldo) elSaldo.textContent = alex3FormatearMonedaSeguro(saldoActual);
      if (elIngHoy) elIngHoy.textContent = alex3FormatearMonedaSeguro(ingresosHoy);
      if (elEgrHoy) elEgrHoy.textContent = alex3FormatearMonedaSeguro(egresosHoy);
      if (elCortes) elCortes.textContent = String(cierresCaja.length);
      if (inputSaldoCorte) inputSaldoCorte.value = alex3FormatearMonedaSeguro(saldoActual);
    }

    // ===== Tabla de movimientos =====
    function renderMovimientosCaja() {
      const tbody = document.getElementById("tabla-movimientos-caja");
      if (!tbody) return;

      tbody.innerHTML = "";

      if (!movimientosCaja.length) {
        tbody.innerHTML = `
          <tr>
            <td colspan="5" class="table-empty">
              A√∫n no hay movimientos en caja.
            </td>
          </tr>
        `;
        return;
      }

      const ordenados = [...movimientosCaja].sort((a, b) => {
        const fa = new Date(a.fechaHora || a.fecha || 0).getTime();
        const fb = new Date(b.fechaHora || b.fecha || 0).getTime();
        return fb - fa;
      });

      ordenados.forEach(m => {
        const fechaTxt = m.fecha || formatearFechaLocal(m.fechaHora || "");
        const tipo = (m.tipo || "").toUpperCase() === "INGRESO" ? "Ingreso" : "Egreso";
        const categoria = m.categoria || "-";
        const descripcion = m.descripcion || "-";
        const montoTxt = alex3FormatearMonedaSeguro(m.monto);

        tbody.innerHTML += `
          <tr>
            <td>${fechaTxt}</td>
            <td>${tipo}</td>
            <td>${categoria}</td>
            <td>${descripcion}</td>
            <td>${montoTxt}</td>
          </tr>
        `;
      });
    }

    // ===== Corte de caja =====
    const btnRegistrarCorte = document.getElementById("btnRegistrarCorte");
    const inputCorteObs = document.getElementById("corteObservaciones");

    function registrarCorteCaja() {
      const saldoCorte = ultimoSaldoCalculado || 0;
      const observaciones = (inputCorteObs && inputCorteObs.value.trim()) || "";

      const ahora = new Date();
      const fechaLocal = ahora.toLocaleString("es-GT");
      const fechaIso = ahora.toISOString();

      const corte = {
        id: "corte_" + Date.now(),
        fecha: fechaLocal,
        fechaHora: fechaIso,
        saldoFinal: saldoCorte,
        observaciones,
        usuario: usuarioActual ? usuarioActual.usuario : null,
        origen: "caja"
      };

      cierresCaja.push(corte);
      guardarCierresCaja();

      if (inputCorteObs) {
        inputCorteObs.value = "";
      }

      recalcularKPIsCaja();

      alert("Corte de caja registrado correctamente.");
    }

    if (btnRegistrarCorte) {
      btnRegistrarCorte.addEventListener("click", registrarCorteCaja);
    }

    // ===== Primera carga =====
    renderMovimientosCaja();
    recalcularKPIsCaja();
  </script>
</body>
</html>
