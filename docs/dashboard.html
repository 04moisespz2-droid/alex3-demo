<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>ALEX 3.0 - Dashboard</title>
  <link rel="stylesheet" href="styles.css">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>

<body class="dashboard-body">
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <span class="logo-badge">A</span>
      <div class="sidebar-logo-text">
        <span class="sidebar-logo-main">ALEX 3.0</span>
        <span class="sidebar-logo-sub">Panel del negocio</span>
      </div>
    </div>

    <nav class="sidebar-nav">
      <a href="dashboard.html" class="sidebar-link active">ğŸ“Š Dashboard</a>
      <a href="ventas.html" class="sidebar-link">ğŸ’µ Ventas</a>
      <a href="inventario.html" class="sidebar-link">ğŸ“¦ Inventario</a>
      <a href="caja.html" class="sidebar-link">ğŸ’° Caja</a>
      <a href="compras.html" class="sidebar-link">ğŸ§¾ Compras</a>
      <a href="gastos.html" class="sidebar-link">ğŸ“‰ Gastos</a>
      <a href="clientes.html" class="sidebar-link">ğŸ‘¥ Clientes</a>
      <a href="proveedores.html" class="sidebar-link">ğŸšš Proveedores</a>
      <a href="contabilidad.html" class="sidebar-link">ğŸ“š Contabilidad</a>
      <a href="sat.html" class="sidebar-link">ğŸ‡¬ğŸ‡¹ SAT Guatemala</a>
      <a href="ia.html" class="sidebar-link">ğŸ¤– IA empresarial</a>
      <a href="configuracion.html" class="sidebar-link">âš™ï¸ ConfiguraciÃ³n</a>
    </nav>

    <div class="sidebar-footer">
      <span class="sidebar-footer-title">Empresa demo</span>
      <span class="sidebar-footer-sub">VersiÃ³n 1.0</span>
    </div>
  </aside>

  <!-- Ãrea principal -->
  <div class="main-layout">
    <!-- Topbar -->
    <header class="topbar">
      <button class="btn-menu-mobile" id="btnMenuMobile">â˜°</button>

      <div class="topbar-left">
        <h1 class="topbar-title">Resumen del dÃ­a</h1>
        <p class="topbar-subtitle">Ventas, gastos, utilidad y caja al instante.</p>
      </div>

      <div class="topbar-right">
        <span class="topbar-company">Mi tienda demo</span>
        <span class="topbar-divider">â€¢</span>
        <span class="topbar-user">Brayan (DueÃ±o)</span>
      </div>
    </header>

    <!-- Contenido -->
    <main class="main-content">
      <!-- Cards principales -->
      <section class="cards-grid">
        <article class="card kpi-card">
          <h2 class="card-title">Ventas de hoy</h2>
          <p class="card-kpi" id="kpi-dashboard-ventas-hoy">Q 0.00</p>
          <p class="card-kpi-sub">Objetivo diario: Q 1,000</p>
        </article>

        <article class="card kpi-card">
          <h2 class="card-title">Gastos de hoy</h2>
          <p class="card-kpi gasto" id="kpi-dashboard-gastos-hoy">Q 0.00</p>
          <p class="card-kpi-sub">Incluye compras y egresos de caja</p>
        </article>

        <article class="card kpi-card">
          <h2 class="card-title">Utilidad estimada</h2>
          <p class="card-kpi utilidad" id="kpi-dashboard-utilidad">Q 0.00</p>
          <p class="card-kpi-sub">Ventas - gastos (estimado rÃ¡pido)</p>
        </article>

        <article class="card kpi-card">
          <h2 class="card-title">Caja actual</h2>
          <p class="card-kpi caja" id="kpi-dashboard-caja">Q 0.00</p>
          <p class="card-kpi-sub">Control por billetes y movimientos</p>
        </article>
      </section>

      <!-- SecciÃ³n secundaria -->
      <section class="grid-2">
        <article class="card">
          <h2 class="card-title">Productos mÃ¡s vendidos</h2>
          <p class="card-description">
            AquÃ­ se mostrarÃ¡n los productos con mayor rotaciÃ³n en el perÃ­odo seleccionado.
          </p>
          <table class="table">
            <thead>
              <tr>
                <th>Producto</th>
                <th>Vendidos</th>
                <th>Ingresos</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td colspan="3" class="table-empty">
                  AÃºn no hay datos en esta versiÃ³n demo.
                </td>
              </tr>
            </tbody>
          </table>
        </article>

        <article class="card">
          <h2 class="card-title">Alertas rÃ¡pidas</h2>
          <ul class="alerts-list">
            <li class="alert-item">
              ğŸ”” <strong>Stock bajo:</strong> Se mostrarÃ¡n productos por debajo del mÃ­nimo.
            </li>
            <li class="alert-item">
              ğŸ”” <strong>Fiados elevados:</strong> ALEX avisarÃ¡ cuando las cuentas por cobrar sean muy altas.
            </li>
            <li class="alert-item">
              ğŸ”” <strong>DÃ­as flojos:</strong> DÃ­as con ventas muy por debajo del promedio.
            </li>
          </ul>
          <p class="card-description">
            Estas alertas serÃ¡n generadas automÃ¡ticamente por la IA empresarial en la versiÃ³n completa.
          </p>
        </article>
      </section>
    </main>
  </div>

  <!-- Scripts base -->
  <script src="alex-storage.js"></script>
  <script src="alex-roles.js"></script>

  <script>
    // MenÃº mÃ³vil: solo muestra/oculta el sidebar en pantallas pequeÃ±as
    const btnMenuMobile = document.getElementById('btnMenuMobile');
    const sidebar = document.querySelector('.sidebar');

    if (btnMenuMobile) {
      btnMenuMobile.addEventListener('click', () => {
        sidebar.classList.toggle('sidebar-open');
      });
    }

    // Usuario y permisos
    const usuarioActual = typeof getUsuarioActualObligatorio === "function"
      ? getUsuarioActualObligatorio()
      : null;

    if (typeof aplicarPermisosYProteger === "function") {
      aplicarPermisosYProteger("dashboard");
    }

    // Cargar datos desde almacenamiento
    let ventas = [];
    let movimientosCaja = [];
    let gastos = [];

    if (typeof load === "function") {
      const vData = load("ventas", []);
      ventas = Array.isArray(vData) ? vData : [];

      const mData = load("caja_movimientos", []);
      movimientosCaja = Array.isArray(mData) ? mData : [];

      // En un futuro, puedes usar un mÃ³dulo separado de gastos:
      const gData = load("gastos", []);
      gastos = Array.isArray(gData) ? gData : [];
    }

    // Helpers
    function alex3FormatearMonedaSeguro(valor) {
      if (typeof alex3FormatearMoneda === "function") {
        return alex3FormatearMoneda(valor);
      }
      const num = Number(valor);
      if (isNaN(num)) return "Q 0.00";
      return "Q " + num.toFixed(2);
    }

    function mismaFecha(d1, d2) {
      return (
        d1.getFullYear() === d2.getFullYear() &&
        d1.getMonth() === d2.getMonth() &&
        d1.getDate() === d2.getDate()
      );
    }

    // CÃ¡lculo principal del dashboard
    function recalcularDashboard() {
      const hoy = new Date();

      // Ventas de hoy
      let ventasHoy = 0;
      ventas.forEach(v => {
        const fecha = new Date(v.fecha || v.fechaHora || Date.now());
        const total = Number(v.total) || 0;
        if (mismaFecha(fecha, hoy)) {
          ventasHoy += total;
        }
      });

      // Movimientos de caja (ingresos y egresos)
      let ingresosTotales = 0;
      let egresosTotales = 0;
      let egresosHoy = 0;

      movimientosCaja.forEach(m => {
        const fecha = new Date(m.fecha || m.fechaHora || Date.now());
        const monto = Number(m.monto) || 0;

        if (m.tipo === "INGRESO") {
          ingresosTotales += monto;
        } else if (m.tipo === "EGRESO") {
          egresosTotales += monto;
          if (mismaFecha(fecha, hoy)) {
            egresosHoy += monto;
          }
        }
      });

      // Gastos adicionales del mÃ³dulo gastos (opcional/futuro)
      let gastosHoyExtra = 0;
      gastos.forEach(g => {
        const fecha = new Date(g.fecha || g.fechaHora || Date.now());
        const monto = Number(g.monto) || 0;
        if (mismaFecha(fecha, hoy)) {
          gastosHoyExtra += monto;
        }
      });

      const gastosHoyTotal = egresosHoy + gastosHoyExtra;

      // Caja actual (simple): ingresos + ventas - egresos
      const cajaActual = ingresosTotales + ventasHoy - egresosTotales;

      // Utilidad estimada (versiÃ³n simple): ventas hoy - gastos hoy
      const utilidadEstim = ventasHoy - gastosHoyTotal;

      // Pintar en pantalla
      const elVentasHoy = document.getElementById("kpi-dashboard-ventas-hoy");
      const elGastosHoy = document.getElementById("kpi-dashboard-gastos-hoy");
      const elUtilidad = document.getElementById("kpi-dashboard-utilidad");
      const elCaja = document.getElementById("kpi-dashboard-caja");

      if (elVentasHoy) elVentasHoy.textContent = alex3FormatearMonedaSeguro(ventasHoy);
      if (elGastosHoy) elGastosHoy.textContent = alex3FormatearMonedaSeguro(gastosHoyTotal);
      if (elUtilidad) elUtilidad.textContent = alex3FormatearMonedaSeguro(utilidadEstim);
      if (elCaja) elCaja.textContent = alex3FormatearMonedaSeguro(cajaActual);
    }

    // Primera carga
    recalcularDashboard();
  </script>
</body>
</html>
